/*! prospect 2016-05-24 */
function PVizModel(a,b){this.vFrame=a,this.frameID=a.getFrameID()+" div.viz-content div.viz-result",this.settings=b,this.recSel=[],this.tUsed=[!1,!1,!1,!1],this.rMap=null}function PFilterModel(a,b){this.id=a,this.att=b,this.dirty=!0}Array.prototype.findIndex||(Array.prototype.findIndex=function(a){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!=typeof a)throw new TypeError("predicate must be a function");for(var b,c=Object(this),d=c.length>>>0,e=arguments[1],f=0;d>f;f++)if(b=c[f],a.call(e,b,f,c))return f;return-1});var EVENT_INSTANT=1,EVENT_F_START=2,EVENT_F_END=4,PSTATE_INIT=0,PSTATE_LOAD=1,PSTATE_PROCESS=2,PSTATE_BUILD=3,PSTATE_UPDATE=4,PSTATE_READY=5,PSTATE_FDIRTY=6,PSTATE_HILITE=7,D3FG_BAR_WIDTH=25,D3FG_MARGINS={top:4,right:7,bottom:22,left:30},D3SC_MARGINS={top:30,right:5,bottom:5,left:40},V_FLAG_LGND=1,V_FLAG_SEL=2,V_FLAG_LOC=4,V_FLAG_SLGND=8,V_FLAG_OPT=16,V_FLAG_VSCRL=32,V_FLAG_HSCRL=64,parseTC=/(\d\d)\:(\d\d)\:(\d\d)\.(\d\d?)/,MS_IN_DAY=86399990,TODAY=new Date,localD3,months,dlText={},PState=function(){var a,b,c,d=PSTATE_INIT;return{init:function(){var c=document.getElementById("dltext-pstates").innerHTML;a=c.trim().split("|"),b=document.getElementById("pstate")},set:function(e){e!=d&&(d===PSTATE_READY?b.classList.add("attn"):e===PSTATE_READY&&b.classList.remove("attn"),b.textContent=a[e-1],d=e,c=b.offsetWidth)}}}();PVizModel.prototype.flags=function(){return 0},PVizModel.prototype.preRender=function(){var a,b=PData.rSize(),c=Math.floor((b+15)/16);for(a=0;4>a;a++)this.tUsed[a]=!1;for(null==this.rMap&&(this.rMap=new Uint16Array(c)),a=0;c>a;a++)this.rMap[a]=0},PVizModel.prototype.isSel=function(a){var b=_.indexOf(this.recSel,a,!0);return-1!=b},PVizModel.prototype.getSel=function(){return this.recSel},PVizModel.prototype.toggleSel=function(a){var b=this.recSel.length,c=_.sortedIndex(this.recSel,a);return this.recSel[c]===a?(this.recSel.splice(c,1),b>0&&0==this.recSel.length&&this.vFrame.selBtns(!1),this.vFrame.vizDelSel(a),!1):(this.recSel.splice(c,0,a),0==b&&this.recSel.length>0&&this.vFrame.selBtns(!0),this.vFrame.vizAddSel(a),!0)},PVizModel.prototype.clearSel=function(){this.recSel=[]},PVizModel.prototype.getLocAtts=function(a){return[]},PVizModel.prototype.getFeatureAtts=function(a){return[]},PVizModel.prototype.teardown=function(){},PVizModel.prototype.resize=function(){},PVizModel.prototype.doOptions=function(){},PVizModel.prototype.getState=function(){return{}},PVizModel.prototype.setState=function(a){},PVizModel.prototype.hint=function(){return null};var VizMap=function(a,b){PVizModel.call(this,a,b)};VizMap.prototype=Object.create(PVizModel.prototype),VizMap.prototype.constructor=VizMap,VizMap.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_OPT},VizMap.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.cAtts[a];return null==b?null:b}return this.settings.cAtts},VizMap.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds},VizMap.prototype.setup=function(){function a(){f.lMap.zoomIn()}function b(){f.lMap.zoomOut()}function c(){f.lMap.setView([g,h],e)}function d(){function a(a){f.lMap.setView([a.coords.latitude,a.coords.longitude])}navigator.geolocation.getCurrentPosition(a)}var e,f=this,g=parseFloat(this.settings.clat),h=parseFloat(this.settings.clon);e="string"==typeof this.settings.zoom?parseInt(this.settings.zoom):this.settings.zoom;var i=this.vFrame.getIndex();jQuery(this.frameID).append('<div id="l-map-'+i+'" class="max-size"></div>'),this.lMap=L.map("l-map-"+i,{zoomControl:!1}).setView([g,h],e),this.baseMap=PMapHub.createMapLayer(this.settings.base,1,this.lMap,null),this.bOp=100,this.lOps=[],this.mapLayers=[];var j;_.each(this.settings.lyrs,function(a,b){j=a.o,f.lOps.push(100*j);var c;c=PMapHub.createMapLayer(a.lid,j,f.lMap,null),f.mapLayers.push(c)});var k=_.template(document.getElementById("dltext-v-map").innerHTML);jQuery("#view-frame-"+i+" div.view-controls").append(k({vi:i})),jQuery("#map-zoom-"+i).button({text:!1,icons:{primary:"ui-icon-plus"}}).click(a),jQuery("#map-unzoom-"+i).button({text:!1,icons:{primary:"ui-icon-minus"}}).click(b),jQuery("#map-reset-"+i).button({text:!1,icons:{primary:"ui-icon-arrowrefresh-1-w"}}).click(c),jQuery("#map-cloc-"+i).button({text:!1,icons:{primary:"ui-icon-pin-s"}}).click(d);var l=L.featureGroup();this.markerLayer=l,l.options=l.options||{},l.options.layerName=dlText.markers,l.addTo(this.lMap);var m=L.featureGroup();this.lineLayer=m,m.addTo(this.lMap);var n=PData.eTNum();this.tLCnt=new Uint16Array(n)},VizMap.prototype.render=function(a){function b(a){if(a.target&&a.target.options){var b=a.target.options._aid,e=c.toggleSel(b),f=PData.n2T(b);c.tLCnt[f]>1?(PState.set(PSTATE_UPDATE),d.eachLayer(function(a){a.options._aid===b&&(e?a.setStyle({color:"yellow",weight:2}):a.setStyle({color:"#000",weight:1}))}),PState.set(PSTATE_READY)):e?this.setStyle({color:"yellow",weight:2}):this.setStyle({color:"#000",weight:1})}}var c=this,d=this.markerLayer;this.recSel.length>0&&(this.recSel=[]),this.preRender(),d.clearLayers();var e=this.lineLayer;e.clearLayers();var f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y=PData.eTNum(),z=0,A=0;for(t=this.settings.min,"string"==typeof t&&(t=parseInt(t)),u=this.settings.max,"string"==typeof u&&(u=parseInt(u)),v=u-t,z=0;y>z;z++)this.tLCnt[z]=0;var B;for(z=0;y>z;z++)if("disable"!==this.settings.pAtts[z]){B=[];break}z=0,A=-1;a:for(;z<a.l;){if(null==l){do{if(++A==y)break a;g=a.t[A]}while(0===g.n||g.i+g.n===z);if(l=this.vFrame.getSelLocAtts(A),0===l.length){l=null;continue}if(m=c.vFrame.getSelFeatAtts(A),0===m.length){l=null;continue}c.tLCnt[A]=l.length,c.tUsed[A]=!0,j=c.vFrame.getSelLegend(A),k=PData.aByID(j),n=c.settings.pAtts[A],h=c.settings.lClrs[A],r=c.settings.sAtts[A],r&&(s=PData.aByID(r),"number"==typeof s.r.min&&"number"==typeof s.r.max?(w=s.r.min,x=s.r.max-w):r=null)}f=a.s[z],i=PData.rByN(f);var C;B&&(C={id:i.id,c:[],p:i.a[n],l:h}),l.forEach(function(a){if(o=i.a[a],o&&(p=i.a[j],"undefined"!=typeof p&&(p=PData.lClr(p,k,m)))){if(c.rMap[f>>4]|=1<<(15&f),"number"==typeof o[0])r?(s=i.a[r],s="number"==typeof s?Math.floor((s-w)*v/x)+t:t):s=t,q=L.circleMarker(o,{_aid:f,weight:1,radius:s,fillColor:p,color:"#000",opacity:1,fillOpacity:1}),C&&C.c.push(o);else if(q=2===o.length?L.polyline(o,{_aid:f,weight:1,fillColor:p,color:"#000",opacity:1,fillOpacity:1}):L.polygon(o,{_aid:f,weight:1,fillColor:p,color:"#000",opacity:1,fillOpacity:1}),C){var e=[0,0];o.forEach(function(a){e[0]+=a[0],e[1]+=a[1]}),e[0]=e[0]/o.length,e[1]=e[1]/o.length,C.c.push(e)}q.on("click",b),d.addLayer(q)}}),C&&C.c.length>0&&B.push(C),++z==g.i+g.n&&(l=null)}if(B){B.sort(function(a,b){return PData.strcmp(b.id,a.id)});var D=[];B.forEach(function(a){a.p&&a.p.forEach(function(b){if(z=_.sortedIndex(B,{id:b},"id"),z<B.length){var c=B[z];c.id===b&&a.c.forEach(function(b){c.c.forEach(function(c){b[0]===c[0]&&b[1]===c[1]||D.push({p:[b,c],c:a.l})})})}})}),D.forEach(function(a){e.addLayer(L.polyline(a.p,{color:a.c,weight:2}))})}},VizMap.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-controls div.iconbar").remove()},VizMap.prototype.resize=function(){this.lMap.invalidateSize(!1)},VizMap.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.markerLayer&&this.markerLayer.eachLayer(function(a){a.setStyle({color:"#000",weight:1})}))},VizMap.prototype.setSel=function(a){var b=this;this.recSel=a,this.markerLayer&&this.markerLayer.eachLayer(function(a){b.isSel(a.options._aid)?a.setStyle({color:"yellow",weight:2}):a.setStyle({color:"#000",weight:1})})},VizMap.prototype.getState=function(){return{c:this.lMap.getCenter(),z:this.lMap.getZoom(),l:this.vFrame.getLgndSels()}},VizMap.prototype.setState=function(a){this.lMap.setView(a.c,a.z),this.vFrame.setLgndSels(a.l)},VizMap.prototype.hint=function(){for(var a="",b=PData.eTNum(),c=0;b>c;c++){var d=this.settings.sAtts[c];if(d){0===a.length?a=dlText.markersize:a+=",";var e=PData.aByID(d),f=PData.eTByN(c),g=PData.tByID(f);a+=" "+e.def.l+" ("+g.l+")"}}return a.length>0?a:null},VizMap.prototype.doOptions=function(){function a(){e&&(b.baseMap.setOpacity(b.bOp/100),b.lOps.forEach(function(a,c){b.mapLayers[c].setOpacity(a/100)})),f.empty()}var b=this,c=this.bOp,d=[],e=!0,f=jQuery("#dialog-opacities div.layer-list"),g=jQuery('<div class="op-layer" data-i="-1">Base Map <input type=range class="op-slider" min=0 max=100 value='+this.bOp+" step=5></div>");g.find(".op-slider").on("change",function(){c=jQuery(this).val(),b.baseMap.setOpacity(c/100)}),f.append(g),this.settings.lyrs.forEach(function(a,c){var e=b.lOps[c];g=jQuery('<div class="op-layer" data-i="'+c+'">'+b.mapLayers[c].options.layerName+' <input type=range class="op-slider" min=0 max=100 value='+e+" step=5></div>"),g.find(".op-slider").on("change",function(){d[c]=jQuery(this).val(),b.mapLayers[c].setOpacity(d[c]/100)}),d.push(e),f.append(g)});var h=jQuery("#dialog-opacities").dialog({height:300,width:500,modal:!0,buttons:[{text:dlText.ok,click:function(){e=!1,h.dialog("close"),b.bOp=c,d.forEach(function(a,c){b.lOps[c]=d[c]})}},{text:dlText.cancel,click:function(){h.dialog("close")}}]});h.on("dialogclose",function(b,c){a(),h.off("dialogclose")})};var VizMap2=function(a,b){PVizModel.call(this,a,b)};VizMap2.prototype=Object.create(PVizModel.prototype),VizMap2.prototype.constructor=VizMap2,VizMap2.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_OPT},VizMap2.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.cAtts[a];return null==b?null:[b]}return[this.settings.cAtts]},VizMap2.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds},VizMap2.prototype.setup=function(){function a(){f.lMap.zoomIn()}function b(){f.lMap.zoomOut()}function c(){f.lMap.setView([g,h],e)}function d(){function a(a){f.lMap.setView([a.coords.latitude,a.coords.longitude])}navigator.geolocation.getCurrentPosition(a)}var e,f=this,g=parseFloat(this.settings.clat),h=parseFloat(this.settings.clon);e="string"==typeof this.settings.zoom?parseInt(this.settings.zoom):this.settings.zoom;var i=this.vFrame.getIndex();jQuery(this.frameID).append('<div id="l-map-'+i+'" class="max-size"></div>'),this.lMap=L.map("l-map-"+i,{zoomControl:!1}).setView([g,h],e),this.baseMap=PMapHub.createMapLayer(this.settings.base,1,this.lMap,null),this.bOp=100,this.lOps=[],this.mapLayers=[];var j;this.settings.lyrs.forEach(function(a,b){j=a.o,f.lOps.push(100*j);var c;c=PMapHub.createMapGroup(a.gid,j,f.lMap),f.mapLayers.push(c)});var k=_.template(document.getElementById("dltext-v-map").innerHTML);jQuery("#view-frame-"+i+" div.view-controls").append(k({vi:i})),jQuery("#map-zoom-"+i).button({text:!1,icons:{primary:"ui-icon-plus"}}).click(a),jQuery("#map-unzoom-"+i).button({text:!1,icons:{primary:"ui-icon-minus"}}).click(b),jQuery("#map-reset-"+i).button({text:!1,icons:{primary:"ui-icon-arrowrefresh-1-w"}}).click(c),jQuery("#map-cloc-"+i).button({text:!1,icons:{primary:"ui-icon-pin-s"}}).click(d);var l=L.featureGroup();this.markerLayer=l,l.options=l.options||{},l.options.layerName=dlText.markers,l.addTo(this.lMap);var m=L.featureGroup();this.lblLayer=m,m.addTo(this.lMap);var n=L.featureGroup();this.lineLayer=n,n.addTo(this.lMap)},VizMap2.prototype.render=function(a){function b(a){if(a.target&&a.target.options){var b=a.target.options._aid,c=d.toggleSel(b),f=PData.n2T(b),g=d.vFrame.getSelLocAtts(f);g=g[0];var h=PData.rByN(b),i=h.a[g];i.length>1?(PState.set(PSTATE_UPDATE),e.eachLayer(function(a){a.options._aid===b&&(c?a.setStyle({color:"yellow",weight:2}):a.setStyle({color:"#000",weight:1}))}),PState.set(PSTATE_READY)):c?this.setStyle({color:"yellow",weight:2}):this.setStyle({color:"#000",weight:1})}}function c(a,c){s?(t=j.a[s],t="number"==typeof t?Math.floor((t-x)*w/y)+u:u):t=u,r=L.circleMarker(a,{_aid:g,weight:1,radius:t,fillColor:q,color:"#000",opacity:1,fillOpacity:1}),r.on("click",b),e.addLayer(r),c&&"n"!=o&&d.lblLayer.addLayer(L.marker(a,{icon:L.divIcon({iconSize:null,className:"maplbl",html:"<div>"+j.l+"</div>"})}))}var d=this,e=this.markerLayer;this.recSel.length>0&&(this.recSel=[]),this.preRender(),e.clearLayers(),this.lblLayer.clearLayers();var f=this.lineLayer;f.clearLayers();var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A=PData.eTNum(),B=0,C=0;u=this.settings.min,"string"==typeof u&&(u=parseInt(u)),v=this.settings.max,"string"==typeof v&&(v=parseInt(v)),w=v-u,B=0,C=-1;a:for(;B<a.l;){if(null==m){do{if(++C==A)break a;h=a.t[C]}while(0===h.n||h.i+h.n===B);if(m=this.vFrame.getSelLocAtts(C),0===m.length){m=null;continue}if(m=m[0],n=d.vFrame.getSelFeatAtts(C),0===n.length){m=null;continue}d.tUsed[C]=!0,k=d.vFrame.getSelLegend(C),l=PData.aByID(k),i=d.settings.lClrs[C],s=d.settings.sAtts[C],s&&(t=PData.aByID(s),"number"==typeof t.r.min&&"number"==typeof t.r.max?(x=t.r.min,y=t.r.max-x):s=null),o=d.settings.lbls[C]}g=a.s[B],j=PData.rByN(g),p=j.a[m],p&&(q=j.a[k],"undefined"!=typeof q&&(q=PData.lClr(q,l,n),q&&(d.rMap[g>>4]|=1<<(15&g),"number"==typeof p[0]?c(p,!0):p.forEach(function(a,b){c(a,0===b),0===b?z=a:f.addLayer(L.polyline([z,a],{color:i}))})))),++B==h.i+h.n&&(m=null)}},VizMap2.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-controls div.iconbar").remove()},VizMap2.prototype.resize=function(){this.lMap.invalidateSize(!1)},VizMap2.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.markerLayer&&this.markerLayer.eachLayer(function(a){a.setStyle({color:"#000",weight:1})}))},VizMap2.prototype.setSel=function(a){var b=this;this.recSel=a,this.markerLayer&&this.markerLayer.eachLayer(function(a){b.isSel(a.options._aid)?a.setStyle({color:"yellow",weight:2}):a.setStyle({color:"#000",weight:1})})},VizMap2.prototype.getState=function(){return{c:this.lMap.getCenter(),z:this.lMap.getZoom(),l:this.vFrame.getLgndSels()}},VizMap2.prototype.setState=function(a){this.lMap.setView(a.c,a.z),this.vFrame.setLgndSels(a.l)},VizMap2.prototype.hint=function(){for(var a="",b=PData.eTNum(),c=0;b>c;c++){var d=this.settings.sAtts[c];if(d){0===a.length?a=dlText.markersize:a+=",";var e=PData.aByID(d),f=PData.eTByN(c),g=PData.tByID(f);a+=" "+e.def.l+" ("+g.l+")"}}return a.length>0?a:null},VizMap2.prototype.doOptions=function(){function a(){e&&(b.baseMap.setOpacity(b.bOp/100),b.lOps.forEach(function(a,c){b.mapLayers[c].eachLayer(function(b){b.setOpacity(a/100)})})),f.empty()}var b=this,c=this.bOp,d=[],e=!0,f=jQuery("#dialog-opacities div.layer-list"),g=jQuery('<div class="op-layer" data-i="-1">Base Map <input type=range class="op-slider" min=0 max=100 value='+this.bOp+" step=5></div>");g.find(".op-slider").on("change",function(){c=jQuery(this).val(),b.baseMap.setOpacity(c/100)}),f.append(g),this.settings.lyrs.forEach(function(a,c){var e=b.lOps[c];g=jQuery('<div class="op-layer" data-i="'+c+'">'+a.gid+' <input type=range class="op-slider" min=0 max=100 value='+e+" step=5></div>"),g.find(".op-slider").on("change",function(){var a=jQuery(this).val();d[c]=a,a/=100,b.mapLayers[c].eachLayer(function(b){b.setOpacity(a)})}),d.push(e),f.append(g)});var h=jQuery("#dialog-opacities").dialog({height:300,width:500,modal:!0,buttons:[{text:dlText.ok,click:function(){e=!1,h.dialog("close"),b.bOp=c,d.forEach(function(a,c){b.lOps[c]=d[c]})}},{text:dlText.cancel,click:function(){h.dialog("close")}}]});h.on("dialogclose",function(b,c){a(),h.off("dialogclose")})};var VizCards=function(a,b){PVizModel.call(this,a,b)};VizCards.prototype=Object.create(PVizModel.prototype),VizCards.prototype.constructor=VizCards,VizCards.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_OPT},VizCards.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds},VizCards.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(b){if("DIV"===b.target.nodeName||"IMG"===b.target.nodeName){var c=jQuery(b.target).closest("div.card");if(1==c.size()){var d=c.data("ai");if(null!=d){var e=a.toggleSel(d);e?c.addClass("obj-sel"):c.removeClass("obj-sel")}}}}),a.sAtts=[];for(var b=0;b<PData.eTNum();b++){var c=jQuery('#dialog-sortby select[data-ti="'+b+'"] :first').val();a.sAtts.push(c)}for(var b=0;b<PData.eTNum();b++)jQuery('#dialog-sortby select[data-ti="'+b+'"]').val(this.sAtts[b])},VizCards.prototype.render=function(a){var b=this;this.stream=a;var c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=PData.eTNum(),w=jQuery(this.frameID);w.empty(),this.recSel.length>0&&(this.recSel=[]),this.preRender();var x,y="w"+this.settings.w+" h"+this.settings.h;for(e=a.t[0],c=0;v>c;){for(;0===e.n;){if(++c===v)return;e=a.t[c]}d=PData.eTByN(c),f=PData.tByID(d),m=b.vFrame.getSelFeatAtts(c),0!==m.length?(w.append('<div class="template-label">'+f.l+'</div><div class="cards" data-ti="'+c+'"></div>'),x=jQuery('div.cards[data-ti="'+c+'"]'),this.tUsed[c]=!0,g=b.vFrame.getSelLegend(c),h=PData.aByID(g),i=b.settings.iAtts[c],q=b.settings.cnt[c],j=b.sAtts[c],k=PData.aByID(j),l=PData.rTOrder(k,a,c),l.forEach(function(a){n=PData.rByN(a.i),r=n.a[g],"undefined"!=typeof r&&(o=PData.lRecs(r,h,m,!1),o&&(b.rMap[a.i>>4]|=1<<(15&a.i),t=b.settings.lOn?'<div class="card-title">'+n.l+"</div>":"",p=!1,s="",q&&q.length>0&&(u=o.b?' style="color:black"':"",q.forEach(function(a){(r=n.a[a])&&(r=PData.procAttTxt(a,r))&&(p=!0,s+=r+"<br/>")})),s=i&&(r=n.a[i])?p?'<div class="card-body"><img src="'+r+'"/><div class="card-cnt"'+u+">"+s+"</div></div>":'<div class="card-body"><img class="full" src="'+r+'"/></div>':'<div class="card-body"><div class="card-cnt"'+u+">"+s+"</div>",x.append('<div class="card '+y+'" style="background-color:'+o.v+'" data-ai="'+a.i+'">'+t+s+"</div>")))}),e=a.t[++c]):e=a.t[++c]}},VizCards.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")},VizCards.prototype.rerender=function(a){var b=this,c=jQuery(this.frameID+' div.cards[data-ti="'+a+'"]');c.empty();var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s="w"+this.settings.w+" h"+this.settings.h;d=b.vFrame.getSelFeatAtts(a),0!=d.length&&(e=b.vFrame.getSelLegend(a),f=PData.aByID(e),g=b.settings.iAtts[a],h=b.settings.cnt[a],i=b.sAtts[a],j=PData.aByID(i),k=PData.rTOrder(j,b.stream,a),k.forEach(function(a){l=PData.rByN(a.i),m=l.a[e],"undefined"!=typeof m&&(n=PData.lRecs(m,f,d,!1),n&&(q=b.settings.lOn?'<div class="card-title">'+l.l+"</div>":"",o=!1,p="",h&&h.length>0&&(r=n.b?' style="color:black"':"",h.forEach(function(a){(m=l.a[a])&&(m=PData.procAttTxt(a,m))&&(o=!0,p+=m+"<br/>")})),p=g&&(m=l.a[g])?o?'<div class="card-body"><img src="'+m+'"/><div class="card-cnt"'+r+">"+p+"</div></div>":'<div class="card-body"><img class="full" src="'+m+'"/></div>':'<div class="card-body"><div class="card-cnt"'+r+">"+p+"</div>",c.append('<div class="card '+s+(b.isSel(a.i)?" obj-sel":"")+'" style="background-color:'+n.v+'" data-ai="'+a.i+'">'+q+p+"</div>")))}))},VizCards.prototype.doOptions=function(){var a=this;this.sAtts.forEach(function(a,b){jQuery('#dialog-sortby select[data-ti="'+b+'"]').val(a)});var b=jQuery("#dialog-sortby").dialog({height:220,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close"),PState.set(PSTATE_BUILD);for(var c=0;c<PData.eTNum();c++){var d=jQuery('#dialog-sortby select[data-ti="'+c+'"]').val();d!=a.sAtts[c]&&(a.sAtts[c]=d,a.rerender(c))}PState.set(PSTATE_READY)}},{text:dlText.cancel,click:function(){b.dialog("close")}}]})},VizCards.prototype.setSel=function(a){var b,c,d=this;this.recSel=a;var e=jQuery(this.frameID).find("div.card");e.each(function(){c=jQuery(this),b=c.data("ai"),null!=b&&(d.isSel(b)?c.addClass("obj-sel"):c.removeClass("obj-sel"))})},VizCards.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],jQuery(this.frameID).find("div.card").removeClass("obj-sel"))},VizCards.prototype.getState=function(){return{l:this.vFrame.getLgndSels(),s:this.sAtts}},VizCards.prototype.setState=function(a){this.vFrame.setLgndSels(a.l),this.sAtts=a.s};var VizPinboard=function(a,b){PVizModel.call(this,a,b)};VizPinboard.prototype=Object.create(PVizModel.prototype),VizPinboard.prototype.constructor=VizPinboard,VizPinboard.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_HSCRL|V_FLAG_VSCRL|V_FLAG_OPT},VizPinboard.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.cAtts[a];return null==b?null:[b]}return[this.settings.cAtts]},VizPinboard.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds},VizPinboard.prototype.setup=function(){var a=this.settings,b=this,c=this.vFrame.getIndex();this.bOp=100,this.lOps=[],this.settings.lyrs.forEach(function(a,c){b.lOps.push(100*a.o)});PData.eTNum();this.xScale=d3.scale.linear().domain([0,a.iw-1]).rangeRound([0,a.dw-1]),this.yScale=d3.scale.linear().domain([0,a.ih-1]).range([0,a.dh-1]),this.xAxis=d3.svg.axis().scale(this.xScale).orient("top"),this.yAxis=d3.svg.axis().scale(this.yScale).orient("left");var d=d3.select(this.frameID).append("svg").attr("width",a.dw+30+3).attr("height",a.dh+30+2);this.chart=d.append("g").attr("transform","translate(30,30)"),this.chart.append("g").attr("class","x axis").call(this.xAxis),this.chart.append("g").attr("class","y axis").call(this.yAxis),this.chart.append("image").attr("id","base-"+c).attr("xlink:href",a.img).attr("x",0).attr("y",0).attr("height",a.dh).attr("width",a.dw),this.settings.lyrs.forEach(function(a,d){b.chart.append("svg").attr("id","ol-"+c+"-"+d).attr("opacity",a.o)}),this.settings.lyrs.forEach(function(a,b){d3.xml(a.url,function(a,d){if(!a){var e=d.getElementsByTagName("svg")[0];d3.select("#ol-"+c+"-"+b).node().appendChild(e)}})}),this.gRecs=this.chart.append("g").attr("id","recs")},VizPinboard.prototype.render=function(a){function b(a,b){var d=c.toggleSel(a.ai);d3.select(this).classed("obj-sel",d)}var c=this;this.gRecs.selectAll(".recobj").remove(),this.gRecs.selectAll(".recline").remove(),this.recSel.length>0&&(this.recSel=[]),this.preRender();var d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x=PData.eTNum(),y=0;for(d=0;x>d;d++)if("disable"!==this.settings.pAtts[d]){w=[];break}r=this.settings.min,"string"==typeof r&&(r=parseInt(r)),s=this.settings.max,"string"==typeof s&&(s=parseInt(s)),t=s-r;var z=[];d=0,y=-1;a:for(;d<a.l;){if(null==k){do{if(++y===x)break a;f=a.t[y]}while(0===f.n||f.i+f.n===d);if(k=this.vFrame.getSelLocAtts(y),0===k.length){k=null;continue}if(k=k[0],l=c.vFrame.getSelFeatAtts(y),0===l.length){k=null;continue}c.tUsed[y]=!0,i=c.vFrame.getSelLegend(y),j=PData.aByID(i),m=c.settings.pAtts[y],g=c.settings.lClrs[y],p=c.settings.sAtts[y],p&&(q=PData.aByID(p),"number"==typeof q.r.min&&"number"==typeof q.r.max?(u=q.r.min,v=q.r.max-u):p=null)}e=a.s[d],h=PData.rByN(e);var A;w&&(A={id:h.id,c:null,p:h.a[m],l:g}),n=h.a[k],"undefined"!=typeof n&&(o=h.a[i],"undefined"!=typeof o&&(o=PData.lClr(o,j,l),o&&(c.rMap[e>>4]|=1<<(15&e),p?(q=h.a[p],q="number"==typeof q?Math.floor((q-u)*t/v)+r:r):q=r,z.push({ai:e,v:o,x:n[0],y:n[1],r:q}),A&&(A.c=n)))),A&&A.c&&w.push(A),++d==f.i+f.n&&(k=null)}if(this.gRecs.selectAll(".recobj").data(z).enter().append("circle").attr("class","recobj").attr("cx",function(a){return c.xScale(a.x)}).attr("cy",function(a){return c.yScale(a.y)}).attr("r",function(a){return c.yScale(a.r)}).style("fill",function(a){return a.v}).on("click",b),w){w.sort(function(a,b){return PData.strcmp(b.id,a.id)});var B=[];w.forEach(function(a){a.p&&a.p.forEach(function(b){if(d=_.sortedIndex(w,{id:b},"id"),d<w.length){var c=w[d];c.id===b&&B.push({f:a.c,t:c.c,c:a.l})}})}),this.gRecs.selectAll(".recline").data(B).enter().append("line").attr("class","recline").attr("x1",function(a){return c.xScale(a.f[0])}).attr("y1",function(a){return c.yScale(a.f[1])}).attr("x2",function(a){return c.xScale(a.t[0])}).attr("y2",function(a){return c.yScale(a.t[1])}).attr("stroke",function(a){return a.c})}},VizPinboard.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.gRecs.selectAll(".recobj").classed("obj-sel",!1))},VizPinboard.prototype.setSel=function(a){var b=this;this.recSel=a,this.gRecs.selectAll(".recobj").classed("obj-sel",function(a){return b.isSel(a.ai)})},VizPinboard.prototype.doOptions=function(){function a(){f&&(d3.select("#base-"+c).attr("opacity",b.bOp/100),b.lOps.forEach(function(a,b){d3.select("#ol-"+c+"-"+b).attr("opacity",a/100)})),g.empty()}var b=this,c=this.vFrame.getIndex(),d=this.bOp,e=[],f=!0,g=jQuery("#dialog-opacities div.layer-list"),h=jQuery('<div class="op-layer" data-i="-1">Base Image <input type=range class="op-slider" min=0 max=100 value='+this.bOp+" step=5></div>");h.find(".op-slider").on("change",function(){d=jQuery(this).val(),d3.select("#base-"+c).attr("opacity",d/100)}),g.append(h),this.lOps.forEach(function(a,b){h=jQuery('<div class="op-layer" data-i="'+b+'">Overlay '+(b+1)+' <input type=range class="op-slider" min=0 max=100 value='+a+" step=5></div>"),h.find(".op-slider").on("change",function(){e[b]=jQuery(this).val(),d3.select("#ol-"+c+"-"+b).attr("opacity",e[b]/100)}),e.push(a),g.append(h)});var i=jQuery("#dialog-opacities").dialog({height:300,width:320,modal:!0,buttons:[{text:dlText.ok,click:function(){f=!1,i.dialog("close"),b.bOp=d,e.forEach(function(a,c){b.lOps[c]=a})}},{text:dlText.cancel,click:function(){i.dialog("close")}}]});i.on("dialogclose",function(b,c){a(),i.off("dialogclose")})},VizPinboard.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}},VizPinboard.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)},VizPinboard.prototype.hint=function(){for(var a="",b=PData.eTNum(),c=0;b>c;c++){var d=this.settings.sAtts[c];if(d){0===a.length?a=dlText.markersize:a+=",";var e=PData.aByID(d),f=PData.eTByN(c),g=PData.tByID(f);a+=" "+e.def.l+" ("+g.l+")"}}return a.length>0?a:null};var VizTime=function(a,b){PVizModel.call(this,a,b)};VizTime.prototype=Object.create(PVizModel.prototype),VizTime.prototype.constructor=VizTime,VizTime.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_VSCRL},VizTime.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds},VizTime.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.dAtts[a];return null==b?null:[b]}return[this.settings.dAtts]},VizTime.prototype.getWidths=function(){var a={top:2,right:2,bottom:2,left:2},b=[],c=jQuery(this.frameID).width();b.push(c);var d=c-(a.left+a.right);return b.push(d),this.threshold=d/(6.25*this.settings.xLbl),b},VizTime.prototype.setup=function(){function a(){var a,b,c,d,e,h;g.dAtts.forEach(function(f){if(null!=f&&"disable"!==f){var g=PData.aByID(f);g&&(null==a||g.r.min.y<a?(a=g.r.min.y,"undefined"!=typeof g.r.min.m?(b=g.r.min.m,c="undefined"!=typeof g.r.min.d?g.r.min.d:1):(b=1,c=1)):g.r.min.y===a&&"undefined"!=typeof g.r.min.m&&(g.r.min.m<b?(b=g.r.min.m,c="undefined"!=typeof g.r.min.d?g.r.min.d:1):g.r.min.m===b&&"undefined"!=typeof g.r.min.d&&g.r.min.d<c&&(c=g.r.min.d)),null==d?"undefined"==typeof g.r.max.y?(d=TODAY.getUTCFullYear(),e=TODAY.getMonth()+1,h=TODAY.getDate()):(d=g.r.max.y,"undefined"!=typeof g.r.max.m?(e=g.r.max.m,h="undefined"!=typeof g.r.max.d?g.r.max.d:PData.lenMnth(d,e)):(e=12,h=31)):g.r.max.y>d?(d=g.r.max.y,"undefined"!=typeof g.r.max.m?(e=g.r.max.m,h="undefined"!=typeof g.r.max.d?g.r.max.d:PData.lenMnth(d,e)):(e=12,h=31)):g.r.max.y===d&&"undefined"!=typeof g.r.max.m&&(g.r.max.m>e?(e=g.r.max.m,h="undefined"!=typeof g.r.max.d?g.r.max.d:PData.lenMnth(d,e)):g.r.max.m===e&&"undefined"!=typeof g.r.max.d&&g.r.max.d>h&&(h=g.r.max.d)))}}),g.from.length>0?f.minDate=PData.dStr(g.from,!1):f.minDate=PData.d3Nums(a,b,c,!1),g.to.length>0?f.maxDate=PData.dStr(g.to,!0):f.maxDate=PData.d3Nums(d,e,h,!0),f.instGap=.015*(f.maxDate-f.minDate)}function b(){var a=[];g.lgnds.forEach(function(b){b.forEach(function(b){a.push(b)})}),a=_.uniq(a);var b=[];a.forEach(function(a){var c=PData.aByID(a);c&&c.l.forEach(function(a){b.push(a.v)})}),b=_.uniq(b),b.sort();var c,d,e=i.append("defs");b.forEach(function(a){d=a.substr(1),c=e.append("linearGradient").attr("id",d+"-fs"),c.append("stop").attr("offset","0%").attr("stop-color","#C0C0C0"),c.append("stop").attr("offset","5%").attr("stop-color",a),c.append("stop").attr("offset","100%").attr("stop-color",a),c=e.append("linearGradient").attr("id",d+"-fe"),c.append("stop").attr("offset","0%").attr("stop-color",a),c.append("stop").attr("offset","95%").attr("stop-color",a),c.append("stop").attr("offset","100%").attr("stop-color","#C0C0C0"),c=e.append("linearGradient").attr("id",d+"-fb"),c.append("stop").attr("offset","0%").attr("stop-color","#C0C0C0"),c.append("stop").attr("offset","5%").attr("stop-color",a),c.append("stop").attr("offset","95%").attr("stop-color",a),c.append("stop").attr("offset","100%").attr("stop-color","#C0C0C0")})}function c(a){var b={id:a,l:0,t:0,h:0,w:h[1],svgID:"#tl-b-"+j+"-"+a,tHt:0,iHt:0,xScale:d3.time.scale(),yScale:function(a){return a*b.tHt},parts:[],g:null,labels:null,labelSVGs:null,redraw:function(){}};if(a?(b.tHt=f.settings.bHt,b.iHt=b.tHt-2):(b.tHt=3,b.iHt=2),1==a){var c=f.minDate,d=f.maxDate;f.settings.zFrom.length>0&&(c=PData.dStr(f.settings.zFrom,!1)),f.settings.zTo.length>0&&(d=PData.dStr(f.settings.zTo,!0)),b.xScale.domain([c,d]),f.zMinDate=c,f.zMaxDate=d}else b.xScale.domain([f.minDate,f.maxDate]);b.xScale.range([0,b.w]),b.g=f.chart.append("g").attr("id",b.svgID.substring(1)).attr("class","tl-band").attr("width",b.w),f.bands[a]=b,f.cmpnts.push(b)}function d(a){var b=f.bands[a],c=d3.svg.axis().scale(b.xScale).orient("bottom").tickSize(6,0);localD3&&c.tickFormat(localD3);var d=b.g.append("g").attr("id","axis-"+j+"-"+a).attr("class","axis").style("font-size","10px"),e={};e.redraw=function(){d.call(c)},b.parts.push(e),f.cmpnts.push(e)}function e(a){var b,c=f.bands[a];b=1===a?32:16;var d={name:"s-"+j+"-"+a,x:function(){return 0},left:function(){return 0},anchor:"start",tDelta:2,whichDate:function(a,b){return a}},e={name:"e-"+j+"-"+a,x:function(){return c.l+c.w},left:function(){return c.l+c.w-f.settings.xLbl},anchor:"end",tDelta:-3,whichDate:function(a,b){return b}};c.labels=[d,e];var g=d3.select(c.svgID).selectAll(".bLblCntr").data(c.labels).enter().append("g").attr("class","bLblCntr");g.append("rect").attr("class","bLbl").attr("id",function(a){return"rect-"+a.name}).attr("x",function(a){return a.left()}).attr("width",f.settings.xLbl).attr("height",b);var h=g.append("text").attr("class","bMinMaxLbl").attr("id",function(a){return"txt-"+a.name}).attr("x",function(a){return a.x()+a.tDelta}).attr("y",12).attr("text-anchor",function(a){return a.anchor}),i={};if(i.redraw=function(){var a=c.xScale.domain(),b=a[0],d=a[1];h.text(function(a){return a.whichDate(b,d).getUTCFullYear()})},c.parts.push(i),f.cmpnts.push(i),1===a){var k=g.append("text").attr("class","bMinMaxLbl").attr("id",function(a){return"m-txt-"+a.name}).attr("x",function(a){return a.x()+a.tDelta}).attr("y",b-4).attr("text-anchor",function(a){return a.anchor}),l={};l.redraw=function(){var a=c.xScale.domain(),b=a[0],d=a[1];k.text(function(a){var c=d.getUTCFullYear()-b.getUTCFullYear();return c>f.threshold?"":months[a.whichDate(b,d).getMonth()]})},c.parts.push(l),f.cmpnts.push(l)}c.labelSVGs=g}var f=this;"number"!=typeof this.settings.xLbl&&(this.settings.xLbl=parseInt(this.settings.xLbl)),this.brush=null,this.brushSVG=null;var g=this.settings;"string"==typeof g.bHt&&(g.bHt=parseInt(g.bHt,10)),a();var h=f.getWidths(),i=d3.select(this.frameID).append("svg").attr("class","tl-vf").attr("width",h[1]);b();var j=this.vFrame.getIndex();i.append("clipPath").attr("id","tl-clip-"+j).append("rect").attr("width",h[1]),f.chart=i.append("g").attr("class","chart").attr("clip-path","url(#tl-clip-"+j+")"),f.instRad=g.bHt/2-1,f.bands=Array(2),f.cmpnts=[],c(0),c(1),d(0),d(1),e(0),e(1)},VizTime.prototype.render=function(a){function b(a,b){var c=a.s-b.s;return 0>c?1:c>0?-1:(c=b.e-a.e,0>c?1:c>0?-1:0)}function c(a){function b(a){return a.f&EVENT_INSTANT?"event instant":"event range"}function c(a){var b=f.toggleSel(a.ai);d3.select(this).classed("obj-sel",b)}var d,e,g,i,j=f.bands[a];if(a){var k=f.bands[0];j.t=k.t+k.h+37,d=e=g=f.instRad,i=2*f.instRad+3}else j.t=0,d=e=g=1;j.h=h*j.tHt+2,j.g.attr("transform","translate(0,"+j.t+")").attr("height",j.h);
var l,m;a&&(l=.75*j.iHt+"px",m=.8*j.iHt);var n;n=d3.select(j.svgID).selectAll(".lgBd").remove(),n=d3.select(j.svgID).selectAll(".lgBd").data(f.lgBds).enter().append("svg").attr("class","lgBd").attr("y",function(a){return j.yScale(a.t)}).attr("height",function(a){return j.yScale(a.h)}),n.append("rect").attr("width","100%").attr("height","100%").attr("fill",function(a){return a.d.v}),1===a&&n.append("text").attr("class","lgBdLbl").attr("x",2).attr("y",m).attr("fill",function(a){return a.d.b?"#000000":"#FFFFFF"}).style("font-size",l).text(function(a){return a.d.l});var o;d3.select(j.svgID).selectAll(".event").remove(),o=d3.select(j.svgID).selectAll(".event").data(f.events).enter().append("svg").attr("class",b).attr("y",function(a){return j.yScale(a.t)}).attr("height",j.iHt),1===a&&o.on("click",c);var p=d3.select(j.svgID).selectAll(".range");p.append("rect").attr("width","100%").attr("height","100%").attr("fill",function(b){return 1===a&&b.f&(EVENT_F_START|EVENT_F_END)?(b.f&(EVENT_F_START|EVENT_F_END))===(EVENT_F_START|EVENT_F_END)?"url("+b.c.v+"-fb)":(b.f&EVENT_F_START)===EVENT_F_START?"url("+b.c.v+"-fs)":"url("+b.c.v+"-fe)":b.c.v}),1===a&&p.append("text").attr("class","rangeLbl").attr("x",4).attr("y",m).attr("fill",function(a){return a.c.b?"#000000":"#FFFFFF"}).style("font-size",l).text(function(a){return a.l});var q=d3.select(j.svgID).selectAll(".instant");q.append("circle").attr("cx",d).attr("cy",e).attr("r",g).attr("fill",function(a){return a.c.v}),1===a&&q.append("text").attr("class","instantLbl").attr("x",i).attr("y",m).style("font-size",l).text(function(a){return a.l}),j.redraw=function(){n.attr("x",function(a){return j.xScale(a.s)}).attr("width",function(a){return j.xScale(a.e)-j.xScale(a.s)}),o.attr("x",function(a){return j.xScale(a.s)}).attr("width",function(a){return j.xScale(a.e)-j.xScale(a.s)}),j.parts.forEach(function(a){a.redraw()})}}function d(a){var b=f.bands[a];d3.select(b.svgID).selectAll(".axis").attr("transform","translate(0,"+b.h+")")}function e(a){var b=f.bands[a];d3.select(b.svgID).selectAll(".bLblCntr").attr("transform","translate(0,"+(b.h+1).toString()+")")}var f=this,g=this.vFrame.getIndex();this.recSel.length>0&&(this.recSel=[]),this.preRender(),this.events=[],this.lgBds=[];var h=0;!function(){for(var c,d,e,g,i,j,k,l,m,n=PData.eTNum(),o=0;n>o;){for(c=a.t[o];0===c.n;){if(++o==n)return;c=a.t[o]}if(e=f.vFrame.getSelLocAtts(o),0!==e.length)if(e=f.vFrame.getSelFeatAtts(o),0!==e.length){f.tUsed[o]=!0,m=f.vFrame.getSelLegend(o),l=PData.aByID(m),g=f.settings.dAtts[o];for(var p,q,r,s,t,u,v,w,x=[],y=c.i;y<c.i+c.n;y++)d=a.s[y],w=PData.rByN(d),j=w.a[m],"undefined"!=typeof j&&(j=PData.lRecs(j,l,e,!1))&&(k=w.a[g])&&"?"!==k&&(f.rMap[d>>4]|=1<<(15&d),u=k.min.f?EVENT_F_START:0,p=k.min.y,"undefined"==typeof k.min.m?(q=1,r=1):(q=k.min.m,r="undefined"==typeof k.min.d?1:k.min.d),s=PData.d3Nums(p,q,r,!1),"undefined"==typeof k.max?(u|=EVENT_INSTANT,t=s.getTime()+f.instGap):"open"===k.max?t=TODAY:(k.max.f&&(u|=EVENT_F_END),p=k.max.y,"undefined"==typeof k.max.m?(q=12,r=31):(q=k.max.m,r="undefined"==typeof k.max.d?PData.lenMnth(p,q):k.max.d),t=PData.d3Nums(p,q,r,!0)),x.push({s:s,e:t,ai:d,f:u,c:j,l:w.l,t:0}));x.sort(b);var z,A=[];x.forEach(function(a){for(z=0;z<A.length&&!(a.e<A[z]);z++);a.t=z+h+1,A[z]=a.s}),i=PData.aByID(g),i.l.forEach(function(a){v=a.d,p=v.min.y,"undefined"==typeof v.min.m?(q=1,r=1):(q=v.min.m,r="undefined"==typeof v.min.d?1:v.min.d),s=PData.d3Nums(p,q,r,!1),"undefined"==typeof v.max.y?t=TODAY:(p=v.max.y,"undefined"==typeof v.max.m?(q=12,r=31):(q=v.max.m,r="undefined"==typeof v.max.d?PData.lenMnth(p,q):v.max.d),t=PData.d3Nums(p,q,r,!0)),f.lgBds.push({s:s,e:t,t:h,h:A.length+1,d:a})}),h+=A.length+1,f.events=f.events.concat(x),o++}else o++;else o++}}();f.getWidths();c(0),c(1),function(){var a=f.bands[0];null!=f.brushSVG&&f.brushSVG.remove(),f.brush=d3.svg.brush().x(a.xScale.range([0,a.w])).extent([f.zMinDate,f.zMaxDate]).on("brush",function(){var a,b=f.brush.extent();if("move"===d3.event.mode){var c=d3.time.day.round(b[0]),d=d3.time.day.offset(c,Math.round((b[1]-b[0])/864e5));a=[c,d]}else a=b.map(d3.time.day.round),a[0]>=a[1]&&(a[0]=d3.time.day.floor(b[0]),a[1]=d3.time.day.ceil(d3.time.day.offset(a[0],Math.round(f.instGap/864e5))));f.zMinDate=a[0],f.zMaxDate=a[1],d3.select(this).call(f.brush.extent(a)),zoom=f.bands[1],zoom.xScale.domain(a),zoom.redraw()}),f.brushSVG=a.g.append("g"),f.brushSVG.attr("class","brush").call(f.brush),f.brushSVG.selectAll("rect").attr("y",-1).attr("height",a.h),f.brushSVG.selectAll(".resize").append("path").attr("d",function(b){var c=+("e"==b),d=c?1:-1,e=a.h/4;return"M"+.5*d+","+e+"A6,6 0 0 "+c+" "+6.5*d+","+(e+6)+"V"+(2*e-6)+"A6,6 0 0 "+c+" "+.5*d+","+2*e+"ZM"+2.5*d+","+(e+8)+"V"+(2*e-8)+"M"+4.5*d+","+(e+8)+"V"+(2*e-8)})}(),function(){var a=f.bands[1],b=a.t+a.h+45;d3.select(f.frameID+" svg.tl-vf").attr("height",b),d3.select("#tl-clip-"+g+" rect").attr("height",b)}(),d(0),d(1),e(0),e(1),f.cmpnts.forEach(function(a){a.redraw()})},VizTime.prototype.resize=function(){var a=this,c=a.getWidths(),d=d3.select(a.frameID+" svg.tl-vf");d.attr("width",c[1]),d.select("#tl-clip-"+a.vFrame.getIndex()+" rect").attr("width",c[1]);for(var e=0;2>e;e++){b=a.bands[e],b.w=c[1],d.select(b.svgID).attr("width",c[1]),b.xScale.range([0,c[1]]);var f=b.labels[1],g=f.x()+f.tDelta;if(b.labelSVGs.select("#rect-"+f.name).attr("x",f.left()),b.labelSVGs.select("#txt-"+f.name).attr("x",g),0===e){if(a.brush){if(a.brushSVG){var h=a.brush.extent();a.brushSVG.call(a.brush.extent(h))}a.brushHandler&&a.brushHandler.redraw()}b.labelSVGs.select("#m-txt-"+f.name).attr("x",g)}}a.cmpnts.forEach(function(a){a.redraw()})},VizTime.prototype.setSel=function(a){function b(a){return c.isSel(a.ai)?a.f&EVENT_INSTANT?"event instant obj-sel":"event range obj-sel":a.f&EVENT_INSTANT?"event instant":"event range"}var c=this;c.recSel=a,d3.select(this.bands[1].svgID).selectAll(".event").attr("class",b)},VizTime.prototype.clearSel=function(){function a(a){return a.f&EVENT_INSTANT?"event instant":"event range"}this.recSel.length>0&&(this.recSel=[],d3.select(this.bands[1].svgID).selectAll(".event").attr("class",a))},VizTime.prototype.getState=function(){var a=this.brush.extent(),b=a[0],c=a[1],d=b.getUTCMonth()+1,e=b.getUTCFullYear().toString()+"-"+d.toString()+"-"+b.getDate().toString();d=c.getUTCMonth()+1;var f=c.getUTCFullYear().toString()+"-"+d.toString()+"-"+c.getDate().toString();return{d0:e,d1:f,l:this.vFrame.getLgndSels()}},VizTime.prototype.setState=function(a){var b=PData.dStr(a.d0,!1),c=PData.dStr(a.d1,!0),d=this.bands[1];d.xScale.domain([b,c]),this.zMinDate=b,this.zMaxDate=c,this.vFrame.setLgndSels(a.l)};var VizDirectory=function(a,b){PVizModel.call(this,a,b)};VizDirectory.prototype=Object.create(PVizModel.prototype),VizDirectory.prototype.constructor=VizDirectory,VizDirectory.prototype.flags=function(){return V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_OPT},VizDirectory.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(b){if("TD"===b.target.nodeName){var c=jQuery(b.target).closest("tr"),d=c.data("ai");if(null!=d){var e=a.toggleSel(d);e?c.addClass("obj-sel"):c.removeClass("obj-sel")}}else if("TH"===b.target.nodeName){var f=jQuery(b.target),g=f.data("aid"),h=f.closest("table").data("ti"),i=PData.aByID(g);switch(i.def.t){case"T":case"V":case"N":case"D":f.closest("tr").find("th").removeClass("sel"),f.addClass("sel"),a.sAtts[h]=g,a.rerender(h)}}}),a.sAtts=[];for(var b=0;b<PData.eTNum();b++){var c=jQuery('#dialog-sortby select[data-ti="'+b+'"] :first').val();a.sAtts.push(c)}},VizDirectory.prototype.render=function(a){var b,c,d,e,f,g,h,i,j,k,l,m=this,n=PData.eTNum(),o=0,p=jQuery(this.frameID);for(p.empty(),this.recSel.length>0&&(this.recSel=[]),this.preRender(),this.stream=a,c=a.t[0];n>o;){for(;0===c.n;){if(++o===n)return;c=a.t[o]}m.tUsed[o]=!0,b=PData.eTByN(o),d=PData.tByID(b),p.append('<div class="template-label">'+d.l+'</div><table cellspacing="0" class="viz-directory" data-ti='+o+"></table>"),e=p.find('table[data-ti="'+o+'"]'),f=m.settings.cnt[o],j=m.sAtts[o],i="<thead><tr>",f.forEach(function(a){var b=PData.aByID(a);i+='<th data-aid="'+a,a===j&&(i+='" class="sel'),i+='">'+b.def.l+"</th>"}),e.append(i+"</tr></thead><tbody></tbody>"),e=e.find("tbody"),k=PData.aByID(j),l=PData.rTOrder(k,m.stream,o),l.forEach(function(a){h=PData.rByN(a.i),m.rMap[a.i>>4]|=1<<(15&a.i),i='<tr data-id="'+h.id+'" data-ai='+a.i+">",f.forEach(function(a){g=h.a[a],"undefined"!=typeof g?(g=PData.procAttTxt(a,g),i+=g?"<td>"+g+"</td>":"<td></td>"):i+="<td></td>"}),e.append(i+"</tr>")}),c=a.t[++o]}},VizDirectory.prototype.rerender=function(a){var b,c,d,e,f,g,h,i=this,j=jQuery(this.frameID+' table.viz-directory[data-ti="'+a+'"] tbody');j.empty(),tRec=this.stream.t[a],b=i.settings.cnt[a],c=i.sAtts[a],d=PData.aByID(c),e=PData.rTOrder(d,i.stream,a),e.forEach(function(a){g=PData.rByN(a.i),h="<tr "+(i.isSel(a.i)?'class="obj-sel" ':"")+'data-id="'+g.id+'" data-ai='+a.i+">",b.forEach(function(a){f=g.a[a],"undefined"!=typeof f?(f=PData.procAttTxt(a,f),h+=f?"<td>"+f+"</td>":"<td></td>"):h+="<td></td>"}),j.append(h+"</tr>")})},VizDirectory.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")},VizDirectory.prototype.doOptions=function(){for(var a=this,b=0;b<PData.eTNum();b++)jQuery('#dialog-sortby select[data-ti="'+b+'"]').val(a.sAtts[b]);var c=jQuery("#dialog-sortby").dialog({height:220,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close"),PState.set(PSTATE_BUILD);for(var b=0;b<PData.eTNum();b++){var d=jQuery('#dialog-sortby select[data-ti="'+b+'"]').val();if(d!==a.sAtts[b]){a.sAtts[b]=d;var e=jQuery(a.frameID+' table[data-ti="'+b+'"] thead tr');e.find("th").removeClass("sel"),e.find('th[data-aid="'+d+'"]').addClass("sel"),a.rerender(b)}}PState.set(PSTATE_READY)}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})},VizDirectory.prototype.setSel=function(a){var b,c,d=this;this.recSel=a;var e=jQuery(this.frameID).find("tr");e.each(function(){c=jQuery(this),b=c.data("ai"),null!=b&&(d.isSel(b)?c.addClass("obj-sel"):c.removeClass("obj-sel"))})},VizDirectory.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],jQuery(this.frameID).find("tr").removeClass("obj-sel"))},VizDirectory.prototype.getState=function(){return{s:this.sAtts}},VizDirectory.prototype.setState=function(a){this.sAtts=a.s};var VizTextStream=function(a,b){PVizModel.call(this,a,b)};VizTextStream.prototype=Object.create(PVizModel.prototype),VizTextStream.prototype.constructor=VizTextStream,VizTextStream.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_VSCRL},VizTextStream.prototype.getLocAtts=function(a){if(null!=a){var b=this.settings.order[a];return null==b?null:[b]}return _.map(this.settings.order,function(a){return[a]})},VizTextStream.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds},VizTextStream.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(b){if("DIV"===b.target.nodeName){var c=jQuery(b.target),d=c.data("ai");if("undefined"!=typeof d&&d>=0){var e=a.toggleSel(d);e?c.addClass("obj-sel"):c.removeClass("obj-sel")}}})},VizTextStream.prototype.render=function(a){var b,c,d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v=this,w=PData.eTNum(),x=0,y=jQuery(this.frameID);for(y.empty(),this.recSel.length>0&&(this.recSel=[]),this.preRender(),t=this.settings.max-this.settings.min,c=a.t[0];w>x;){for(;0===c.n;){if(++x===w)return;c=a.t[x]}m=v.vFrame.getSelLocAtts(x),0!==m.length?(m=v.vFrame.getSelFeatAtts(x),0!==m.length?(v.tUsed[x]=!0,n=v.vFrame.getSelLegend(x),o=PData.aByID(n),y.append('<div class="viz-textstream" data-ti='+x+"></div>"),e=y.find("div.viz-textstream[data-ti="+x+"]"),b=PData.eTByN(x),d=PData.tByID(b),e.append('<div class="template-label">'+d.l+"</div>"),l=v.settings.cnt[x],r=v.settings.sAtts[x],r&&(q=PData.aByID(r),"number"==typeof q.r.min&&"number"==typeof q.r.max?s=q.r.max-q.r.min:r=null),l&&(k=PData.aByID(v.settings.order[x]),j=PData.rTOrder(k,a,x),j.forEach(function(a){f=PData.rByN(a.i),g=f.a[n],"undefined"!=typeof g&&(p=PData.lRecs(g,o,m,!1),p&&(h=f.a[l],h&&(h=PData.procAttTxt(l,h)),h&&(v.rMap[a.i>>4]|=1<<(15&a.i),r?(i=f.a[r],i="number"==typeof i?Math.floor((i-q.r.min)*t/s)+v.settings.min:v.settings.min):i=v.settings.min,u=p.b?";background-color:black":"",e.append('<div class="recitem" data-ai='+a.i+' style="color:'+p.v+u+";font-size:"+i+'px">'+h+"</div>"))))})),x++):x++):x++}},VizTextStream.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")},VizTextStream.prototype.setSel=function(a){var b,c,d=this;this.vFrame.getIndex();this.recSel=a;var e=jQuery(this.frameID).find("div.recitem");e.each(function(){c=jQuery(this),b=c.data("ai"),null!=b&&(d.isSel(b)?c.addClass("obj-sel"):c.removeClass("obj-sel"))})},VizTextStream.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],jQuery(this.frameID).find("div.recitem").removeClass("obj-sel"))},VizTextStream.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}},VizTextStream.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)},VizTextStream.prototype.hint=function(){for(var a,b,c,d,e="",f=PData.eTNum(),g=0;f>g;g++)a=this.settings.order[g],a&&(b=PData.aByID(a),c=PData.eTByN(g),d=PData.tByID(c),e.length>0&&(e+="; "),e+=d.l+": "+dlText.orderedby+" "+b.def.l,a=this.settings.sAtts[g],a&&(b=PData.aByID(a),e+=", "+dlText.textsize+" "+b.def.l));return e};var VizNetWheel=function(a,b){PVizModel.call(this,a,b),this.bSel=[]};VizNetWheel.prototype=Object.create(PVizModel.prototype),VizNetWheel.prototype.constructor=VizNetWheel,VizNetWheel.prototype.flags=function(){return V_FLAG_OPT|V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_HSCRL},VizNetWheel.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds},VizNetWheel.prototype.setup=function(){function a(){b.spin>360?b.spin-=360:b.spin<0&&(b.spin+=360),b.center.attr("transform","translate("+b.cr+","+b.cr+")rotate("+b.spin+")")}var b=this;this.spin=0,this.prune=!0;var c=this.vFrame.getIndex(),d=_.template(document.getElementById("dltext-v-nwheel").innerHTML);jQuery("#view-frame-"+c+" div.view-controls").append(d({vi:c})),jQuery("#nw-prev-"+c).button({text:!1,icons:{primary:" ui-icon-arrowreturnthick-1-s"}}).click(function(){jQuery("#nw-size-"+c+" :radio:checked").attr("id")=="nw-size-1-"+c?b.spin+=b.inc:b.spin+=90,a()}),jQuery("#nw-for-"+c).button({text:!1,icons:{primary:" ui-icon-arrowreturnthick-1-n"}}).click(function(){jQuery("#nw-size-"+c+" :radio:checked").attr("id")=="nw-size-1-"+c?b.spin-=b.inc:b.spin-=90,a()}),jQuery("#nw-size-"+c).buttonset(),this.svg=d3.select(this.frameID).append("svg"),this.center=this.svg.append("g")},VizNetWheel.prototype.render=function(a){function b(a){var b=g.toggleSel(a.ai);d3.select(this).classed("obj-sel",b)}function c(a){var b=this;PState.set(PSTATE_UPDATE),f.each(function(a){a.linked=!1}),d.each(function(b){if(b.s===a){b.t.linked=!0;for(var c=0;c<h.length;c++){var d=h[c];if(d.source===a&&d.target===b.t){d3.select(this).attr("stroke",d.c).classed("thick",!0),this.parentElement.appendChild(this);break}}}else if(b.t===a){b.s.linked=!0;for(var c=0;c<h.length;c++){var d=h[c];if(d.target===a&&d.source===b.s){d3.select(this).attr("stroke",d.c).classed("thick",!0),this.parentElement.appendChild(this);break}}}else d3.select(this).attr("stroke","black").classed("thick",!1)}),f.select("text").attr("fill",function(a){return a.linked?"white":"black"}),d3.select(b).attr("fill","yellow"),PState.set(PSTATE_READY)}var d,e,f,g=this,h=[];if(a?this.stream=a:a=this.stream,this.svg.selectAll(".node").remove(),this.svg.selectAll(".link").remove(),this.recSel.length>0&&(this.recSel=[],this.vFrame.selBtns(!1)),this.preRender(),0===a.l)return void this.svg.attr("width","10").attr("height","10");var i={children:[]};!function(){var b,c,d,e,f,h,j=0,k=0,l=[],m=null;b=a.t[0],h=g.vFrame.getSelLegend(0),f=PData.aByID(h),m=g.vFrame.getSelFeatAtts(0),m.length>0&&b.n>0&&(g.tUsed[0]=!0);a:for(;k<a.l;){for(;0===b.n||b.i+b.n===k||0===m.length;){if(l.length>0&&(i.children.push({ti:j,children:l}),l=[]),++j===PData.eTNum())break a;l=[],b=a.t[j],h=g.vFrame.getSelLegend(j),f=PData.aByID(h),m=g.vFrame.getSelFeatAtts(j),m.length>0&&b.n>0&&(g.tUsed[j]=!0)}e=a.s[k],c=PData.rByN(e),d=c.a[h],"undefined"!=typeof d&&(fData=PData.lRecs(d,f,m,!1),fData&&(g.rMap[e>>4]|=1<<(15&e),l.push({r:c,ai:e,c:fData.v,l:!1,children:[]}))),k++}l.length>0&&i.children.push({ti:j,children:l})}(),i.children.forEach(function(a){var b,c=g.settings.pAtts[a.ti];a.children.forEach(function(a){c.forEach(function(c){b=a.r.a[c.pid],"undefined"!=typeof b&&b.forEach(function(b){var d,e=!1;a:for(var f=0;f<i.children.length;f++)for(var g=i.children[f],j=0;j<g.children.length;j++)if(d=g.children[j],d.r.id==b){e=!0;break a}e&&(a.l=!0,d.l=!0,h.push({source:a,target:d,c:c.clr}))})})})}),this.prune&&i.children.forEach(function(a){for(var b=a.children.length-1;b>=0;b--){var c=a.children[b];c.l||(g.rMap[c.ai>>4]&=1<<(15&c.ai)^65535,a.children.splice(b,1))}});var j=0;if(i.children.forEach(function(a){j+=a.children.length}),this.inc=360/(j+i.children.length),0===j)return void this.svg.attr("width","10").attr("height","10");var k=Math.max((14*j+20)/(2*Math.PI),30),l=this.settings.lw;"string"==typeof l&&(l=parseInt(l)),this.cr=l+12+k;var m=2*this.cr;this.svg.attr("width",m).attr("height",m),this.center.attr("transform","translate("+this.cr+","+this.cr+")");var n=d3.layout.cluster().size([360,k]).sort(null);e=n.nodes(i),f=this.center.append("g").selectAll(".node").data(e.filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("transform",function(a){return"rotate("+(a.x-90)+")translate("+(a.y+8)+",0)"}),f.append("circle").attr("r","5").style("fill",function(a){return a.c}).on("click",b),f.append("text").attr("dy",".31em").attr("dx",function(a){return a.x<180?"10":"-10"}).attr("transform",function(a){return a.x<180?"":"rotate(180)"}).style("text-anchor",function(a){return a.x<180?"start":"end"}).attr("fill","black").text(function(a){return a.r.l}).on("click",c);var o=d3.layout.bundle(),p=d3.svg.line.radial().interpolate("bundle").tension(.85).radius(function(a){return a.y}).angle(function(a){return a.x/180*Math.PI});d=this.center.append("g").selectAll(".link").data(o(h)).enter().append("path").each(function(a){a.s=a[0],a.t=a[a.length-1]}).attr("class","link").attr("d",p).attr("stroke","black")},VizNetWheel.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-controls div.iconbar").remove()},VizNetWheel.prototype.setSel=function(a){var b=this;b.recSel=a,this.svg.selectAll(".node circle").attr("class",function(a){return b.isSel(a.ai)?"obj-sel":""})},VizNetWheel.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.svg.selectAll(".node circle").attr("class",""))},VizNetWheel.prototype.doOptions=function(){var a=this;jQuery("#prune-nodes").prop("checked",this.prune);var b=jQuery("#dialog-prune").dialog({height:150,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close"),PState.set(PSTATE_BUILD);var c=jQuery("#prune-nodes").prop("checked");a.prune!==c&&(a.prune=c,a.render(null)),PState.set(PSTATE_READY)}},{text:dlText.cancel,click:function(){b.dialog("close")}}]})},VizNetWheel.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}},VizNetWheel.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)},PFilterModel.prototype.isDirty=function(a){return null!=a&&(!this.dirty&&a&&this.id>0&&jQuery("body").trigger("prospect",{s:PSTATE_FDIRTY}),this.dirty=a),this.dirty},PFilterModel.prototype.title=function(){return this.att.def.l},PFilterModel.prototype.evalPrep=function(){},PFilterModel.prototype.evalDone=function(){},PFilterModel.prototype.insertPt=function(){return jQuery('div.filter-instance[data-id="'+this.id+'"] div.filter-body')},PFilterModel.prototype.teardown=function(){},PFilterModel.prototype.getState=function(){return{}},PFilterModel.prototype.setState=function(a){};var PFilterRemove=function(a){PFilterModel.call(this,a,null)};PFilterRemove.prototype=Object.create(PFilterModel.prototype),PFilterRemove.prototype.constructor=PFilterRemove,PFilterRemove.prototype.title=function(){return dlText.rha},PFilterRemove.prototype.eval=function(a){return!1},PFilterRemove.prototype.setup=function(){var a=this.insertPt(),b=document.getElementById("dltext-filter-remove").innerHTML;a.append(b)};var PFilterText=function(a,b){PFilterModel.call(this,a,b)};PFilterText.prototype=Object.create(PFilterModel.prototype),PFilterText.prototype.constructor=PFilterText,PFilterText.prototype.evalPrep=function(){var a=this.insertPt();this.cs=a.find("input.filter-text-cs").prop("checked"),this.s=a.find("input.filter-text").val(),this.cs||(this.s=this.s.toLocaleLowerCase())},PFilterText.prototype.eval=function(a){var b=this.s;if(null==b||""===b)return!0;var c=a.a[this.att.id];return"undefined"==typeof c?!1:(this.cs||(c=c.toLocaleLowerCase()),-1!==c.indexOf(b))},PFilterText.prototype.setup=function(){var a=this,b=this.insertPt(),c=document.getElementById("dltext-filter-text").innerHTML;b.append(c),b.find("input.filter-text").change(function(){a.isDirty(!0)}),b.find("input.filter-text-cs").click(function(b){a.isDirty(!0)})},PFilterText.prototype.getState=function(){var a=this.insertPt();return{cs:a.find("input.filter-text-cs").prop("checked"),t:a.find("input.filter-text").val()}},PFilterText.prototype.setState=function(a){var b=this.insertPt();b.find("input.filter-text-cs").prop("checked",a.cs),b.find("input.filter-text").val(a.t)};var PFilterTags=function(a,b){PFilterModel.call(this,a,b)};PFilterTags.prototype=Object.create(PFilterModel.prototype),PFilterTags.prototype.constructor=PFilterTags,PFilterTags.prototype.evalPrep=function(){var a=this.insertPt();this.cs=a.find("input.filter-text-cs").prop("checked"),this.p=a.find("input.filter-text-p").prop("checked"),this.s=a.find("input.filter-text").val(),this.cs||(this.s=this.s.toLocaleLowerCase())},PFilterTags.prototype.eval=function(a){var b=this.s;if(null==b||""===b)return!0;var c=a.a[this.att.id];if("undefined"==typeof c)return!1;for(var d=0;d<c.length;d++){var e=c[d];return this.cs||(e=e.toLocaleLowerCase()),this.p?-1!==e.indexOf(b):e===b}return!1},PFilterTags.prototype.setup=function(){var a=this,b=this.insertPt(),c=document.getElementById("dltext-filter-tags").innerHTML;b.append(c),b.find("input.filter-text").change(function(){a.isDirty(!0)}),b.find("input.filter-text-cs").click(function(b){a.isDirty(!0)}),b.find("input.filter-text-p").click(function(b){a.isDirty(!0)})},PFilterTags.prototype.getState=function(){var a=this.insertPt();return{cs:a.find("input.filter-text-cs").prop("checked"),p:a.find("input.filter-text-p").prop("checked"),t:a.find("input.filter-text").val()}},PFilterTags.prototype.setState=function(a){var b=this.insertPt();b.find("input.filter-text-cs").prop("checked",a.cs),b.find("input.filter-text-p").prop("checked",a.p),b.find("input.filter-text").val(a.t)};var PFilterVocab=function(a,b){PFilterModel.call(this,a,b)};PFilterVocab.prototype=Object.create(PFilterModel.prototype),PFilterVocab.prototype.constructor=PFilterVocab,PFilterVocab.prototype.evalPrep=function(){var a=this;this.sel=[];var b=this.insertPt().find("div.filter-vocab-row input:checked");b.each(function(){var b=jQuery(this).parent().data("id");b&&a.sel.push(b)}),this.sel.sort(),this.ctrs=new Uint16Array(this.sel.length);for(var c=0;c<this.sel.length;c++)this.ctrs[c]=0},PFilterVocab.prototype.eval=function(a){if(0===this.sel.length)return!1;var b=a.a[this.att.id];if("undefined"==typeof b)return!1;for(var c,d,e=0;e<b.length;e++)if(d=b[e],c=_.sortedIndex(this.sel,d),this.sel[c]===d)return this.ctrs[c]++,!0;return!1},PFilterVocab.prototype.evalDone=function(a){var b,c,d,e,f=this,g=this.insertPt().find("div.filter-vocab-row");g.each(function(){e=jQuery(this),b=e.data("id"),b&&(c=_.sortedIndex(f.sel,b),d=f.sel[c]===b&&a>0?Math.round(100*f.ctrs[c]/a):0,e.next().width(d+"%"))})},PFilterVocab.prototype.setup=function(){var a=this,b='<div class="filter-vocab-container"><div class="filter-vocab-hsa"><input type="checkbox" checked="checked" data-index=-1><i> '+dlText.sha+"</i></div>";this.att.l.forEach(function(a,c){b+='<div class="filter-vocab-entry" data-index="'+c+'"><div class="filter-vocab-row" data-id="'+a.l+'"><input type="checkbox" class="term-parent" checked="checked">'+a.l+'</div><div class="filter-vocab-bar" style="background-color:'+a.v+'"></div>',a.z.forEach(function(d,e){b+='<div class="filter-vocab-row" data-id="'+d.l+'"><input type="checkbox" data-parent="'+c+'" checked="checked">'+d.l+"</div>",b+=null==d.v||""===d.v?'<div class="filter-vocab-bar" style="background-color:'+a.v+'"></div>':'<div class="filter-vocab-bar" style="background-color:'+d.v+'"></div>'}),b+="</div>"});var c=this.insertPt();c.append(b+"</div>"),c.click(function(b){var d=b.target;if("INPUT"===d.nodeName){if("undefined"!=typeof d.dataset.index&&-1==d.dataset.index){var e=d.checked,f=c.find("div.filter-vocab-row input");f.prop("checked",e)}else if("term-parent"===b.target.className&&d.checked){var g=b.target.parentElement.parentElement.dataset.index;c.find('input[data-parent="'+g+'"]').prop("checked",!0)}a.isDirty(!0)}})},PFilterVocab.prototype.getState=function(){var a=[],b=this.insertPt().find("div.filter-vocab-row input:checked");return b.each(function(){var b=jQuery(this).parent().data("id");b&&a.push(b)}),a.sort(),{s:a}},PFilterVocab.prototype.setState=function(a){var b=this.insertPt().find("div.filter-vocab-row");b.each(function(){var b=jQuery(this),c=b.data("id"),d=_.indexOf(a.s,c,!0);b.find("input").prop("checked",-1!==d)})};var PFilterNum=function(a,b){PFilterModel.call(this,a,b)};PFilterNum.prototype=Object.create(PFilterModel.prototype),PFilterNum.prototype.constructor=PFilterNum,PFilterNum.prototype.refreshBoxes=function(){var a=this.insertPt();a.find(".from").removeClass("error").val(this.min),a.find(".to").removeClass("error").val(this.max),a.find(".filter-update").prop("disabled",!0)},PFilterNum.prototype.evalBoxes=function(a){function b(b,c){function d(){k=!0,a.find(b).addClass("error")}function i(){a.find(b).removeClass("error")}var j,k=!1,l=a.find(b),m=l.val(),n=f.exec(m);return n?(i(),j=parseInt(n[1],10)):d(),k||(0==c?null!==g&&g>j&&d():null!==h&&j>h&&d()),e.uNums[c]=j,k}var c,d,e=this,f=/^(\d+)$/,g="undefined"==typeof this.att.r.min?null:this.att.r.min,h="undefined"==typeof this.att.r.max?null:this.att.r.max;return c=b(".from",0),d=b(".to",1),this.uNums[0]>this.uNums[1]&&(d=!0),a.find(".filter-update").prop("disabled",c||d),!(c||d)},PFilterNum.prototype.useBoxes=function(a){if(this.evalBoxes(a)){if(this.isDirty(!0),this.min=this.uNums[0],this.max=this.uNums[1],null!==this.rCats){var b,c;for(b=0;b<this.rCats.length&&!(this.min<=this.rCats[b].max);b++);for(c=b;c<this.rCats.length&&!(this.max<=this.rCats[c].max);c++);c=c===this.rCats.length?this.rCats.length-1:c,this.b0=b,this.b1=c,this.brushg.call(this.brush.extent([b,c+1]))}a.find(".filter-update").prop("disabled",!0)}},PFilterNum.prototype.evalPrep=function(){if(null!==this.rCats)for(var a=0;a<this.rCats.length;a++)this.ctrs[a]=0},PFilterNum.prototype.eval=function(a){var b=a.a[this.att.id];if("undefined"==typeof b)return!1;if("?"===b)return this.u;if(b<this.min||b>this.max)return!1;if(null===this.rCats)return!0;for(var c,d=this.b0;d<=this.b1;d++)if(c=this.rCats[d],c.min<=b&&b<=c.max){this.ctrs[d]++;break}return!0},PFilterNum.prototype.evalDone=function(a){if(null!==this.rCats){for(var b=this,c=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,d=new Uint16Array(this.ctrs.length),e=0;e<this.ctrs.length;e++)d[e]=a>0?Math.round(100*this.ctrs[e]/a):0;this.chart.selectAll(".bar").transition().duration(500).attr("height",function(a,e){return c-b.yScale(d[e])}).attr("y",function(a,c){return b.yScale(d[c])})}},PFilterNum.prototype.setup=function(){function a(a){var b=+("e"==a),c=b?1:-1,d=e/4;return"M"+.5*c+","+d+"A6,6 0 0 "+b+" "+6.5*c+","+(d+6)+"V"+(2*d-6)+"A6,6 0 0 "+b+" "+.5*c+","+2*d+"ZM"+2.5*c+","+(d+8)+"V"+(2*d-8)+"M"+4.5*c+","+(d+8)+"V"+(2*d-8)}function b(){if(d3.event.sourceEvent){var a=c.brush.extent(),b=[Math.floor(a[0]),Math.floor(a[1])];b[0]>=b[1]&&(b[0]=Math.floor(a[0]),b[1]=Math.ceil(a[1])),b[1]=Math.max(b[1],b[0]+1),d3.select(this).transition().call(c.brush.extent(b)),c.b0=b[0],c.b1=b[1]-1,c.min=c.rCats[c.b0].min,c.max=c.rCats[c.b1].max,c.refreshBoxes(),c.isDirty(!0)}}var c=this;this.u=!1,this.uNums=new Array(2);var d=this.insertPt();if(d.append(document.getElementById("dltext-filter-nums").innerHTML),"undefined"==typeof this.att.r.u?d.find(".allow-undef").prop("disabled",!0):d.find(".allow-undef").click(function(){c.u=d.find("input.allow-undef").prop("checked"),c.isDirty(!0)}),this.rCats=PData.cRNew(this.att,!1,!1),null!==this.rCats){this.ctrs=new Uint16Array(this.rCats.length),this.b0=0,this.b1=this.rCats.length-1,this.min=this.rCats[0].min,this.max=this.rCats[this.b1].max;var e=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,f=0;this.rCats.forEach(function(a){f=Math.max(f,a.l.length)}),f=Math.max(D3FG_BAR_WIDTH,7*f);var g=this.rCats.length*f,h=d3.scale.linear().domain([0,this.rCats.length]).rangeRound([0,g]),i=d3.scale.linear().domain([0,100]).range([e,0]);this.yScale=i;var j=d3.scale.ordinal().rangeRoundBands([0,g]);j.domain(this.rCats.map(function(a){return a.l}));var k=d3.svg.axis().scale(j).orient("bottom"),l=d3.svg.axis().scale(i).orient("left").ticks(4),m=d3.select(d.get(0)).append("svg").attr("width",g+D3FG_MARGINS.left+D3FG_MARGINS.right).attr("height",e+D3FG_MARGINS.top+D3FG_MARGINS.bottom).append("g").attr("transform","translate("+D3FG_MARGINS.left+","+D3FG_MARGINS.top+")");this.chart=m,m.append("g").attr("class","x axis").attr("transform","translate(0,"+e+")").call(k),m.append("g").attr("class","y axis").call(l),m.selectAll(".bar").data(this.rCats).enter().append("rect").attr("class","bar").attr("x",function(a,b){return h(b)+2}).attr("y",function(a){return i(100)}).attr("fill",function(a){return a.c}).attr("height",function(a){return e-i(100)}).attr("width",f-4),c.brush=d3.svg.brush().x(h).extent([0,this.rCats.length]).on("brushend",b),c.brushg=m.append("g"),c.brushg.attr("class","brush").call(c.brush),c.brushg.selectAll("rect").attr("y",-1).attr("height",e+4),c.brushg.selectAll(".resize").append("path").attr("d",a)}else this.min="undefined"==typeof att.r.min?0:att.r.min,this.max="undefined"==typeof att.r.max?100:att.r.max;this.refreshBoxes(),d.find("input[type=text]").change(function(){c.evalBoxes(d)}),d.find(".filter-update").click(function(){c.useBoxes(d)})},PFilterNum.prototype.getState=function(){return{min:this.min,max:this.max,u:this.u}},PFilterNum.prototype.setState=function(a){var b=this.insertPt();b.find("input.allow-undef").prop("checked",a.u),this.u=a.u,b.find(".from").removeClass("error").val(a.min),b.find(".to").removeClass("error").val(a.max),this.useBoxes(b)};var PFilterDates=function(a,b,c){PFilterModel.call(this,a,b,c)};PFilterDates.prototype=Object.create(PFilterModel.prototype),PFilterDates.prototype.constructor=PFilterDates,PFilterDates.prototype.refreshBoxes=function(){function a(a,c){var d=a.getUTCFullYear(),e=a.getUTCMonth()+1,f=a.getUTCDate();b.find(c+"-y").removeClass("error").val(d),b.find(c+"-m").removeClass("error").val(e),b.find(c+"-d").removeClass("error").val(f)}var b=this.insertPt();a(this.min,".from"),a(this.max,".to"),b.find(".filter-update").prop("disabled",!0)},PFilterDates.prototype.evalBoxes=function(a){function b(b,c){function d(c){i=!0,a.find(b+c).addClass("error")}function h(c){a.find(b+c).removeClass("error")}var i=!1,j={y:0,m:0,d:0,ms:null},k=a.find(b+"-y"),l=k.val(),m=f.exec(l);return m?(h("-y"),j.y=parseInt(m[1],10)):d("-y"),k=a.find(b+"-m"),l=k.val(),m=g.exec(l),m?(j.m=parseInt(m[1],10),j.m<1||j.m>12?d("-m"):h("-m")):d("-m"),k=a.find(b+"-d"),l=k.val(),m=g.exec(l),m?(j.d=parseInt(m[1],10),j.d<1||j.d>31?d("-d"):h("-d")):d("-d"),i||(j.ms=PData.d3Nums(j.y,j.m,j.d,!1),0==c?j.ms<e.rCats[0].min&&(d("-y"),d("-m"),d("-d")):j.ms>e.rCats[e.rCats.length-1].max&&(d("-y"),d("-m"),d("-d"))),
e.uDates[c]=j,i}var c,d,e=this,f=/^(-?\d+)$/,g=/^(\d{1,2})$/;return c=b(".from",0),d=b(".to",1),this.uDates[0].ms>this.uDates[1].ms&&(d=!0),a.find(".filter-update").prop("disabled",c||d),!(c||d)},PFilterDates.prototype.useBoxes=function(a){if(this.evalBoxes(a)){this.isDirty(!0),this.min=this.uDates[0].ms;var b=this.uDates[1].ms;b.setTime(b.getTime()+10),this.max=b;var c,d;for(c=0;c<this.rCats.length&&!(this.min<this.rCats[c].max);c++);for(d=c;d<this.rCats.length&&!(this.max<=this.rCats[d].max);d++);d=d===this.rCats.length?this.rCats.length-1:d,this.b0=c,this.b1=d,this.brushg.call(this.brush.extent([c,d+1])),a.find(".filter-update").prop("disabled",!0)}},PFilterDates.prototype.evalPrep=function(){this.c=jQuery("input[name=dctrl-"+this.id+"]:checked").val();for(var a=0;a<this.rCats.length;a++)this.ctrs[a]=0},PFilterDates.prototype.eval=function(a){function b(a,b,c,d,e){return"undefined"!=typeof d.m&&(b=d.m,"undefined"!=typeof d.d&&(c=d.d)),PData.d3Nums(a,b,c,e)}var c=a.a[this.att.id];if("undefined"==typeof c)return!1;if("?"===c)return this.u;if("undefined"==typeof c.max){var d=b(c.min.y,1,1,c.min,!1);if(d<this.min||d>=this.max)return!1}else{var e,d=b(c.min.y,1,1,c.min,!1);if(e="open"===c.max?TODAY:b(c.max.y,12,31,c.max,!0),"o"===this.c){if(e<this.min||d>=this.max)return!1}else if(this.min>d||e>this.max)return!1}for(var f,g=this.b0;g<=this.b1;g++)if(f=this.rCats[g],f.min<=d&&d<f.max){this.ctrs[g]++;break}return!0},PFilterDates.prototype.evalDone=function(a){for(var b=this,c=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,d=new Uint16Array(this.ctrs.length),e=0;e<this.ctrs.length;e++)d[e]=a>0?Math.round(100*this.ctrs[e]/a):0;this.chart.selectAll(".bar").transition().duration(500).attr("height",function(a,e){return c-b.yScale(d[e])}).attr("y",function(a,c){return b.yScale(d[c])})},PFilterDates.prototype.setup=function(){function a(a){var b=+("e"==a),c=b?1:-1,e=d/4;return"M"+.5*c+","+e+"A6,6 0 0 "+b+" "+6.5*c+","+(e+6)+"V"+(2*e-6)+"A6,6 0 0 "+b+" "+.5*c+","+2*e+"ZM"+2.5*c+","+(e+8)+"V"+(2*e-8)+"M"+4.5*c+","+(e+8)+"V"+(2*e-8)}function b(){if(d3.event.sourceEvent){var a=c.brush.extent(),b=[Math.floor(a[0]),Math.floor(a[1])];b[0]>=b[1]&&(b[0]=Math.floor(a[0]),b[1]=Math.ceil(a[1])),b[1]=Math.max(b[1],b[0]+1),d3.select(this).transition().call(c.brush.extent(b)),c.b0=b[0],c.b1=b[1]-1,c.min=c.rCats[c.b0].min,c.max=c.rCats[c.b1].max,c.refreshBoxes(),c.isDirty(!0)}}var c=this;this.rCats=PData.cRNew(this.att,!1,!1),this.ctrs=new Uint16Array(this.rCats.length),this.b0=0,this.b1=this.rCats.length-1,this.u=!1,this.min=this.rCats[0].min,this.max=this.rCats[this.b1].max,this.uDates=new Array(2);var d=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,e=this.insertPt(),f=0;this.rCats.forEach(function(a){f=Math.max(f,a.l.length)}),f=Math.max(D3FG_BAR_WIDTH,7*f);var g=this.rCats.length*f,h=d3.scale.linear().domain([0,this.rCats.length]).rangeRound([0,g]),i=d3.scale.linear().domain([0,100]).range([d,0]);this.yScale=i;var j=d3.scale.ordinal().rangeRoundBands([0,g]);j.domain(this.rCats.map(function(a){return a.l}));var k=d3.svg.axis().scale(j).orient("bottom"),l=d3.svg.axis().scale(i).orient("left").ticks(4),m=_.template(document.getElementById("dltext-filter-dates").innerHTML);e.append(m({id:this.id})),e.find("input[name=dctrl-"+c.id+"]").change(function(){c.isDirty(!0)}),"undefined"==typeof this.att.r.u?e.find(".allow-undef").prop("disabled",!0):e.find(".allow-undef").click(function(){c.u=e.find("input.allow-undef").prop("checked"),c.isDirty(!0)}),this.refreshBoxes(),e.find("input[type=text]").change(function(){c.evalBoxes(e)}),e.find(".filter-update").click(function(){c.useBoxes(e)});var n=d3.select(e.get(0)).append("svg").attr("width",g+D3FG_MARGINS.left+D3FG_MARGINS.right).attr("height",d+D3FG_MARGINS.top+D3FG_MARGINS.bottom).append("g").attr("transform","translate("+D3FG_MARGINS.left+","+D3FG_MARGINS.top+")");this.chart=n,n.append("g").attr("class","x axis").attr("transform","translate(0,"+d+")").call(k),n.append("g").attr("class","y axis").call(l),n.selectAll(".bar").data(this.rCats).enter().append("rect").attr("class","bar").attr("x",function(a,b){return h(b)+2}).attr("y",function(a){return i(100)}).attr("fill",function(a){return a.c}).attr("height",function(a){return d-i(100)}).attr("width",f-4),c.brush=d3.svg.brush().x(h).extent([0,this.rCats.length]).on("brushend",b),c.brushg=n.append("g"),c.brushg.attr("class","brush").call(c.brush),c.brushg.selectAll("rect").attr("y",-1).attr("height",d+4),c.brushg.selectAll(".resize").append("path").attr("d",a)},PFilterDates.prototype.getState=function(){function a(a){return a.getUTCFullYear()+"-"+(a.getUTCMonth()+1)+"-"+a.getUTCDate()}var b=jQuery("input[name=dctrl-"+this.id+"]:checked").val();return{min:a(this.min),max:a(this.max),c:b,u:this.u}},PFilterDates.prototype.setState=function(a){function b(a,b){var d=b.split("-"),e=0;4===d.length?(c.find(a+"-y").removeClass("error").val("-"+d[1]),e=1):c.find(a+"-y").removeClass("error").val(d[0]),c.find(a+"-m").removeClass("error").val(d[++e]),c.find(a+"-d").removeClass("error").val(d[++e])}var c=this.insertPt();jQuery('input[name="dctrl-'+this.id+'"]').val([a.c]),c.find("input.allow-undef").prop("checked",a.u),this.u=a.u,b(".from",a.min),b(".to",a.max),this.useBoxes(c)};var PFilterPtr=function(a,b){PFilterModel.call(this,a,b)};PFilterPtr.prototype=Object.create(PFilterModel.prototype),PFilterPtr.prototype.constructor=PFilterPtr,PFilterPtr.prototype.evalPrep=function(){var a=this.insertPt();this.cs=a.find("input.filter-text-cs").prop("checked"),this.s=a.find("input.filter-text").val(),this.cs||(this.s=this.s.toLocaleLowerCase())},PFilterPtr.prototype.eval=function(a){var b,c,d=this.s;if(null==d||""===d)return!0;var e=a.a[this.att.id];if("undefined"==typeof e||0===e.length)return!1;for(var f=0;f<e.length;f++)if(c=PData.rByID(e[f]),b=c.l,this.cs||(b=b.toLocaleLowerCase()),-1!==b.indexOf(d))return!0;return!1},PFilterPtr.prototype.setup=function(){var a=this,b=this.insertPt(),c=document.getElementById("dltext-filter-ptr").innerHTML;b.append(c),b.find("input.filter-text").change(function(){a.isDirty(!0)}),b.find("input.filter-text-cs").click(function(b){a.isDirty(!0)})},PFilterPtr.prototype.getState=function(){var a=this.insertPt();return{cs:a.find("input.filter-text-cs").prop("checked"),t:a.find("input.filter-text").val()}},PFilterPtr.prototype.setState=function(a){var b=this.insertPt();b.find("input.filter-text-cs").prop("checked",a.cs),b.find("input.filter-text").val(a.t)};var PData=function(){function rChunk(a,b,c){jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_records",tmplt_id:prspdata.t[a].id,from:b,count:c},success:function(b,d,e){var f=recs[a],g=JSON.parse(b);f.d?f.d=f.d.concat(g):f.d=g,f.n+=c,rLoad()},error:function(a,b,c){alert(c)}})}function rLoad(){for(var a=!0,b=0;b<prspdata.t.length;b++){var c=recs[b].n,d=prspdata.t[b].n;if(d>c){a=!1;var e=d-c,f=LOAD_DATA_CHUNK>e?e:LOAD_DATA_CHUNK;rChunk(b,c,f);break}}a&&(loaded=!0,setTimeout(function(){jQuery("body").trigger("prospect",{s:PSTATE_PROCESS})},500))}var LOAD_DATA_CHUNK=1e3,dltextTo,dltextApprox,dltextNow,mnthDays=[31,28,31,30,31,30,31,31,30,31,30,31],recs=[],rCount=0,loaded=!1;return{init:function(){dltextTo=document.getElementById("dltext-to").innerHTML,dltextApprox=document.getElementById("dltext-approximately").innerHTML,dltextNow=document.getElementById("dltext-now").innerHTML,"number"==typeof prspdata.x.chunk&&prspdata.x.chunk>0&&(LOAD_DATA_CHUNK=prspdata.x.chunk),prspdata.t.forEach(function(a){var b={i:rCount,n:0,d:null};recs.push(b),rCount+=a.n}),rLoad()},rSize:function(){return rCount},intersect:function(a,b){for(var c,d,e=[],f=a.length,g=b.length,h=0,i=0;f>h&&g>i;)c=a[h],d=b[i],c>d?i++:d>c?h++:(e.push(c),h++,i++);return e},union:function(a,b){for(var c,d,e=[],f=0,g=0;f<a.length&&g<b.length;)c=a[f],d=b[g],d>c?(e.push(c),f++):c==d?(e.push(c),f++,g++):(e.push(d),g++);for(;f<a.length;f++)e.push(a[f]);for(;g<b.length;g++)e.push(b[g]);return e},strcmp:function(a,b){for(var c=0,d=Math.max(a.length,b.length);d>c&&a.charAt(c)===b.charAt(c);++c);return c===d?0:a.charAt(c)>b.charAt(c)?-1:1},sNew:function(a){var b={};if(b.s=new Uint16Array(rCount),b.t=[],b.l=0,a){var c;for(c=0;rCount>c;c++)b.s[c]=c;for(c=0;c<recs.length;c++){var d=recs[c],e={i:d.i,n:d.n};b.t.push(e)}b.l=rCount}return b},s1stT:function(a,b){var c=a.t[b];return 0==c.n?-1:c.i},n2T:function(a){for(var b=0;b<recs.length;b++){var c=recs[b];if(c.i<=a&&a<c.i+c.n)return b}},aInT:function(a,b){var c=prspdata.t[b];return-1!=c.def.a.findIndex(function(b){return b==a})},rByN:function(a){for(var b=0;b<recs.length;b++){var c=recs[b];if(c.n>0&&c.i<=a&&a<c.i+c.n)return c.d[a-c.i]}return null},procAttTxt:function(a,b){var c=PData.aByID(a);switch(c.def.t){case"V":case"g":return b.join(", ");case"T":return b;case"N":return"?"===b?dlText.undef:b.toString();case"D":if("?"===b)return dlText.undef;var d="";return b.max?(b.min.f&&(d=dltextApprox+" "),d+=b.min.y.toString(),b.min.m&&(d+="-"+b.min.m.toString(),b.min.d&&(d+="-"+b.min.d.toString())),d+=dltextTo+" ","open"==b.max?d+=dltextNow:(b.max.f&&(d+=dltextApprox+" "),d+=b.max.y.toString(),b.max.m&&(d+="-"+b.max.m.toString(),b.max.d&&(d+="-"+b.max.d.toString())))):(d=b.min.f?dltextApprox+" ":"",d+=b.min.y.toString(),b.min.m&&(d+="-"+b.min.m.toString(),b.min.d&&(d+="-"+b.min.d.toString()))),d;case"L":case"X":return null!=c.def.d&""!==c.def.d?"number"==typeof b[0]?b.join(", "):b.map(function(a){return a.join(", ")}).join(c.def.d+" "):b.join(", ");case"I":return'<img src="'+b+'" alt="'+c.def.l+'"/>';case"l":return'<a href="'+b+'" target="_blank">(See Link)</a>';case"S":return'<a href="'+b+'" target="_blank">(SoundCloud)</a>';case"Y":return'<a href="https://www.youtube.com/watch?v='+b+'" target="_blank">(YouTube)</a>';case"x":return'<a href="'+b+'" target="_blank">(See Transcript File)</a>';case"t":return b;case"P":if(b.length>0){var e="";return b.forEach(function(a){var b=PData.rByID(a);b&&(e.length>0&&(e+=", "),e+='<a href="'+prspdata.site_url+"?p="+b.wp+'" target="_blank">'+b.l+"</a>")}),e}return null}return null},rAV:function(a,b,c){for(var d=0;d<recs.length;d++){var e=recs[d];if(e.n>0&&e.i<=a&&a<e.i+e.n){var f=e.d[a-e.i],g=f.a[b];return null==g||"undefined"==typeof g?null:c?g:PData.procAttTxt(b,g)}}return null},nByID:function(a){for(var b=0;b<recs.length;b++){var c=recs[b];if(c.n>0)for(var d,e,f,g=0,h=c.n-1;h>=g;)if(d=g+h>>1,f=c.d[d],e=PData.strcmp(a,f.id),0>e)g=d+1;else{if(!(e>0))return c.i+d;h=d-1}}return null},rByID:function(a){for(var b=0;b<recs.length;b++){var c=recs[b];if(c.n>0)for(var d,e,f,g=0,h=c.n-1;h>=g;)if(d=g+h>>1,f=c.d[d],e=PData.strcmp(a,f.id),0>e)g=d+1;else{if(!(e>0))return f;h=d-1}}return null},aByID:function(a){for(var b,c,d=0,e=prspdata.a.length-1;e>=d;)if(b=d+e>>1,c=PData.strcmp(a,prspdata.a[b].id),0>c)d=b+1;else{if(!(c>0))return prspdata.a[b];e=b-1}return null},aByN:function(a){return prspdata.a[a]},eTNum:function(){return prspdata.e.g.ts.length},eTByN:function(a){return prspdata.e.g.ts[a]},tByID:function(a){for(var b=0;b<prspdata.t.length;b++)if(a==prspdata.t[b].id)return prspdata.t[b].def},lRecs:function(a,b,c,d){function e(a){for(var d=0;h>d;d++)if(f=c[d],"number"==typeof f){if(g=b.l[f],g.l===a)return g}else{g=b.l[f[0]];var e=g.z[f[1]];if(e.l===a)return e.v&&""!==e.v?e:g}return null}var f,g,h=c.length;switch(b.def.t){case"V":if(d&&""!==b.def.d){var i,j=[];return a.forEach(function(a){i=e(a),null!=i&&j.push(i)}),j.length>0?j:null}if(""!=b.def.d){for(var i,k=0;k<a.length;k++)if(i=e(a[k]),null!=i)return i;return null}return e(a[0]);case"T":for(var i=0;h>i;i++)if(f=c[i],g=b.l[f],-1!=a.indexOf(g.d))return g;return null;case"N":var i=0;if(-1===c[0]){if("?"===a)return"undefined"==typeof b.r.u?null:b.r.u;i=1}if("?"===a)return null;for(;h>i;i++)if(f=c[i],g=b.l[f],"undefined"!=typeof g.d.min){if(g.d.min<=a){if("undefined"==typeof g.d.max)return g;if(a<=g.d.max)return g}}else if(a<=g.d.max)return g;return null;case"D":var i=0;if(-1===c[0]){if("?"===a)return"undefined"==typeof b.r.u?null:b.r.u;i=1}if("?"===a)return null;for(;h>i;i++){if(f=c[i],g=b.l[f],"undefined"!=typeof g.d.max.y){if("undefined"!=typeof a.max&&"open"!==a.max){if(a.max.y<g.d.min.y)continue;if(a.max.y===g.d.min.y&&a.max.m&&g.d.min.m){if(a.max.m<g.d.min.m)continue;if(a.max.m==g.d.min.m&&a.max.d&&g.d.min.d&&a.max.d<g.d.min.d)continue}}if(a.min.y>g.d.max.y)continue;if(a.min.y===g.d.max.y&&a.min.m&&g.d.max.m){if(a.min.m>g.d.max.m)continue;if(a.min.m===g.d.max.m&&a.min.d&&g.d.max.d&&a.min.d>g.d.max.d)continue}return g}if("undefined"!=typeof a.max){if("open"===a.max)return g;if(a.max.y<g.d.min.y)continue;if(a.max.y===g.d.min.y&&a.max.m&&g.d.min.m){if(a.max.m<g.d.min.m)continue;if(a.max.m===g.d.min.m&&a.max.d&&g.d.min.d&&a.max.d<g.d.min.d)continue}return g}if(!(a.min.y<g.d.min.y)){if(a.min.y===g.d.min.y&&a.min.m&&g.d.min.m){if(a.min.m<g.d.min.m)continue;if(a.min.m===g.d.min.m&&a.min.d&&g.d.min.d&&a.min.d<g.d.min.d)continue}return g}}}return null},lClr:function(a,b,c){var d;return(d=PData.lRecs(a,b,c,!1))?d.v:null},lenMnth:function(a,b){return 2===b&&a%4===0&&a%100!==0||a%400===0?29:mnthDays[b-1]},d3Nums:function(a,b,c,d){var e;return 0>a||a>99?e=new Date(a,b-1,c):0==a?e=new Date(-1,b-1,c):(e=new Date(a,b-1,c),e.setUTCFullYear(("0000"+a).slice(-4))),d&&e.setTime(e.getTime()+MS_IN_DAY),e},dObj:function(a,b,c){var d;return"undefined"!=typeof a.m&&null!==a.m?(b=a.m,d="undefined"!=typeof a.d&&null!==a.d?a.d:PData.lenMnth(a.y,b)):d=PData.lenMnth(a.y,b),PData.d3Nums(a.y,b,d,c)},dStr:function(a,b){var c,d;if("open"==a)return TODAY;var e=1;"-"===a.charAt(0)&&(e=-1,a=a.substring(1));var f=a.split("-"),g=parseInt(f[0])*e;return f.length>1?(c=parseInt(f[1]),d=3==f.length?parseInt(f[2]):b?PData.lenMnth(g,c):1):b?(c=12,d=31):(c=1,d=1),PData.d3Nums(g,c,d,b)},cLNew:function(a,b,c){var d=[];switch(a.def.t){case"T":return a.l.forEach(function(c){(null==b||PData.lRecs(c.d,a,b,!1))&&d.push({l:c.l,x:c.d,c:c.v,i:[]})}),d;case"g":return d;case"V":return a.l.forEach(function(c){(null==b||PData.lRecs([c.l],a,b,!1))&&d.push({l:c.l,c:c.v,i:[]}),c.z.forEach(function(e){(null==b||PData.lRecs([e.l],a,b,!1))&&(""===e.v?d.push({l:e.l,c:c.v,i:[]}):d.push({l:e.l,c:e.v,i:[]}))})}),d;case"N":return c&&"undefined"!=typeof a.r.u&&(null==b||PData.lRecs("?",a,b,!1))&&d.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]}),a.l.forEach(function(c){(null==b||PData.lRecs(c.d.min,a,b,!1))&&d.push({l:c.l,c:c.v,min:c.d.min,max:c.d.max,i:[]})}),d;case"D":c&&"undefined"!=typeof a.r.u&&(null==b||PData.lRecs("?",a,b,!1))&&d.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]});var e,f;return a.l.forEach(function(c){e=PData.dObj(c.d.min,1,!1),(null===b||PData.lRecs(e,a,b,!1))&&(f=null==c.d.max.y?TODAY:PData.dObj(c.d.max,12,!1),f.setTime(f.getTime()+10),d.push({l:c.l,c:c.v,min:e,max:f,i:[]}))}),d}},cRNew:function(a,b,c){function d(a,b,c,d){return"undefined"!=typeof d.m&&(b=d.m,"undefined"!=typeof d.d&&(c=d.d)),PData.d3Nums(a,b,c,!1)}function e(a){var b,c,d;return"undefined"==typeof a.y?TODAY:(b=a.y,"undefined"==typeof a.m?(c=12,d=31):(c=a.m,d="undefined"==typeof a.d?PData.lenMnth(b,c):a.d),PData.d3Nums(b,c,d,!1))}var f=[];switch(a.def.t){case"T":return a.l.forEach(function(a){b?f.push({l:a.l,x:a.d,c:a.v,i:[]}):f.push({l:a.l,x:a.d,c:a.v})}),f;case"g":return f;case"V":return a.l.forEach(function(a){b?f.push({l:a.l,c:a.v,i:[]}):f.push({l:a.l,c:a.v}),a.z.forEach(function(c){var d=""===c?a.v:c.v;b?f.push({l:c.l,c:d,i:[]}):f.push({l:c.l,c:d})})}),f;case"N":if("undefined"==typeof a.r.min||"undefined"==typeof a.r.max)return null;c&&"undefined"!=typeof a.r.u&&(b?f.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]}):f.push({l:"?",c:a.r.u.v,min:"?",max:"?"}));var g,h,i,j=Math.pow(10,a.r.g),k=a.r.min,l=0;for(a.l.length>0&&(g=a.l[0]);k<=a.r.max;){for(;l<a.l.length&&"undefined"!=typeof g.d.max&&k>g.d.max;)g=a.l[++l];i=0==a.l.length||k<g.d.min?"#777777":l===a.l.length?"#777777":"undefined"==typeof g.d.max||k<=g.d.max?g.v:"#777777",h=k,k+=j,max=k-1,max>a.r.max&&(max=a.r.max);var m=h.toString();j>1&&m.length<4&&h!==max&&(m+="-"+max.toString()),b?f.push({l:m,c:i,min:h,max:max,i:[]}):f.push({l:m,c:i,min:h,max:max})}return f;case"D":var n=e(a.r.max),j=a.r.g,o=a.r.min.y,p=1,q=1;"undefined"!=typeof a.r.min.m&&(p=a.r.min.m,"undefined"!=typeof a.r.min.d&&(q=a.r.min.d));var g,r,s,t,u=PData.d3Nums(o,p,q,!1),l=0;for(a.l.length>0&&(g=a.l[0],r=d(g.d.min.y,1,1,g.d.min),s=e(g.d.max)),c&&"undefined"!=typeof a.r.u&&(b?f.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]}):f.push({l:"?",c:a.r.u.v,min:"?",max:"?"}));n>=u;){var v={};switch(b&&(v.i=[]),j){case"d":v.l=o.toString()+"-"+p.toString()+"-"+q.toString();break;case"m":v.l=o.toString()+"-"+p.toString();break;case"y":case"t":case"c":v.l=o.toString()}for(;l<a.l.length&&u>s;)g=a.l[++l],l<a.l.length&&(r=d(g.d.min.y,1,1,g.d.min),s=e(g.d.max));switch(0==a.l.length||r>u?v.c="#777777":l==a.l.length?v.c="#777777":s>=u?v.c=g.v:v.c="#777777",v.min=u,j){case"d":++q>PData.lenMnth(o,p)&&(q=1,++p>12&&(p=1,o++));break;case"m":++p>12&&(p=1,o++);break;case"y":o++;break;case"t":o+=10;break;case"c":o+=100}t=PData.d3Nums(o,p,q,!1),t>TODAY&&(t=TODAY),t.setTime(t.getTime()+10),v.max=t,f.push(v),u=PData.d3Nums(o,p,q,!1)}return f}},cFill:function(a,b,c,d){var e,f,g,h,i,j,k=PData.eTNum(),l=0,m=0,n=PData.aByID(b);for(e=d.t[0];m<d.l;){for(;0===e.n||e.i+e.n===m||!PData.aInT(b,l)||c&&!PData.aInT(c,l);){if(++l===k)return;e=d.t[l],m=e.i}if(f=d.s[m],g=PData.rByN(f),h=g.a[b],"undefined"!=typeof h)switch(n.def.t){case"T":for(i=0;i<a.length;i++)if(j=a[i],-1!==h.indexOf(j.x)){j.i.push(f);break}break;case"g":h.forEach(function(b){for(i=0;i<a.length;i++)if(j=a[i],b===j.l){j.i.push(f);break}i===a.length&&a.push({l:b,i:[f],c:"#"+Math.floor(16777215*Math.random()).toString(16)})});break;case"V":h.forEach(function(b){for(i=0;i<a.length;i++)if(j=a[i],b==j.l){j.i.push(f);break}});break;case"N":if(i=0,j=a[0],"?"===j.min){if("?"===h){j.i.push(f);break}i=1}if("?"===h)break;for(;i<a.length&&(j=a[i],!(h<j.min));i++)if(j.min<=h&&h<=j.max){j.i.push(f);break}break;case"D":if(i=0,j=a[0],"?"===j.min){if("?"===h){j.i.push(f);break}i=1}if("?"===h)break;for(var o=PData.dObj(h.min,1,!1);i<a.length&&(j=a[i],!(o<j.min));i++)if(j.min<=o&&o<j.max){j.i.push(f);break}}m++}"g"==n.def.t&&a.sort(function(a,b){return PData.strcmp(b.l,a.l)})},cSort:function(a,b,c){var d,e,f,g=b.id;a.forEach(function(a){if(d=PData.rByN(a),datum=d.a[g],"undefined"!=typeof datum)switch(b.def.t){case"T":for(e=0;e<c.length;e++)if(f=c[e],-1!==datum.indexOf(f.x)){f.i.push(a);break}break;case"g":datum.forEach(function(b){for(e=0;e<c.length;e++)if(f=c[e],b===f.l){f.i.push(a);break}e===c.length&&c.push({l:b,i:[a],c:"#777777"})});break;case"V":datum.forEach(function(b){for(e=0;e<c.length;e++)if(f=c[e],b===f.l){f.i.push(a);break}});break;case"N":if(e=0,f=c[0],"?"===f.min){if("?"===datum){f.i.push(a);break}e=1}if("?"===datum)break;for(;e<c.length&&(f=c[e],!(datum<f.min));e++)if(f.min<=datum&&datum<=f.max){f.i.push(a);break}break;case"D":if(e=0,f=c[0],"?"===f.min){if("?"===datum){f.i.push(a);break}e=1}if("?"===datum)break;var h=PData.dObj(datum.min,1,!1);for(e=0;e<c.length&&(f=c[e],!(h<f.min));e++)if(f.min<=h&&h<f.max){f.i.push(a);break}}}),"g"==b.def.t&&c.sort(function(a,b){return PData.strcmp(b.l,a.l)})},rTOrder:function(att,stream,tI){function vIden(a){return a}function vFirst(a){return a[0]}function vDate(a){if("?"===a)return"?";var b=1,c=1;return"undefined"!=typeof a.min.m&&(b=a.min.m,"undefined"!=typeof a.min.d&&(c=a.min.d)),PData.d3Nums(a.min.y,b,c,!1)}var eval,maxV;switch(att.def.t){case"T":eval=vIden,maxV="~";break;case"V":eval=vFirst,maxV="~";break;case"g":eval=vFirst,maxV="~";break;case"N":eval=vIden,maxV=att.r.max;break;case"D":eval=vDate,maxV=TODAY}for(var ord=[],tRec=stream.t[tI],ad=recs[tI],relI=0,absI,rec,v;relI<tRec.n;)absI=stream.s[tRec.i+relI++],rec=ad.d[absI-ad.i],v=rec.a[att.id],"undefined"==typeof v?ord.push({i:absI,v:maxV}):ord.push({i:absI,v:eval(v)});switch(att.def.t){case"T":case"g":case"V":ord.sort(function(a,b){return PData.strcmp(b.v,a.v)});break;case"D":case"N":ord.sort(function(a,b){return"?"===a.v?-1:"?"===b.v?1:a.v-b.v})}return ord},vByN:function(a){return prspdata.e.vf[a]},ready:function(){return loaded}}}();
