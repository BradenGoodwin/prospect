var volURL,tour,tourTxt,tourTOC,widgetData={ytLoaded:!1,ytCall:null,ytCode:null,timer:null,extract:null,sTime:null,eTime:null,playing:!1,widget:null,xscriptOn:!1,tcArray:null,tcIndex:-1};function PViewFrame(a,b){this.vfIndex=a;this.callbacks=b;this.vizSel=[];this.selAbsIs=[]}PViewFrame.prototype.getFrameID=function(){return"#view-frame-"+this.vfIndex};
PViewFrame.prototype.selBtns=function(a){var b=jQuery(this.getFrameID()+" div.view-controls");a?(b.find(".osel").button("enable"),b.find(".osel").addClass("pulse")):(b.find(".osel").button("disable"),b.find(".osel").removeClass("pulse"))};
PViewFrame.prototype.openSelection=function(){function a(c){return c.replace(/^[ \f\t\v\u200b]+|[ \f\t\v\u200b]+$/g,"")}function b(c){new Number;var a=parseTC.exec(c);if(null!==a)c=1E3*(3600*parseInt(a[1])+60*parseInt(a[2])+parseFloat(a[3])),c=1==a[4].length?c+100*parseInt(a[4]):c+10*parseInt(a[4]);else throw Error("Error in transcript file: Cannot parse "+c+" as timecode.");return c}function f(c,d){var u=new String(c),u=a(u).split(/\r\n|\r|\n/g),b=[];if(u){var l,w=0;_.each(u,function(c){c=a(c);0<
c.length&&("["===c.charAt(0)?(0<w&&b.push(l),l=""):(0<l.length&&(l+="<br/>"),l+=c),w++)})}_.each(b,function(l,c){d.find('div.timecode[data-tcindex="'+c+'"]').next().after('<div class="xscript">'+l+"</div>")})}function e(c){widgetData.tcArray=[];widgetData.tcIndex=-1;var d=widgetData.tcArray;c=new String(c);if(c=a(c).split(/\r\n|\r|\n/g)){var u=jQuery("#xscript-tbl"),e=0,l,w=0,v=0,F="";_.each(c,function(c){c=a(c);1<c.length&&("["===c.charAt(0)&&"0"<=c.charAt(1)&&"9">=c.charAt(1)?(l=b(c),0<F.length&&
(v&&d.push({s:w,e:l}),u.append('<div class="row"><div class="timecode" data-timecode="'+w+'" data-tcindex="'+e++ +'">'+v+'</div><div class="xscript">'+F+"</div></div>"),F=""),v=c,w=l):(0<F.length&&(F+="<br/>"),F+=c))});0<F.length&&(d.push({s:w,e:324E5}),u.append('<div class="row"><div class="timecode" data-timecode="'+w+'" data-tcindex="'+e+'">'+v+'</div><div class="xscript">'+F+"</div></div>"));"undefined"!==typeof t&&null!=t&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",
transcript:t,excerpt:widgetData.extract},success:function(l,c,a){f(JSON.parse(l),u)},error:function(l,c,a){alert(a)}})}}function g(c){var a,d=widgetData.tcIndex;_.find(widgetData.tcArray,function(u,l){if((a=u.s<=c&&c<u.e)&&l!=d){var w=jQuery("#xscript-tbl");if(document.getElementById("sync-xscript").checked){var v=w.find('[data-tcindex="'+l+'"]').offset().top-w.offset().top,v=w.scrollTop()+v;w.animate({scrollTop:v},300)}-1!=d&&w.find('[data-tcindex="'+d+'"]').removeClass("current");w.find('[data-tcindex="'+
l+'"]').addClass("current");widgetData.tcIndex=l}return a})}function d(){widgetData.widget=new YT.Player("yt-widget",{width:p-40,height:Math.floor(9*(p-40)/16),videoId:widgetData.ytCode,events:{onError:function(c){console.log("YouTube Error: "+c.data)},onStateChange:function(c){var a;switch(c.data){case 1:widgetData.playing=!0;null==widgetData.timer&&(widgetData.timer=setInterval(function(){a=1E3*widgetData.widget.getCurrentTime();widgetData.playing&&widgetData.xscriptOn&&g(a)},300));break;case 0:case 2:widgetData.playing=
!1;window.clearInterval(widgetData.timer);widgetData.timer=null;break;case 3:case 5:widgetData.playing=!1}},onReady:function(){widgetData.extract&&widgetData.widget.cueVideoById({videoId:widgetData.ytCode,startSeconds:widgetData.sTime/1E3,endSeconds:widgetData.eTime/1E3})}}})}function k(){widgetData.playing=!0}function c(){widgetData.playing=!1}function u(){widgetData.playing&&widgetData.xscriptOn&&g(1E3*widgetData.widget.currentTime)}function h(){switch(n){case 3:null!=widgetData.widget&&(widgetData.widget.removeEventListener("ended",
c),widgetData.widget.removeEventListener("pause",c),widgetData.widget.removeEventListener("playing",k),widgetData.widget.removeEventListener("timeupdate",u));case 1:null!=widgetData.widget&&widgetData.playing&&widgetData.widget.pause();widgetData.playing=!1;widgetData.widget=null;break;case 2:widgetData.ytCall=null,null!=widgetData.widget&&widgetData.playing&&widgetData.widget.stopVideo(),widgetData.widget=null,widgetData.playing=!1,null!=widgetData.timer&&(window.clearInterval(widgetData.timer),
widgetData.timer=null)}}function m(){function a(){widgetData.sTime=widgetData.eTime=null;var c;(c=prspdata.e.i.t.tcAtts[l])&&(c=q.a[c])&&""!==c&&(widgetData.extract=c,c=c.split("-"),widgetData.sTime=b(c[0]),widgetData.eTime=b(c[1]))}var f=r[x];q=PData.rByN(f);var h=" "+q.l+" ("+(x+1)+"/"+r.length+") ",m=jQuery("#inspect-name");m.text(h);m.prop("title",q.id);var l=PData.n2T(f);C.empty();B=null;n=0;widgetData.extract=null;widgetData.xscriptOn=!1;widgetData.playing=!1;if(prspdata.e.i.modal.scOn||"boolean"===
typeof prspdata.e.i.modal.aOn&&prspdata.e.i.modal.aOn)if(B=prspdata.e.i.sc.atts[l])if(h=q.a[B])if(a(),h.match(/soundcloud\.com/)){var w=!0;n=1;C.append('<iframe id="sc-widget" class="player" width="100%" height="110" src="http://w.soundcloud.com/player/?url='+h+'"></iframe>');var v=SC.Widget(document.getElementById("sc-widget"));widgetData.widget=v;v.bind(SC.Widget.Events.READY,function(){v.play();v.bind(SC.Widget.Events.PLAY,function(){widgetData.playing=!0});v.bind(SC.Widget.Events.PAUSE,function(){widgetData.playing=
!1});v.bind(SC.Widget.Events.PLAY_PROGRESS,function(c){w&&(v.pause(),w=!1,widgetData.playing=!1);widgetData.extract&&(c.currentPosition<widgetData.sTime?v.seekTo(widgetData.sTime):c.currentPosition>widgetData.eTime&&(v.pause(),widgetData.playing=!1));widgetData.playing&&widgetData.xscriptOn&&g(c.currentPosition)});v.bind(SC.Widget.Events.FINISH,function(){widgetData.playing=!1})})}else n=3,widgetData.extract&&(m=widgetData.extract.split("-"),h+="#t="+m[0]+","+m[1]),C.append('<audio id="na-widget" controls src="'+
h+'"></audio>'),widgetData.widget=document.getElementById("na-widget"),widgetData.widget.addEventListener("ended",c),widgetData.widget.addEventListener("pause",c),widgetData.widget.addEventListener("playing",k),widgetData.widget.addEventListener("timeupdate",u);0===n&&prspdata.e.i.modal.ytOn&&(B=prspdata.e.i.yt.atts[l])&&(h=q.a[B])&&(a(),widgetData.ytCode=h,C.append('<div id="yt-widget"></div>'),widgetData.ytCall=d,widgetData.ytLoaded?d():(widgetData.ytLoaded=!0,h=document.createElement("script"),
h.src="https://www.youtube.com/iframe_api",m=document.getElementsByTagName("script")[0],m.parentNode.insertBefore(h,m)),n=2);prspdata.e.i.modal.tOn&&(h=prspdata.e.i.t.t1Atts[l])&&""!==h&&"disable"!==h&&(h=q.a[h],"string"===typeof h&&""!==h&&(0<n&&C.append("<div>"+document.getElementById("dltext-sync-xscript").innerHTML+"</div>"),C.find("#xscript-tbl").remove(),C.append('<div id="xscript-tbl"></div>'),widgetData.xscriptOn=!0,jQuery("#xscript-tbl").click(function(c){if(n&&jQuery(c.target).hasClass("timecode"))switch(c=
jQuery(c.target).data("timecode"),n){case 1:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play());widgetData.widget.seekTo(c);break;case 2:widgetData.playing||(widgetData.playing=!0,widgetData.widget.playVideo());widgetData.widget.seekTo(c/1E3);break;case 3:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play()),widgetData.widget.currentTime=c/1E3}}),t=null,(m=prspdata.e.i.t.t2Atts[l])&&""!==m&&"disable"!==m&&(t=q.a[m]),jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",
transcript:h,excerpt:widgetData.extract},success:function(c,l,a){e(JSON.parse(c))},error:function(c,l,a){alert(a)}})));prspdata.e.i.modal.atts[l].forEach(function(c){var l=PData.rAV(f,c,!1);if(l){c=PData.aByID(c);var a;"_"==c.def.l.charAt(0)?a="<div>"+l+"</div>":(a='<div><span class="att-label">'+c.def.l+":</span> ","I"==c.def.t&&(a+="<br/>"),a+=l+"</div>");C.append(a)}})}function G(c){c=x+c;-1==c?c=r.length-1:c==r.length&&(c=0);c!=x&&(x=c,h(),m())}function D(c){G(-1)}function z(c){G(1)}var J=this,
C=jQuery("#inspect-content"),B=null,n=0,t,p=450,A=400,r=null,r=this.vizSel;if(null!=r&&0!==r.length){var y,q,x=0;prspdata.e.i.modal.scOn&&(p=550);prspdata.e.i.modal.ytOn&&(p=Math.max(p,475),A=500);prspdata.e.i.modal.tOn&&(A+=100,prspdata.e.i.modal.t2On?(p=Math.max(750,Math.floor(.8*jQuery(document).width())),p=Math.min(900,p)):p=Math.max(p,550));"number"===typeof prspdata.e.i.modal.w&&(p=prspdata.e.i.modal.w);"number"===typeof prspdata.e.i.modal.h&&(A=prspdata.e.i.modal.h);this.selBtns(!1);m();jQuery("#btn-inspect-left").click(D);
jQuery("#btn-inspect-right").click(z);y=jQuery("#dialog-inspector").dialog({width:p,height:A,modal:!0,buttons:[{text:dlText.findintext,click:function(){J.callbacks.textFrame.findRec(q.id)}},{text:dlText.seerec,click:function(){window.open(prspdata.site_url+"?p="+q.wp,"_blank")}},{text:dlText.close,click:function(){y.dialog("close")}}]});y.on("dialogclose",function(c,a){h();jQuery("#btn-inspect-left").off("click");jQuery("#btn-inspect-right").off("click");J.selBtns(!0);y.off("dialogclose")})}};
var PVizFrame=function(a,b){this.lDirty=null;this.vizSelIndex=0;this.vizModel=null;this.legendIDs=[];this.datastream=null;PViewFrame.call(this,a,b)};PVizFrame.prototype=Object.create(PViewFrame.prototype);PVizFrame.prototype.constructor=PViewFrame;PVizFrame.prototype.getIndex=function(){return 1};PVizFrame.prototype.setLDirty=function(a){a!==this.lDirty&&(this.lDirty=a,jQuery("#view-frame-1 div.lgnd-container div.lgnd-handle button.lgnd-update").prop("disabled",!a))};
PVizFrame.prototype.selectChangeViz=function(){var a=jQuery("#view-frame-1 div.view-controls select.view-viz-select option:selected").val();PState.set(PSTATE_BUILD);this.createViz(a,!0);this.computeSel();PState.set(PSTATE_READY)};
PVizFrame.prototype.computeSel=function(){this.vizSel=[];if(null!=this.vizModel)if(0===this.selAbsIs.length)this.selBtns(!1),this.vizModel.clearSel();else{var a=[],b=this.vizModel.rMap;this.selAbsIs.forEach(function(f){b[f>>4]&1<<(f&15)&&a.push(f)});this.vizSel=a;0===a.length?(this.vizModel.clearSel(),this.selBtns(!1)):(this.vizModel.setSel(a),this.selBtns(!0))}};
PVizFrame.prototype.initDOM=function(a){function b(a,c){jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",c);f.setLDirty(!0)}var f=this,e=jQuery("#view-frame-1"),g=prspdata.bClrs.vf;g&&0<g.length&&e.find("div.view-controls").css("background-color",g);e.find("div.lgnd-container").draggable({handle:e.find("div.lgnd-handle"),containment:"parent"});var d=e.find("div.view-controls select.view-viz-select");
prspdata.e.vf.forEach(function(a,c){d.append('<option value="'+c+'">'+a.l+"</option>")});d.val(a);d.change(function(){f.selectChangeViz()});e.find("div.view-controls button:first").button({icons:{primary:"ui-icon-bookmark"},text:!1}).click(function(a){f.vizModel.flags()&V_FLAG_LGND&&jQuery("#view-frame-1 div.lgnd-container").toggle("slide",{direction:"left"});a.preventDefault()}).next().button({icons:{primary:"ui-icon-wrench"},text:!1}).click(function(a){f.vizModel&&f.vizModel.doOptions();a.preventDefault()}).next().button({icons:{primary:"ui-icon-info"},
text:!1}).click(function(a){var c=jQuery("#dialog-vnotes").dialog({width:300,height:300,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close")}}]});a.preventDefault()}).next().button({icons:{primary:"ui-icon-star"},text:!1}).click(function(a){jQuery("body").trigger("prospect",{s:PSTATE_HILITE,v:1,t:f.vizModel.tUsed});a.preventDefault()}).next().button({icons:{primary:"ui-icon-search"},text:!1}).click(function(a){a.preventDefault();f.openSelection()});e.find("div.lgnd-container").click(function(a){var c=
jQuery(a.target).closest("div.lgnd-template").data("index"),d=a.target.className;switch(d){case "lgnd-update":f.vizModel&&f.datastream&&(PState.set(PSTATE_BUILD),f.vizModel.render(f.datastream),f.computeSel(),f.setLDirty(!1),PState.set(PSTATE_READY));break;case "lgnd-entry-check":d=jQuery(a.target).closest("div.lgnd-entry");a=jQuery(a.target).is(":checked");d.hasClass("lgnd-sh")?b(c,a):d.hasClass("lgnd-locate")?(d.data("id"),f.setLDirty(!0)):d.hasClass("lgnd-value")&&(d.data("index"),f.setLDirty(!0));
break;case "lgnd-viz":case "lgnd-value-title":d=jQuery(a.target).closest("div.lgnd-entry");d.hasClass("lgnd-locate")?(a=d.data("id"),jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+c+'"] div.lgnd-locate input.lgnd-entry-check').prop("checked",!1),jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+c+'"] div.lgnd-locate[data-id="'+a+'"] input.lgnd-entry-check').prop("checked",!0),f.setLDirty(!0)):d.hasClass("lgnd-value")&&
(a=d.data("index"),jQuery(getFrameID()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+c+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",!1),jQuery(getFrameID()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+c+'"] div.lgnd-group div.lgnd-value[data-index="'+a+'"] input.lgnd-entry-check').prop("checked",!0),f.setLDirty(!0));break;case "lgnd-template":case "lgnd-select":case "":break;default:d.match(/lgnd-sh/i)&&(d=jQuery(a.target).find("input.lgnd-entry-check"),
a=!d.is(":checked"),d.prop("checked",a),b(c,a))}});f.createViz(a,!1)};
PVizFrame.prototype.setLegendFeatures=function(a,b){var f,e=jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group');e.empty();this.legendIDs[a]=b;var g=PData.aByID(b);"undefined"!==typeof g.r.u&&(f='<div class="lgnd-value lgnd-entry" data-index="-1"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+g.r.u.v+'"> </div> <span class="lgnd-value-title">'+dlText.undef+"</span></div>",
e.append(f));g.l.forEach(function(a,b){f='<div class="lgnd-value lgnd-entry" data-index="'+b+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+a.v+'"> </div> <span class="lgnd-value-title">'+a.l+"</span></div>";e.append(f);a.z&&0<a.z.length&&a.z.forEach(function(c,a){f='<div class="lgnd-value lgnd-entry" data-index="'+b+","+a+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/>';f=c.v&&""!==c.v?f+('<div class="lgnd-viz" style="background-color: '+
c.v+'"></div>'):f+'<div class="lgnd-viz lgnd-viz-empty"></div>';f+=' <span class="lgnd-value-title">&raquo; '+c.l+"</span></div>";e.append(f)})});jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-sh input').prop("checked",!0)};
PVizFrame.prototype.createViz=function(a,b){function f(c){var a=jQuery(c.target).closest("div.lgnd-template").data("index");c=jQuery(c.target).val();e.setLegendFeatures(a,c);e.setLDirty(!0)}var e=this,g=PData.vByN(a);this.vizModel&&(this.vizModel.teardown(),this.vizModel=null);var d=jQuery("#view-frame-1");d.find("div.viz-content div.viz-result").empty();var k;switch(g.vf){case "M":k=new VizMap(this,g.c);break;case "p":k=new VizMap2(this,g.c);break;case "C":k=new VizCards(this,g.c);break;case "P":k=
new VizPinboard(this,g.c);break;case "T":k=new VizTime(this,g.c);break;case "D":k=new VizDirectory(this,g.c);break;case "t":k=new VizTextStream(this,g.c);break;case "N":k=new VizNetWheel(this,g.c)}this.vizSelIndex=a;var c=k.flags();c&V_FLAG_HSCRL?(d.find("div.viz-content").addClass("h-scroll"),d.find("div.viz-result").addClass("viz-fit-w"),d.find("div.viz-result").removeClass("viz-max-w")):(d.find("div.viz-content").removeClass("h-scroll"),d.find("div.viz-result").removeClass("viz-fit-w"),d.find("div.viz-result").addClass("viz-max-w"));
c&V_FLAG_VSCRL?(d.find("div.viz-content").addClass("v-scroll"),d.find("div.viz-result").addClass("viz-fit-h"),d.find("div.viz-result").removeClass("viz-max-h")):(d.find("div.viz-content").removeClass("v-scroll"),d.find("div.viz-result").removeClass("viz-fit-h"),d.find("div.viz-result").addClass("viz-max-h"));this.legendIDs=[];if(c&V_FLAG_LGND){d.find(".hslgnd").button("enable");var u=d.find("div.lgnd-container div.lgnd-scroll");u.empty();if(c&V_FLAG_SLGND){var h=k.getFeatureAtts(),m=PData.aByID(h);
u.append('<div class="lgnd-template" data-index="0"><div class="lgnd-title">'+m.def.l+'</div><div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div></div>');this.legendIDs.push(h);this.setLegendFeatures(0,h)}else{var G=!1;prspdata.e.g.ts.forEach(function(a,d){var b=PData.tByID(a),h=k.getLocAtts(d);if(h&&0<h.length||!(c&V_FLAG_LOC)){var m=k.getFeatureAtts(d);if(0<m.length){G&&u.append("<hr/>");var g=
jQuery('<div class="lgnd-template" data-index="'+d+'"><div class="lgnd-title">'+b.l+"</div></div>");h&&h.forEach(function(c,a){var d=PData.aByID(c);g.append('<div class="lgnd-entry lgnd-locate" data-id="'+c+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><span class="lgnd-value-title">'+d.def.l+"</span></div>")});var t='<select class="lgnd-select">';m.forEach(function(c,a){var d=PData.aByID(c);t+='<option value="'+c+'">'+d.def.l+"</option>"});t+="</select>";b=jQuery(t);b.change(f);
jQuery(g).append(b);jQuery(g).append('<div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div>');u.append(g);m=m[0];e.legendIDs.push(m);e.setLegendFeatures(d,m);G=!0}}})}d.find("div.lgnd-container").show()}else d.find("button.hslgnd").button("disable"),d.find("div.lgnd-container").hide();this.setLDirty(!1);d.find(".hilite").button("enable");c&V_FLAG_OPT?d.find(".vopts").button("enable"):d.find(".vopts").button("disable");
(h=k.hint())||"string"===typeof g.n&&""!==g.n?(d.find(".vnote").button("enable"),h=h?"string"===typeof g.n&&""!==g.n?h+(".<br/>"+g.n):h+".":g.n,jQuery("#vnotes-txt").empty().append(h)):d.find(".vnote").button("disable");k.setup();this.datastream&&b&&k.render(this.datastream);this.vizModel=k};PVizFrame.prototype.setViz=function(a,b){a!==this.vizSelIndex&&(jQuery("#view-frame-1 div.view-controls select.view-viz-select").val(a),this.createViz(a,b))};
PVizFrame.prototype.getSelLocAtts=function(a){var b=[];jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-locate input:checked').each(function(){var a=jQuery(this).parent().data("id");b.push(a)});return b};
PVizFrame.prototype.getSelFeatAtts=function(a){var b=[],f,e;jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group div.lgnd-value input:checked').each(function(){f=jQuery(this).parent().data("index");"number"==typeof f?b.push(f):-1!=(e=f.indexOf(","))?b.push([parseInt(f.substring(0,e),10),parseInt(f.substring(e+1),10)]):b.push(parseInt(f,10))});return b};PVizFrame.prototype.getSelLegend=function(a){return this.legendIDs[a]};
PVizFrame.prototype.getLgndSels=function(){return this.legendIDs.slice(0)};PVizFrame.prototype.setLgndSels=function(a){var b=this;a.forEach(function(a,e){a&&(jQuery('#view-frame-1 div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+e+'"] select.lgnd-select').val(a),b.setLegendFeatures(e,a))})};PVizFrame.prototype.getState=function(){return this.vizModel?this.vizModel.getState():null};PVizFrame.prototype.setState=function(a){this.vizModel&&this.vizModel.setState(a)};
PVizFrame.prototype.showStream=function(a){this.vizSel=[];this.selAbsIs=[];this.datastream=a;this.vizModel&&this.vizModel.render(a);this.setLDirty(!1)};PVizFrame.prototype.setStream=function(a){this.datastream=a};PVizFrame.prototype.clearSel=function(){this.selBtns(!1);this.vizModel&&this.vizModel.clearSel();this.selAbsIs=[];this.vizSel=[]};PVizFrame.prototype.setSel=function(a){this.selAbsIs=a.slice(0);this.vizModel&&this.computeSel();return!1};
PVizFrame.prototype.addSel=function(a){var b;b=_.sortedIndex(this.selAbsIs,a);this.selAbsIs[b]!==a&&(this.selAbsIs.splice(b,0,a),this.computeSel())};PVizFrame.prototype.delSel=function(a){a=_.sortedIndex(this.selAbsIs,a);this.selAbsIs.splice(a,1);this.computeSel()};PVizFrame.prototype.vizAddSel=function(a){var b;b=_.sortedIndex(this.selAbsIs,a);this.selAbsIs.splice(b,0,a);b=_.sortedIndex(this.vizSel,a);this.vizSel[b]!==a&&this.vizSel.splice(b,0,a);this.callbacks.addSel(1,a)};
PVizFrame.prototype.vizDelSel=function(a){var b;b=_.sortedIndex(this.selAbsIs,a);this.selAbsIs.splice(b,1);b=_.sortedIndex(this.vizSel,a);this.vizSel[b]===a&&this.vizSel.splice(b,1);this.callbacks.delSel(1,a)};PVizFrame.prototype.resize=function(){this.vizModel&&this.vizModel.resize()};PVizFrame.prototype.title=function(){return PData.vByN(this.vizSelIndex).l};PVizFrame.prototype.flushLgnd=function(){jQuery("#view-frame-1 div.lgnd-container").css("left","10px")};
PVizFrame.prototype.getBMData=function(){return this.vizModel?{t:this.vizModel.tUsed,r:this.vizModel.rMap}:null};var PTextFrame=function(a,b){this.tocVis=!1;this.volData=[];this.tocRL=[];this.tocSel=[];this.tocSelDirty=!1;this.bm=[];this.txtIDs=[];this.svg;PViewFrame.call(this,a,b)};PTextFrame.prototype=Object.create(PViewFrame.prototype);PTextFrame.prototype.constructor=PViewFrame;
PTextFrame.prototype.updateBookMark=function(){for(var a=0,b,f,e,g=0;g<this.tocSel.length;g++){b=this.tocSel[g];f=this.tocRL[g];e=this.bm[a++];e.sel=b.c;e.rl=f.c;for(var d=0;d<b.s.length;d++)e=this.bm[a++],e.sel=b.s[d],e.rl=f.s[d]}this.svg.selectAll(".bm").attr("class",function(a){return a.sel?"bm sel":"bm"}).attr("fill",function(a){return a.rl?"#0099FF":"#C0C0C0"})};
PTextFrame.prototype.searchFunc=function(a){var b=this,f,e;this.volData.forEach(function(g,d){f=!1;if(a(g.e,!0))f=!0;else for(e=jQuery(g.e).next();0!=e.length;)switch(e.prop("tagName").toUpperCase()){case "H1":case "H2":e=[];break;default:a(e,!1)?(f=!0,e=[]):e=e.next()}b.tocRL[d].c=f;g.s.forEach(function(g,c){f=!1;if(a(g.e,!0))f=!0;else for(e=jQuery(g.e).next();0!=e.length;)switch(e.prop("tagName").toUpperCase()){case "H1":case "H2":e=[];break;default:a(e,!1)?(f=!0,e=[]):e=e.next()}b.tocRL[d].s[c]=
f})});this.updateTOCRL();this.updateBookMark()};PTextFrame.prototype.findRec=function(a){this.searchFunc(function(b,f){var e,g,d,k=!1;if(!f)for(e=jQuery(b).children("a"),g=0;g<e.length;g++)if((d=jQuery(e[g]).data("id"))&&d===a){k=!0;break}return k})};
PTextFrame.prototype.updateTOCRL=function(){var a,b;a=jQuery("#toc-frame");this.tocRL.forEach(function(f,e){b=a.find('ul.toc-wrapper > li.toc-chap[data-c="'+e+'"]');b.find(".readlist-c").prop("checked",f.c);f.s.forEach(function(a,d){b.find('li[data-s="'+d+'"] > .readlist').prop("checked",a)})})};
PTextFrame.prototype.updateTOCSel=function(){var a,b;a=jQuery("#toc-frame");this.tocSel.forEach(function(f,e){b=a.find('ul.toc-wrapper > li.toc-chap[data-c="'+e+'"]');b.toggleClass("sel",f.c);f.s.forEach(function(a,d){b.find('li[data-s="'+d+'"]').toggleClass("sel",a)})})};
PTextFrame.prototype.buildTextFrame=function(){var a=this,b,f,e,g=jQuery("#read-pane");g.empty();this.tocSel.forEach(function(c,d){b=a.volData[d];if(c.c)for(g.append(jQuery(b.e).clone()),e=jQuery(b.e).next();0!=e.length;)switch(e.prop("tagName").toUpperCase()){case "H1":case "H2":e=[];break;default:g.append(e.clone()),e=e.next()}c.s.forEach(function(c,a){if(c)for(f=b.s[a],g.append(jQuery(f.e).clone()),e=jQuery(f.e).next();0!=e.length;)switch(e.prop("tagName").toUpperCase()){case "H1":case "H2":e=
[];break;default:g.append(e.clone()),e=e.next()}})});this.selAbsI=[];this.vizSel=[];this.txtIDs=[];this.selBtns(!1);var d=[],k;jQuery("#read-pane").find("a").each(function(c){c=jQuery(this).prop("href");if(-1!==(k=c.indexOf("#")))if(c=c.substr(k+1),jQuery(this).prop("href","#"),jQuery(this).attr("data-id",c),0===d.length)d.push(c);else{var a=_.sortedIndex(d,c);d[a]!==c&&d.splice(a,0,c)}else jQuery(this).addClass("no-data")});this.txtIDs=d;this.callbacks.newText()};
PTextFrame.prototype.initDOM=function(){function a(c,a,b){if(c)for(var e=0;e<d.tocSel.length;e++){c=d.tocSel[e];c.c=!1;for(var f=0;f<c.s.length;f++)c.s[f]=!1}c=d.tocSel[a];-1===b?c.c=!0:c.s[b]=!0;d.updateTOCSel();d.updateBookMark();d.buildTextFrame()}function b(c){jQuery(this).closest("li.toc-chap").find("ul.toc-secs").toggle();c.preventDefault()}function f(c){var a=c.target.dataset.c;if("undefined"!=typeof a){d.tocSelDirty=!0;var b=d.tocSel[a];b.c=!b.c;a=jQuery('#toc-frame > ul.toc-wrapper > li.toc-chap[data-c="'+
a+'"]');b.c?a.addClass("sel"):a.removeClass("sel");d.updateBookMark();c.preventDefault()}}function e(c){var a=c.target.dataset.s;if("undefined"!=typeof a){d.tocSelDirty=!0;var b=jQuery(c.target).closest("li.toc-chap"),e=b.data("c"),e=d.tocSel[e],e=e.s[a]=!e.s[a],a=b.find('ul.toc-secs > li[data-s="'+a+'"]');e?a.addClass("sel"):a.removeClass("sel");d.updateBookMark();c.preventDefault()}}function g(a){var b=a.target.checked,e;"readlist-c"===a.target.className?(a=jQuery(a.target).closest("li.toc-chap").data("c"),
d.tocRL[a].c=b):"readlist"===a.target.className&&(e=jQuery(a.target).closest("li").data("s"),a=jQuery(a.target).closest("li.toc-chap").data("c"),d.tocRL[a].s[e]=b);d.updateBookMark()}var d=this,k=0;jQuery("#view-frame-1");(function(){for(var a=jQuery("#prsp-volume").children(":first"),b=null,e=null,f=0;0!=a.length;){switch(a.prop("tagName").toUpperCase()){case "H1":null!=e&&(null!=b&&b.s.push(e),e=null);null!=b&&d.volData.push(b);b={e:a.get(0),s:[],l:0};break;case "H2":null!=e&&(null!=b&&b.s.push(e),
e=null);e={e:a.get(0),l:0};break;default:f=jQuery(a).contents().text().length,null!=e?e.l+=f:null!=b&&(b.l+=f)}a=a.next()}null!=e&&b.s.push(e);null!=b&&d.volData.push(b);d.volData.forEach(function(a){k=Math.max(k,a.l);var c={c:!0,s:[]},b={c:!1,s:[]};a.s.forEach(function(a){k=Math.max(k,a.l);c.s.push(!0);b.s.push(!1)});d.tocRL.push(c);d.tocSel.push(b)});d.tocSel[0].c=!0})();jQuery("#hstoc").button({icons:{primary:"ui-icon-bookmark"},text:!1}).click(function(a){d.tocVis=!d.tocVis;d.tocVis?(tour=tourTOC,
d.tocSelDirty=!1,jQuery("#toc-controls").show(),jQuery("#toc-frame").show(),jQuery("#text-controls").hide(),jQuery("#text-frame").hide()):(tour=tourTxt,d.tocSelDirty&&d.buildTextFrame(),jQuery("#toc-controls").hide(),jQuery("#toc-frame").hide(),jQuery("#text-controls").show(),jQuery("#text-frame").show());a.preventDefault()});jQuery("#tochcall").click(function(a){a=a.target.checked;for(var b=0;b<d.tocRL.length;b++){var e=d.tocRL[b];e.c=a;for(var f=0;f<e.s.length;f++)e.s[f]=a}d.updateTOCRL();d.updateBookMark()});
jQuery("#tochsall").click(function(a){d.tocSelDirty=!0;var b=a.target.checked;d.tocSel.forEach(function(a,c){var d=jQuery('#toc-frame > ul.toc-wrapper > li.toc-chap[data-c="'+c+'"]');a.c=b;for(i=0;i<a.s.length;i++)a.s[i]=b;b?(d.addClass("sel"),d.find("ul.toc-secs > li").addClass("sel")):(d.removeClass("sel"),d.find("ul.toc-secs > li").removeClass("sel"))});d.updateBookMark()});jQuery("#tocfind").button({icons:{primary:"ui-icon-star"},text:!1}).click(function(c){var b;b=jQuery("#dialog-find-toc").dialog({height:150,
width:250,modal:!0,buttons:[{text:dlText.ok,click:function(){var c=jQuery("#find-toc-txt").val();d.searchFunc(function(a,d){return d?-1!==a.innerHTML.indexOf(c):-1!==jQuery(a).contents().text().indexOf(c)});var e=0;a:for(;e<d.tocRL.length;e++){var f=d.tocRL[e];if(f.c){a(!0,e,-1);break}for(var g=0;g<f.s.length;g++)if(f.s[g]){a(!0,e,g);break a}}b.dialog("close")}},{text:dlText.cancel,click:function(){b.dialog("close")}}]});c.preventDefault()});jQuery("#textprev").button({icons:{primary:"ui-icon-arrow-1-w"},
text:!1}).click(function(c){c.preventDefault();var b=c=null,e,f,g;f=0;a:for(;f<d.tocSel.length;f++){e=d.tocSel[f];if(e.c){c=f-1;break}for(g=0;g<e.s.length;g++)if(e.s[g]){c=f;b=g-1;break a}}if(null!=c)for(;-1<c;){e=d.tocRL[c];for(null==b&&(b=e.s.length-1);-1<b;b--)if(e.s[b]){a(!0,c,b);return}b=null;if(e.c){a(!0,c,-1);break}c--}});jQuery("#textnext").button({icons:{primary:"ui-icon-arrow-1-e"},text:!1}).click(function(c){c.preventDefault();var b=c=null,e,f,g,k=!1;f=d.tocSel.length-1;a:for(;0<=f;f--){e=
d.tocSel[f];for(g=e.s.length-1;0<=g;g--)if(e.s[g]){b=g+1;g==e.s.length-1?(c=f+1,b=0,k=!0):c=f;break a}if(e.c){c=f;b=0;break}}if(null!=c)for(;c<d.tocRL.length;){e=d.tocRL[c];if(k&&e.c){a(!0,c,-1);break}for(;b<e.s.length;b++)if(e.s[b]){a(!0,c,b);return}b=0;c++;k=!0}});jQuery("#view-frame-0 .hilite").button({icons:{primary:"ui-icon-star"},text:!1}).click(function(a){jQuery("body").trigger("prospect",{s:PSTATE_HILITE,v:0,t:null});a.preventDefault()});jQuery("#view-frame-0 .osel").button({icons:{primary:"ui-icon-search"},
text:!1}).click(function(a){d.openSelection();a.preventDefault()});jQuery("#read-pane").click(function(a){var b,e,f,g=d.vizSel;b=a.target;"A"===b.nodeName&&(f=b.dataset.id,b=PData.nByID(f),null!=b&&(e=_.sortedIndex(g,b),g[e]===b?(g.splice(e,1),0===g.length&&d.selBtns(!1),d.selAbsIs.splice(_.sortedIndex(d.selAbsIs,b),1),d.callbacks.delSel(0,b),jQuery('#read-pane a[data-id="'+f+'"]').removeClass("sel")):(0===g.length?(d.selBtns(!0),g.push(b)):g.splice(e,0,b),d.selAbsIs.splice(_.sortedIndex(d.selAbsIs,
b),0,b),d.callbacks.addSel(0,b),jQuery('#read-pane a[data-id="'+f+'"]').addClass("sel")),a.preventDefault()))});(function(){document.getElementById("prsp-volume");var a,k=jQuery("#toc-frame > ul.toc-wrapper");k.empty();d.volData.forEach(function(b,d){a='<li class="toc-chap" data-c='+d+'><input type="checkbox" class="readlist-c"/> ';0<b.s.length&&(a+='<button class="toccollapse">Collapse</button> ');a+=b.e.innerHTML;a+='<ul class="toc-secs">';b.s.forEach(function(b,d){a+="<li data-s="+d+'><input type="checkbox" class="readlist"/>'+
b.e.innerHTML+"</li>"});a+="</ul></li>";k.append(a)});jQuery("#toc-frame > ul.toc-wrapper > li.toc-chap").click(f);jQuery("#toc-frame > ul.toc-wrapper > li.toc-chap > ul.toc-secs li").click(e);jQuery("#toc-frame > ul.toc-wrapper > li.toc-chap input[type=checkbox]").click(g);jQuery("#toc-frame .toccollapse").button({icons:{primary:"ui-icon-plus"},text:!1}).click(b)})();this.updateTOCRL();this.updateTOCSel();this.buildTextFrame();(function(){for(var a=0,b,e,f,g=[],D=0;D<d.tocSel.length;D++){b=d.tocSel[D];
e=d.tocRL[D];f=d.volData[D];g.push({i:a++,cI:D,sI:-1,l:Math.floor(12*f.l/k),sel:b.c,rl:e.c});for(var z=0;z<b.s.length;z++)g.push({i:a++,cI:D,sI:z,l:Math.floor(12*f.s[z].l/k),sel:b.s[z],rl:e.s[z]})}d.bm=g;d.svg=d3.select("#bookmark").append("svg");d.svg.selectAll(".bm").data(g).enter().append("rect").attr("class",function(a){return a.sel?"bm sel":"bm"}).attr("x",function(a){return 6*a.i}).attr("y",function(a){return 12-a.l}).attr("width","5").attr("height",function(a){return 2+a.l}).attr("fill",function(a){return a.rl?
"#0099FF":"#C0C0C0"})})()};PTextFrame.prototype.txtIDs2IS=function(){var a={s:[],t:[],l:0},b,f,e,g;f=0;for(e=PData.eTNum();f<e;f++)a.t.push({i:0,n:0});this.txtIDs.forEach(function(d){b=PData.nByID(d);if(null!=b){0===a.s.length?a.s.push(b):(f=_.sortedIndex(a.s,b),a.s.splice(f,0,b));g=PData.n2T(b);for(a.t[g++].n+=1;g<e;)a.t[g++].i+=1;a.l+=1}});return a};PTextFrame.prototype.clearSel=function(){this.selAbsIs=[];this.vizSel=[];this.selBtns(!1);jQuery("#read-pane a").removeClass("sel")};
PTextFrame.prototype.setSel=function(a){jQuery("#read-pane a").removeClass("sel");this.selAbsIs=a.slice(0);var b,f,e=[];a.forEach(function(a){if(b=PData.rByN(a))f=jQuery('#read-pane a[data-id="'+b.id+'"]'),0<f.length&&(f.addClass("sel"),e.push(a))});this.vizSel=e;0<e.length&&this.selBtns(!0);return!0};
PTextFrame.prototype.addSel=function(a){var b;b=_.sortedIndex(this.selAbsIs,a);this.selAbsIs.splice(b,0,a);b=PData.rByN(a);b=jQuery('#read-pane a[data-id="'+b.id+'"]');0<b.length&&(b.addClass("sel"),0===this.vizSel.length?(this.selBtns(!0),this.vizSel.push(a)):(b=_.sortedIndex(this.vizSel,a),this.vizSel.splice(b,0,a)))};
PTextFrame.prototype.delSel=function(a){var b;b=_.sortedIndex(this.selAbsIs,a);this.selAbsIs.splice(b,1);b=_.sortedIndex(this.vizSel,a);this.vizSel[b]===a&&(this.vizSel.splice(b,1),0===this.vizSel.length&&this.selBtns(!1),a=PData.rByN(a),jQuery('#read-pane a[data-id="'+a.id+'"]').removeClass("sel"))};
jQuery(document).ready(function(a){function b(a){var b=[];a.forEach(function(a){b.push({c:a.c,s:a.s.slice(0)})});return b}function f(a){var b=[],c;a.forEach(function(a){c=PData.rByN(a);null!=c&&b.push(c.id)});return b}function e(a){var b=[],c;a.forEach(function(a){c=PData.nByID(a);null!=c&&b.push(c)});return b}function g(a){var b={s:[],t:[],l:0},c,d,e;c=0;for(d=PData.eTNum();c<d;c++)b.t.push({i:0,n:0});a.forEach(function(a){0===b.s.length?b.s.push(a):(c=_.sortedIndex(b.s,a),b.s.splice(c,0,a));e=PData.n2T(a);
for(b.t[e++].n+=1;e<d;)b.t[e++].i+=1;b.l+=1});return b}function d(){PState.set(PSTATE_PROCESS);null==A&&(A=PData.sNew(!0));r=A;PState.set(PSTATE_BUILD)}function k(a){var b=jQuery("#annote");b.text(a);0<a.length?(jQuery("#btn-annote").button("enable"),b.show()):(jQuery("#btn-annote").button("disable"),b.hide())}function c(a){var b=_.find(prspdata.p,function(b){return a==b.id});return b?b:null==y||0==q.length?null:(b=_.find(q,function(b){return a==b.id}))?b:null}function u(a,c){var d=n[0],e=n[1],g=
jQuery("input[name=save-reading-dest]:checked").val();if(""==g)return null;var k=jQuery("#save-reading-note").val(),k=k.replace(/"/g,""),h={rl:b(d.tocRL),sel:b(d.tocSel),vm:x,h0:null,h1:null,recs:null,v1:null};e&&(h.v1={l:e.title(),s:e.getState()});switch(jQuery("input[name=select-read-by]:checked").val()){case "recs":h.recs=[f(d.vizSel),f(e.vizSel)];break;case "h0":h.h0={id:p[0],s:t[0].getState()};break;case "h1":h.h1={id:p[1],s:t[1].getState()}}var L={id:a,l:c,n:k,s:h};"local"==g?(q.push(L),y.setItem(prspdata.e.id,
JSON.stringify(q))):"server"==g&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_save_reading",id:a,l:c,x:prspdata.e.id,n:k,s:JSON.stringify(h)},success:function(a,b,c){"0"!=a&&prspdata.p.push(L)},error:function(a,b,c){alert(c)}});return g}function h(){var a,b=[],c=!1;(function(){var a=jQuery("#reading-mlist");a.empty();q.forEach(function(b){a.append('<li data-type="l" data-id="'+b.id+'"><span class="label">'+b.l+'</span> <button class="del">'+dlText.del+'</button> <button class="edit">'+
dlText.edit+"</button></li>")});for(var c=0;c<y.length;c++){var d=y.key(c);if(d!=prspdata.e.id){var l=y.getItem(d);b.push({id:d,ps:JSON.parse(l)})}}b.forEach(function(b,c){b.ps.forEach(function(d){a.append('<li data-type="x" data-xid="'+b.id+'" data-xindex="'+c+'" data-id="'+d.id+'"><i class="label">'+d.l+'</i> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")})})})();jQuery("#reading-mlist").click(function(a){if("BUTTON"==a.target.nodeName){var d=jQuery(a.target).hasClass("del"),
l=jQuery(a.target).parent(),e=l.data("type"),f=l.data("id");if(d){switch(e){case "l":a=q.findIndex(function(a){return f==a.id});-1!=a&&(q.splice(a,1),0==q.length?y.removeItem(prspdata.e.id):y.setItem(prspdata.e.id,JSON.stringify(q)));break;case "x":a=l.data("xindex"),d=b[a],a=d.ps.findIndex(function(a){return f==a.id}),-1!=a&&(d.ps.splice(a,1),c=!0)}l.remove()}else{var g;switch(e){case "l":g=_.find(q,function(a){return f==a.id});break;case "x":a=l.data("xindex"),d=b[a],g=_.find(d.ps,function(a){return f==
a.id})}jQuery("#edit-reading-lbl").val(g.l);jQuery("#edit-reading-note").val(g.n);var k=jQuery("#dialog-edit-reading").dialog({width:340,height:270,modal:!0,buttons:[{text:dlText.ok,click:function(){g.l=jQuery("#edit-reading-lbl").val();g.n=jQuery("#edit-reading-note").val();l.find(".label").text(g.l);"x"==e?c=!0:y.setItem(prspdata.e.id,JSON.stringify(q));k.dialog("close")}},{text:dlText.cancel,click:function(){k.dialog("close")}}]})}}});a=jQuery("#dialog-manage-reading").dialog({width:450,height:350,
modal:!0,buttons:[{text:dlText.ok,click:function(){c&&b.forEach(function(a){0<a.ps.length?y.setItem(a.id,JSON.stringify(a.ps)):y.removeItem(a.id)});jQuery("#reading-mlist").off("click");a.dialog("close")}}]})}function m(a){window.location.href=prspdata.e.g.hurl;a.preventDefault()}function G(a,b,c){var d;if("_remove"==a)d=new PFilterRemove(c),a={t:[!0,!0,!0,!0]};else switch(a=PData.aByID(a),a.def.t){case "V":d=new PFilterVocab(c,a);break;case "T":d=new PFilterText(c,a);break;case "g":d=new PFilterTags(c,
a);break;case "N":d=new PFilterNum(c,a);break;case "D":d=new PFilterDates(c,a);break;case "P":d=new PFilterPtr(c,a)}jQuery("#dialog-hilite-"+c+" span.filter-id").html(a.def.l);jQuery("#hilite-"+c).empty();d.setup();return d}function D(a,b,c,d){jQuery("#filter-list li").removeClass("selected");var e,f,g,k;jQuery("#filter-list li").each(function(b){e=jQuery(this);f=e.data("id");"_remove"==f?a?e.show():e.hide():c?(g=PData.aByID(f),k=!1,g.t.forEach(function(a,b){k=k||a&&c[b]}),k?e.show():e.hide()):e.show()});
var h,n={height:300,width:350,modal:!0,buttons:[{text:dlText.add,click:function(){var a=jQuery("#filter-list li.selected");1===a.length&&d(a.data("id"));h.dialog("close")}},{text:dlText.cancel,click:function(){h.dialog("close")}}]};b&&(n.appendTo="#dialog-2");h=jQuery("#dialog-choose-att").dialog(n)}function z(a){var b=t[a],c=n[0],d=n[1],e=0,f,k=0,h,m=[];PState.set(PSTATE_PROCESS);if(0===a){var p=c.txtIDs2IS();jQuery("#read-pane a").removeClass("sel");b.evalPrep();h=p.t[0];a:for(;e<p.l;){for(;0==
h.n||h.i+h.n==e;){if(++k===PData.eTNum())break a;h=p.t[k];e=h.i}a=p.s[e++];f=PData.rByN(a);b.eval(f)&&m.push(a)}b.evalDone(p.l);PState.set(PSTATE_UPDATE);switch(x){case "v0":case "v1":0<m.length?(c.setSel(m),d.setSel(m)):(c.clearSel(),d.clearSel());break;case "v2":0<m.length?c.setSel(m):c.clearSel(),d.clearSel(),r=g(m),d.showStream(r)}}else{p=d.getBMData();if(null!=r){b.evalPrep();h=r.t[0];a:for(;e<r.l;){for(;!p.t[k]||0==h.n||h.i+h.n==e;){if(++k===PData.eTNum())break a;h=r.t[k];e=h.i}a=r.s[e++];p.r[a>>
4]&1<<(a&15)&&(f=PData.rByN(a),b.eval(f)&&m.push(a))}b.evalDone(r.l)}PState.set(PSTATE_UPDATE);0<m.length?(d.setSel(m),"v2"!==x&&c.setSel(m)):(d.clearSel(),"v2"!==x&&c.clearSel())}PState.set(PSTATE_READY)}function J(a,b){var c;c=jQuery("#dialog-hilite-"+a).dialog({height:275,width:Math.min(jQuery(window).width()-20,675),modal:!0,appendTo:"#dialog-1",buttons:[{text:dlText.chsatt,click:function(){D(!1,!0,b,function(b){p[a]=b;t[a]=G(b,null,a)})}},{text:dlText.ok,click:function(){c.dialog("close");null!==
t[a]&&z(a)}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})}function C(a){function f(a,b){var c=G(b.id,null,a),d=a^1;p[a]=b.id;t[a]=c;c.setState(b.s);p[d]=null;t[d]=null}var g=n[0],h=n[1];a=c(a);if(null==a)return!1;PState.set(PSTATE_PROCESS);g.tocRL=b(a.s.rl);g.tocSel=b(a.s.sel);x=a.s.vm;jQuery("#command-bar input[type=radio][name=vizmode]").val([x]);PState.set(PSTATE_BUILD);g.updateTOCRL();g.updateTOCSel();g.updateBookMark();g.buildTextFrame();vI=function(a){return prspdata.e.vf.findIndex(function(b){return a===
b.l})}(a.s.v1.l);h?(h.setViz(vI,!0),h.selBtns(!1)):(n[1]=new PVizFrame(1,H),h=n[1],h.initDOM(vI));h.setState(a.s.v1.s);k(a.n);null!=a.s.h0?f(0,a.s.h0):null!=a.s.h1?(f(1,a.s.h1),g.clearSel()):(p[0]=p[1]=t[0]=t[1]=null,g.setSel(e(a.s.recs[0])),"v2"!==x?(h.setSel(e(a.s.recs[1])),E=null):E=a.s.recs[1]);PData.ready()&&A&&(d(),null!=p[0]&&z(0),B(),null!=p[1]?z(1):null!=E&&(h.setSel(e(E)),E=null));return!0}function B(){var a=n[0],b=n[1];if(null!=A)switch(x){case "v0":r=A;b.showStream(A);a=a.vizSel;0<a.length?
b.setSel(a.slice(0)):b.clearSel();break;case "v1":r=a.txtIDs2IS();b.showStream(r);a=a.vizSel;0<a.length?b.setSel(a.slice(0)):b.clearSel();break;case "v2":b.clearSel(),r=g(a.vizSel),b.showStream(r)}}var n=[null,null],t=[null,null],p=[null,null],A=null,r=null,y=null,q=[],x="v1",H,E=null;jQuery("body").addClass("waiting");(function(a,b){var c=prspdata.bClrs[a];c&&0<c.length&&jQuery(b).css("background-color",c)})("cb","#command-bar");PState.init();"undefined"!==typeof PMapHub&&PMapHub.init(prspdata.m);
(function(){function a(c,d){b=document.getElementById(c).innerHTML;dlText[d]=b.trim()}var b;a("dltext-removehideall","rha");a("dltext-showhideall","sha");a("dltext-ok","ok");a("dltext-cancel","cancel");a("dltext-next","next");a("dltext-prev","prev");a("dltext-choose-att","chsatt");a("dltext-seerec","seerec");a("dltext-close","close");a("dltext-add","add");a("dltext-manage","manage");a("dltext-delete","del");a("dltext-edit","edit");a("dltext-markers","markers");a("dltext-hint-marker","markersize");
a("dltext-hint-text","textsize");a("dltext-xaxis","xaxis");a("dltext-yaxis","yaxis");a("dltext-undefined","undef");a("dltext-orderedby","orderedby");a("dltext-grpblks","grpblks");a("dltext-reset","reset");a("dltext-nofilter","nofilter");a("dltext-dofilters","dofilters");a("dltext-filtered","filtered");a("dltext-findintext","findintext");b=document.getElementById("dltext-month-names").innerHTML;months=b.trim().split("|");(b=document.getElementById("dltext-d3-local"))&&(b=b.innerHTML.trim())&&"no-d3-local"!==
b&&(localD3=d3.locale(JSON.parse(b)).timeFormat.multi([["%H:%M",function(a){return a.getMinutes()}],["%H:%M",function(a){return a.getHours()}],["%a %d",function(a){return a.getDay()&&1!=a.getDate()}],["%b %d",function(a){return 1!=a.getDate()}],["%B",function(a){return a.getMonth()}],["%Y",function(){return!0}]]))})();volURL=window.location.pathname;volURL=volURL.replace(/\&*reading=[\w\-]+/,"");volURL=volURL.replace(/\/$/,"");volURL=volURL.replace(/^\//,"");volURL="http://"+window.location.host+
"/"+volURL;(function(){var a=_.template(document.getElementById("dltext-filter-template").innerHTML),b=[];prspdata.t.forEach(function(c,d){b.push(a({ti:d,tl:c.def.l}))});apTmStr=b.join("&nbsp;")})();(function(){var a;prspdata.t.forEach(function(b,c){var d="";b.def.a.forEach(function(b){a=PData.aByID(b);switch(a.def.t){case "T":case "V":case "N":case "D":d+='<option value="'+b+'">'+a.def.l+"</option>"}});jQuery("#dialog-sortby").append("<b>"+b.def.l+"</b>: <select data-ti="+c+">"+d+"</select><br/>")})})();
"/"!=prspdata.site_url.charAt(prspdata.site_url.length-1)&&(prspdata.site_url+="/");""!=prspdata.e.g.l&&jQuery("#title").text(prspdata.e.g.l);try{var I=window.localStorage;I.setItem("__storage_test__","__storage_test__");I.removeItem("__storage_test__");var K=I.getItem(prspdata.e.id),y=I;0<K.length&&(q=JSON.parse(K))}catch(l){}jQuery("#btn-about").button({icons:{primary:"ui-icon-power"},text:!1}).click(function(a){var b;jQuery("#dialog-about img").removeClass("zoomin");b=jQuery("#dialog-about").dialog({height:390,
width:350,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close")}}]});jQuery("#dialog-about img").addClass("zoomin");a.preventDefault()});jQuery("#btn-show-reading").button({icons:{primary:"ui-icon-image"},text:!1}).click(function(a){var b=jQuery("#reading-slist");b.empty();prspdata.p.forEach(function(a){b.append('<li data-src="server" data-id="'+a.id+'">'+a.l+"</li>")});q.forEach(function(a){b.append('<li data-src="local" data-id="'+a.id+'">'+a.l+"</li>")});var c=[{text:dlText.ok,click:function(){d.dialog("close");
var a=b.find("li.selected");a.length&&(a=a.data("id"),C(a),PState.set(PSTATE_READY))}},{text:dlText.cancel,click:function(){d.dialog("close")}}];y&&c.push({text:dlText.manage,click:function(){d.dialog("close");h()}});var d=jQuery("#dialog-show-reading").dialog({width:350,height:350,modal:!0,buttons:c});a.preventDefault()});jQuery("#btn-save-reading").button({icons:{primary:"ui-icon-pencil"},text:!1}).click(function(a){var b,d=/[^\w\-]/;jQuery("#save-reading-id").val("");jQuery("#save-reading-lbl").val("");
jQuery("#save-reading-note").val("");y||jQuery("#save-reading-d-1").prop("disabled",!0);prspdata.x.add_reading||jQuery("#save-reading-d-2").prop("disabled",!0);jQuery("#read-by-h0").prop("disabled",null==t[0]);jQuery("#read-by-h1").prop("disabled",null==t[1]);b=jQuery("#dialog-save-reading").dialog({width:350,height:420,modal:!0,buttons:[{text:dlText.ok,click:function(){var a=jQuery("#save-reading-id").val().trim(),e=a.match(d),f=jQuery("#save-reading-lbl").val().trim(),f=f.replace(/"/g,"");if(0===
a.length||20<a.length||e)e="#dialog-reading-id-badchars";else if(c(a))e="#dialog-reading-id-used";else if(0===f.length||32<f.length)e="#dialog-reading-label-bad";if(e)var g=jQuery(e).dialog({width:320,height:210,modal:!0,buttons:[{text:dlText.ok,click:function(){g.dialog("close")}}]});else if(e=u(a,f),b.dialog("close"),"server"==e){a=volURL+"/?reading="+a;jQuery("#save-reading-embed").val(a);var h=jQuery("#dialog-reading-url").dialog({width:480,height:230,modal:!0,buttons:[{text:dlText.ok,click:function(){h.dialog("close")}}]})}}},
{text:dlText.cancel,click:function(){b.dialog("close")}}]});a.preventDefault()});jQuery("#btn-annote").button({icons:{primary:"ui-icon-comment"},text:!1}).click(function(a){jQuery("#annote").toggle("slide",{direction:"right"});a.preventDefault()});jQuery("#clearsel").click(function(a){var b=n[0],c=n[1];PState.set(PSTATE_UPDATE);b.clearSel();switch(x){case "v0":case "v1":c.clearSel();break;case "v2":c.selBtns(!1),r=g([]),c.showStream(r)}PState.set(PSTATE_READY);a.preventDefault()});jQuery("#command-bar input[type=radio][name=vizmode]").change(function(){x=
this.value;n[0].clearSel();n[1].clearSel();null!=A&&B()});0<prspdata.e.g.hbtn.length&&0<prspdata.e.g.hurl.length?(jQuery("#home-title").text(prspdata.e.g.hbtn),jQuery("#btn-home").button({icons:{primary:"ui-icon-home"},text:!1}).click(m)):jQuery("#btn-home").remove();jQuery("#filter-list").click(function(a){"I"==a.target.nodeName?(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).parent().addClass("selected")):"LI"==a.target.nodeName&&(jQuery("#filter-list li").removeClass("selected"),
jQuery(a.target).addClass("selected"))});jQuery("#reading-slist").click(function(a){"LI"==a.target.nodeName&&(jQuery("#reading-slist li").removeClass("selected"),jQuery(a.target).addClass("selected"))});jQuery("#dialog-about .logo").attr("src",prspdata.assets+"prospectlogo.jpg");jQuery("#btn-inspect-left").button({icons:{primary:"ui-icon-arrowthick-1-w"},text:!1});jQuery("#btn-inspect-right").button({icons:{primary:"ui-icon-arrowthick-1-e"},text:!1});(function(){jQuery("#filter-list").append('<li class="remove" data-id="_remove"><i>'+
dlText.rha+"</i></li>");prspdata.a.forEach(function(a){switch(a.def.t){case "V":case "T":case "g":case "N":case "D":case "P":jQuery("#filter-list").append('<li data-id="'+a.id+'">'+a.def.l+"</li>")}})})();H={addSel:function(a,b){var c=n[a^1];switch(x){case "v0":case "v1":c.addSel(b);break;case "v2":0===a&&B()}},delSel:function(a,b){var c=n[a^1];switch(x){case "v0":case "v1":c.delSel(b);break;case "v2":0===a&&B()}},newText:function(){var a=n[1];null!=a&&a.clearSel();B()},textFrame:null};n[0]=new PTextFrame(0,
H);n[0].initDOM();H.textFrame=n[0];0!==prspdata.show_reading.length&&C(prspdata.show_reading)||(n[1]=new PVizFrame(1,H),n[1].initDOM(0),k(""));jQuery(window).resize(function(){n[1]&&n[1].resize()});jQuery("body").on("prospect",function(a,b){switch(b.s){case PSTATE_PROCESS:PState.set(PSTATE_PROCESS);d();null!=p[0]&&z(0);B();null!=p[1]?z(1):null!=E&&(v1.setSel(e(E)),E=null);PState.set(PSTATE_READY);jQuery("body").removeClass("waiting");break;case PSTATE_HILITE:J(b.v,b.t)}});PState.set(PSTATE_LOAD);
PData.init();prspdata.x.tour?(a=function(a,b){for(var c={id:b,showPrevButton:!0,i18n:{nextBtn:dlText.next,prevBtn:dlText.prev,doneBtn:dlText.close},steps:[]},d=jQuery(a).children(":first");0!=d.length;){var e={target:jQuery(d).data("t"),placement:jQuery(d).data("p"),title:jQuery(d).data("l"),xOffset:jQuery(d).data("x"),yOffset:jQuery(d).data("y"),content:jQuery(d).contents().text()};c.steps.push(e);d=d.next()}return c},tourTxt=a("#help-txt-tour","helpTxt"),tourTOC=a("#help-toc-tour","helpTOC"),tour=
tourTxt,jQuery("#command-bar .help").click(function(){hopscotch.startTour(tour)})):jQuery("#command-bar .help").hide()});function onYouTubeIframeAPIReady(){widgetData.ytCall&&widgetData.ytCall()};