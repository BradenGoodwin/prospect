var VizStackChart=function(b,a){PVizModel.call(this,b,a)};VizStackChart.prototype=Object.create(PVizModel.prototype);VizStackChart.prototype.constructor=VizStackChart;VizStackChart.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SLGND|V_FLAG_VSCRL|V_FLAG_HSCRL};VizStackChart.prototype.getFeatureAtts=function(b){return this.settings.sAtt};
VizStackChart.prototype.setup=function(){var b=this.settings.h;this.xScale=d3.scale.linear();this.yScale=d3.scale.linear().range([0,b-1]);this.rScale=d3.scale.ordinal();this.xAxis=d3.svg.axis().scale(this.rScale).orient("top");this.yAxis=d3.svg.axis().scale(this.yScale).orient("left").ticks(10);this.svg=d3.select(this.frameID).append("svg");this.chart=this.svg.append("g");this.chart.attr("class","chart").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")");this.svg.append("g").attr("class",
"x axis").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")");this.svg.append("g").attr("class","y axis").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")")};
VizStackChart.prototype.render=function(b){var a=this;this.bSel=[];var c=this.settings.oAtt,d=PData.aByID(c),l=this.settings.sAtt;this.cats="g"!==d.def.t?this.settings.gr?PData.cRNew(d,!0,!0):PData.cLNew(d,null,!0):[];PData.cFill(this.cats,c,l,b);var e=0;this.cats.forEach(function(a){e=Math.max(e,a.l.length)});this.colW=e=Math.max(D3FG_BAR_WIDTH,8*e+4);b=this.cats.length*e;c=this.settings.h;this.xScale.domain([0,this.cats.length]).rangeRound([0,b]);this.rScale.rangeRoundBands([0,b]);this.rScale.domain(this.cats.map(function(a){return a.l}));
this.svg.attr("width",b+D3SC_MARGINS.left+D3SC_MARGINS.right).attr("height",c+D3SC_MARGINS.top+D3SC_MARGINS.bottom);this.svg.selectAll(".block").remove();this.blocks=[];l=PData.aByID(l);b=0;for(var c=a.vFrame.getSelFeatAtts(0),c=PData.cLNew(l,c,!0),g=0;g<this.cats.length;g++){if(0<g)for(d=0;d<c.length;d++)c[d].i=[];PData.cSort(a.cats[g].i,l,c);var f=0;c.forEach(function(d){0<d.i.length&&(a.blocks.push({x:g,c:d.c,y:f,h:d.i.length,a:d.i}),f+=d.i.length)});b=Math.max(b,f)}a.yScale.domain([0,b]);a.svg.select(".x.axis").call(a.xAxis);
a.svg.select(".y.axis").call(a.yAxis);l=a.colW-7;this.svg.selectAll(".block").data(a.blocks).enter().append("rect").attr("class","block").attr("x",function(d){return D3SC_MARGINS.left+5+a.xScale(d.x)}).attr("y",function(d){return a.yScale(d.y)+D3SC_MARGINS.top}).attr("fill",function(a){return a.c}).attr("height",function(d){return Math.max(1,a.yScale(d.h)-1)}).attr("width",l).on("click",function(d,c){var b=a.bSel.length,g=_.sortedIndex(a.bSel,c);a.bSel[g]===c?(d3.select(this).classed("obj-sel",!1),
a.bSel.splice(g,1),0<b&&0==a.bSel.length&&a.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),a.bSel.splice(g,0,c),0==b&&0<a.bSel.length&&a.vFrame.selBtns(!0))})};VizStackChart.prototype.setSel=function(b){};VizStackChart.prototype.clearSel=function(){0<this.bSel.length&&(this.bSel=[],this.svg.selectAll(".block").classed("obj-sel",!1))};VizStackChart.prototype.getSel=function(){var b=this,a=[];this.bSel.forEach(function(c){a=PData.union(a,b.blocks[c].a)});return a};
VizStackChart.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}};VizStackChart.prototype.setState=function(b){this.vFrame.setLgndSels(b.l)};VizStackChart.prototype.hint=function(){var b=dlText.xaxis+": ",a=PData.aByID(this.settings.oAtt),b=b+(a.def.l+", "+dlText.yaxis+": "),a=PData.aByID(this.settings.sAtt);return b+=a.def.l};var VizFlow=function(b,a){PVizModel.call(this,b,a)};VizFlow.prototype=Object.create(PVizModel.prototype);VizFlow.prototype.constructor=VizFlow;
VizFlow.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL};VizFlow.prototype.setup=function(){this.bH=Math.max(120,Math.ceil(this.settings.w/3));var b=40+(this.settings.fcts.length-1)*this.bH;this.svg=d3.select(this.frameID).append("svg").attr("width",this.settings.w+10).attr("height",b);this.barG=this.svg.append("g");this.flowG=this.svg.append("g");this.titleG=this.svg.append("g")};
VizFlow.prototype.render=function(b){var a=this;this.bSel=[];this.fSel=[];this.barG.selectAll(".bar").remove();this.flowG.selectAll(".flow").remove();this.titleG.selectAll(".att-title").remove();var c=this.settings.w;a.bars=[];a.atts=[];a.settings.fcts.forEach(function(d,l){var e,g=PData.aByID(d);e="g"!==g.def.t?a.settings.gr?PData.cRNew(g,!0,!0):PData.cLNew(g,null,!0):[];PData.cFill(e,d,null,b);var f=[],k=0;e.forEach(function(a){0<a.i.length&&(f.push(a),k+=a.i.length)});var h=0,m=31+l*a.bH;f.forEach(function(d){a.bars.push({x:5+
h*c/k,w:d.i.length*c/k,y:m,c:d});h+=d.i.length});a.atts.push({l:g.def.l,c:f,t:k,y:m})});this.barG.selectAll(".bar").data(a.bars).enter().append("rect").attr("class","bar").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("fill",function(a){return a.c.c}).attr("height","8").attr("width",function(a){return a.w}).on("click",function(d,c){var b=a.bSel.length,g=_.sortedIndex(a.bSel,c);a.bSel[g]===c?(d3.select(this).classed("obj-sel",!1),a.bSel.splice(g,1),0<b&&0===a.bSel.length&&
0===a.fSel.length&&a.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),a.bSel.splice(g,0,c),0===b&&0===a.fSel.length&&0<a.bSel.length&&a.vFrame.selBtns(!0))}).append("title").text(function(a){return a.c.l+" ("+a.c.i.length+")"});a.ints=[];a.atts.forEach(function(d,b){if(b!==a.atts.length-1){for(var e=a.atts[b+1],g=Array(d.c.length),f=0;f<d.c.length;f++)g[f]=Array(e.c.length);d.c.forEach(function(a,d){e.c.forEach(function(c,b){g[d][b]=PData.intersect(a.i,c.i)})});for(var k=Array(e.c.length),
h=0;h<e.c.length;h++){for(var m=0,f=0;f<d.c.length;f++)0<g[f][h].length&&m++;k[h]=m-1}for(var n=Array(e.c.length),h=0;h<e.c.length;h++)n[h]=0;var u=0;d.c.forEach(function(b,h){for(var m=0,f=0;f<e.c.length;f++)0<g[h][f].length&&m++;--m;var l=b.i.length*c/d.t,x=0,v=0;e.c.forEach(function(f,p){var w=g[h][p];if(0<w.length){var q=w.length*c,y=q/d.t,q=q/e.t,z=f.i.length*c/e.t;a.ints.push({i:w,c:b.c,l:b.l+" > "+f.l,x1:5+u*c/d.t+(m?(l-y)*x/m:0),x2:5+v*c/e.t+(k[p]?(z-q)*n[p]/k[p]:0),w1:y,w2:q,y1:d.y+10,y2:e.y-
1});x++;n[p]++}v+=f.i.length});u+=b.i.length})}});this.flowG.selectAll(".flow").data(a.ints).enter().append("path").attr("class","flow").attr("d",function(a){return"M "+a.x1+" "+a.y1+"  L "+(a.x1+a.w1)+" "+a.y1+" L "+(a.x2+a.w2)+" "+a.y2+" L "+a.x2+" "+a.y2+" L "+a.x1+" "+a.y1}).attr("fill",function(a){return a.c}).on("click",function(b,c){var e=a.fSel.length,g=_.sortedIndex(a.fSel,c);a.fSel[g]===c?(d3.select(this).classed("obj-sel",!1),a.fSel.splice(g,1),0<e&&0===a.fSel.length&&0===a.bSel.length&&
a.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),a.fSel.splice(g,0,c),0===e&&0===a.bSel.length&&0<a.fSel.length&&a.vFrame.selBtns(!0))}).on("mouseover",function(){d3.select(this).classed("active",!0);this.parentElement.appendChild(this)}).on("mouseout",function(){d3.select(this).classed("active",!1)}).append("title").text(function(a){return a.l+" ("+a.i.length+")"});this.titleG.selectAll(".att-title").data(a.atts).enter().append("text").attr("class","att-title").attr("x","5").attr("y",
function(a){return a.y-8}).text(function(a){return a.l})};VizFlow.prototype.setSel=function(b){};VizFlow.prototype.clearSel=function(){0<this.bSel.length&&(this.bSel=[],this.svg.selectAll(".bar").classed("obj-sel",!1));0<this.fSel.length&&(this.fSel=[],this.svg.selectAll(".flow").classed("obj-sel",!1))};VizFlow.prototype.getSel=function(){var b=this,a=[];this.bSel.forEach(function(c){a=PData.union(a,b.bars[c].c.i)});this.fSel.forEach(function(c){a=PData.union(a,b.ints[c].i)});return a};
var VizBrowser=function(b,a){PVizModel.call(this,b,a);this.stream=null};VizBrowser.prototype=Object.create(PVizModel.prototype);VizBrowser.prototype.constructor=VizBrowser;VizBrowser.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL};VizBrowser.prototype.setup=function(){var b=250*this.settings.fcts.length;this.svg=d3.select(this.frameID).append("svg").attr("width",b);this.pState=null};
VizBrowser.prototype.update=function(){var b=this,a=this.vFrame.getIndex();PState.set(PSTATE_UPDATE);var c=null,d,l=!1;this.fcts.forEach(function(a){-1!=a.s&&(l=!0,d=a.c[a.s].i,c=c?PData.intersect(c,d):d)});l?this.vFrame.selBtns(0<c.length):(this.vFrame.selBtns(!1),c=this.stream.s);this.recSel=c;this.fcts.forEach(function(d){b.svg.select("#facet-"+a+"-"+d.i).selectAll(".facet-val-bar").data(d.c).transition().attr("width",function(a){return 0<c.length?242*PData.intersect(c,a.i).length/c.length:0})});
PState.set(PSTATE_READY)};
VizBrowser.prototype.render=function(b){var a=this,c=this.vFrame.getIndex();this.recSel=[];this.stream=b;this.svg.selectAll(".facet-col").remove();var d=0;this.fcts=[];this.settings.fcts.forEach(function(c,e){var k,h=PData.aByID(c);k="g"===h.def.t?[]:a.settings.gr?PData.cRNew(h,!0,!0):PData.cLNew(h,null,!0);PData.cFill(k,c,null,b);var m=[],n=0;k.forEach(function(a){0<a.i.length&&(a.n=n++,m.push(a))});a.fcts.push({c:m,x:250*e,i:e,l:h.def.l,n:h.id,s:-1});d=Math.max(d,27+22*(m.length+1))});a.svg.attr("height",
d);var l=a.svg.selectAll(".facet-col").data(a.fcts).enter().append("g").attr("transform",function(a){return"translate("+a.x+", 0)"}).attr("class","facet-col").attr("id",function(a){return"facet-"+c+"-"+a.i});l.append("rect").attr("class","facet-lbl").attr("height",24).attr("width",242);l.append("text").attr("class","facet-lbl-txt").attr("x",3).attr("y",18).attr("text-anchor","start").text(function(a){return a.l});var e;a.fcts.forEach(function(d){var f="#facet-"+c+"-"+d.i,k=null,h;null!=a.pState&&
a.pState.p.find(function(a){return d.n===a.f?(-1!==(h=d.c.findIndex(function(d){return a.v===d.l}))&&(d.s=h,k=a),!0):!1});e=a.svg.select(f).selectAll(".facet-reset").data([1]).enter().append("g").attr("transform","translate(0,26)").attr("class",function(a){return k?"facet-reset":"facet-reset inactive"}).attr("height",19).on("click",function(c){-1!==d.s&&(d.s=-1,a.svg.select(f).selectAll(".facet-val").classed("inactive",!1),d3.select(this).classed("inactive",!0),a.update())});e.append("rect").attr("class",
"facet-reset-btn").attr("height",19).attr("width",242);e.append("text").attr("class","facet-reset-txt").attr("x",3).attr("y",13).text(dlText.reset);e=a.svg.select(f).selectAll(".facet-val").data(d.c).enter().append("g").attr("transform",function(a,d){return"translate(0,"+(27+22*(d+1))+")"}).attr("class",function(a,d){return k?d===h?"facet-val":"facet-val inactive":"facet-val"}).on("click",function(c,b){var k=a.svg.select(f).select(".facet-reset");d.s!==b?(d.s=b,a.svg.select(f).selectAll(".facet-val").classed("inactive",
function(a){return b!==a.n}),k.classed("inactive",!1)):(a.svg.select(f).selectAll(".facet-val").classed("inactive",!1),d.s=-1,k.classed("inactive",!0));a.update()});e.append("rect").attr("class","facet-val-btn").attr("height",21).attr("width",242);e.append("rect").attr("class","facet-val-bar").attr("height",21).attr("width",function(a){return 0<b.l?242*a.i.length/b.l:0});e.append("text").attr("class","facet-val-txt").attr("x",3).attr("y",16).text(function(a){return a.l});e.append("text").attr("class",
"facet-val-num").attr("x",239).attr("y",16).text(function(a){return a.i.length})});null!=this.pState&&(this.update(),this.pState=null)};VizBrowser.prototype.setSel=function(b){};VizBrowser.prototype.clearSel=function(){var b=this,a=this.vFrame.getIndex();this.fcts.forEach(function(c){c.s=-1;c="#facet-"+a+"-"+c.i;b.svg.select(c).select(".facet-reset").classed("inactive",!0);b.svg.select(c).selectAll(".facet-val").classed("inactive",!1)});this.update()};VizBrowser.prototype.getSel=function(){return this.recSel};
VizBrowser.prototype.getState=function(){var b=[];this.fcts.forEach(function(a){-1!==a.s&&b.push({f:a.n,v:a.c[a.s].l})});return{p:b}};VizBrowser.prototype.setState=function(b){this.pState=b};var VizMBMap=function(b,a){PVizModel.call(this,b,a)};VizMBMap.prototype=Object.create(PVizModel.prototype);VizMBMap.prototype.constructor=VizMBMap;VizMBMap.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL};
VizMBMap.prototype.setup=function(){function b(){a.bkSel&&(a.bkSel.s=!1);a.clearSel()}var a=this,c=this.settings.h+40+30*this.settings.fcts.length;this.svg=d3.select(this.frameID).append("svg").attr("width",this.settings.w+10).attr("height",c);this.infoG=this.svg.append("g");this.infoG.attr("transform","translate(5,"+(3+this.settings.h)+")");this.attsG=this.svg.append("g");this.attsG.attr("transform","translate(5,"+(40+this.settings.h)+")");this.infoG.append("rect").attr("class","mbm-reset").attr("x",
"0").attr("y","8").attr("width","60").attr("height","20").attr("rx","4").attr("ry","4").on("click",b);this.infoG.append("text").attr("class","mbm-reset-text").attr("x","30").attr("y","23").text(dlText.reset).on("click",b)};VizMBMap.prototype.resetAttBars=function(){this.attsG.selectAll(".bar").transition().attr("x",function(b){return b.x0}).attr("width",function(b){return b.w0})};
VizMBMap.prototype.refreshTitles=function(){this.svg.selectAll(".mbm-title").attr("class",function(b){return b.s?"mbm-title obj-sel":"mbm-title"})};
VizMBMap.prototype.renderTree=function(b){function a(){var a=0,b=c.settings.w,e=null!==c.sbkSel?c.sbkSel.i:c.bkSel.i;PState.set(PSTATE_UPDATE);c.fcts.forEach(function(g,f){var k=[],h=0;g.c.forEach(function(a){a=PData.intersect(e,a.i);k.push(a);h+=a.length});var m=0,n;k.forEach(function(k){n=c.bars[a++];n.x=h?m*b/h:0;n.w=h?k.length*b/h:0;m+=k.length})});c.attsG.selectAll(".bar").transition().attr("x",function(a){return a.x}).attr("width",function(a){return a.w});PState.set(PSTATE_READY)}var c=this;
this.svg.selectAll(".mbm-g").remove();b=this.treemaps[b];b=this.svg.selectAll(".mbm-g").data(b,function(a){return a.id}).enter().append("g").attr("class","mbm-g").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});b.append("rect").attr("class","mbm-cell").attr("width",function(a){return a.dx-1}).attr("height",function(a){return a.dy-1}).attr("rx","3").attr("ry","3").style("fill",function(a){return 2===a.depth?a.c:"#888888"}).on("click",function(b){2===b.depth&&(c.sbkSel===b?c.clearSel():
(c.svg.selectAll(".mbm-cell").classed("obj-sel",!1),c.bkSel&&(c.bkSel.s=!1),c.sbkSel=b,d3.select(this).classed("obj-sel",!0),c.infoG.select(".mbm-select").remove(),c.infoG.append("text").attr("class","mbm-select").attr("x","70").attr("y","23").text(b.l),b.p.s=!0,c.bkSel=b.p,c.refreshTitles(),a(),c.vFrame.selBtns(!0)))}).append("title").text(function(a){return a.l});b.filter(function(a){return 1===a.depth}).append("text").attr("class","mbm-title").attr("x","3").attr("y","11").text(function(a){return a.l}).on("click",
function(b){c.bkSel===b?c.clearSel():(c.svg.selectAll(".mbm-cell").classed("obj-sel",!1),c.bkSel&&(c.bkSel.s=!1),b.s=!0,c.bkSel=b,c.sbkSel=null,c.refreshTitles(),c.infoG.select(".mbm-select").remove(),c.infoG.append("text").attr("class","mbm-select").attr("x","70").attr("y","23").text(b.l+" ("+b.i.length+")"),a(),c.vFrame.selBtns(!0))})};
VizMBMap.prototype.render=function(b){var a=this;this.sbkSel=this.bkSel=null;this.attSel=0;var c=this.settings.w;this.attsG.selectAll(".bar").remove();this.attsG.selectAll(".mbm-att-title").remove();this.infoG.select(".mbm-select").remove();this.fcts=[];this.bars=[];this.settings.fcts.forEach(function(d,h){var e,g=PData.aByID(d),f=30*h;e="g"!==g.def.t?a.settings.gr?PData.cRNew(g,!0,!0):PData.cLNew(g,null,!0):[];PData.cFill(e,d,null,b);var l=[],r=0;e.forEach(function(a){0<a.i.length&&(l.push(a),r+=
a.i.length)});var t=0;l.forEach(function(b){a.bars.push({x0:t*c/r,w0:b.i.length*c/r,x:0,w:0,y:f+18,c:b});t+=b.i.length});a.fcts.push({i:h,l:g.def.l,y:f+14,c:l})});this.attsG.selectAll(".mbm-att-title").data(a.fcts).enter().append("text").attr("class",function(a,b){return 0===b?"mbm-att-title obj-sel":"mbm-att-title"}).attr("x","0").attr("y",function(a){return a.y}).text(function(a){return a.l}).on("click",function(b,c){a.attSel!=c&&(PState.set(PSTATE_UPDATE),a.attsG.selectAll(".mbm-att-title").classed("obj-sel",
!1),a.clearSel(),a.resetAttBars(),a.renderTree(c),d3.select(this).classed("obj-sel",!0),a.attSel=c,PState.set(PSTATE_READY))});this.attsG.selectAll(".bar").data(a.bars).enter().append("rect").attr("class","bar").attr("x",function(a){return a.x0}).attr("y",function(a){return a.y}).attr("fill",function(a){return a.c.c}).attr("height","8").attr("width",function(a){return a.w0}).append("title").text(function(a){return a.c.l});var d=this.settings.p,l=PData.aByID(d),e;e="g"!==l.def.t?a.settings.gr?PData.cRNew(l,
!0,!0):PData.cLNew(l,null,!0):[];PData.cFill(e,d,null,b);var g=this.vFrame.getIndex();a.trees=[];a.fcts.forEach(function(b,c){var d={z:[],id:g+"."+c};e.forEach(function(a,e){if(0<a.i.length){var f=[],l={i:a.i,l:a.l,s:!1,z:f,id:g+"."+c+"."+e};b.c.forEach(function(b,d){var k=[],k=PData.intersect(a.i,b.i);0<k.length&&f.push({i:k,p:l,c:b.c,l:a.l+" + "+b.l+" ("+k.length+")",id:g+"."+c+"."+e+"."+d})});d.z.push(l)}});a.trees.push(d)});var f=d3.layout.treemap().padding([14,3,3,3]).size([c,this.settings.h]).round(!0).children(function(a,
b){return 2===b?null:a.z}).value(function(a){return a.i.length});a.treemaps=[];a.trees.forEach(function(b){a.treemaps.push(f.nodes(b))});a.renderTree(0)};VizMBMap.prototype.setSel=function(b){};VizMBMap.prototype.clearSel=function(){this.bkSel&&(this.bkSel.s=!1);this.infoG.select(".mbm-select").remove();this.sbkSel=this.bkSel=null;this.svg.selectAll(".mbm-cell").classed("obj-sel",!1);this.svg.selectAll(".mbm-title").classed("obj-sel",!1);this.resetAttBars();this.vFrame.selBtns(!1)};
VizMBMap.prototype.getSel=function(){return null!==this.sbkSel?this.sbkSel.i:null!==this.bkSel?this.bkSel.i:[]};VizMBMap.prototype.hint=function(){var b=PData.aByID(this.settings.p);return dlText.grpblks+" "+b.def.l};