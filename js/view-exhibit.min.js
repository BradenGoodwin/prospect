Array.prototype.findIndex||(Array.prototype.findIndex=function(a,c){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!==typeof a)throw new TypeError("predicate must be a function");for(var e=Object(this),d=e.length>>>0,f,g=0;g<d;g++)if(f=e[g],a.call(c,f,g,e))return g;return-1});
var EVENT_INSTANT=1,EVENT_F_START=2,EVENT_F_END=4,PSTATE_INIT=0,PSTATE_LOAD=1,PSTATE_PROCESS=2,PSTATE_BUILD=3,PSTATE_UPDATE=4,PSTATE_READY=5,D3FG_BAR_WIDTH=25,D3FG_MARGINS={top:4,right:7,bottom:22,left:30},D3SC_MARGINS={top:30,right:5,bottom:5,left:40},V_FLAG_LGND=1,V_FLAG_SEL=2,V_FLAG_LOC=4,V_FLAG_SLGND=8,V_FLAG_OPT=16,V_FLAG_VSCRL=32,V_FLAG_HSCRL=64,parseTC=/(\d\d)\:(\d\d)\:(\d\d)\.(\d\d?)/,mnthDays=[31,28,31,30,31,30,31,31,30,31,30,31],MS_IN_DAY=86399990,TODAY=new Date,localD3,months,dlText={},
xhbtURL,widgetData={ytLoaded:!1,ytCall:null,ytCode:null,timer:null,extract:null,sTime:null,eTime:null,playing:!1,widget:null,xscriptOn:!1,tcArray:null,tcIndex:-1},PState=function(){var a=PSTATE_INIT,c;return{init:function(){c=document.getElementById("dltext-pstates").innerHTML.trim().split("|")},set:function(e){if(e!=a){var d=jQuery("#pstate");a==PSTATE_READY?d.addClass("attn"):e==PSTATE_READY&&d.removeClass("attn");d.text(c[e-1]);a=e}}}}();
function PVizModel(a,c){this.vFrame=a;this.frameID=a.getFrameID()+" div.viz-content div.viz-result";this.settings=c;this.recSel=[]}PVizModel.prototype.flags=function(){return 0};PVizModel.prototype.isSel=function(a){return-1!=_.indexOf(this.recSel,a,!0)};PVizModel.prototype.getSel=function(){return this.recSel};
PVizModel.prototype.toggleSel=function(a){var c=this.recSel.length,e=_.sortedIndex(this.recSel,a);if(this.recSel[e]==a)return this.recSel.splice(e,1),0<c&&0==this.recSel.length&&this.vFrame.selBtns(!1),!1;this.recSel.splice(e,0,a);0==c&&0<this.recSel.length&&this.vFrame.selBtns(!0);return!0};PVizModel.prototype.clearSel=function(){this.recSel=[]};PVizModel.prototype.getLocAtts=function(a){return[]};PVizModel.prototype.getFeatureAtts=function(a){return[]};PVizModel.prototype.teardown=function(){};
PVizModel.prototype.resize=function(){};PVizModel.prototype.doOptions=function(){};PVizModel.prototype.getState=function(){return{}};PVizModel.prototype.setState=function(a){};PVizModel.prototype.hint=function(){return null};var VizMap=function(a,c){PVizModel.call(this,a,c)};VizMap.prototype=Object.create(PVizModel.prototype);VizMap.prototype.constructor=VizMap;VizMap.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_OPT};
VizMap.prototype.getLocAtts=function(a){return null!=a?(a=this.settings.cAtts[a],null==a?null:a):this.settings.cAtts};VizMap.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};
VizMap.prototype.setup=function(){var a=this,c=parseFloat(this.settings.clat),e=parseFloat(this.settings.clon),d;d="string"==typeof this.settings.zoom?parseInt(this.settings.zoom):this.settings.zoom;var f=this.vFrame.getIndex();jQuery(this.frameID).append('<div id="l-map-'+f+'" class="max-size"></div>');this.lMap=L.map("l-map-"+f,{zoomControl:!1}).setView([c,e],d);this.baseMap=PMapHub.createMapLayer(this.settings.base,1,this.lMap,null);var g;this.mapLayers=[];var l=jQuery("#dialog-opacities div.layer-list");
l.empty();var p=jQuery('<div class="op-layer" data-i="-1">Base Map <input type=range class="op-slider" min=0 max=100 value=100 step=5></div>');l.append(p);_.each(this.settings.lyrs,function(c,h){g=c.o||1;var q;q=PMapHub.createMapLayer(c.lid,g,a.lMap,null);a.mapLayers.push(q);p=jQuery('<div class="op-layer" data-i="'+h+'">'+q.options.layerName+' <input type=range class="op-slider" min=0 max=100 value='+100*c.o+" step=5></div>");l.append(p)});var n=_.template(document.getElementById("dltext-v-map").innerHTML);
jQuery("#view-frame-"+f+" div.view-control-bar").append(n({vi:f}));jQuery("#map-zoom-"+f).button({text:!1,icons:{primary:"ui-icon-plus"}}).click(function(){a.lMap.zoomIn()});jQuery("#map-unzoom-"+f).button({text:!1,icons:{primary:"ui-icon-minus"}}).click(function(){a.lMap.zoomOut()});jQuery("#map-reset-"+f).button({text:!1,icons:{primary:"ui-icon-arrowrefresh-1-w"}}).click(function(){a.lMap.setView([c,e],d)});this.markerLayer=f=L.featureGroup();f.options=f.options||{};f.options.layerName="Markers";
f.addTo(this.lMap);this.lineLayer=f=L.featureGroup();f.addTo(this.lMap);f=PData.getNumETmplts();this.tLCnt=new Uint16Array(f)};
VizMap.prototype.render=function(a){function c(a){if(a.target&&a.target.options){var h=a.target.options._aid,c=e.toggleSel(h);a=PData.aIndex2Tmplt(h);1<e.tLCnt[a]?(PState.set(PSTATE_UPDATE),d.eachLayer(function(a){a.options._aid==h&&(c?a.setStyle({color:"#ff0000"}):a.setStyle({color:"#000"}))}),PState.set(PSTATE_READY)):c?this.setStyle({color:"#ff0000"}):this.setStyle({color:"#000"})}}var e=this,d=this.markerLayer;0<this.recSel.length&&(this.recSel=[]);d.clearLayers();var f=this.lineLayer;f.clearLayers();
var g=PData.getNumETmplts(),l=0,p,n=0,t,h,q,v,y,m,u,k,z,A,r,D,w,x,C,B,E;x=this.settings.min;"string"==typeof x&&(x=parseInt(x));n=this.settings.max;"string"==typeof n&&(n=parseInt(n));C=n-x;for(l=0;l<g;l++)this.tLCnt[l]=0;for(var G,l=0;l<g;l++)if("disable"!=this.settings.pAtts[l]){G=[];break}l=0;n=-1;a:for(;l<a.l;){if(null==m){do{if(++n==g)break a;t=a.t[n]}while(0==t.n||t.i+t.n==l);m=this.vFrame.getSelLocAtts(n);if(0==m.length){m=null;continue}u=e.vFrame.getSelFeatAtts(n);if(0==u.length){m=null;continue}e.tLCnt[n]=
m.length;v=e.vFrame.getSelLegend(n);y=PData.getAttID(v);k=e.settings.pAtts[n];h=e.settings.lClrs[n];if(D=e.settings.sAtts[n])w=PData.getAttID(D),"number"==typeof w.r.min&&"number"==typeof w.r.max?(B=w.r.min,E=w.r.max-B):D=null}p=a.s[l];q=PData.getRecByIndex(p);var F;G&&(F={id:q.id,c:[],p:q.a[k],l:h});m.forEach(function(a){if(z=q.a[a])if(A=q.a[v],"undefined"!=typeof A&&(A=PData.getAttLgndVal(A,y,u))){if("number"==typeof z[0])D?(w=q.a[D],w="undefined"!=typeof w?Math.floor((w-B)*C/E)+x:x):w=x,r=L.circleMarker(z,
{_aid:p,weight:1,radius:w,fillColor:A,color:"#000",opacity:1,fillOpacity:1}),F&&F.c.push(z);else if(r=2==z.length?L.polyline(z,{_aid:p,weight:1,fillColor:A,color:"#000",opacity:1,fillOpacity:1}):L.polygon(z,{_aid:p,weight:1,fillColor:A,color:"#000",opacity:1,fillOpacity:1}),F){var h=[0,0];z.forEach(function(a){h[0]+=a[0];h[1]+=a[1]});h[0]/=z.length;h[1]/=z.length;F.c.push(h)}r.on("click",c);d.addLayer(r)}});F&&0<F.c.length&&G.push(F);++l==t.i+t.n&&(m=null)}if(G){G.sort(function(a,h){return PData.strcmp(h.id,
a.id)});var H=[];G.forEach(function(a){a.p&&a.p.forEach(function(h){l=_.sortedIndex(G,{id:h},"id");if(l<G.length){var c=G[l];c.id==h&&a.c.forEach(function(h){c.c.forEach(function(c){h[0]==c[0]&&h[1]==c[1]||H.push({p:[h,c],c:a.l})})})}})});H.forEach(function(a){f.addLayer(L.polyline(a.p,{color:a.c,weight:2}))})}};VizMap.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-control-bar div.iconbar").remove()};VizMap.prototype.resize=function(){this.lMap.invalidateSize(!1)};
VizMap.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],this.markerLayer&&this.markerLayer.eachLayer(function(a){a.setStyle({color:"#000"})}))};VizMap.prototype.setSel=function(a){var c=this;this.recSel=a;this.markerLayer&&this.markerLayer.eachLayer(function(a){c.isSel(a.options._aid)?a.setStyle({color:"#ff0000"}):a.setStyle({color:"#000"})})};VizMap.prototype.getState=function(){return{c:this.lMap.getCenter(),z:this.lMap.getZoom(),l:this.vFrame.getLgndSels()}};
VizMap.prototype.setState=function(a){this.lMap.setView(a.c,a.z);this.vFrame.setLgndSels(a.l)};VizMap.prototype.hint=function(){for(var a="",c=PData.getNumETmplts(),e=0;e<c;e++){var d=this.settings.sAtts[e];if(d)var a=0==a.length?dlText.markersize:a+",",d=PData.getAttID(d),f=PData.getETmpltIndex(e),f=PData.getTmpltID(f),a=a+(" "+d.def.l+" ("+f.l+")")}return 0<a.length?a:null};
VizMap.prototype.doOptions=function(){var a=this;this.vFrame.getIndex();var c=jQuery("#dialog-opacities").dialog({height:300,width:500,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close");var e,d;e=jQuery('.op-layer[data-i="-1"] .op-slider').val();a.baseMap.setOpacity(e/100);d=a.settings.lyrs.length;for(var f=0;f<d;f++)e=jQuery('.op-layer[data-i="'+f+'"] .op-slider').val(),a.mapLayers[f].setOpacity(e/100)}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})};
var VizCards=function(a,c){PVizModel.call(this,a,c)};VizCards.prototype=Object.create(PVizModel.prototype);VizCards.prototype.constructor=VizCards;VizCards.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_OPT};VizCards.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};
VizCards.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(c){if("DIV"==c.target.nodeName||"IMG"==c.target.nodeName)if(c=jQuery(c.target).closest("div.card"),1==c.size()){var e=c.data("ai");null!=e&&(a.toggleSel(e)?c.addClass("obj-sel"):c.removeClass("obj-sel"))}});a.sAtts=[];for(var c=0;c<PData.getNumETmplts();c++){var e=jQuery('#dialog-sortby select[data-ti="'+c+'"] :first').val();a.sAtts.push(e)}for(c=0;c<PData.getNumETmplts();c++)jQuery('#dialog-sortby select[data-ti="'+
c+'"]').val(this.sAtts[c])};
VizCards.prototype.render=function(a){var c=this;this.stream=a;var e=PData.getNumETmplts(),d,f,g,l,p,n,t,h,q,v,y,m,u,k,z=jQuery(this.frameID);z.empty();0<this.recSel.length&&(this.recSel=[]);var A,r="w"+this.settings.w+" h"+this.settings.h;f=a.t[0];for(d=0;d<e;){for(;0==f.n;){if(++d==e)return;f=a.t[d]}f=PData.getETmpltIndex(d);f=PData.getTmpltID(f);n=c.vFrame.getSelFeatAtts(d);0!=n.length&&(z.append('<div class="template-label">'+f.l+'</div><div class="cards" data-ti="'+d+'"></div>'),A=jQuery('div.cards[data-ti="'+
d+'"]'),g=c.vFrame.getSelLegend(d),l=PData.getAttID(g),p=c.settings.iAtts[d],v=c.settings.cnt[d],f=c.sAtts[d],f=PData.getAttID(f),f=PData.orderTBy(f,a,d),f.forEach(function(a){t=PData.getRecByIndex(a.i);y=t.a[g];"undefined"!=typeof y&&(h=PData.getAttLgndRecs(y,l,n,!1))&&(u=c.settings.lOn?'<div class="card-title">'+t.l+"</div>":"",q=!1,m="",v&&0<v.length&&(k=h.b?' style="color:black"':"",v.forEach(function(a){if(y=t.a[a])if(y=PData.procAttTxt(a,y))q=!0,m+=y+"<br/>"})),m=p&&(y=t.a[p])?q?'<div class="card-body"><img src="'+
y+'"/><div class="card-cnt"'+k+">"+m+"</div></div>":'<div class="card-body"><img class="full" src="'+y+'"/></div>':'<div class="card-body"><div class="card-cnt"'+k+">"+m+"</div>",A.append('<div class="card '+r+'" style="background-color:'+h.v+'" data-ai="'+a.i+'">'+u+m+"</div>"))}));f=a.t[++d]}};VizCards.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")};
VizCards.prototype.rerender=function(a){var c=this,e=jQuery(this.frameID+' div.cards[data-ti="'+a+'"]');e.empty();var d,f,g,l,p,n,t,h,q,v,y,m,u,k="w"+this.settings.w+" h"+this.settings.h;d=c.vFrame.getSelFeatAtts(a);0!=d.length&&(f=c.vFrame.getSelLegend(a),g=PData.getAttID(f),l=c.settings.iAtts[a],p=c.settings.cnt[a],n=c.sAtts[a],n=PData.getAttID(n),a=PData.orderTBy(n,c.stream,a),a.forEach(function(a){t=PData.getRecByIndex(a.i);h=t.a[f];"undefined"!=typeof h&&(q=PData.getAttLgndRecs(h,g,d,!1))&&(m=
c.settings.lOn?'<div class="card-title">'+t.l+"</div>":"",v=!1,y="",p&&0<p.length&&(u=q.b?' style="color:black"':"",p.forEach(function(a){if(h=t.a[a])if(h=PData.procAttTxt(a,h))v=!0,y+=h+"<br/>"})),y=l&&(h=t.a[l])?v?'<div class="card-body"><img src="'+h+'"/><div class="card-cnt"'+u+">"+y+"</div></div>":'<div class="card-body"><img class="full" src="'+h+'"/></div>':'<div class="card-body"><div class="card-cnt"'+u+">"+y+"</div>",e.append('<div class="card '+k+(c.isSel(a.i)?" obj-sel":"")+'" style="background-color:'+
q.v+'" data-ai="'+a.i+'">'+m+y+"</div>"))}))};VizCards.prototype.doOptions=function(){var a=this,c=jQuery("#dialog-sortby").dialog({height:220,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close");PState.set(PSTATE_BUILD);for(var e=0;e<PData.getNumETmplts();e++){var d=jQuery('#dialog-sortby select[data-ti="'+e+'"]').val();d!=a.sAtts[e]&&(a.sAtts[e]=d,a.rerender(e))}PState.set(PSTATE_READY)}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})};
VizCards.prototype.setSel=function(a){var c=this,e,d;this.recSel=a;jQuery(this.frameID).find("div.card").each(function(){d=jQuery(this);e=d.data("ai");null!=e&&(c.isSel(e)?d.addClass("obj-sel"):d.removeClass("obj-sel"))})};VizCards.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],jQuery(this.frameID).find("div.card").removeClass("obj-sel"))};VizCards.prototype.getState=function(){return{l:this.vFrame.getLgndSels(),s:this.sAtts}};
VizCards.prototype.setState=function(a){this.vFrame.setLgndSels(a.l);this.sAtts=a.s;this.sAtts.forEach(function(a,e){jQuery('#dialog-sortby select[data-ti="'+e+'"]').val(a)})};var VizPinboard=function(a,c){PVizModel.call(this,a,c)};VizPinboard.prototype=Object.create(PVizModel.prototype);VizPinboard.prototype.constructor=VizPinboard;VizPinboard.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_HSCRL|V_FLAG_VSCRL|V_FLAG_OPT};
VizPinboard.prototype.getLocAtts=function(a){return null!=a?(a=this.settings.cAtts[a],null==a?null:[a]):[this.settings.cAtts]};VizPinboard.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};
VizPinboard.prototype.setup=function(){var a=this.settings,c=this,e=this.vFrame.getIndex(),d=jQuery("#dialog-opacities div.layer-list");d.empty();var f=jQuery('<div class="op-layer" data-i="-1">Base Image <input type=range class="op-slider" min=0 max=100 value=100 step=5></div>');d.append(f);this.settings.lyrs.forEach(function(a,c){f=jQuery('<div class="op-layer" data-i="'+c+'">Overlay '+(c+1)+' <input type=range class="op-slider" min=0 max=100 value='+100*a.o+" step=5></div>");d.append(f)});PData.getNumETmplts();
this.xScale=d3.scale.linear().domain([0,a.iw-1]).rangeRound([0,a.dw-1]);this.yScale=d3.scale.linear().domain([0,a.ih-1]).range([0,a.dh-1]);this.xAxis=d3.svg.axis().scale(this.xScale).orient("top");this.yAxis=d3.svg.axis().scale(this.yScale).orient("left");this.chart=d3.select(this.frameID).append("svg").attr("width",a.dw+30+3).attr("height",a.dh+30+2).append("g").attr("transform","translate(30,30)");this.chart.append("g").attr("class","x axis").call(this.xAxis);this.chart.append("g").attr("class",
"y axis").call(this.yAxis);this.chart.append("image").attr("id","base-"+e).attr("xlink:href",a.img).attr("x",0).attr("y",0).attr("height",a.dh).attr("width",a.dw);this.settings.lyrs.forEach(function(a,d){c.chart.append("svg").attr("id","ol-"+e+"-"+d).attr("opacity",a.o)});this.settings.lyrs.forEach(function(a,c){d3.xml(a.url,function(a,d){if(!a){var t=d.getElementsByTagName("svg")[0];d3.select("#ol-"+e+"-"+c).node().appendChild(t)}})});this.gRecs=this.chart.append("g").attr("id","recs")};
VizPinboard.prototype.render=function(a){var c=this;this.gRecs.selectAll(".recobj").remove();this.gRecs.selectAll(".recline").remove();0<this.recSel.length&&(this.recSel=[]);var e=PData.getNumETmplts(),d,f,g=0,l,p,n,t,h,q,v,y,m,u,k,z,A,r,D,w;for(d=0;d<e;d++)if("disable"!=this.settings.pAtts[d]){w=[];break}z=this.settings.min;"string"==typeof z&&(z=parseInt(z));f=this.settings.max;"string"==typeof f&&(f=parseInt(f));A=f-z;var x=[];d=0;g=-1;a:for(;d<a.l;){if(null==q){do{if(++g==e)break a;l=a.t[g]}while(0==
l.n||l.i+l.n==d);q=this.vFrame.getSelLocAtts(g);if(0==q.length){q=null;continue}q=q[0];v=c.vFrame.getSelFeatAtts(g);if(0==v.length){q=null;continue}t=c.vFrame.getSelLegend(g);h=PData.getAttID(t);y=c.settings.pAtts[g];p=c.settings.lClrs[g];if(k=c.settings.sAtts[g])n=PData.getAttID(k),"number"==typeof n.r.min&&"number"==typeof n.r.max?(r=n.r.min,D=n.r.max-r):k=null}f=a.s[d];n=PData.getRecByIndex(f);var C;w&&(C={id:n.id,c:null,p:n.a[y],l:p});m=n.a[q];"undefined"!=typeof m&&(u=n.a[t],"undefined"!=typeof u&&
(u=PData.getAttLgndVal(u,h,v)))&&(k?(n=n.a[k],n="undefined"!=typeof n?Math.floor((n-r)*A/D)+z:z):n=z,x.push({ai:f,v:u,x:m[0],y:m[1],r:n}),C&&(C.c=m));C&&C.c&&w.push(C);++d==l.i+l.n&&(q=null)}this.gRecs.selectAll(".recobj").data(x).enter().append("circle").attr("class","recobj").attr("cx",function(a){return c.xScale(a.x)}).attr("cy",function(a){return c.yScale(a.y)}).attr("r",function(a){return c.yScale(a.r)}).style("fill",function(a){return a.v}).on("click",function(a,h){var q=c.toggleSel(a.ai);d3.select(this).classed("obj-sel",
q)});if(w){w.sort(function(a,h){return PData.strcmp(h.id,a.id)});var B=[];w.forEach(function(a){a.p&&a.p.forEach(function(h){d=_.sortedIndex(w,{id:h},"id");if(d<w.length){var c=w[d];c.id==h&&B.push({f:a.c,t:c.c,c:a.l})}})});this.gRecs.selectAll(".recline").data(B).enter().append("line").attr("class","recline").attr("x1",function(a){return c.xScale(a.f[0])}).attr("y1",function(a){return c.yScale(a.f[1])}).attr("x2",function(a){return c.xScale(a.t[0])}).attr("y2",function(a){return c.yScale(a.t[1])}).attr("stroke",
function(a){return a.c})}};VizPinboard.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],this.gRecs.selectAll(".recobj").classed("obj-sel",!1))};VizPinboard.prototype.setSel=function(a){var c=this;this.recSel=a;this.gRecs.selectAll(".recobj").classed("obj-sel",function(a){return c.isSel(a.ai)})};
VizPinboard.prototype.doOptions=function(){var a=this,c=this.vFrame.getIndex(),e=jQuery("#dialog-opacities").dialog({height:300,width:320,modal:!0,buttons:[{text:dlText.ok,click:function(){e.dialog("close");var d,f;d=jQuery('.op-layer[data-i="-1"] .op-slider').val();d3.select("#base-"+c).attr("opacity",d/100);f=a.settings.lyrs.length;for(var g=0;g<f;g++)d=jQuery('.op-layer[data-i="'+g+'"] .op-slider').val(),d3.select("#ol-"+c+"-"+g).attr("opacity",d/100)}},{text:dlText.cancel,click:function(){e.dialog("close")}}]})};
VizPinboard.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}};VizPinboard.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)};VizPinboard.prototype.hint=function(){for(var a="",c=PData.getNumETmplts(),e=0;e<c;e++){var d=this.settings.sAtts[e];if(d)var a=0==a.length?dlText.markersize:a+",",d=PData.getAttID(d),f=PData.getETmpltIndex(e),f=PData.getTmpltID(f),a=a+(" "+d.def.l+" ("+f.l+")")}return 0<a.length?a:null};var VizTime=function(a,c){PVizModel.call(this,a,c)};
VizTime.prototype=Object.create(PVizModel.prototype);VizTime.prototype.constructor=VizTime;VizTime.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_VSCRL};VizTime.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};VizTime.prototype.getLocAtts=function(a){return null!=a?(a=this.settings.dAtts[a],null==a?null:[a]):[this.settings.dAtts]};
VizTime.prototype.getWidths=function(){var a=[],c=jQuery(this.frameID).width();a.push(c);c-=4;a.push(c);this.threshold=c/(6.25*this.settings.xLbl);return a};
VizTime.prototype.setup=function(){function a(a){var c={id:a,l:0,t:0,h:0,w:g[1],svgID:"#tl-b-"+p+"-"+a,tHt:0,iHt:0,xScale:d3.time.scale(),yScale:function(a){return a*c.tHt},parts:[],g:null,labels:null,labelSVGs:null,redraw:function(){}};a?(c.tHt=d.settings.bHt,c.iHt=c.tHt-2):(c.tHt=3,c.iHt=2);if(1==a){var h=d.minDate,q=d.maxDate;0<d.settings.zFrom.length&&(h=PData.parseDate(d.settings.zFrom,!1));0<d.settings.zTo.length&&(q=PData.parseDate(d.settings.zTo,!0));c.xScale.domain([h,q]);d.zMinDate=h;d.zMaxDate=
q}else c.xScale.domain([d.minDate,d.maxDate]);c.xScale.range([0,c.w]);c.g=d.chart.append("g").attr("id",c.svgID.substring(1)).attr("class","tl-band").attr("width",c.w);d.bands[a]=c;d.cmpnts.push(c)}function c(a){var c=d.bands[a],h=d3.svg.axis().scale(c.xScale).orient("bottom").tickSize(6,0);localD3&&h.tickFormat(localD3);var q=c.g.append("g").attr("id","axis-"+p+"-"+a).attr("class","axis").style("font-size","10px");a={redraw:function(){q.call(h)}};c.parts.push(a);d.cmpnts.push(a)}function e(a){var c=
d.bands[a],h;h=1==a?32:16;c.labels=[{name:"s-"+p+"-"+a,x:function(){return 0},left:function(){return 0},anchor:"start",tDelta:2,whichDate:function(a,c){return a}},{name:"e-"+p+"-"+a,x:function(){return c.l+c.w},left:function(){return c.l+c.w-d.settings.xLbl},anchor:"end",tDelta:-3,whichDate:function(a,c){return c}}];var q=d3.select(c.svgID).selectAll(".bLblCntr").data(c.labels).enter().append("g").attr("class","bLblCntr");q.append("rect").attr("class","bLbl").attr("id",function(a){return"rect-"+a.name}).attr("x",
function(a){return a.left()}).attr("width",d.settings.xLbl).attr("height",h);var v=q.append("text").attr("class","bMinMaxLbl").attr("id",function(a){return"txt-"+a.name}).attr("x",function(a){return a.x()+a.tDelta}).attr("y",12).attr("text-anchor",function(a){return a.anchor}),e={redraw:function(){var a=c.xScale.domain(),h=a[0],q=a[1];v.text(function(a){return a.whichDate(h,q).getUTCFullYear()})}};c.parts.push(e);d.cmpnts.push(e);if(1==a){var m=q.append("text").attr("class","bMinMaxLbl").attr("id",
function(a){return"m-txt-"+a.name}).attr("x",function(a){return a.x()+a.tDelta}).attr("y",h-4).attr("text-anchor",function(a){return a.anchor});a={redraw:function(){var a=c.xScale.domain(),h=a[0],q=a[1];m.text(function(a){return q.getUTCFullYear()-h.getUTCFullYear()>d.threshold?"":months[a.whichDate(h,q).getMonth()]})}};c.parts.push(a);d.cmpnts.push(a)}c.labelSVGs=q}var d=this;"number"!=typeof this.settings.xLbl&&(this.settings.xLbl=parseInt(this.settings.xLbl));this.brushSVG=this.brush=null;var f=
this.settings;"string"===typeof f.bHt&&(f.bHt=parseInt(f.bHt,10));(function(){var a,c,h,q,v,e;f.dAtts.forEach(function(d){null!=d&&"disable"!=d&&(d=PData.getAttID(d))&&(null==a||d.r.min.y<a?(a=d.r.min.y,"undefined"!=typeof d.r.min.m?(c=d.r.min.m,h="undefined"!=typeof d.r.min.d?d.r.min.d:1):h=c=1):d.r.min.y==a&&"undefined"!=typeof d.r.min.m&&(d.r.min.m<c?(c=d.r.min.m,h="undefined"!=typeof d.r.min.d?d.r.min.d:1):d.r.min.m==c&&"undefined"!=typeof d.r.min.d&&d.r.min.d<h&&(h=d.r.min.d)),null==q?"undefined"==
typeof d.r.max.y?(q=TODAY.getUTCFullYear(),v=TODAY.getMonth()+1,e=TODAY.getDate()):(q=d.r.max.y,"undefined"!=typeof d.r.max.m?(v=d.r.max.m,e="undefined"!=typeof d.r.max.d?d.r.max.d:mnthDays[v-1]):(v=12,e=31)):d.r.max.y>q?(q=d.r.max.y,"undefined"!=typeof d.r.max.m?(v=d.r.max.m,e="undefined"!=typeof d.r.max.d?d.r.max.d:mnthDays[v-1]):(v=12,e=31)):d.r.max.y==q&&"undefined"!=typeof d.r.max.m&&(d.r.max.m>v?(v=d.r.max.m,e="undefined"!=typeof d.r.max.d?d.r.max.d:mnthDays[v-1]):d.r.max.m==v&&"undefined"!=
typeof d.r.max.d&&d.r.max.d>e&&(e=d.r.max.d)))});d.minDate=0<f.from.length?PData.parseDate(f.from,!1):PData.date3Nums(a,c,h,!1);d.maxDate=0<f.to.length?PData.parseDate(f.to,!0):PData.date3Nums(q,v,e,!0);d.instGap=.015*(d.maxDate-d.minDate)})();var g=d.getWidths(),l=d3.select(this.frameID).append("svg").attr("class","tl-vf").attr("width",g[1]);(function(){var a=[];f.lgnds.forEach(function(c){c.forEach(function(c){a.push(c)})});var a=_.uniq(a),c=[];a.forEach(function(a){(a=PData.getAttID(a))&&a.l.forEach(function(a){c.push(a.v)})});
c=_.uniq(c);c.sort();var h=l.append("defs"),q,d;c.forEach(function(a){d=a.substr(1);q=h.append("linearGradient").attr("id",d+"-fs");q.append("stop").attr("offset","0%").attr("stop-color","#C0C0C0");q.append("stop").attr("offset","5%").attr("stop-color",a);q.append("stop").attr("offset","100%").attr("stop-color",a);q=h.append("linearGradient").attr("id",d+"-fe");q.append("stop").attr("offset","0%").attr("stop-color",a);q.append("stop").attr("offset","95%").attr("stop-color",a);q.append("stop").attr("offset",
"100%").attr("stop-color","#C0C0C0");q=h.append("linearGradient").attr("id",d+"-fb");q.append("stop").attr("offset","0%").attr("stop-color","#C0C0C0");q.append("stop").attr("offset","5%").attr("stop-color",a);q.append("stop").attr("offset","95%").attr("stop-color",a);q.append("stop").attr("offset","100%").attr("stop-color","#C0C0C0")});h.append("filter").attr("id","xortext").append("feComposite").attr("operator","xor")})();var p=this.vFrame.getIndex();l.append("clipPath").attr("id","tl-clip-"+p).append("rect").attr("width",
g[1]);d.chart=l.append("g").attr("class","chart").attr("clip-path","url(#tl-clip-"+p+")");d.instRad=f.bHt/2-1;d.bands=Array(2);d.cmpnts=[];a(0);a(1);c(0);c(1);e(0);e(1)};
VizTime.prototype.render=function(a){function c(a,c){var h=a.s-c.s;if(0>h)return 1;if(0<h)return-1;h=c.e-a.e;return 0>h?1:0<h?-1:0}function e(a){function c(a){a=g.toggleSel(a.ai);d3.select(this).classed("obj-sel",a)}var h,q,d,e,m=g.bands[a];a?(h=g.bands[0],m.t=h.t+h.h+37,h=q=d=g.instRad,e=2*g.instRad+3):(m.t=0,h=q=d=1);m.h=p*m.tHt+2;m.g.attr("transform","translate(0,"+m.t+")").attr("height",m.h);var u,k;a&&(u=.75*m.iHt+"px",k=.8*m.iHt);var f;f=d3.select(m.svgID).selectAll(".lgBd").remove();f=d3.select(m.svgID).selectAll(".lgBd").data(g.lgBds).enter().append("svg").attr("class",
"lgBd").attr("y",function(a){return m.yScale(a.t)}).attr("height",function(a){return m.yScale(a.h)});f.append("rect").attr("width","100%").attr("height","100%").attr("fill",function(a){return a.d.v});1==a&&f.append("text").attr("class","lgBdLbl").attr("x",2).attr("y",k).attr("fill",function(a){return a.d.b?"#000000":"#FFFFFF"}).style("font-size",u).text(function(a){return a.d.l});var l;d3.select(m.svgID).selectAll(".event").remove();l=d3.select(m.svgID).selectAll(".event").data(g.events).enter().append("svg").attr("class",
function(a){return a.f&EVENT_INSTANT?"event instant":"event range"}).attr("y",function(a){return m.yScale(a.t)}).attr("height",m.iHt);if(1==a)l.on("click",c);var r=d3.select(m.svgID).selectAll(".range");r.append("rect").attr("width","100%").attr("height","100%").attr("fill",function(c){return 1==a&&c.f&(EVENT_F_START|EVENT_F_END)?(c.f&(EVENT_F_START|EVENT_F_END))==(EVENT_F_START|EVENT_F_END)?"url("+c.c.v+"-fb)":(c.f&EVENT_F_START)===EVENT_F_START?"url("+c.c.v+"-fs)":"url("+c.c.v+"-fe)":c.c.v});1==
a&&r.append("text").attr("class","rangeLbl").attr("x",4).attr("y",k).attr("fill",function(a){return a.c.b?"#000000":"#FFFFFF"}).style("font-size",u).text(function(a){return a.l});r=d3.select(m.svgID).selectAll(".instant");r.append("circle").attr("cx",h).attr("cy",q).attr("r",d).attr("fill",function(a){return a.c.v});1==a&&r.append("text").attr("class","instantLbl").attr("x",e).attr("y",k).style("font-size",u).text(function(a){return a.l});m.redraw=function(){f.attr("x",function(a){return m.xScale(a.s)}).attr("width",
function(a){return m.xScale(a.e)-m.xScale(a.s)});l.attr("x",function(a){return m.xScale(a.s)}).attr("width",function(a){return m.xScale(a.e)-m.xScale(a.s)});m.parts.forEach(function(a){a.redraw()})}}function d(a){a=g.bands[a];d3.select(a.svgID).selectAll(".axis").attr("transform","translate(0,"+a.h+")")}function f(a){a=g.bands[a];d3.select(a.svgID).selectAll(".bLblCntr").attr("transform","translate(0,"+(a.h+1).toString()+")")}var g=this,l=g.vFrame.getIndex();0<this.recSel.length&&(this.recSel=[]);
g.events=[];g.lgBds=[];var p=0;(function(){for(var d=PData.getNumETmplts(),e=0,h,q,v,f,m,u,k,l;e<d;){for(h=a.t[e];0==h.n;){if(++e==d)return;h=a.t[e]}v=g.vFrame.getSelLocAtts(e);if(0!=v.length&&(v=g.vFrame.getSelFeatAtts(e),0!=v.length)){l=g.vFrame.getSelLegend(e);k=PData.getAttID(l);f=g.settings.dAtts[e];for(var A,r,D,w,x,C,B,E,G=[],F=h.i;F<h.i+h.n;F++)q=a.s[F],E=PData.getRecByIndex(q),m=E.a[l],"undefined"!=typeof m&&(m=PData.getAttLgndRecs(m,k,v,!1))&&(u=E.a[f])&&(C=u.min.f?EVENT_F_START:0,A=u.min.y,
"undefined"==typeof u.min.m?D=r=1:(r=u.min.m,D="undefined"==typeof u.min.d?1:u.min.d),w=PData.date3Nums(A,r,D,!1),"undefined"==typeof u.max?(C|=EVENT_INSTANT,x=w.getTime()+g.instGap):"open"==u.max?x=TODAY:(u.max.f&&(C|=EVENT_F_END),A=u.max.y,"undefined"==typeof u.max.m?(r=12,D=31):(r=u.max.m,D="undefined"==typeof u.max.d?mnthDays[r-1]:u.max.d),x=PData.date3Nums(A,r,D,!0)),G.push({s:w,e:x,ai:q,f:C,c:m,l:E.l,t:0}));G.sort(c);var H=[],I;G.forEach(function(a){for(I=0;I<H.length&&!(a.e<H[I]);I++);a.t=
I+p+1;H[I]=a.s});h=PData.getAttID(f);h.l.forEach(function(a){B=a.d;A=B.min.y;"undefined"==typeof B.min.m?D=r=1:(r=B.min.m,D="undefined"==typeof B.min.d?1:B.min.d);w=PData.date3Nums(A,r,D,!1);"undefined"==typeof B.max.y?x=TODAY:(A=B.max.y,"undefined"==typeof B.max.m?(r=12,D=31):(r=B.max.m,D="undefined"==typeof B.max.d?mnthDays[r-1]:B.max.d),x=PData.date3Nums(A,r,D,!0));g.lgBds.push({s:w,e:x,t:p,h:H.length+1,d:a})});p+=H.length+1;g.events=g.events.concat(G)}e++}})();g.getWidths();e(0);e(1);(function(){var a=
function(){function a(c,h){this._height=h;this.g=c;this.mask=this.g.attr("class","brush").call(g.brush);this.mask.selectAll("rect").attr("y",0).attr("height",h);this.left=this.mask.append("polygon").attr("class","dragger");this.right=this.mask.append("polygon").attr("class","dragger");this._bottom=this._top=this._x=null}a.prototype.style=function(a,c){this.left.style(a,c);this.right.style(a,c);return this};a.prototype.x=function(a){if(null==a)return this._x;this._x=a;return this};a.prototype.height=
function(a){if(null==a)return this._height;this._height=a;this.mask.selectAll("rect").attr("height",a);return this};a.prototype.redraw=function(){var a,c;c=g.brush.extent();this._x.range();a=c[0];c=c[1];a=this._x(a);c=this._x(c);this.left.attr("points",""+a+","+this._height+" "+(a+5)+","+(this._height+5)+" "+(a+5)+","+(this._height+9)+" "+(a-5)+","+(this._height+9)+" "+(a-5)+","+(this._height+5)+" "+a+","+this._height);this.right.attr("points",""+c+","+this._height+" "+(c+5)+","+(this._height+5)+
" "+(c+5)+","+(this._height+9)+" "+(c-5)+","+(this._height+9)+" "+(c-5)+","+(this._height+5)+" "+c+","+this._height);return this};return a}(),c=g.bands[0];null!=g.brushSVG&&g.brushSVG.remove();g.brush=d3.svg.brush().x(c.xScale.range([0,c.w])).extent([g.zMinDate,g.zMaxDate]).on("brush",function(){var a=g.brush.extent(),c;"move"===d3.event.mode?(c=d3.time.day.round(a[0]),a=d3.time.day.offset(c,Math.round((a[1]-a[0])/864E5)),c=[c,a]):(c=a.map(d3.time.day.round),c[0]>=c[1]&&(c[0]=d3.time.day.floor(a[0]),
c[1]=d3.time.day.ceil(d3.time.day.offset(c[0],Math.round(g.instGap/864E5)))));g.zMinDate=c[0];g.zMaxDate=c[1];g.brush.extent(c);g.brushHandler.redraw();zoom=g.bands[1];zoom.xScale.domain(c);zoom.redraw()});g.brushSVG=c.g.append("svg");g.brushHandler=(new a(g.brushSVG,c.h-1)).x(c.xScale).redraw()})();(function(){var a=g.bands[1],a=a.t+a.h+45;d3.select(g.frameID+" svg.tl-vf").attr("height",a);d3.select("#tl-clip-"+l+" rect").attr("height",a)})();d(0);d(1);f(0);f(1);g.cmpnts.forEach(function(a){a.redraw()})};
VizTime.prototype.resize=function(){var a=this.getWidths(),c=d3.select(this.frameID+" svg.tl-vf");c.attr("width",a[1]);c.select("#tl-clip-"+this.vFrame.getIndex()+" rect").attr("width",a[1]);for(var e=0;2>e;e++){b=this.bands[e];b.w=a[1];c.select(b.svgID).attr("width",a[1]);b.xScale.range([0,a[1]]);var d=b.labels[1],f=d.x()+d.tDelta;b.labelSVGs.select("#rect-"+d.name).attr("x",d.left());b.labelSVGs.select("#txt-"+d.name).attr("x",f);if(0==e){if(this.brush){if(this.brushSVG){var g=this.brush.extent();
this.brushSVG.call(this.brush.extent(g))}this.brushHandler&&this.brushHandler.redraw()}b.labelSVGs.select("#m-txt-"+d.name).attr("x",f)}}this.cmpnts.forEach(function(a){a.redraw()})};VizTime.prototype.setSel=function(a){var c=this;c.recSel=a;d3.select(this.bands[1].svgID).selectAll(".event").attr("class",function(a){return c.isSel(a.ai)?a.f&EVENT_INSTANT?"event instant obj-sel":"event range obj-sel":a.f&EVENT_INSTANT?"event instant":"event range"})};
VizTime.prototype.clearSel=function(){function a(a){return a.f&EVENT_INSTANT?"event instant":"event range"}0<this.recSel.length&&(this.recSel=[],d3.select(this.bands[1].svgID).selectAll(".event").attr("class",a))};
VizTime.prototype.getState=function(){var a=this.brush.extent(),c=a[0],a=a[1],e=c.getUTCMonth()+1,c=c.getUTCFullYear().toString()+"-"+e.toString()+"-"+c.getDate().toString(),e=a.getUTCMonth()+1,a=a.getUTCFullYear().toString()+"-"+e.toString()+"-"+a.getDate().toString();return{d0:c,d1:a,l:this.vFrame.getLgndSels()}};VizTime.prototype.setState=function(a){var c=PData.parseDate(a.d0,!1),e=PData.parseDate(a.d1,!0);this.bands[1].xScale.domain([c,e]);this.zMinDate=c;this.zMaxDate=e;this.vFrame.setLgndSels(a.l)};
var VizDirectory=function(a,c){PVizModel.call(this,a,c)};VizDirectory.prototype=Object.create(PVizModel.prototype);VizDirectory.prototype.constructor=VizDirectory;VizDirectory.prototype.flags=function(){return V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_OPT};
VizDirectory.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(c){if("TD"==c.target.nodeName){c=jQuery(c.target).closest("tr");var e=c.data("ai");null!=e&&(a.toggleSel(e)?c.addClass("obj-sel"):c.removeClass("obj-sel"))}});a.sAtts=[];for(var c=0;c<PData.getNumETmplts();c++){var e=jQuery('#dialog-sortby select[data-ti="'+c+'"] :first').val();a.sAtts.push(e)}for(c=0;c<PData.getNumETmplts();c++)jQuery('#dialog-sortby select[data-ti="'+c+'"]').val(a.sAtts[c])};
VizDirectory.prototype.render=function(a){var c=PData.getNumETmplts(),e=0,d,f,g,l,p,n,t=jQuery(this.frameID);t.empty();0<this.recSel.length&&(this.recSel=[]);this.stream=a;for(d=a.t[0];e<c;){for(;0==d.n;){if(++e==c)return;d=a.t[e]}d=PData.getETmpltIndex(e);d=PData.getTmpltID(d);t.append('<div class="template-label">'+d.l+'</div><table cellspacing="0" class="viz-directory" data-ti='+e+"></table>");f=t.find('table[data-ti="'+e+'"]');g=this.settings.cnt[e];n="<thead><tr>";g.forEach(function(a){a=PData.getAttID(a);
n+="<th>"+a.def.l+"</th>"});f.append(n+"<tr></thead><tbody></tbody>");f=f.find("tbody");d=this.sAtts[e];d=PData.getAttID(d);d=PData.orderTBy(d,this.stream,e);d.forEach(function(a){p=PData.getRecByIndex(a.i);n='<tr data-id="'+p.id+'" data-ai='+a.i+">";g.forEach(function(a){l=p.a[a];"undefined"!=typeof l?n=(l=PData.procAttTxt(a,l))?n+("<td>"+l+"</td>"):n+"<td></td>":n+="<td></td>"});f.append(n+"</tr>")});d=a.t[++e]}};
VizDirectory.prototype.rerender=function(a){var c=this,e,d,f,g,l,p=jQuery(this.frameID+' table.viz-directory[data-ti="'+a+'"] tbody');p.empty();tRec=this.stream.t[a];e=c.settings.cnt[a];d=PData.getAttID(c.sAtts[a]);PData.orderTBy(d,c.stream,a).forEach(function(a){g=PData.getRecByIndex(a.i);l="<tr "+(c.isSel(a.i)?'class="obj-sel" ':"")+'data-id="'+g.id+'" data-ai='+a.i+">";e.forEach(function(a){f=g.a[a];"undefined"!=typeof f?l=(f=PData.procAttTxt(a,f))?l+("<td>"+f+"</td>"):l+"<td></td>":l+="<td></td>"});
p.append(l+"</tr>")})};VizDirectory.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")};
VizDirectory.prototype.doOptions=function(){var a=this,c=jQuery("#dialog-sortby").dialog({height:220,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close");PState.set(PSTATE_BUILD);for(var e=0;e<PData.getNumETmplts();e++){var d=jQuery('#dialog-sortby select[data-ti="'+e+'"]').val();d!=a.sAtts[e]&&(a.sAtts[e]=d,a.rerender(e))}PState.set(PSTATE_READY)}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})};
VizDirectory.prototype.setSel=function(a){var c=this,e,d;this.recSel=a;jQuery(this.frameID).find("tr").each(function(){d=jQuery(this);e=d.data("ai");null!=e&&(c.isSel(e)?d.addClass("obj-sel"):d.removeClass("obj-sel"))})};VizDirectory.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],jQuery(this.frameID).find("tr").removeClass("obj-sel"))};VizDirectory.prototype.getState=function(){return{s:this.sAtts}};
VizDirectory.prototype.setState=function(a){this.sAtts=a.s;this.sAtts.forEach(function(a,e){jQuery('#dialog-sortby select[data-ti="'+e+'"]').val(a)})};var VizTextStream=function(a,c){PVizModel.call(this,a,c)};VizTextStream.prototype=Object.create(PVizModel.prototype);VizTextStream.prototype.constructor=VizTextStream;VizTextStream.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_VSCRL};
VizTextStream.prototype.getLocAtts=function(a){return null!=a?(a=this.settings.order[a],null==a?null:[a]):_.map(this.settings.order,function(a){return[a]})};VizTextStream.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};VizTextStream.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(c){if("DIV"==c.target.nodeName){c=jQuery(c.target);var e=c.data("ai");"undefined"!=typeof e&&0<=e&&(a.toggleSel(e)?c.addClass("obj-sel"):c.removeClass("obj-sel"))}})};
VizTextStream.prototype.render=function(a){var c=this,e=PData.getNumETmplts(),d=0,f,g,l,p,n,t,h,q,v,y,m,u,k,z,A,r,D,w=jQuery(this.frameID);w.empty();0<this.recSel.length&&(this.recSel=[]);r=this.settings.max-this.settings.min;for(g=a.t[0];d<e;){for(;0==g.n;){if(++d==e)return;g=a.t[d]}v=c.vFrame.getSelLocAtts(d);if(0!=v.length&&(v=c.vFrame.getSelFeatAtts(d),0!=v.length)){y=c.vFrame.getSelLegend(d);m=PData.getAttID(y);w.append('<div class="viz-textstream" data-ti='+d+"></div>");l=w.find("div.viz-textstream[data-ti="+
d+"]");f=PData.getETmpltIndex(d);f=PData.getTmpltID(f);l.append('<div class="template-label">'+f.l+"</div>");q=c.settings.cnt[d];if(z=c.settings.sAtts[d])k=PData.getAttID(z),"number"==typeof k.r.min&&"number"==typeof k.r.max?A=k.r.max-k.r.min:z=null;q&&(f=PData.getAttID(c.settings.order[d]),f=PData.orderTBy(f,a,d),f.forEach(function(a){p=PData.getRecByIndex(a.i);n=p.a[y];"undefined"!=typeof n&&(u=PData.getAttLgndRecs(n,m,v,!1))&&((t=p.a[q])&&(t=PData.procAttTxt(q,t)),t&&(z?(h=p.a[z],h="undefined"!=
typeof h?Math.floor((h-k.r.min)*r/A)+c.settings.min:c.settings.min):h=c.settings.min,D=u.b?";background-color:black":"",l.append('<div class="recitem" data-ai='+a.i+' style="color:'+u.v+D+";font-size:"+h+'px">'+t+"</div>")))}))}d++}};VizTextStream.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")};
VizTextStream.prototype.setSel=function(a){var c=this;this.vFrame.getIndex();var e,d;this.recSel=a;jQuery(this.frameID).find("div.recitem").each(function(){d=jQuery(this);e=d.data("ai");null!=e&&(c.isSel(e)?d.addClass("obj-sel"):d.removeClass("obj-sel"))})};VizTextStream.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],jQuery(this.frameID).find("div.recitem").removeClass("obj-sel"))};VizTextStream.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}};
VizTextStream.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)};VizTextStream.prototype.hint=function(){for(var a="",c,e,d=PData.getNumETmplts(),f=0;f<d;f++)if(c=this.settings.order[f])if(c=PData.getAttID(c),e=PData.getETmpltIndex(f),e=PData.getTmpltID(e),0<a.length&&(a+="; "),a+=e.l+": "+dlText.orderedby+" "+c.def.l,c=this.settings.sAtts[f])c=PData.getAttID(c),a+=", "+dlText.textsize+" "+c.def.l;return a};var VizStackChart=function(a,c){PVizModel.call(this,a,c);this.bSel=[]};
VizStackChart.prototype=Object.create(PVizModel.prototype);VizStackChart.prototype.constructor=VizStackChart;VizStackChart.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SLGND|V_FLAG_VSCRL|V_FLAG_HSCRL};VizStackChart.prototype.getFeatureAtts=function(a){return this.settings.sAtt};
VizStackChart.prototype.setup2=function(){var a=0;this.cats.forEach(function(c){a=Math.max(a,c.l.length)});this.colW=a=Math.max(D3FG_BAR_WIDTH,8*a+4);var c=this.cats.length*a,e=this.settings.h;this.xScale=d3.scale.linear().domain([0,this.cats.length]).rangeRound([0,c]);this.yScale=d3.scale.linear().range([0,e-1]);this.rScale=d3.scale.ordinal().rangeRoundBands([0,c]);this.rScale.domain(this.cats.map(function(a){return a.l}));this.xAxis=d3.svg.axis().scale(this.rScale).orient("top");this.yAxis=d3.svg.axis().scale(this.yScale).orient("left").ticks(10);
this.svg=d3.select(this.frameID).append("svg").attr("width",c+D3SC_MARGINS.left+D3SC_MARGINS.right).attr("height",e+D3SC_MARGINS.top+D3SC_MARGINS.bottom);this.svg.append("g").attr("class","chart").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")");this.svg.append("g").attr("class","x axis").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")").call(this.xAxis);this.svg.append("g").attr("class","y axis").attr("transform","translate("+D3SC_MARGINS.left+","+
D3SC_MARGINS.top+")")};VizStackChart.prototype.setup=function(){var a=PData.getAttID(this.settings.oAtt);"T"==a.def.t&&this.settings.tlit?this.cats=null:(this.cats=this.settings.gr?PData.getRCats(a,!0):PData.getLCats(a,null),this.setup2())};
VizStackChart.prototype.render=function(a){var c=this;this.bSel=[];var e=this.settings.oAtt,d=this.settings.sAtt;this.svg.selectAll(".block").remove();null==this.cats?(this.cats=[],PData.fillCats(this.cats,e,d,a,!0),this.setup2()):PData.fillCats(this.cats,e,d,a,!1);this.blocks=[];a=PData.getAttID(d);for(var e=0,d=c.vFrame.getSelFeatAtts(0),d=PData.getLCats(a,d),f=0;f<this.cats.length;f++){if(0<f)for(var g=0;g<d.length;g++)d[g].i=[];PData.sortCats(c.cats[f].i,a,d);var l=0;d.forEach(function(a){0<a.i.length&&
(c.blocks.push({x:f,c:a.c,y:l,h:a.i.length,a:a.i}),l+=a.i.length)});e=Math.max(e,l)}c.yScale.domain([0,e]);c.svg.select(".y.axis").call(c.yAxis);a=c.colW-7;this.svg.selectAll(".block").data(c.blocks).enter().append("rect").attr("class","block").attr("x",function(a){return D3SC_MARGINS.left+5+c.xScale(a.x)}).attr("y",function(a){return c.yScale(a.y)+D3SC_MARGINS.top}).attr("fill",function(a){return a.c}).attr("height",function(a){return Math.max(1,c.yScale(a.h)-1)}).attr("width",a).on("click",function(a,
d){var e=c.bSel.length,h=_.sortedIndex(c.bSel,d);c.bSel[h]==d?(d3.select(this).classed("obj-sel",!1),c.bSel.splice(h,1),0<e&&0==c.bSel.length&&c.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),c.bSel.splice(h,0,d),0==e&&0<c.bSel.length&&c.vFrame.selBtns(!0))})};VizStackChart.prototype.setSel=function(a){};VizStackChart.prototype.clearSel=function(){0<this.bSel.length&&(this.bSel=[],this.svg.selectAll(".block").classed("obj-sel",!1))};
VizStackChart.prototype.getSel=function(){var a=this,c=[];this.bSel.forEach(function(e){c=PData.union(c,a.blocks[e].a)});return c};VizStackChart.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}};VizStackChart.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)};VizStackChart.prototype.hint=function(){var a=dlText.xaxis+": ",c=PData.getAttID(this.settings.oAtt),a=a+(c.def.l+", "+dlText.yaxis+": "),c=PData.getAttID(this.settings.sAtt);return a+=c.def.l};
var VizNetWheel=function(a,c){PVizModel.call(this,a,c);this.bSel=[]};VizNetWheel.prototype=Object.create(PVizModel.prototype);VizNetWheel.prototype.constructor=VizNetWheel;VizNetWheel.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_HSCRL};VizNetWheel.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};
VizNetWheel.prototype.setup=function(){function a(){360<c.spin?c.spin-=360:0>c.spin&&(c.spin+=360);c.center.attr("transform","translate("+c.cr+","+c.cr+")rotate("+c.spin+")")}var c=this;this.spin=0;var e=this.vFrame.getIndex(),d=_.template(document.getElementById("dltext-v-nwheel").innerHTML);jQuery("#view-frame-"+e+" div.view-control-bar").append(d({vi:e}));jQuery("#nw-prev-"+e).button({text:!1,icons:{primary:" ui-icon-arrowreturnthick-1-s"}}).click(function(){jQuery("#nw-size-"+e+" :radio:checked").attr("id")==
"nw-size-1-"+e?c.spin+=c.inc:c.spin+=90;a()});jQuery("#nw-for-"+e).button({text:!1,icons:{primary:" ui-icon-arrowreturnthick-1-n"}}).click(function(){jQuery("#nw-size-"+e+" :radio:checked").attr("id")=="nw-size-1-"+e?c.spin-=c.inc:c.spin-=90;a()});jQuery("#nw-size-"+e).buttonset();this.svg=d3.select(this.frameID).append("svg");this.center=this.svg.append("g")};
VizNetWheel.prototype.render=function(a){var c=this,e=[],d,f,g;this.svg.selectAll(".node").remove();this.svg.selectAll(".link").remove();this.inc=360/(a.l+a.t.length);f=Math.max((14*a.l+20)/(2*Math.PI),30);var l=this.settings.lw;"string"==typeof l&&(l=parseInt(l));this.cr=l+12+f;l=2*this.cr;this.svg.attr("width",l).attr("height",l);this.center.attr("transform","translate("+this.cr+","+this.cr+")");0<this.recSel.length&&(this.recSel=[]);var p={children:[]};(function(){var d,e=0,h=0,q,v,f,m=[],u=null,
k,g;d=a.t[0];g=c.vFrame.getSelLegend(0);k=PData.getAttID(g);u=c.vFrame.getSelFeatAtts(0);a:for(;h<a.l;){for(;0==d.n||d.i+d.n==h||0==u.length;){0<m.length&&(p.children.push({ti:e,children:m}),m=[]);if(++e==PData.getNumETmplts())break a;m=[];d=a.t[e];g=c.vFrame.getSelLegend(e);k=PData.getAttID(g);u=c.vFrame.getSelFeatAtts(e)}f=a.s[h];q=PData.getRecByIndex(f);v=q.a[g];"undefined"!=typeof v&&(fData=PData.getAttLgndRecs(v,k,u,!1))&&m.push({r:q,ai:f,c:fData.v,children:[]});h++}0<m.length&&p.children.push({ti:e,
children:m})})();f=d3.layout.cluster().size([360,f]).sort(null).nodes(p);g=this.center.append("g").selectAll(".node").data(f.filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("transform",function(a){return"rotate("+(a.x-90)+")translate("+(a.y+8)+",0)"});g.append("circle").attr("r","5").style("fill",function(a){return a.c}).on("click",function(a){a=c.toggleSel(a.ai);d3.select(this).classed("obj-sel",a)});g.append("text").attr("dy",".31em").attr("dx",function(a){return 180>
a.x?"10":"-10"}).attr("transform",function(a){return 180>a.x?"":"rotate(180)"}).style("text-anchor",function(a){return 180>a.x?"start":"end"}).attr("fill","white").text(function(a){return a.r.l}).on("click",function(a){PState.set(PSTATE_UPDATE);g.each(function(a){a.linked=!1});d.each(function(c){if(c.s===a){c.t.linked=!0;for(var h=0;h<e.length;h++){var d=e[h];if(d.source===a&&d.target===c.t){d3.select(this).attr("stroke",d.c).classed("thick",!0);this.parentElement.appendChild(this);break}}}else if(c.t===
a)for(c.s.linked=!0,h=0;h<e.length;h++){if(d=e[h],d.target===a&&d.source===c.s){d3.select(this).attr("stroke",d.c).classed("thick",!0);this.parentElement.appendChild(this);break}}else d3.select(this).attr("stroke","white").classed("thick",!1)});g.select("text").attr("fill",function(a){return a.linked?"black":"white"});d3.select(this).attr("fill","red");PState.set(PSTATE_READY)});f=d3.layout.bundle();l=d3.svg.line.radial().interpolate("bundle").tension(.85).radius(function(a){return a.y}).angle(function(a){return a.x/
180*Math.PI});p.children.forEach(function(a){var d=c.settings.pAtts[a.ti],h;a.children.forEach(function(a){d.forEach(function(c){h=a.r.a[c.pid];"undefined"!=typeof h&&h.forEach(function(h){var d=!1,f,k=0;a:for(;k<p.children.length;k++)for(var g=p.children[k],l=0;l<g.children.length;l++)if(f=g.children[l],f.r.id==h){d=!0;break a}d&&e.push({source:a,target:f,c:c.clr})})})})});d=this.center.append("g").selectAll(".link").data(f(e)).enter().append("path").each(function(a){a.s=a[0];a.t=a[a.length-1]}).attr("class",
"link").attr("d",l).attr("stroke","white")};VizNetWheel.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-control-bar div.iconbar").remove()};VizNetWheel.prototype.setSel=function(a){var c=this;c.recSel=a;this.svg.selectAll(".node circle").attr("class",function(a){return c.isSel(a.ai)?"obj-sel":""})};VizNetWheel.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],this.svg.selectAll(".node circle").attr("class",""))};
VizNetWheel.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}};VizNetWheel.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)};var VizFlow=function(a,c){PVizModel.call(this,a,c);this.bSel=[];this.fSel=[]};VizFlow.prototype=Object.create(PVizModel.prototype);VizFlow.prototype.constructor=VizFlow;VizFlow.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL};
VizFlow.prototype.setup=function(){this.bH=Math.max(120,Math.ceil(this.settings.w/3));var a=40+(this.settings.fcts.length-1)*this.bH;this.svg=d3.select(this.frameID).append("svg").attr("width",this.settings.w+10).attr("height",a);this.barG=this.svg.append("g");this.flowG=this.svg.append("g");this.titleG=this.svg.append("g")};
VizFlow.prototype.render=function(a){var c=this;this.bSel=[];this.fSel=[];this.barG.selectAll(".bar").remove();this.flowG.selectAll(".flow").remove();this.titleG.selectAll(".att-title").remove();var e=this.settings.w;c.bars=[];c.atts=[];c.settings.fcts.forEach(function(d,f){var g,l=PData.getAttID(d);"T"==l.def.t&&c.settings.tlit?(g=[],PData.fillCats(g,d,null,a,!0)):(g=c.settings.gr?PData.getRCats(l,!0):PData.getLCats(l,null),PData.fillCats(g,d,null,a,!1));var p=[],n=0;g.forEach(function(a){0<a.i.length&&
(p.push(a),n+=a.i.length)});var t=0,h=31+f*c.bH;p.forEach(function(a){c.bars.push({x:5+t*e/n,w:a.i.length*e/n,y:h,c:a});t+=a.i.length});c.atts.push({l:l.def.l,c:p,t:n,y:h})});this.barG.selectAll(".bar").data(c.bars).enter().append("rect").attr("class","bar").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("fill",function(a){return a.c.c}).attr("height","8").attr("width",function(a){return a.w}).on("click",function(a,e){var g=c.bSel.length,l=_.sortedIndex(c.bSel,e);c.bSel[l]==
e?(d3.select(this).classed("obj-sel",!1),c.bSel.splice(l,1),0<g&&0==c.bSel.length&&0==c.fSel.length&&c.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),c.bSel.splice(l,0,e),0==g&&0==c.fSel.length&&0<c.bSel.length&&c.vFrame.selBtns(!0))}).append("title").text(function(a){return a.c.l+" ("+a.c.i.length+")"});c.ints=[];c.atts.forEach(function(a,f){if(f!=c.atts.length-1){for(var g=c.atts[f+1],l=Array(a.c.length),p=0;p<a.c.length;p++)l[p]=Array(g.c.length);a.c.forEach(function(a,c){g.c.forEach(function(h,
d){l[c][d]=PData.intersect(a.i,h.i)})});for(var n=Array(g.c.length),t=0;t<g.c.length;t++){for(var h=0,p=0;p<a.c.length;p++)0<l[p][t].length&&h++;n[t]=h-1}for(var q=Array(g.c.length),t=0;t<g.c.length;t++)q[t]=0;var v=0;a.c.forEach(function(h,m){for(var f=0,k=0;k<g.c.length;k++)0<l[m][k].length&&f++;--f;var p=h.i.length*e/a.t,t=0,r=0;g.c.forEach(function(k,w){var x=l[m][w];if(0<x.length){var C=x.length*e,B=C/a.t,C=C/g.t,E=k.i.length*e/g.t;c.ints.push({i:x,c:h.c,l:h.l+" > "+k.l,x1:5+v*e/a.t+(f?(p-B)*
t/f:0),x2:5+r*e/g.t+(n[w]?(E-C)*q[w]/n[w]:0),w1:B,w2:C,y1:a.y+10,y2:g.y-1});t++;q[w]++}r+=k.i.length});v+=h.i.length})}});this.flowG.selectAll(".flow").data(c.ints).enter().append("path").attr("class","flow").attr("d",function(a){return"M "+a.x1+" "+a.y1+"  L "+(a.x1+a.w1)+" "+a.y1+" L "+(a.x2+a.w2)+" "+a.y2+" L "+a.x2+" "+a.y2+" L "+a.x1+" "+a.y1}).attr("fill",function(a){return a.c}).on("click",function(a,e){var g=c.fSel.length,l=_.sortedIndex(c.fSel,e);c.fSel[l]==e?(d3.select(this).classed("obj-sel",
!1),c.fSel.splice(l,1),0<g&&0==c.fSel.length&&0==c.bSel.length&&c.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),c.fSel.splice(l,0,e),0==g&&0==c.bSel.length&&0<c.fSel.length&&c.vFrame.selBtns(!0))}).on("mouseover",function(){d3.select(this).classed("active",!0);this.parentElement.appendChild(this)}).on("mouseout",function(){d3.select(this).classed("active",!1)}).append("title").text(function(a){return a.l+" ("+a.i.length+")"});this.titleG.selectAll(".att-title").data(c.atts).enter().append("text").attr("class",
"att-title").attr("x","5").attr("y",function(a){return a.y-8}).text(function(a){return a.l})};VizFlow.prototype.setSel=function(a){};VizFlow.prototype.clearSel=function(){0<this.bSel.length&&(this.bSel=[],this.svg.selectAll(".bar").classed("obj-sel",!1));0<this.fSel.length&&(this.fSel=[],this.svg.selectAll(".flow").classed("obj-sel",!1))};
VizFlow.prototype.getSel=function(){var a=this,c=[];this.bSel.forEach(function(e){c=PData.union(c,a.bars[e].c.i)});this.fSel.forEach(function(e){c=PData.union(c,a.ints[e].i)});return c};function PFilterModel(a,c){this.id=a;this.att=c;this.dirty=!0}PFilterModel.prototype.isDirty=function(a){null!=a&&(!this.dirty&&a&&0<this.id&&jQuery("#btn-recompute").addClass("pulse"),this.dirty=a);return this.dirty};PFilterModel.prototype.title=function(){return this.att.def.l};
PFilterModel.prototype.insertPt=function(){return jQuery('div.filter-instance[data-id="'+this.id+'"] div.filter-body')};PFilterModel.prototype.teardown=function(){};var PFilterRemove=function(a){PFilterModel.call(this,a,null)};PFilterRemove.prototype=Object.create(PFilterModel.prototype);PFilterRemove.prototype.constructor=PFilterRemove;PFilterRemove.prototype.title=function(){return dlText.rha};PFilterRemove.prototype.evalPrep=function(){};PFilterRemove.prototype.eval=function(a){return!1};
PFilterRemove.prototype.setup=function(){var a=this.insertPt(),c=document.getElementById("dltext-filter-remove").innerHTML;a.append(c)};PFilterRemove.prototype.getState=function(){return{}};PFilterRemove.prototype.setState=function(a){};var PFilterText=function(a,c){PFilterModel.call(this,a,c)};PFilterText.prototype=Object.create(PFilterModel.prototype);PFilterText.prototype.constructor=PFilterText;PFilterText.prototype.evalPrep=function(){this.fStr=this.insertPt().find("input.filter-text").val()};
PFilterText.prototype.eval=function(a){var c=this.fStr;if(null==c||""==c)return!0;a=a.a[this.att.id];return"undefined"==typeof a?!1:-1!=a.indexOf(c)};PFilterText.prototype.setup=function(){var a=this,c=this.insertPt(),e=document.getElementById("dltext-filter-text").innerHTML;c.append(e);c.find("input.filter-text").change(function(){a.isDirty(!0)})};PFilterText.prototype.getState=function(){return{t:this.insertPt().find("input.filter-text").val()}};PFilterText.prototype.setState=function(a){this.insertPt().find("input.filter-text").val(a.t)};
var PFilterVocab=function(a,c){PFilterModel.call(this,a,c)};PFilterVocab.prototype=Object.create(PFilterModel.prototype);PFilterVocab.prototype.constructor=PFilterVocab;PFilterVocab.prototype.evalPrep=function(){var a=this;this.sel=[];this.insertPt().find("div.filter-vocab-row input:checked").each(function(){var c=jQuery(this).parent().data("id");a.sel.push(c)});a.sel.sort()};
PFilterVocab.prototype.eval=function(a){if(0==this.sel.length)return!1;a=a.a[this.att.id];if("undefined"==typeof a)return!1;for(var c,e,d=0;d<a.length;d++)if(e=a[d],c=_.sortedIndex(this.sel,e),this.sel[c]==e)return!0;return!1};
PFilterVocab.prototype.setup=function(){var a=this,c='<div class="filter-vocab-container">';this.att.l.forEach(function(a,e){c+='<div class="filter-vocab-entry" data-index="'+e+'"><div class="filter-vocab-row" data-id="'+a.l+'"><input type="checkbox" value="min-use" checked="checked">'+a.l+'</div><div class="filter-vocab-bar" style="background-color:'+a.v+'"></div>';a.z.forEach(function(e,f){c+='<div class="filter-vocab-row" data-id="'+e.l+'"><input type="checkbox" value="min-use" checked="checked">'+
e.l+"</div>";c=null==e.v||""==e.v?c+('<div class="filter-vocab-bar" style="background-color:'+a.v+'"></div>'):c+('<div class="filter-vocab-bar" style="background-color:'+e.v+'"></div>')});c+="</div>"});var e=this.insertPt();e.append(c+"</div>");e.click(function(c){"INPUT"==c.target.nodeName&&a.isDirty(!0)})};PFilterVocab.prototype.getState=function(){var a=[];this.insertPt().find("div.filter-vocab-row input:checked").each(function(){var c=jQuery(this).parent().data("id");a.push(c)});a.sort();return{s:a}};
PFilterVocab.prototype.setState=function(a){this.insertPt().find("div.filter-vocab-row").each(function(){var c=jQuery(this),e=c.data("id"),e=_.indexOf(a.s,e,!0);c.find("input").prop("checked",-1!=e)})};var PFilterNum=function(a,c){PFilterModel.call(this,a,c)};PFilterNum.prototype=Object.create(PFilterModel.prototype);PFilterNum.prototype.constructor=PFilterNum;
PFilterNum.prototype.evalPrep=function(){if(null==this.rCats){var a=this.insertPt();this.min=parseInt(a.find("input.filter-num-min-val").val());this.max=parseInt(a.find("input.filter-num-max-val").val());this.useMin=a.find("input.filter-num-min-use").is(":checked");this.useMax=a.find("input.filter-num-max-use").is(":checked")}};
PFilterNum.prototype.eval=function(a){a=a.a[this.att.id];if("undefined"==typeof a||this.useMin&&a<this.min)return!1;if(null==this.rCats){if(this.useMax&&a>this.max)return!1}else if(a>=this.max)return!1;return!0};
PFilterNum.prototype.setup=function(){var a=this,c=this.insertPt();this.rCats=PData.getRCats(this.att,!1);if(null==this.rCats){var e=_.template(document.getElementById("dltext-filter-num-boxes").innerHTML),d="undefined"==typeof this.att.r.min?0:this.att.r.min;c.append(e({min:d,max:"undefined"==typeof this.att.r.max?d+100:this.att.r.max}));c.click(function(c){"INPUT"==c.target.nodeName&&a.isDirty(!0)});c.find("input.filter-num-min-val").change(function(){var d=jQuery(this).val(),h=c.find("input.filter-num-max-val").val();
d<=h?a.isDirty(!0):jQuery(this).val(h)});c.find("input.filter-num-max-val").change(function(){var d=jQuery(this).val(),h=c.find("input.filter-num-min-val").val();d>=h?a.isDirty(!0):jQuery(this).val(h)})}else{this.useMin=this.useMax=!0;this.min=this.rCats[0].min;this.max=this.rCats[this.rCats.length-1].max;var f=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,g=0;this.rCats.forEach(function(a){g=Math.max(g,a.l.length)});var g=Math.max(D3FG_BAR_WIDTH,7*g),e=this.rCats.length*g,l=d3.scale.linear().domain([0,
this.rCats.length]).rangeRound([0,e]),p=d3.scale.linear().domain([0,100]).range([f,0]),d=d3.scale.ordinal().rangeRoundBands([0,e]);d.domain(this.rCats.map(function(a){return a.l}));var d=d3.svg.axis().scale(d).orient("bottom"),n=d3.svg.axis().scale(p).orient("left").ticks(4),e=d3.select(c.get(0)).append("svg").attr("width",e+D3FG_MARGINS.left+D3FG_MARGINS.right).attr("height",f+D3FG_MARGINS.top+D3FG_MARGINS.bottom).append("g").attr("transform","translate("+D3FG_MARGINS.left+","+D3FG_MARGINS.top+")");
e.append("g").attr("class","x axis").attr("transform","translate(0,"+f+")").call(d);e.append("g").attr("class","y axis").call(n);e.selectAll(".bar").data(this.rCats).enter().append("rect").attr("class","bar").attr("x",function(a,c){return l(c)+2}).attr("y",function(a){return p(100)}).attr("fill",function(a){return a.c}).attr("height",function(a){return f-p(100)}).attr("width",g-4);a.brush=d3.svg.brush().x(l).extent([0,this.rCats.length]).on("brushend",function(){if(d3.event.sourceEvent){var c=a.brush.extent(),
h=[Math.floor(c[0]),Math.floor(c[1])];h[0]>=h[1]&&(h[0]=Math.floor(c[0]),h[1]=Math.ceil(c[1]));h[1]=Math.max(h[1],h[0]+1);d3.select(this).transition().call(a.brush.extent(h));a.min=a.rCats[h[0]].min;a.max=a.rCats[h[1]-1].max;a.isDirty(!0)}});a.brushg=e.append("g");a.brushg.attr("class","brush").call(a.brush);a.brushg.selectAll("rect").attr("y",0).attr("height",f);a.brushg.selectAll(".resize").append("path").attr("d",function(a){var c=(a=+("e"==a))?1:-1,d=f/4;return"M"+.5*c+","+d+"A6,6 0 0 "+a+" "+
6.5*c+","+(d+6)+"V"+(2*d-6)+"A6,6 0 0 "+a+" "+.5*c+","+2*d+"ZM"+2.5*c+","+(d+8)+"V"+(2*d-8)+"M"+4.5*c+","+(d+8)+"V"+(2*d-8)})}};
PFilterNum.prototype.getState=function(){if(null==this.rCats){var a=this.insertPt(),c=parseInt(a.find("input.filter-num-min-val").val()),e=parseInt(a.find("input.filter-num-max-val").val()),d=a.find("input.filter-num-min-use").is(":checked"),a=a.find("input.filter-num-max-use").is(":checked");return{rc:!1,min:c,max:e,useMin:d,useMax:a}}c=this.brush.extent();return{rc:!0,e0:c[0],e1:c[1]}};
PFilterNum.prototype.setState=function(a){if(a.rc)this.min=this.rCats[a.e0].min,this.max=this.rCats[a.e1-1].max,this.brush.extent([a.e0,a.e1]),this.brushg.call(this.brush);else{var c=this.insertPt();c.find("input.filter-num-min-val").val(a.min);c.find("input.filter-num-max-val").val(a.max);c.find("input.filter-num-min-use").prop("checked",a.useMin);c.find("input.filter-num-max-use").prop("checked",a.useMax)}};var PFilterDates=function(a,c,e){PFilterModel.call(this,a,c,e)};PFilterDates.prototype=Object.create(PFilterModel.prototype);
PFilterDates.prototype.constructor=PFilterDates;PFilterDates.prototype.evalPrep=function(){this.c=jQuery("input[name=dctrl-"+this.id+"]:checked").val()};
PFilterDates.prototype.eval=function(a){function c(a,c,e,l,p){"undefined"!=typeof l.m&&(c=l.m,"undefined"!=typeof l.d&&(e=l.d));return PData.date3Nums(a,c,e,p)}var e=a.a[this.att.id];if("undefined"==typeof e)return!1;if("undefined"==typeof e.max)return a=c(e.min.y,1,1,e.min,!1),this.min<=a&&a<this.max;a=c(e.min.y,1,1,e.min,!1);e="open"==e.max?TODAY:c(e.max.y,12,31,e.max,!0);return"o"==this.c?e<this.min||a>=this.max?!1:!0:this.min<=a&&e<=this.max};
PFilterDates.prototype.setup=function(){var a=this;this.rCats=PData.getRCats(this.att,!1);this.min=this.rCats[0].min;this.max=this.rCats[this.rCats.length-1].max;var c=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,e=0;this.rCats.forEach(function(a){e=Math.max(e,a.l.length)});var e=Math.max(D3FG_BAR_WIDTH,7*e),d=this.rCats.length*e,f=d3.scale.linear().domain([0,this.rCats.length]).rangeRound([0,d]),g=d3.scale.linear().domain([0,100]).range([c,0]),l=d3.scale.ordinal().rangeRoundBands([0,d]);l.domain(this.rCats.map(function(a){return a.l}));
var l=d3.svg.axis().scale(l).orient("bottom"),p=d3.svg.axis().scale(g).orient("left").ticks(4),n=this.insertPt(),t=_.template(document.getElementById("dltext-filter-date-ctrl").innerHTML);n.append(t({id:this.id}));n.find("input[name=dctrl-"+a.id+"]").change(function(){a.isDirty(!0)});d=d3.select(n.get(0)).append("svg").attr("width",d+D3FG_MARGINS.left+D3FG_MARGINS.right).attr("height",c+D3FG_MARGINS.top+D3FG_MARGINS.bottom).append("g").attr("transform","translate("+D3FG_MARGINS.left+","+D3FG_MARGINS.top+
")");d.append("g").attr("class","x axis").attr("transform","translate(0,"+c+")").call(l);d.append("g").attr("class","y axis").call(p);d.selectAll(".bar").data(this.rCats).enter().append("rect").attr("class","bar").attr("x",function(a,c){return f(c)+2}).attr("y",function(a){return g(100)}).attr("fill",function(a){return a.c}).attr("height",function(a){return c-g(100)}).attr("width",e-4);a.brush=d3.svg.brush().x(f).extent([0,this.rCats.length]).on("brushend",function(){if(d3.event.sourceEvent){var c=
a.brush.extent(),d=[Math.floor(c[0]),Math.floor(c[1])];d[0]>=d[1]&&(d[0]=Math.floor(c[0]),d[1]=Math.ceil(c[1]));d[1]=Math.max(d[1],d[0]+1);d3.select(this).transition().call(a.brush.extent(d));a.min=a.rCats[d[0]].min;a.max=a.rCats[d[1]-1].max;a.isDirty(!0)}});a.brushg=d.append("g");a.brushg.attr("class","brush").call(a.brush);a.brushg.selectAll("rect").attr("y",0).attr("height",c);a.brushg.selectAll(".resize").append("path").attr("d",function(a){var d=(a=+("e"==a))?1:-1,e=c/4;return"M"+.5*d+","+e+
"A6,6 0 0 "+a+" "+6.5*d+","+(e+6)+"V"+(2*e-6)+"A6,6 0 0 "+a+" "+.5*d+","+2*e+"ZM"+2.5*d+","+(e+8)+"V"+(2*e-8)+"M"+4.5*d+","+(e+8)+"V"+(2*e-8)})};PFilterDates.prototype.getState=function(){var a=this.brush.extent(),c=jQuery("input[name=dctrl-"+this.id+"]:checked").val();return{e0:a[0],e1:a[1],c:c}};PFilterDates.prototype.setState=function(a){jQuery('input[name="dctrl-'+this.id+'"]').val([a.c]);this.min=this.rCats[a.e0].min;this.max=this.rCats[a.e1-1].max;this.brush.extent([a.e0,a.e1]);this.brushg.call(this.brush)};
function PViewFrame(a){function c(){return"#view-frame-"+a}function e(a){a=jQuery(c()+" div.view-control-bar select.view-viz-select option:selected").val();PState.set(PSTATE_BUILD);y(a,!0);PState.set(PSTATE_READY)}function d(a){k.flags()&V_FLAG_LGND&&jQuery(c()+" div.lgnd-container").toggle("slide",{direction:"left"});a.preventDefault()}function f(a){function c(a){var h=new Number,d=parseTC.exec(a);if(null!==d)h=1E3*(3600*parseInt(d[1])+60*parseInt(d[2])+parseFloat(d[3])),h=1==d[4].length?h+100*parseInt(d[4]):
h+10*parseInt(d[4]);else throw reportError(!1,"Error in transcript file: Cannot parse "+a+" as timecode."),Error("Error in transcript file: Cannot parse "+a+" as timecode.");return h}function h(a,c){var d=new String(a);if(widgetData.extract){var e=d.indexOf(widgetData.extract[0]);if(-1==e)throw Error("Transcript2 excerpt error: Cannot find timestamp "+widgetData.extract[0]);var q=d.indexOf(widgetData.extract[1]);if(-1==q)throw Error("Transcript2 excerpt error: Cannot find timestamp "+widgetData.extract[1]);
d=d.substring(e-1,q-1)}var d=d.trim().split(/\r\n|\r|\n/g),v=[];if(d){var k,m=0;_.each(d,function(a){a=a.trim();0<a.length&&("["===a.charAt(0)?(0<m&&v.push(k),k=""):k+=a,m++)})}_.each(v,function(a,h){c.find('div.timecode[data-tcindex="'+h+'"]').next().after('<div class="xscript">'+a+"</div>")})}function d(a){widgetData.tcArray=[];widgetData.tcIndex=-1;var e=widgetData.tcArray;a=new String(a);if(widgetData.extract){var q=a.indexOf(widgetData.extract[0]);if(-1==q)throw Error("Transcript excerpt error: Cannot find timestamp "+
widgetData.extract[0]);var v=a.indexOf(widgetData.extract[1]);if(-1==v)throw Error("Transcript excerpt error: Cannot find timestamp "+widgetData.extract[1]);a=a.substring(q-1,v-1)}if(a=a.trim().split(/\r\n|\r|\n/g)){var k=0,m,f=0,u=0,g="",r=jQuery("#xscript-tbl");_.each(a,function(a){a=a.trim();1<a.length&&("["===a.charAt(0)&&"0"<=a.charAt(1)&&"9">=a.charAt(1)?(m=c(a),0<g.length&&(u&&e.push({s:f,e:m}),r.append('<div class="row"><div class="timecode" data-timecode="'+f+'" data-tcindex="'+k++ +'">'+
u+'</div><div class="xscript">'+g+"</div></div>"),g=""),u=a,f=m):g+=a)});0<g.length&&(e.push({s:f,e:324E5}),r.append('<div class="row"><div class="timecode" data-timecode="'+f+'" data-tcindex="'+k+'">'+u+'</div><div class="xscript">'+g+"</div></div>"));if("undefined"!=typeof p&&null!=p){var y=new XMLHttpRequest;y.onload=function(a){h(y.responseText,r)};y.open("GET",p,!0);y.send()}}}function e(a){var c,h=widgetData.tcIndex;_.find(widgetData.tcArray,function(d,e){if((c=d.s<=a&&a<d.e)&&e!=h){var q=jQuery("#xscript-tbl");
if(document.getElementById("sync-xscript").checked){var v=q.find('[data-tcindex="'+e+'"]').offset().top-q.offset().top,v=q.scrollTop()+v;q.animate({scrollTop:v},300)}-1!=h&&q.find('[data-tcindex="'+h+'"]').removeClass("current");q.find('[data-tcindex="'+e+'"]').addClass("current");widgetData.tcIndex=e}return c})}function q(){widgetData.widget=new YT.Player("yt-widget",{width:"426",height:"240",videoId:widgetData.ytCode,events:{onError:function(a){console.log("YouTube Error: "+a.data)},onStateChange:function(a){var c;
switch(a.data){case 1:widgetData.playing=!0;null==widgetData.timer&&(widgetData.timer=setInterval(function(){c=1E3*widgetData.widget.getCurrentTime();widgetData.playing&&e(c)},300));break;case 0:case 2:widgetData.playing=!1;window.clearInterval(widgetData.timer);widgetData.timer=null;break;case 3:case 5:widgetData.playing=!1}},onReady:function(){widgetData.extract&&widgetData.widget.cueVideoById({videoId:widgetData.ytCode,startSeconds:widgetData.sTime/1E3,endSeconds:widgetData.eTime/1E3})}}})}function v(){function a(){widgetData.sTime=
widgetData.eTime=null;var h;(h=prspdata.e.i.t.tcAtts[m])&&(h=A.a[h])&&""!=h&&(h=h.split("-"),widgetData.extract=h,widgetData.sTime=c(h[0]),widgetData.eTime=c(h[1]))}var h=z[t];A=PData.getRecByIndex(h);var k=" "+A.l+" ("+(t+1)+"/"+z.length+") ";jQuery("#inspect-name").text(k);var m=PData.aIndex2Tmplt(h);u.empty();prspdata.e.i.modal.atts[m].forEach(function(a){var c=PData.getRecAtt(h,a,!1);c&&(a=PData.getAttID(a),c="_"==a.def.l.charAt(0)?"<div>"+c+"</div>":'<div><span class="att-label">'+a.def.l+":</span> "+
c+"</div>",u.append(c))});y=null;l=0;widgetData.extract=null;widgetData.xscriptOn=!1;widgetData.playing=!1;if(prspdata.e.i.modal.scOn&&(y=prspdata.e.i.sc.atts[m])&&(k=A.a[y])){var f=!0;a();l=1;u.append('<iframe id="sc-widget" class="player" width="100%" height="150" src="http://w.soundcloud.com/player/?url='+k+'"></iframe></p>');var g=SC.Widget(document.getElementById("sc-widget"));widgetData.widget=g;g.bind(SC.Widget.Events.READY,function(){g.play();g.bind(SC.Widget.Events.PLAY,function(){widgetData.playing=
!0});g.bind(SC.Widget.Events.PAUSE,function(){widgetData.playing=!1});g.bind(SC.Widget.Events.PLAY_PROGRESS,function(a){f&&(g.pause(),f=!1,widgetData.playing=!1);widgetData.extract&&(a.currentPosition<widgetData.sTime?g.seekTo(widgetData.sTime):a.currentPosition>widgetData.eTime&&(g.pause(),widgetData.playing=!1));widgetData.playing&&widgetData.xscriptOn&&e(a.currentPosition)});g.bind(SC.Widget.Events.FINISH,function(){widgetData.playing=!1})})}if(0==l&&prspdata.e.i.modal.ytOn&&(y=prspdata.e.i.yt.atts[m])&&
(k=A.a[y])){a();widgetData.ytCode=k;u.append('<div id="yt-widget"></div>');widgetData.ytCall=q;if(widgetData.ytLoaded)q();else{widgetData.ytLoaded=!0;k=document.createElement("script");k.src="https://www.youtube.com/iframe_api";var r=document.getElementsByTagName("script")[0];r.parentNode.insertBefore(k,r)}l=2}if(prspdata.e.i.modal.tOn&&(k=prspdata.e.i.t.t1Atts[m])&&""!==k&&"disable"!=k&&(k=A.a[k])){0<l&&u.append("<div>"+document.getElementById("dltext-sync-xscript").innerHTML+"</div>");u.append('<div id="xscript-tbl"><div>');
widgetData.xscriptOn=!0;jQuery("#xscript-tbl").click(function(a){if(l&&jQuery(a.target).hasClass("timecode"))switch(a=jQuery(a.target).data("timecode"),l){case 1:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play());widgetData.widget.seekTo(a);break;case 2:widgetData.playing||(widgetData.playing=!0,widgetData.widget.playVideo()),widgetData.widget.seekTo(a/1E3)}});p=null;(r=prspdata.e.i.t.t2Atts[m])&&""!==r&&"disable"!=r&&(p=A.a[r]);var F=new XMLHttpRequest;F.onload=function(a){d(F.responseText)};
F.open("GET",k,!0);F.send()}}function m(a){a=t+a;-1==a?a=z.length-1:a==z.length&&(a=0);a!=t&&(t=a,v())}function f(a){m(-1)}function g(a){m(1)}var u=jQuery("#inspect-content"),y=null,l=0,p,z=null;k&&(z=k.getSel());if(null!=z&&0!=z.length){var n,A,t=0;v();jQuery("#btn-inspect-left").click(f);jQuery("#btn-inspect-right").click(g);var J=450,K=400;prspdata.e.i.modal.scOn&&(J=550);prspdata.e.i.modal.ytOn&&(J=Math.max(J,460),K=500);prspdata.e.i.tOn&&(K+=100,J=prspdata.e.i.t2On?750:Math.max(J,500));n=jQuery("#dialog-inspector").dialog({width:J,
height:K,modal:!0,buttons:[{text:dlText.seerec,click:function(){window.open(prspdata.site_url+"?p="+A.wp,"_blank")}},{text:dlText.close,click:function(){switch(l){case 1:null!=widgetData.widget&&widgetData.playing&&widgetData.widget.pause();widgetData.playing=!1;widgetData.widget=null;break;case 2:widgetData.ytCall=null,null!=widgetData.widget&&widgetData.playing&&widgetData.widget.stopVideo(),widgetData.widget=null,widgetData.playing=!1,null!=widgetData.timer&&(window.clearInterval(widgetData.timer),
widgetData.timer=null)}jQuery("#btn-inspect-left").off("click");jQuery("#btn-inspect-right").off("click");n.dialog("close")}}]});a.preventDefault()}}function g(a){var h=jQuery(c()+" .view-control-bar");a?(h.find(".osel").button("enable"),h.find(".osel").addClass("pulse"),h.find(".xsel").button("enable")):(h.find(".osel").button("disable"),h.find(".osel").removeClass("pulse"),h.find(".xsel").button("disable"))}function l(a){PState.set(PSTATE_UPDATE);k&&k.clearSel();g(!1);PState.set(PSTATE_READY);a.preventDefault()}
function p(a){k&&k.doOptions();a.preventDefault()}function n(a){var c=jQuery("#dialog-vnotes").dialog({width:300,height:300,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close")}}]});a.preventDefault()}function t(a,h){jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",h)}function h(a){var h=jQuery(a.target).closest("div.lgnd-template").data("index"),d=a.target.className;switch(d){case "lgnd-update":k&&
A&&(PState.set(PSTATE_BUILD),g(!1),k.render(A),PState.set(PSTATE_READY));break;case "lgnd-entry-check":d=jQuery(a.target).closest("div.lgnd-entry");a=jQuery(a.target).is(":checked");d.hasClass("lgnd-sh")?t(h,a):d.hasClass("lgnd-locate")?d.data("id"):d.hasClass("lgnd-value")&&d.data("index");break;case "lgnd-viz":case "lgnd-value-title":d=jQuery(a.target).closest("div.lgnd-entry");d.hasClass("lgnd-locate")?(a=d.data("id"),jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+
h+'"] div.lgnd-locate input.lgnd-entry-check').prop("checked",!1),jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+h+'"] div.lgnd-locate[data-id="'+a+'"] input.lgnd-entry-check').prop("checked",!0)):d.hasClass("lgnd-value")&&(a=d.data("index"),jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+h+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",!1),jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+h+
'"] div.lgnd-group div.lgnd-value[data-index="'+a+'"] input.lgnd-entry-check').prop("checked",!0));break;case "lgnd-template":case "lgnd-select":case "":break;default:d.match(/lgnd-sh/i)&&(d=jQuery(a.target).find("input.lgnd-entry-check"),a=!d.is(":checked"),d.prop("checked",a),t(h,a))}}function q(a){var c=jQuery(a.target).closest("div.lgnd-template").data("index");a=jQuery(a.target).val();v(c,a)}function v(a,h){var d,e=jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+
a+'"] div.lgnd-group');e.empty();z[a]=h;PData.getAttID(h).l.forEach(function(a,c){d='<div class="lgnd-value lgnd-entry" data-index="'+c+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+a.v+'"> </div> <span class="lgnd-value-title">'+a.l+"</span></div>";e.append(d);a.z&&0<a.z.length&&a.z.forEach(function(a,h){d='<div class="lgnd-value lgnd-entry" data-index="'+c+","+h+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/>';
d=a.v&&""!=a.v?d+('<div class="lgnd-viz" style="background-color: '+a.v+'"></div>'):d+'<div class="lgnd-viz lgnd-viz-empty"></div>';d+=' <span class="lgnd-value-title">&raquo; '+a.l+"</span></div>";e.append(d)})});jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-sh input').prop("checked",!0)}function y(h,d){var e=PData.getVizIndex(h);k&&(k.teardown(),k=null);var f=jQuery(c());f.find("div.viz-content div.viz-result").empty();var y;switch(e.vf){case "M":y=
new VizMap(m,e.c);break;case "C":y=new VizCards(m,e.c);break;case "P":y=new VizPinboard(m,e.c);break;case "T":y=new VizTime(m,e.c);break;case "D":y=new VizDirectory(m,e.c);break;case "t":y=new VizTextStream(m,e.c);break;case "S":y=new VizStackChart(m,e.c);break;case "N":y=new VizNetWheel(m,e.c);break;case "F":y=new VizFlow(m,e.c)}u=h;var l=y.flags();l&V_FLAG_HSCRL?(f.find("div.viz-content").addClass("h-scroll"),f.find("div.viz-result").addClass("viz-fit-w"),f.find("div.viz-result").removeClass("viz-max-w")):
(f.find("div.viz-content").removeClass("h-scroll"),f.find("div.viz-result").removeClass("viz-fit-w"),f.find("div.viz-result").addClass("viz-max-w"));l&V_FLAG_VSCRL?(f.find("div.viz-content").addClass("v-scroll"),f.find("div.viz-result").addClass("viz-fit-h"),f.find("div.viz-result").removeClass("viz-max-h")):(f.find("div.viz-content").removeClass("v-scroll"),f.find("div.viz-result").removeClass("viz-fit-h"),f.find("div.viz-result").addClass("viz-max-h"));z=[];if(l&V_FLAG_LGND){f.find(".hslgnd").button("enable");
var p=f.find("div.lgnd-container div.lgnd-scroll");p.empty();if(l&V_FLAG_SLGND){var n=y.getFeatureAtts(),F=PData.getAttID(n);p.append('<div class="lgnd-template" data-index="0"><div class="lgnd-title">'+F.def.l+'</div><div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/>'+dlText.sha+'</div><div class="lgnd-group"></div></div>');z.push(n);v(0,n)}else prspdata.e.g.ts.forEach(function(a,c){var h=PData.getTmpltID(a),d=y.getLocAtts(c);if(d&&0<d.length||!(l&
V_FLAG_LOC)){var e=jQuery('<div class="lgnd-template" data-index="'+c+'"><div class="lgnd-title">'+h.l+"</div></div>");d&&d.forEach(function(a,c){var h=PData.getAttID(a);e.append('<div class="lgnd-entry lgnd-locate" data-id="'+a+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><span class="lgnd-value-title">'+h.def.l+"</span></div>")});var h=y.getFeatureAtts(c),k='<select class="lgnd-select">';h.forEach(function(a,c){var h=PData.getAttID(a);k+='<option value="'+a+'">'+h.def.l+
"</option>"});k+="</select>";d=jQuery(k);d.change(q);jQuery(e).append(d);jQuery(e).append('<div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/>'+dlText.sha+'</div><div class="lgnd-group"></div>');p.append(e);c!=prspdata.t.length-1&&p.append("<hr/>");h=0<h.length?h[0]:null;z.push(h);h&&v(c,h)}});f.find("div.lgnd-container").show()}else f.find(".hslgnd").button("disable"),f.find("div.lgnd-container").hide();n=jQuery("#selector-v"+a);l&V_FLAG_SEL?(n.removeAttr("disabled"),
n.prop("checked",!0)):(n.attr("disabled",!0),n.prop("checked",!1));l&V_FLAG_OPT?f.find(".vopts").button("enable"):f.find(".vopts").button("disable");(n=y.hint())||"string"==typeof e.n&&""!=e.n?(f.find(".vnote").button("enable"),n=n?"string"==typeof e.n&&""!=e.n?n+(".<br/>"+e.n):n+".":e.n,jQuery("#vnotes-txt").empty().append(n)):f.find(".vnote").button("disable");y.setup();g(!1);A&&d&&y.render(A);k=y}var m={},u=0,k=null,z=[],A=null;m.getFrameID=c;m.getIndex=function(){return a};m.setViz=function(a,
h){a!=u&&(jQuery(c()+" div.view-control-bar select.view-viz-select").val(a),y(a,h))};m.initDOM=function(q){var k=document.getElementById("dltext-viewframe-dom").innerHTML;jQuery("#viz-display-frame").append('<div id="view-frame-'+a+'">'+k+"</div>");var k=jQuery(c()),v=prspdata.bClrs.vf;v&&0<v.length&&k.find("div.view-control-bar").css("background-color",v);k.find("div.lgnd-container").draggable({handle:k.find("div.lgnd-handle"),containment:"parent"});var m=k.find("div.view-control-bar select.view-viz-select");
prspdata.e.vf.forEach(function(a,c){m.append('<option value="'+c+'">'+a.l+"</option>")});m.val(q);m.change(e);k.find("div.view-control-bar button:first").button({icons:{primary:"ui-icon-bookmark"},text:!1}).click(d).next().button({icons:{primary:"ui-icon-search"},text:!1}).click(f).next().button({icons:{primary:"ui-icon-cancel"},text:!1}).click(l).next().button({icons:{primary:"ui-icon-gear"},text:!1}).click(p).next().button({icons:{primary:"ui-icon-help"},text:!1}).click(n).next();k.find("div.lgnd-container").click(h);
y(q,!1)};m.getSelLocAtts=function(a){var h=[];jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-locate input:checked').each(function(){var a=jQuery(this).parent().data("id");h.push(a)});return h};m.getSelFeatAtts=function(a){var h=[],d,e;jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group div.lgnd-value input:checked').each(function(){d=jQuery(this).parent().data("index");"number"==typeof d?h.push(d):-1!=
(e=d.indexOf(","))?h.push([parseInt(d.substring(0,e),10),parseInt(d.substring(e+1),10)]):h.push(parseInt(d,10))});return h};m.getSelLegend=function(a){return z[a]};m.getLgndSels=function(){return z.slice(0)};m.setLgndSels=function(a){a.forEach(function(a,h){jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+h+'"] select.lgnd-select').val(a);v(h,a)})};m.getState=function(){return k?k.getState():null};m.setState=function(a){k&&k.setState(a)};m.showStream=function(a){A=a;
k&&k.render(a)};m.setStream=function(a){A=a};m.selBtns=function(a){g(a)};m.clearSel=function(){k&&k.clearSel();g(!1)};m.setSel=function(a){return k&&k.flags()&V_FLAG_SEL?(k.setSel(a),g(0<a.length),!0):!1};m.resize=function(){k&&k.resize()};m.title=function(){return PData.getVizIndex(u).l};m.flushLgnd=function(){jQuery(c()).find("div.lgnd-container").css("left","10px")};return m}
var PData=function(){function a(a,d,e){jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_records",tmplt_id:prspdata.t[a].id,from:d,count:e},success:function(d,q,f){q=p[a];d=JSON.parse(d);q.d=q.d?q.d.concat(d):d;q.n+=e;c()},error:function(a,c,h){alert(h)}})}function c(){for(var c=!0,d=0;d<prspdata.t.length;d++){var v=p[d].n,f=prspdata.t[d].n;if(v<f){c=!1;f-=v;a(d,v,f<e?f:e);break}}c&&(t=!0,setTimeout(function(){jQuery("body").trigger("prospect",{pstate:PSTATE_PROCESS,component:0})},
500))}var e=1E3,d,f,g,l,p=[],n=0,t=!1;return{init:function(){d=document.getElementById("dltext-from").innerHTML;f=document.getElementById("dltext-to").innerHTML;g=document.getElementById("dltext-approximately").innerHTML;l=document.getElementById("dltext-now").innerHTML;"number"==typeof prspdata.chunk&&0<prspdata.chunk&&(e=prspdata.chunk);prspdata.t.forEach(function(a){p.push({i:n,n:0,d:null});n+=a.n});c()},intersect:function(a,c){for(var d=[],e=a.length,m=c.length,f,k,g=0,l=0;g<e&&l<m;)f=a[g],k=
c[l],f>k?l++:k>f?g++:(d.push(f),g++,l++);return d},union:function(a,c){for(var d=[],e=0,f=0,g,k;e<a.length&&f<c.length;)g=a[e],k=c[f],g<k?(d.push(g),e++):(g==k?(d.push(g),e++):d.push(k),f++);for(;e<a.length;e++)d.push(a[e]);for(;f<c.length;f++)d.push(c[f]);return d},strcmp:function(a,c){for(var d=0,e=Math.max(a.length,c.length);d<e&&a.charAt(d)===c.charAt(d);++d);return d===e?0:a.charAt(d)>c.charAt(d)?-1:1},newIndexStream:function(a){var c={};c.s=new Uint16Array(n);c.t=[];c.l=0;if(a){for(a=0;a<n;a++)c.s[a]=
a;for(a=0;a<p.length;a++){var d=p[a];c.t.push({i:d.i,n:d.n})}c.l=n}return c},aIndex2Tmplt:function(a){for(var c=0;c<p.length;c++){var d=p[c];if(d.i<=a&&a<d.i+d.n)return c}},attInTmplt:function(a,c){return-1!=prspdata.t[c].def.a.findIndex(function(c){return c==a})},stream1stTEntry:function(a,c){var d=a.t[c];return 0==d.n?-1:d.i},getRecByIndex:function(a){for(var c=0;c<p.length;c++){var d=p[c];if(0<d.n&&d.i<=a&&a<d.i+d.n)return d.d[a-d.i]}return null},procAttTxt:function(a,c){var e=PData.getAttID(a);
switch(e.def.t){case "V":return c.join(", ");case "T":return c;case "N":return c.toString();case "D":return c.max?(e=d,c.min.f&&(e+=g),e+=c.min.y.toString(),c.min.m&&(e+="-"+c.min.m.toString(),c.min.d&&(e+="-"+c.min.d.toString())),e+=f,"open"==c.max?e+=l:(c.max.f&&(e+=g+" "),e+=c.max.y.toString(),c.max.m&&(e+="-"+c.max.m.toString(),c.max.d&&(e+="-"+c.max.d.toString())))):(e=c.min.f?g:"",e+=c.min.y.toString(),c.min.m&&(e+="-"+c.min.m.toString(),c.min.d&&(e+="-"+c.min.d.toString()))),e;case "L":case "X":return c.join(", ");
case "I":return'<img src="'+c+'" alt="'+e.def.l+'"/>';case "l":return'<a href="'+c+'" target="_blank">(See Link)</a>';case "S":return'<a href="'+c+'" target="_blank">(SoundCloud)</a>';case "Y":return'<a href="https://www.youtube.com/watch?v='+c+'" target="_blank">(YouTube)</a>';case "x":return'<a href="'+c+'" target="_blank">(See Transcript File)</a>';case "t":return c;case "P":if(0<c.length){var y="";c.forEach(function(a){(a=PData.getRecByID(a))&&(y+='<a href="'+prspdata.site_url+"?p="+a.wp+'" target="_blank">'+
a.l+"</a> ")});return y}}return null},getRecAtt:function(a,c,d){for(var e=0;e<p.length;e++){var f=p[e];if(0<f.n&&f.i<=a&&a<f.i+f.n){a=f.d[a-f.i].a[c];if(null==a||"undefined"==typeof a)break;return d?a:PData.procAttTxt(c,a)}}return null},getAbsIByID:function(a){for(var c=0;c<p.length;c++){var d=p[c];if(0<d.n)for(var e=0,f=d.n-1,g,k;e<=f;)if(g=e+f>>1,k=d.d[g],k=PData.strcmp(a,k.id),0>k)e=g+1;else if(0<k)f=g-1;else return d.i+g}return null},getRecByID:function(a){for(var c=0;c<p.length;c++){var d=p[c];
if(0<d.n)for(var e=0,f=d.n-1,g,k,l;e<=f;)if(g=e+f>>1,l=d.d[g],k=PData.strcmp(a,l.id),0>k)e=g+1;else if(0<k)f=g-1;else return l}return null},getAttID:function(a){for(var c=0,d=prspdata.a.length-1,e,f;c<=d;)if(e=c+d>>1,f=PData.strcmp(a,prspdata.a[e].id),0>f)c=e+1;else if(0<f)d=e-1;else return prspdata.a[e];return null},getAttIndex:function(a){return prspdata.a[a]},getNumETmplts:function(){return prspdata.e.g.ts.length},getETmpltIndex:function(a){return prspdata.e.g.ts[a]},getTmpltID:function(a){for(var c=
0;c<prspdata.t.length;c++)if(a==prspdata.t[c].id)return prspdata.t[c].def},getAttLgndRecs:function(a,c,d,e){var f,g=d.length,k;switch(c.def.t){case "V":var l=function(a){for(var e=0;e<g;e++)if(f=d[e],"number"===typeof f){if(k=c.l[f],k.l==a)return k}else{k=c.l[f[0]];var h=k.z[f[1]];if(h.l==a)return h.v&&""!=h.v?h:k}return null};if(e&&""!=c.def.d){var p=[],r;a.forEach(function(a){r=l(a);null!=r&&p.push(r)});return 0<p.length?p:null}if(""!=c.def.d){for(e=0;e<a.length;e++)if(r=l(a[e]),null!=r)return r;
break}else return l(a[0]);case "T":for(r=0;r<g;r++)if(f=d[r],k=c.l[f],-1!=a.indexOf(k.d))return k;break;case "N":for(r=0;r<g;r++)if(f=d[r],k=c.l[f],"undefined"!=typeof k.d.min){if(k.d.min<=a)if("undefined"!=typeof k.d.max){if(a<=k.d.max)return k}else return k}else if(a<=k.d.max)return k;break;case "D":for(r=0;r<g;r++)if(f=d[r],k=c.l[f],"undefined"!=typeof k.d.max.y){if("undefined"!=typeof a.max&&"open"!=a.max){if(a.max.y<k.d.min.y)continue;if(a.max.y==k.d.min.y&&a.max.m&&k.d.min.m){if(a.max.m<k.d.min.m)continue;
if(a.max.m==k.d.min.m&&a.max.d&&k.d.min.d&&a.max.d<k.d.min.d)continue}}if(!(a.min.y>k.d.max.y)){if(a.min.y==k.d.max.y&&a.min.m&&k.d.max.m){if(a.min.m>k.d.max.m)continue;if(a.min.m==k.d.max.m&&a.min.d&&k.d.max.d&&a.min.d>k.d.max.d)continue}return k}}else if("undefined"!=typeof a.max){if("open"==a.max)return k;if(!(a.max.y<k.d.min.y)){if(a.max.y==k.d.min.y&&a.max.m&&k.d.min.m){if(a.max.m<k.d.min.m)continue;if(a.max.m==k.d.min.m&&a.max.d&&k.d.min.d&&a.max.d<k.d.min.d)continue}return k}}else if(!(a.min.y<
k.d.min.y)){if(a.min.y==k.d.min.y&&a.min.m&&k.d.min.m){if(a.min.m<k.d.min.m)continue;if(a.min.m==k.d.min.m&&a.min.d&&k.d.min.d&&a.min.d<k.d.min.d)continue}return k}}return null},getAttLgndVal:function(a,c,d){var e;return(e=PData.getAttLgndRecs(a,c,d,!1))?e.v:null},getVLgndVal:function(a,c){for(var d=0,e=a.x.length-1,f,g;d<=e;)if(f=d+e>>1,g=PData.strcmp(c,a.x[f].l),0>g)d=f+1;else if(0<g)e=f-1;else return d=a.x[f].i,"number"==typeof d?a.l[d]:a.l[d[0]].z[d[1]];return null},date3Nums:function(a,c,d,e){0>
a||99<a?c=new Date(a,c-1,d):0==a?c=new Date(-1,c-1,d):(c=new Date(a,c-1,d),c.setUTCFullYear(("0000"+a).slice(-4)));e&&c.setTime(c.getTime()+MS_IN_DAY);return c},objDate:function(a,c,d){var e;"undefined"!=typeof a.m&&null!=a.m?(c=a.m,e="undefined"!=typeof a.d&&null!=a.d?a.d:mnthDays[c-1]):e=mnthDays[c-1];return PData.date3Nums(a.y,c,e,d)},parseDate:function(a,c){var d,e;if("open"==a)return TODAY;d=1;"-"==a.charAt(0)&&(d=-1,a=a.substring(1));e=a.split("-");var f=parseInt(e[0])*d;1<e.length?(d=parseInt(e[1]),
e=3==e.length?parseInt(e[2]):c?mnthDays[d-1]:1):c?(d=12,e=31):e=d=1;return PData.date3Nums(f,d,e,c)},makeDates:function(a){var c,d,e,f,g=!1;d=a.min.y;"undefined"==typeof a.min.m?f=e=1:(e=a.min.m,"undefined"==typeof a.min.d?f=1:(f=a.min.d,g=!0));c=PData.date3Nums(d,e,f,!1);if("undefined"!=typeof a.max)"open"==a.max?a=TODAY:(d=a.max.y,"undefined"==typeof a.max.m?(e=12,f=31):(e=a.max.m,f="undefined"==typeof a.max.d?mnthDays[e-1]:a.max.d),a=PData.date3Nums(d,e,f,!0));else{if(g)return[c,null];"undefined"==
typeof a.min.m?(e=12,f=31):(e=a.min.m,f=mnthDays[e-1]);a=PData.date3Nums(d,e,f,!0)}return[c,a]},getLCats:function(a,c){var d=[];switch(a.def.t){case "T":return a.l.forEach(function(e){(null==c||PData.getAttLgndRecs(e.d,a,c,!1))&&d.push({l:e.l,x:e.d,c:e.v,i:[]})}),d;case "V":return a.l.forEach(function(e){(null==c||PData.getAttLgndRecs([e.l],a,c,!1))&&d.push({l:e.l,c:e.v,i:[]});e.z.forEach(function(e){(null==c||PData.getAttLgndRecs([e.l],a,c,!1))&&d.push({l:e.l,c:e.v,i:[]})})}),d;case "N":return a.l.forEach(function(e){(null==
c||PData.getAttLgndRecs(e.d.min,a,c,!1))&&d.push({l:e.l,c:e.v,min:e.d.min,max:e.d.max,i:[]})}),d;case "D":var e,f;a.l.forEach(function(g){e=PData.objDate(g.min,1,!1);if(null==c||PData.getAttLgndRecs(e,a,c,!1))f=null==g.max.y?TODAY:PData.objDate(g.max,12,!0),d.push({l:g.l,c:g.v,min:e,max:f})});return d}},getRCats:function(a,c){var d=[];switch(a.def.t){case "T":return a.l.forEach(function(a){c?d.push({l:a.l,x:a.d,c:a.v,i:[]}):d.push({l:a.l,x:a.d,c:a.v})}),d;case "V":return a.l.forEach(function(a){c?
d.push({l:a.l,c:a.v,i:[]}):d.push({l:a.l,c:a.v});a.z.forEach(function(a){c?d.push({l:a.l,c:a.v,i:[]}):d.push({l:a.l,c:a.v})})}),d;case "N":if("undefined"==typeof a.r.min||"undefined"==typeof a.r.max)return null;var e=Math.pow(10,a.r.g),f=a.r.min,g=0,k,l,p;for(0<a.l.length&&(k=a.l[0]);f<=a.r.max;){for(;g<a.l.length&&"undefined"!=typeof k.d.max&&f>k.d.max;)k=a.l[++g];p=0==a.l.length||f<k.d.min?"#777777":g==a.l.length?"#777777":"undefined"==typeof k.d.max||f<=k.d.max?k.v:"#777777";l=f;max=f+=e;var r=
l.toString();1<e&&4>r.length&&(r+="-"+(max-1).toString());c?d.push({l:r,c:p,min:l,max:f,i:[]}):d.push({l:r,c:p,min:l,max:f})}return d;case "D":f=function(a){var c,d;if("undefined"==typeof a.y)return TODAY;c=a.y;"undefined"==typeof a.m?(d=12,a=31):(d=a.m,a="undefined"==typeof a.d?mnthDays[d-1]:a.d);return PData.date3Nums(c,d,a,!0)};l=function(a,c,d,e){"undefined"!=typeof e.m&&(c=e.m,"undefined"!=typeof e.d&&(d=e.d));return PData.date3Nums(a,c,d,!1)};p=f(a.r.max);var e=a.r.g,r=a.r.min.y,n=1,w=1;"undefined"!=
typeof a.r.min.m&&(n=a.r.min.m,"undefined"!=typeof a.r.min.d&&(w=a.r.min.d));var x=PData.date3Nums(r,n,w,!1),g=0,t,B;0<a.l.length&&(k=a.l[0],t=l(k.d.min.y,1,1,k.d.min),B=f(k.d.max));for(;x<=p;){var E={};c&&(E.i=[]);switch(e){case "d":E.l=r.toString()+"-"+n.toString()+"-"+w.toString();break;case "m":E.l=r.toString()+"-"+n.toString();break;case "y":case "t":case "c":E.l=r.toString()}for(;g<a.l.length&&x>B;)k=a.l[++g],g<a.l.length&&(t=l(k.d.min.y,1,1,k.d.min),B=f(k.d.max));E.c=0==a.l.length||x<t?"#777777":
g==a.l.length?"#777777":x<=B?k.v:"#777777";E.min=x;switch(e){case "d":E.max=PData.date3Nums(r,n,w+1,!0);w++;break;case "m":E.max=PData.date3Nums(r,n+1,w,!0);n++;break;case "y":E.max=PData.date3Nums(r+1,n,w,!0);r++;break;case "t":E.max=PData.date3Nums(r+10,n,w,!0);r+=10;break;case "c":E.max=PData.date3Nums(r+100,n,w,!0),r+=100}d.push(E);x=PData.date3Nums(r,n,w,!1)}return d}},fillCats:function(a,c,d,e,f){var g=PData.getNumETmplts(),k=0,l,p=0,n,t,w,x,C=PData.getAttID(c);for(l=e.t[0];p<e.l;){for(;0==
l.n||l.i+l.n==p||!PData.attInTmplt(c,k)||d&&!PData.attInTmplt(d,k);){if(++k==g)return;l=e.t[k];p=l.i}n=e.s[p];t=PData.getRecByIndex(n);t=t.a[c];if("undefined"!=typeof t)switch(C.def.t){case "T":if(f){for(w=0;w<a.length;w++)if(x=a[w],t==x.l){x.i.push(n);break}w==a.length&&a.push({l:t,i:[n]})}else for(w=0;w<a.length;w++)if(x=a[w],-1!=t.indexOf(x.x)){x.i.push(n);break}break;case "V":t.forEach(function(c){for(w=0;w<a.length;w++)if(x=a[w],c==x.l){x.i.push(n);break}});break;case "N":for(w=0;w<a.length;w++){x=
a[w];if(t<x.min)break;if(x.min<=t&&t<=x.max){x.i.push(n);break}}break;case "D":for(t=PData.objDate(t.min,1,!1),w=0;w<a.length;w++){x=a[w];if(t<x.min)break;if(x.min<=t&&t<=x.max){x.i.push(n);break}}}p++}f&&a.sort(function(a,c){return PData.strcmp(c.l,a.l)})},sortCats:function(a,c,d){var e=c.id,f,g,k;a.forEach(function(a){f=PData.getRecByIndex(a);datum=f.a[e];if("undefined"!=typeof datum)switch(c.def.t){case "T":for(g=0;g<d.length;g++)if(k=d[g],-1!=datum.indexOf(k.x)){k.i.push(a);break}break;case "V":datum.forEach(function(c){for(g=
0;g<d.length;g++)if(k=d[g],c==k.l){k.i.push(a);break}});break;case "N":for(g=0;g<d.length;g++){k=d[g];if(datum<k.min)break;if(k.min<=datum&&datum<=k.max){k.i.push(a);break}}break;case "D":var h=PData.objDate(datum.min,1,!1);for(g=0;g<d.length;g++){k=d[g];if(h<k.min)break;if(k.min<=h&&h<=k.max){k.i.push(a);break}}}})},orderTBy:function(a,c,d){function e(a){return a}function f(a){return a[0]}function g(a){var c=1,d=1;"undefined"!=typeof a.min.m&&(c=a.min.m,"undefined"!=typeof a.min.d&&(d=a.min.d));
return PData.date3Nums(a.min.y,c,d,!1)}var k,l;switch(a.def.t){case "T":k=e;l="~";break;case "V":k=f;l="~";break;case "N":k=e;l=a.r.max;break;case "D":k=g,l=TODAY}var n=[],r=c.t[d];d=p[d];for(var t=0,w,x;t<r.n;)w=c.s[r.i+t++],x=d.d[w-d.i],x=x.a[a.id],"undefined"==typeof x?n.push({i:w,v:l}):n.push({i:w,v:k(x)});switch(a.def.t){case "T":case "V":n.sort(function(a,c){return PData.strcmp(c.v,a.v)});break;case "D":case "N":n.sort(function(a,c){return a.v-c.v})}return n},getVizIndex:function(a){return prspdata.e.vf[a]},
ready:function(){return t}}}();
jQuery(document).ready(function(a){function c(){var a;PState.set(PSTATE_PROCESS);null==w&&(w=PData.newIndexStream(!0));x=w;var c=!1,d,e;for(d=0;d<z.length;d++)if(e=z[d],a=jQuery('div.filter-instance[data-id="'+e.id+'"]'),c||e.f.isDirty(null)){c=!0;e.f.evalPrep();var f=PData.newIndexStream(!1),h=0,g,l,n=0,m=x.t[0],p=0,q;for(q=a.find(".apply-tmplt-0").is(":checked");h<x.l;){for(;0==m.n||m.i+m.n==h;)f.t.push({i:f.l-p,n:p}),p=0,m=x.t[++n],q=a.find(".apply-tmplt-"+n).is(":checked");g=x.s[h++];q?(l=PData.getRecByIndex(g),
e.f.eval(l)&&(f.s[f.l++]=g,p++)):(f.s[f.l++]=g,p++)}for(;n++<PData.getNumETmplts();)f.t.push({i:f.l-p,n:p}),p=0;e.f.isDirty(!1);x=e.f.out=f}else x=e.f.out;PState.set(PSTATE_BUILD);u.showStream(x);k&&k.showStream(x);jQuery("#btn-recompute").removeClass("pulse")}function e(a){var c=jQuery("#annote");c.text(a);0<a.length?(jQuery("#btn-annote").button("enable"),c.show()):(jQuery("#btn-annote").button("disable"),c.hide())}function d(a){var c=_.find(prspdata.p,function(c){return a==c.id});return c?c:null==
C||0==B.length?null:(c=_.find(B,function(c){return a==c.id}))?c:null}function f(a){var c=jQuery("input[name=save-prspctv-dest]:checked").val();if(""==c)return null;var d=jQuery("#save-psrctv-note").val(),d=d.replace(/"/,""),e=jQuery("#save-psrctv-lbl").val().trim(),e=e.replace(/"/,""),f=!jQuery("#selector-v0").prop("disabled")&&jQuery("#selector-v0").is(":checked"),h=!jQuery("#selector-v1").prop("disabled")&&jQuery("#selector-v1").is(":checked"),g={f:[],s:null,a0:f,a1:h,v0:{l:u.title(),s:u.getState()},
v1:null};z.forEach(function(a){for(var c=[],d=jQuery('div.filter-instance[data-id="'+a.id+'"]'),e=0;e<PData.getNumETmplts();e++)c.push(d.find(".apply-tmplt-"+e).is(":checked"));g.f.push({id:a.attID,a:c,s:a.f.getState()})});A&&(g.s={id:r,s:A.getState()});k&&(g.v1={l:k.title(),s:k.getState()});var l={id:a,l:e,n:d,s:g};"local"==c?(B.push(l),C.setItem(prspdata.e.id,JSON.stringify(B))):"server"==c&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_save_prspctv",id:a,l:e,x:prspdata.e.id,
n:d,s:JSON.stringify(g)},success:function(a,c,d){"0"!=a&&prspdata.p.push(l)},error:function(a,c,d){alert(d)}});return c}function g(){var a,c=[],d=!1;(function(){var a=jQuery("#prspctv-mlist");a.empty();B.forEach(function(c){a.append('<li data-type="l" data-id="'+c.id+'"><span class="label">'+c.l+'</span> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")});for(var d=0;d<C.length;d++){var e=C.key(d);if(e!=prspdata.e.id){var f=C.getItem(e);c.push({id:e,
ps:JSON.parse(f)})}}c.forEach(function(c,d){c.ps.forEach(function(e){a.append('<li data-type="x" data-xid="'+c.id+'" data-xindex="'+d+'" data-id="'+e.id+'"><i class="label">'+e.l+'</i> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")})})})();jQuery("#prspctv-mlist").click(function(a){if("BUTTON"==a.target.nodeName){var e=jQuery(a.target).hasClass("del"),f=jQuery(a.target).parent(),g=f.data("type"),h=f.data("id");if(e){switch(g){case "l":a=B.findIndex(function(a){return h==
a.id});-1!=a&&(B.splice(a,1),0==B.length?C.removeItem(prspdata.e.id):C.setItem(prspdata.e.id,JSON.stringify(B)));break;case "x":a=f.data("xindex"),e=c[a],a=e.ps.findIndex(function(a){return h==a.id}),-1!=a&&(e.ps.splice(a,1),d=!0)}f.remove()}else{var k;switch(g){case "l":k=_.find(B,function(a){return h==a.id});break;case "x":a=f.data("xindex"),e=c[a],k=_.find(e.ps,function(a){return h==a.id})}jQuery("#edit-psrctv-lbl").val(k.l);jQuery("#edit-psrctv-note").val(k.n);var l=jQuery("#dialog-edit-prsrctv").dialog({width:340,
height:270,modal:!0,buttons:[{text:dlText.ok,click:function(){k.l=jQuery("#edit-psrctv-lbl").val();k.n=jQuery("#edit-psrctv-note").val();f.find(".label").text(k.l);"x"==g?d=!0:C.setItem(prspdata.e.id,JSON.stringify(B));l.dialog("close")}},{text:dlText.cancel,click:function(){l.dialog("close")}}]})}}});a=jQuery("#dialog-manage-prsrctv").dialog({width:450,height:350,modal:!0,buttons:[{text:dlText.ok,click:function(){d&&c.forEach(function(a){0<a.ps.length?C.setItem(a.id,JSON.stringify(a.ps)):C.removeItem(a.id)});
jQuery("#prspctv-mlist").off("click");a.dialog("close")}}]})}function l(a){window.location.href=prspdata.e.g.hurl;a.preventDefault()}function p(a){jQuery(this).parent().next().slideToggle(400);a.preventDefault()}function n(a){if(a=jQuery(this).closest("div.filter-instance")){var c=a.data("id");c&&""!=c&&(a=z.find(function(a){return a.id==c}),null==a?alert("Bad Filter ID "+c):a.f.isDirty(!0))}}function t(a){var c=jQuery(this).closest("div.filter-instance"),d=c.data("id"),e,f;e=z.findIndex(function(a){return a.id==
d});-1==e?alert("Bad Filter ID "+d):(f=z[e].f,f.teardown(),z.splice(e,1),e>=z.length?(e=0==z.length?w:z[e-1].out,u.setStream(e),k&&k.setStream(e),jQuery("#btn-recompute").addClass("pulse")):z[e].f.isDirty(!0),c.remove(),0==z.length&&jQuery("#btn-toggle-filters").button("disable"),a.preventDefault())}function h(){null!=A&&(A.teardown(),jQuery('div.filter-instance[data-id="0"]').empty(),A=null,jQuery("#btn-toggle-selector").button("disable"),jQuery("#btn-apply-selector").button("disable"))}function q(a,
c,d){var e;if(d)h(),e=0;else{do e=Math.floor(1E3*Math.random()+1),-1!=z.findIndex(function(a){return a.id==e})&&(e=-1);while(-1==e)}var f,g;if("_remove"==a)f=new PFilterRemove(e),g={t:[!0,!0,!0,!0]};else switch(g=PData.getAttID(a),g.def.t){case "V":f=new PFilterVocab(e,g);break;case "T":f=new PFilterText(e,g);break;case "N":f=new PFilterNum(e,g);break;case "D":f=new PFilterDates(e,g)}if(d)A=f,r=a,d=_.template(document.getElementById("dltext-selector-head").innerHTML),a=jQuery('div.filter-instance[data-id="0"]'),
a.append(d({title:f.title()})),a.find("button.btn-filter-del").button({text:!1,icons:{primary:"ui-icon-trash"}}).click(h);else{z.push({id:e,attID:a,f:f,out:null});d=_.template(document.getElementById("dltext-filter-head").innerHTML);jQuery("#filter-instances").append(d({newID:e,title:f.title(),apply:D}));a=jQuery('div.filter-instance[data-id="'+e+'"]');for(d=0;d<PData.getNumETmplts();d++){var k=a.find(".apply-tmplt-"+d);k.prop("disabled",!g.t[d]);k.prop("checked",c[d]);k.click(n)}a.find("button.btn-filter-toggle").button({text:!1,
icons:{primary:"ui-icon-carat-2-n-s"}}).click(p);a.find("button.btn-filter-del").button({text:!1,icons:{primary:"ui-icon-trash"}}).click(t);jQuery("#btn-recompute").addClass("pulse")}f.setup();return f}function v(){PState.set(PSTATE_PROCESS);var a=[],c=!1;if(null!=A&&null!=x){A.evalPrep();for(var d=0,e,f;d<x.l;)e=x.s[d++],f=PData.getRecByIndex(e),A.eval(f)&&a.push(e);A.isDirty(!1)}PState.set(PSTATE_UPDATE);jQuery("#selector-v0").is(":checked")&&(c=u.setSel(a));jQuery("#selector-v1").is(":checked")&&
k&&(c&&(a=a.slice(0)),k.setSel(a))}function y(a){function f(a){return prspdata.e.vf.findIndex(function(c){return a==c.l})}a=d(a);if(null==a)return!1;PState.set(PSTATE_PROCESS);z.forEach(function(a){a.f.teardown()});z=[];jQuery("#filter-instances").empty();a.s.f.forEach(function(a){q(a.id,a.a,!1).setState(a.s)});jQuery("#filter-instances").hide();jQuery("#btn-toggle-filters").button(0==a.s.f.length?"disable":"enable");h();null!=a.s.s&&(q(a.s.s.id,null,!0),A.setState(a.s.s.s),jQuery("#btn-toggle-selector").button("enable"),
jQuery("#btn-apply-selector").button("enable"));jQuery("#selector-instance").hide();var g;PState.set(PSTATE_BUILD);g=f(a.s.v0.l);u?(u.setViz(g,!1),u.selBtns(!1)):(u=PViewFrame(0),u.initDOM(g));u.setState(a.s.v0.s);null!=a.s.v1?(g=f(a.s.v1.l),k?(k.selBtns(!1),k.setViz(g,!1),k.setState(a.s.v1.s)):(u.flushLgnd(),k=PViewFrame(1),k.initDOM(g),k.setState(a.s.v1.s),u.resize())):k&&(k=null,jQuery("#view-frame-1").remove(),jQuery("#selector-v1").prop("disabled",!0),u.resize());e(a.n);jQuery("#selector-v0").prop("checked",
a.s.a0);jQuery("#selector-v1").prop("checked",a.s.a1);PData.ready()&&w&&(c(),A&&v());return!0}function m(a,c){var d=prspdata.bClrs[a];d&&0<d.length&&jQuery(c).css("background-color",d)}var u,k,z=[],A=null,r,D,w,x,C=null,B=[];jQuery("body").addClass("waiting");m("cb","#command-bar");m("fs","#filter-frame");m("sf","#selector-frame");PState.init();PMapHub.init(prspdata.m);(function(){function a(d,e){c=document.getElementById(d).innerHTML;dlText[e]=c.trim()}var c;a("dltext-removehideall","rha");a("dltext-showhideall",
"sha");a("dltext-ok","ok");a("dltext-cancel","cancel");a("dltext-seerec","seerec");a("dltext-close","close");a("dltext-add","add");a("dltext-manage","manage");a("dltext-delete","del");a("dltext-edit","edit");a("dltext-hint-marker","markersize");a("dltext-hint-text","textsize");a("dltext-xaxis","xaxis");a("dltext-yaxis","yaxis");a("dltext-orderedby","orderedby");c=document.getElementById("dltext-month-names").innerHTML;months=c.trim().split("|");(c=document.getElementById("dltext-d3-local"))&&(c=c.innerHTML)&&
1<c.length&&(localD3=d3.locale(JSON.parse(c)).timeFormat.multi([["%H:%M",function(a){return a.getMinutes()}],["%H:%M",function(a){return a.getHours()}],["%a %d",function(a){return a.getDay()&&1!=a.getDate()}],["%b %d",function(a){return 1!=a.getDate()}],["%B",function(a){return a.getMonth()}],["%Y",function(){return!0}]]))})();xhbtURL=window.location.pathname;xhbtURL=xhbtURL.replace(/\&*prspctv=[\w\-]+/,"");xhbtURL=xhbtURL.replace(/\/$/,"");xhbtURL=xhbtURL.replace(/^\//,"");xhbtURL="http://"+window.location.host+
"/"+xhbtURL;(function(){var a=_.template(document.getElementById("dltext-filter-template").innerHTML),c=[];prspdata.t.forEach(function(d,e){c.push(a({ti:e,tl:d.def.l}))});D=c.join("&nbsp;")})();(function(){var a;prspdata.t.forEach(function(c,d){var e="";c.def.a.forEach(function(c){a=PData.getAttID(c);switch(a.def.t){case "T":case "V":case "N":case "D":e+='<option value="'+c+'">'+a.def.l+"</option>"}});jQuery("#dialog-sortby").append("<b>"+c.def.l+"</b>: <select data-ti="+d+">"+e+"</select><br/>")})})();
"/"!=prspdata.site_url.charAt(prspdata.site_url.length-1)&&(prspdata.site_url+="/");""!=prspdata.e.g.l&&jQuery("#title").text(prspdata.e.g.l);try{var E=window.localStorage;E.setItem("__storage_test__","__storage_test__");E.removeItem("__storage_test__");var G=E.getItem(prspdata.e.id),C=E;0<G.length&&(B=JSON.parse(G))}catch(F){}jQuery("#btn-about").button({icons:{primary:"ui-icon-info"},text:!1}).click(function(a){var c;jQuery("#dialog-about img").removeClass("zoomin");c=jQuery("#dialog-about").dialog({height:390,
width:350,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close")}}]});jQuery("#dialog-about img").addClass("zoomin");a.preventDefault()});jQuery("#btn-recompute").button({icons:{primary:"ui-icon-refresh"},text:!1}).click(function(a){c();PState.set(PSTATE_READY);a.preventDefault()});jQuery("#btn-set-layout").button({icons:{primary:"ui-icon-newwin"},text:!1}).click(function(){null!=k?(k=null,jQuery("#view-frame-1").remove(),jQuery("#selector-v1").prop("checked",!1),jQuery("#selector-v1").prop("disabled",
!0)):(u.flushLgnd(),PState.set(PSTATE_BUILD),k=PViewFrame(1),k.initDOM(0),k.showStream(x),jQuery("#selector-v1").prop("disabled",!1),PState.set(PSTATE_READY));u.resize()});jQuery("#btn-show-prspctv").button({icons:{primary:"ui-icon-image"},text:!1}).click(function(a){var c=jQuery("#prspctv-slist");c.empty();prspdata.p.forEach(function(a){c.append('<li data-src="server" data-id="'+a.id+'">'+a.l+"</li>")});B.forEach(function(a){c.append('<li data-src="local" data-id="'+a.id+'">'+a.l+"</li>")});var d=
[{text:dlText.ok,click:function(){e.dialog("close");var a=c.find("li.selected");a.length&&(a=a.data("id"),y(a),PState.set(PSTATE_READY))}},{text:dlText.cancel,click:function(){e.dialog("close")}}];C&&d.push({text:dlText.manage,click:function(){e.dialog("close");g()}});var e=jQuery("#dialog-show-prsrctv").dialog({width:350,height:350,modal:!0,buttons:d});a.preventDefault()});jQuery("#btn-save-prspctv").button({icons:{primary:"ui-icon-pencil"},text:!1}).click(function(a){var c,e=/[^\w\-]/;jQuery("#save-psrctv-id").val("");
jQuery("#save-psrctv-lbl").val("");jQuery("#save-psrctv-note").val("");C||jQuery("#save-prspctv-d-1").attr("disabled","disabled");prspdata.add_prspctv||jQuery("#save-prspctv-d-2").attr("disabled","disabled");c=jQuery("#dialog-save-prsrctv").dialog({width:340,height:350,modal:!0,buttons:[{text:dlText.ok,click:function(){var a=jQuery("#save-psrctv-id").val().trim(),g=a.match(e);0==a.length||20<a.length||g?g="#dialog-prspctv-id-badchars":d(a)&&(g="#dialog-prspctv-id-used");if(g)var h=jQuery(g).dialog({width:320,
height:210,modal:!0,buttons:[{text:dlText.ok,click:function(){h.dialog("close")}}]});else if(g=f(a),c.dialog("close"),"server"==g){a=xhbtURL+"/?prspctv="+a;jQuery("#save-psrctv-embed").val(a);var k=jQuery("#dialog-prspctv-url").dialog({width:480,height:230,modal:!0,buttons:[{text:dlText.ok,click:function(){k.dialog("close")}}]})}}},{text:dlText.cancel,click:function(){c.dialog("close")}}]});a.preventDefault()});jQuery("#btn-annote").button({icons:{primary:"ui-icon-comment"},text:!1}).click(function(a){jQuery("#annote").toggle("slide",
{direction:"right"});a.preventDefault()});0<prspdata.e.g.hbtn.length&&0<prspdata.e.g.hurl.length?(jQuery("#home-title").text(prspdata.e.g.hbtn),jQuery("#btn-home").button({icons:{primary:"ui-icon-home"},text:!1}).click(l)):jQuery("#btn-home").remove();jQuery("#filter-list").click(function(a){"I"==a.target.nodeName?(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).parent().addClass("selected")):"LI"==a.target.nodeName&&(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).addClass("selected"))});
jQuery("#prspctv-slist").click(function(a){"LI"==a.target.nodeName&&(jQuery("#prspctv-slist li").removeClass("selected"),jQuery(a.target).addClass("selected"))});jQuery("#btn-new-filter").button({icons:{primary:"ui-icon-plus"},text:!1}).click(function(a){var c=1==PData.getNumETmplts()?[!0]:[!1,!1,!1,!1];jQuery("#filter-list li").removeClass("selected");jQuery("#filter-list li.remove").show();var d;d=jQuery("#dialog-new-filter").dialog({height:300,width:350,modal:!0,buttons:[{text:dlText.add,click:function(){var a=
jQuery("#filter-list li.selected");a.length&&(jQuery("#filter-instances").show(400),q(a.data("id"),c,!1),jQuery("#btn-toggle-filters").button("enable"));d.dialog("close")}},{text:dlText.cancel,click:function(){d.dialog("close")}}]});a.preventDefault()});jQuery("#btn-toggle-filters").button({icons:{primary:"ui-icon-arrow-2-n-s"},text:!1}).click(function(a){jQuery("#filter-instances").slideToggle(400);a.preventDefault()});jQuery("#btn-new-selector").button({icons:{primary:"ui-icon-plus"},text:!1}).click(function(a){jQuery("#filter-list li").removeClass("selected");
jQuery("#filter-list li.remove").hide();var c;c=jQuery("#dialog-new-filter").dialog({height:300,width:350,modal:!0,buttons:[{text:dlText.add,click:function(){var a=jQuery("#filter-list li.selected");a.length&&(jQuery("#selector-instance").show(400),q(a.data("id"),null,!0),jQuery("#btn-toggle-selector").button("enable"),jQuery("#btn-apply-selector").button("enable"));c.dialog("close")}},{text:dlText.cancel,click:function(){c.dialog("close")}}]});a.preventDefault()});jQuery("#btn-toggle-selector").button({icons:{primary:"ui-icon-arrow-2-n-s"},
text:!1}).click(function(a){jQuery("#selector-instance").slideToggle(400);a.preventDefault()});jQuery("#btn-apply-selector").button({icons:{primary:"ui-icon-arrowreturn-1-e"},text:!1}).click(function(a){v();PState.set(PSTATE_READY);a.preventDefault()});jQuery("#dialog-about .logo").attr("src",prspdata.assets+"prospectlogo.jpg");jQuery("#btn-inspect-left").button({icons:{primary:"ui-icon-arrowthick-1-w"},text:!1});jQuery("#btn-inspect-right").button({icons:{primary:"ui-icon-arrowthick-1-e"},text:!1});
(function(){jQuery("#filter-list").append('<li class="remove" data-id="_remove"><i>'+dlText.rha+"</i></li>");prspdata.a.forEach(function(a){switch(a.def.t){case "V":case "T":case "N":case "D":jQuery("#filter-list").append('<li data-id="'+a.id+'">'+a.def.l+"</li>")}})})();0!=prspdata.show_prspctv.length&&y(prspdata.show_prspctv)||(u=PViewFrame(0),u.initDOM(0),e(""));jQuery(window).resize(function(){u&&u.resize();k&&k.resize()});jQuery("body").on("prospect",function(a,d){d.pstate==PSTATE_PROCESS&&(PState.set(PSTATE_PROCESS),
c(),A&&v(),PState.set(PSTATE_READY),jQuery("body").removeClass("waiting"))});PState.set(PSTATE_LOAD);PData.init()});function onYouTubeIframeAPIReady(){widgetData.ytCall&&widgetData.ytCall()};