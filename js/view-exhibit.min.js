var xhbtURL,widgetData={ytLoaded:!1,ytCall:null,ytCode:null,timer:null,extract:null,sTime:null,eTime:null,playing:!1,widget:null,xscriptOn:!1,tcArray:null,tcIndex:-1};
function PViewFrame(t){function u(b){b!==v&&(v=b,jQuery(r()+" div.lgnd-container div.lgnd-handle button.lgnd-update").prop("disabled",!b))}function r(){return"#view-frame-"+t}function M(b){b=jQuery(r()+" div.view-controls select.view-viz-select option:selected").val();PState.set(PSTATE_BUILD);G(b,!0);PState.set(PSTATE_READY)}function N(b){k.flags()&V_FLAG_LGND&&jQuery(r()+" div.lgnd-container").toggle("slide",{direction:"left"});b.preventDefault()}function O(b){function g(a){return a.replace(/^[ \f\t\v\u200b]+|[ \f\t\v\u200b]+$/g,
"")}function c(a){var e=new Number,d=parseTC.exec(a);if(null!==d)e=1E3*(3600*parseInt(d[1])+60*parseInt(d[2])+parseFloat(d[3])),e=1==d[4].length?e+100*parseInt(d[4]):e+10*parseInt(d[4]);else throw Error("Error in transcript file: Cannot parse "+a+" as timecode.");return e}function f(a,e){var d=new String(a),d=g(d).split(/\r\n|\r|\n/g),p=[];if(d){var b,h=0;_.each(d,function(a){a=g(a);0<a.length&&("["===a.charAt(0)?(0<h&&p.push(b),b=""):(0<b.length&&(b+="<br/>"),b+=a),h++)})}_.each(p,function(a,d){e.find('div.timecode[data-tcindex="'+
d+'"]').next().after('<div class="xscript">'+a+"</div>")})}function l(a){widgetData.tcArray=[];widgetData.tcIndex=-1;var d=widgetData.tcArray;a=new String(a);if(a=g(a).split(/\r\n|\r|\n/g)){var e=jQuery("#xscript-tbl"),p=0,b,h=0,m=0,q="";_.each(a,function(a){a=g(a);1<a.length&&("["===a.charAt(0)&&"0"<=a.charAt(1)&&"9">=a.charAt(1)?(b=c(a),0<q.length&&(m&&d.push({s:h,e:b}),e.append('<div class="row"><div class="timecode" data-timecode="'+h+'" data-tcindex="'+p++ +'">'+m+'</div><div class="xscript">'+
q+"</div></div>"),q=""),m=a,h=b):(0<q.length&&(q+="<br/>"),q+=a))});0<q.length&&(d.push({s:h,e:324E5}),e.append('<div class="row"><div class="timecode" data-timecode="'+h+'" data-tcindex="'+p+'">'+m+'</div><div class="xscript">'+q+"</div></div>"));"undefined"!==typeof t&&null!=t&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:t,excerpt:widgetData.extract},success:function(a,d,b){f(JSON.parse(a),e)},error:function(a,d,e){alert(e)}})}}function r(a){var d,
e=widgetData.tcIndex;_.find(widgetData.tcArray,function(b,p){if((d=b.s<=a&&a<b.e)&&p!=e){var h=jQuery("#xscript-tbl");if(document.getElementById("sync-xscript").checked){var c=h.find('[data-tcindex="'+p+'"]').offset().top-h.offset().top,c=h.scrollTop()+c;h.animate({scrollTop:c},300)}-1!=e&&h.find('[data-tcindex="'+e+'"]').removeClass("current");h.find('[data-tcindex="'+p+'"]').addClass("current");widgetData.tcIndex=p}return d})}function a(){widgetData.widget=new YT.Player("yt-widget",{width:A-40,
height:Math.floor(9*(A-40)/16),videoId:widgetData.ytCode,events:{onError:function(a){console.log("YouTube Error: "+a.data)},onStateChange:function(a){var d;switch(a.data){case 1:widgetData.playing=!0;null==widgetData.timer&&(widgetData.timer=setInterval(function(){d=1E3*widgetData.widget.getCurrentTime();widgetData.playing&&widgetData.xscriptOn&&r(d)},300));break;case 0:case 2:widgetData.playing=!1;window.clearInterval(widgetData.timer);widgetData.timer=null;break;case 3:case 5:widgetData.playing=
!1}},onReady:function(){widgetData.extract&&widgetData.widget.cueVideoById({videoId:widgetData.ytCode,startSeconds:widgetData.sTime/1E3,endSeconds:widgetData.eTime/1E3})}}})}function p(){widgetData.playing=!0}function d(){widgetData.playing=!1}function e(){widgetData.playing&&widgetData.xscriptOn&&r(1E3*widgetData.widget.currentTime)}function h(){switch(C){case 3:null!=widgetData.widget&&(widgetData.widget.removeEventListener("ended",d),widgetData.widget.removeEventListener("pause",d),widgetData.widget.removeEventListener("playing",
p),widgetData.widget.removeEventListener("timeupdate",e));case 1:null!=widgetData.widget&&widgetData.playing&&widgetData.widget.pause();widgetData.playing=!1;widgetData.widget=null;break;case 2:widgetData.ytCall=null,null!=widgetData.widget&&widgetData.playing&&widgetData.widget.stopVideo(),widgetData.widget=null,widgetData.playing=!1,null!=widgetData.timer&&(window.clearInterval(widgetData.timer),widgetData.timer=null)}}function m(){function b(){widgetData.sTime=widgetData.eTime=null;var a;(a=prspdata.e.i.t.tcAtts[g])&&
(a=D.a[a])&&""!==a&&(widgetData.extract=a,a=a.split("-"),widgetData.sTime=c(a[0]),widgetData.eTime=c(a[1]))}var h=u[v];D=PData.rByN(h);var m=" "+D.l+" ("+(v+1)+"/"+u.length+") ",q=jQuery("#inspect-name");q.text(m);q.prop("title",D.id);var g=PData.n2T(h);z.empty();y=null;C=0;widgetData.extract=null;widgetData.xscriptOn=!1;widgetData.playing=!1;if(prspdata.e.i.modal.scOn||"boolean"===typeof prspdata.e.i.modal.aOn&&prspdata.e.i.modal.aOn)if(y=prspdata.e.i.sc.atts[g])if(m=D.a[y])if(b(),m.match(/soundcloud\.com/)){var f=
!0;C=1;z.append('<iframe id="sc-widget" class="player" width="100%" height="110" src="http://w.soundcloud.com/player/?url='+m+'"></iframe>');var k=SC.Widget(document.getElementById("sc-widget"));widgetData.widget=k;k.bind(SC.Widget.Events.READY,function(){k.play();k.bind(SC.Widget.Events.PLAY,function(){widgetData.playing=!0});k.bind(SC.Widget.Events.PAUSE,function(){widgetData.playing=!1});k.bind(SC.Widget.Events.PLAY_PROGRESS,function(a){f&&(k.pause(),f=!1,widgetData.playing=!1);widgetData.extract&&
(a.currentPosition<widgetData.sTime?k.seekTo(widgetData.sTime):a.currentPosition>widgetData.eTime&&(k.pause(),widgetData.playing=!1));widgetData.playing&&widgetData.xscriptOn&&r(a.currentPosition)});k.bind(SC.Widget.Events.FINISH,function(){widgetData.playing=!1})})}else C=3,widgetData.extract&&(q=widgetData.extract.split("-"),m+="#t="+q[0]+","+q[1]),z.append('<audio id="na-widget" controls src="'+m+'"></audio>'),widgetData.widget=document.getElementById("na-widget"),widgetData.widget.addEventListener("ended",
d),widgetData.widget.addEventListener("pause",d),widgetData.widget.addEventListener("playing",p),widgetData.widget.addEventListener("timeupdate",e);0===C&&prspdata.e.i.modal.ytOn&&(y=prspdata.e.i.yt.atts[g])&&(m=D.a[y])&&(b(),widgetData.ytCode=m,z.append('<div id="yt-widget"></div>'),widgetData.ytCall=a,widgetData.ytLoaded?a():(widgetData.ytLoaded=!0,m=document.createElement("script"),m.src="https://www.youtube.com/iframe_api",q=document.getElementsByTagName("script")[0],q.parentNode.insertBefore(m,
q)),C=2);prspdata.e.i.modal.tOn&&(m=prspdata.e.i.t.t1Atts[g])&&""!==m&&"disable"!==m&&(m=D.a[m],"string"===typeof m&&""!==m&&(0<C&&z.append("<div>"+document.getElementById("dltext-sync-xscript").innerHTML+"</div>"),z.find("#xscript-tbl").remove(),z.append('<div id="xscript-tbl"></div>'),widgetData.xscriptOn=!0,jQuery("#xscript-tbl").click(function(a){if(C&&jQuery(a.target).hasClass("timecode"))switch(a=jQuery(a.target).data("timecode"),C){case 1:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play());
widgetData.widget.seekTo(a);break;case 2:widgetData.playing||(widgetData.playing=!0,widgetData.widget.playVideo());widgetData.widget.seekTo(a/1E3);break;case 3:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play()),widgetData.widget.currentTime=a/1E3}}),t=null,(q=prspdata.e.i.t.t2Atts[g])&&""!==q&&"disable"!==q&&(t=D.a[q]),jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:m,excerpt:widgetData.extract},success:function(a,d,e){l(JSON.parse(a))},
error:function(a,d,e){alert(e)}})));prspdata.e.i.modal.atts[g].forEach(function(a){var d=PData.rAV(h,a,!1);if(d){a=PData.aByID(a);var e;"_"==a.def.l.charAt(0)?e="<div>"+d+"</div>":(e='<div><span class="att-label">'+a.def.l+":</span> ","I"==a.def.t&&(e+="<br/>"),e+=d+"</div>");z.append(e)}})}function q(a){a=v+a;-1==a?a=u.length-1:a==u.length&&(a=0);a!=v&&(v=a,h(),m())}function E(a){q(-1)}function J(a){q(1)}var z=jQuery("#inspect-content"),y=null,C=0,t,A=450,w=400,u=null;k&&(u=k.getSel());if(null!=
u&&0!=u.length){var x,D,v=0;prspdata.e.i.modal.scOn&&(A=550);prspdata.e.i.modal.ytOn&&(A=Math.max(A,475),w=500);prspdata.e.i.modal.tOn&&(w+=100,prspdata.e.i.modal.t2On?(A=Math.max(750,Math.floor(.8*jQuery(document).width())),A=Math.min(900,A)):A=Math.max(A,550));"number"===typeof prspdata.e.i.modal.w&&(A=prspdata.e.i.modal.w);"number"===typeof prspdata.e.i.modal.h&&(w=prspdata.e.i.modal.h);B(!1);m();jQuery("#btn-inspect-left").click(E);jQuery("#btn-inspect-right").click(J);x=jQuery("#dialog-inspector").dialog({width:A,
height:w,modal:!0,buttons:[{text:dlText.seerec,click:function(){window.open(prspdata.site_url+"?p="+D.wp,"_blank")}},{text:dlText.close,click:function(){x.dialog("close")}}]});x.on("dialogclose",function(a,e){h();jQuery("#btn-inspect-left").off("click");jQuery("#btn-inspect-right").off("click");B(!0);x.off("dialogclose")});b.preventDefault()}}function B(b){var g=jQuery(r()+" div.view-controls");b?(g.find(".osel").button("enable"),g.find(".osel").addClass("pulse"),g.find(".xsel").button("enable")):
(g.find(".osel").button("disable"),g.find(".osel").removeClass("pulse"),g.find(".xsel").button("disable"))}function P(b){jQuery("body").trigger("prospect",{s:PSTATE_HILITE,v:t,t:k.tUsed});b.preventDefault()}function Q(b){PState.set(PSTATE_UPDATE);k&&k.clearSel();B(!1);PState.set(PSTATE_READY);b.preventDefault()}function R(b){k&&k.doOptions();b.preventDefault()}function H(b){var g=jQuery("#dialog-vnotes").dialog({width:300,height:300,modal:!0,buttons:[{text:dlText.ok,click:function(){g.dialog("close")}}]});
b.preventDefault()}function K(b,g){jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",g);u(!0)}function L(b){var g=jQuery(b.target).closest("div.lgnd-template").data("index"),c=b.target.className;switch(c){case "lgnd-update":k&&x&&(PState.set(PSTATE_BUILD),B(!1),k.render(x),u(!1),PState.set(PSTATE_READY));break;case "lgnd-entry-check":c=jQuery(b.target).closest("div.lgnd-entry");b=jQuery(b.target).is(":checked");
c.hasClass("lgnd-sh")?K(g,b):c.hasClass("lgnd-locate")?(c.data("id"),u(!0)):c.hasClass("lgnd-value")&&(c.data("index"),u(!0));break;case "lgnd-viz":case "lgnd-value-title":c=jQuery(b.target).closest("div.lgnd-entry");c.hasClass("lgnd-locate")?(b=c.data("id"),jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+g+'"] div.lgnd-locate input.lgnd-entry-check').prop("checked",!1),jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+g+'"] div.lgnd-locate[data-id="'+
b+'"] input.lgnd-entry-check').prop("checked",!0),u(!0)):c.hasClass("lgnd-value")&&(b=c.data("index"),jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+g+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",!1),jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+g+'"] div.lgnd-group div.lgnd-value[data-index="'+b+'"] input.lgnd-entry-check').prop("checked",!0),u(!0));break;case "lgnd-template":case "lgnd-select":case "":break;default:c.match(/lgnd-sh/i)&&
(c=jQuery(b.target).find("input.lgnd-entry-check"),b=!c.is(":checked"),c.prop("checked",b),K(g,b))}}function S(b){var g=jQuery(b.target).closest("div.lgnd-template").data("index");b=jQuery(b.target).val();F(g,b);u(!0)}function F(b,g){var c,f=jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] div.lgnd-group');f.empty();w[b]=g;var k=PData.aByID(g);"undefined"!==typeof k.r.u&&(c='<div class="lgnd-value lgnd-entry" data-index="-1"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+
k.r.u.v+'"> </div> <span class="lgnd-value-title">'+dlText.undef+"</span></div>",f.append(c));k.l.forEach(function(b,a){c='<div class="lgnd-value lgnd-entry" data-index="'+a+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+b.v+'"> </div> <span class="lgnd-value-title">'+b.l+"</span></div>";f.append(c);b.z&&0<b.z.length&&b.z.forEach(function(b,d){c='<div class="lgnd-value lgnd-entry" data-index="'+a+","+d+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/>';
c=b.v&&""!==b.v?c+('<div class="lgnd-viz" style="background-color: '+b.v+'"></div>'):c+'<div class="lgnd-viz lgnd-viz-empty"></div>';c+=' <span class="lgnd-value-title">&raquo; '+b.l+"</span></div>";f.append(c)})});jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] div.lgnd-sh input').prop("checked",!0)}function G(b,g){var c=PData.vByN(b);k&&(k.teardown(),k=null);var n=jQuery(r());n.find("div.viz-content div.viz-result").empty();var l;switch(c.vf){case "M":l=new VizMap(f,
c.c);break;case "p":l=new VizMap2(f,c.c);break;case "C":l=new VizCards(f,c.c);break;case "P":l=new VizPinboard(f,c.c);break;case "T":l=new VizTime(f,c.c);break;case "D":l=new VizDirectory(f,c.c);break;case "t":l=new VizTextStream(f,c.c);break;case "S":l=new VizStackChart(f,c.c);break;case "N":l=new VizNetWheel(f,c.c);break;case "F":l=new VizFlow(f,c.c);break;case "B":l=new VizBrowser(f,c.c);break;case "m":l=new VizMBMap(f,c.c)}I=b;var v=l.flags();v&V_FLAG_HSCRL?(n.find("div.viz-content").addClass("h-scroll"),
n.find("div.viz-result").addClass("viz-fit-w"),n.find("div.viz-result").removeClass("viz-max-w")):(n.find("div.viz-content").removeClass("h-scroll"),n.find("div.viz-result").removeClass("viz-fit-w"),n.find("div.viz-result").addClass("viz-max-w"));v&V_FLAG_VSCRL?(n.find("div.viz-content").addClass("v-scroll"),n.find("div.viz-result").addClass("viz-fit-h"),n.find("div.viz-result").removeClass("viz-max-h")):(n.find("div.viz-content").removeClass("v-scroll"),n.find("div.viz-result").removeClass("viz-fit-h"),
n.find("div.viz-result").addClass("viz-max-h"));w=[];if(v&V_FLAG_LGND){n.find(".hslgnd").button("enable");var a=n.find("div.lgnd-container div.lgnd-scroll");a.empty();if(v&V_FLAG_SLGND){var p=l.getFeatureAtts(),d=PData.aByID(p);a.append('<div class="lgnd-template" data-index="0"><div class="lgnd-title">'+d.def.l+'</div><div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div></div>');w.push(p);F(0,p)}else{var e=
!1;prspdata.e.g.ts.forEach(function(d,b){var p=PData.tByID(d),c=l.getLocAtts(b);if(c&&0<c.length||!(v&V_FLAG_LOC)){var g=l.getFeatureAtts(b);if(0<g.length){e&&a.append("<hr/>");var f=jQuery('<div class="lgnd-template" data-index="'+b+'"><div class="lgnd-title">'+p.l+"</div></div>");c&&c.forEach(function(a,d){var e=PData.aByID(a);f.append('<div class="lgnd-entry lgnd-locate" data-id="'+a+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><span class="lgnd-value-title">'+e.def.l+
"</span></div>")});var k='<select class="lgnd-select">';g.forEach(function(a,e){var d=PData.aByID(a);k+='<option value="'+a+'">'+d.def.l+"</option>"});k+="</select>";p=jQuery(k);p.change(S);jQuery(f).append(p);jQuery(f).append('<div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div>');a.append(f);g=g[0];w.push(g);F(b,g);e=!0}}})}n.find("div.lgnd-container").show()}else n.find("button.hslgnd").button("disable"),
n.find("div.lgnd-container").hide();u(!1);v&V_FLAG_SEL?(n.find(".hilite").button("enable"),jQuery("#save-prspctv-h"+t).prop("disabled",!1).prop("checked",!1)):(n.find(".hilite").button("disable"),jQuery("#save-prspctv-h"+t).prop("disabled",!0).prop("checked",!1));v&V_FLAG_OPT?n.find(".vopts").button("enable"):n.find(".vopts").button("disable");(p=l.hint())||"string"===typeof c.n&&""!==c.n?(n.find(".vnote").button("enable"),p=p?"string"===typeof c.n&&""!==c.n?p+(".<br/>"+c.n):p+".":c.n,jQuery("#vnotes-txt").empty().append(p)):
n.find(".vnote").button("disable");l.setup();B(!1);x&&g&&l.render(x);k=l}var f={},I=0,k=null,w=[],v=null,x=null;f.getFrameID=r;f.getIndex=function(){return t};f.setViz=function(b,g){b!=I&&(jQuery(r()+" div.view-controls select.view-viz-select").val(b),G(b,g))};f.initDOM=function(b){var g=document.getElementById("dltext-view-controls").innerHTML;jQuery("#viz-frame").append('<div id="view-frame-'+t+'">'+g+"</div>");var g=jQuery(r()),c=prspdata.bClrs.vf;c&&0<c.length&&g.find("div.view-controls").css("background-color",
c);g.find("div.lgnd-container").draggable({handle:g.find("div.lgnd-handle"),containment:"parent"});var f=g.find("div.view-controls select.view-viz-select");prspdata.e.vf.forEach(function(b,c){f.append('<option value="'+c+'">'+b.l+"</option>")});f.val(b);f.change(M);g.find("div.view-controls button:first").button({icons:{primary:"ui-icon-bookmark"},text:!1}).click(N).next().button({icons:{primary:"ui-icon-wrench"},text:!1}).click(R).next().button({icons:{primary:"ui-icon-info"},text:!1}).click(H).next().button({icons:{primary:"ui-icon-star"},
text:!1}).click(P).next().button({icons:{primary:"ui-icon-cancel"},text:!1}).click(Q).next().button({icons:{primary:"ui-icon-search"},text:!1}).click(O).next();g.find("div.lgnd-container").click(L);G(b,!1)};f.getSelLocAtts=function(b){var g=[];jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] div.lgnd-locate input:checked').each(function(){var b=jQuery(this).parent().data("id");g.push(b)});return g};f.getSelFeatAtts=function(b){var g=[],c,f;jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+
b+'"] div.lgnd-group div.lgnd-value input:checked').each(function(){c=jQuery(this).parent().data("index");"number"==typeof c?g.push(c):-1!=(f=c.indexOf(","))?g.push([parseInt(c.substring(0,f),10),parseInt(c.substring(f+1),10)]):g.push(parseInt(c,10))});return g};f.getSelLegend=function(b){return w[b]};f.getLgndSels=function(){return w.slice(0)};f.setLgndSels=function(b){b.forEach(function(b,c){b&&(jQuery(r()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+c+'"] select.lgnd-select').val(b),
F(c,b))})};f.getState=function(){return k?k.getState():null};f.setState=function(b){k&&k.setState(b)};f.showStream=function(b){x=b;k&&k.render(b);u(!1)};f.setStream=function(b){x=b};f.selBtns=function(b){B(b)};f.clearSel=function(){k&&k.clearSel();B(!1)};f.setSel=function(b){return k&&k.flags()&V_FLAG_SEL?(k.setSel(b),B(0<b.length),!0):!1};f.vizAddSel=function(b){};f.vizDelSel=function(b){};f.resize=function(){k&&k.resize()};f.title=function(){return PData.vByN(I).l};f.flushLgnd=function(){jQuery(r()).find("div.lgnd-container").css("left",
"10px")};f.getBMData=function(){return k?{t:k.tUsed,r:k.rMap}:null};return f}
jQuery(document).ready(function(t){function u(){var a;PState.set(PSTATE_PROCESS);null==x&&(x=PData.sNew(!0));b=x;var p=!1,d,e;for(d=0;d<k.length;d++)if(e=k[d],a=jQuery('div.filter-instance[data-id="'+e.id+'"]'),p||e.f.isDirty(null)){p=!0;e=e.f;e.evalPrep();for(var h=PData.sNew(!1),c=0,g,E,J=0,z=b.t[0],y=0,l=0,n=a.find(".apply-tmplt-0").is(":checked");c<b.l;){for(;0===z.n||z.i+z.n===c;)h.t.push({i:h.l-y,n:y}),y=0,z=b.t[++J],n=a.find(".apply-tmplt-"+J).is(":checked");g=b.s[c++];n?(E=PData.rByN(g),e.eval(E)&&
(h.s[h.l++]=g,y++),l++):(h.s[h.l++]=g,y++)}for(;J++<PData.eTNum();)h.t.push({i:h.l-y,n:y}),y=0;e.isDirty(!1);e.out=h;e.evalDone(l);b=h}else b=e.f.out;PState.set(PSTATE_BUILD);f.forEach(function(a){a&&a.showStream(b)});0<k.length?jQuery("#btn-f-state").prop("disabled",!0).html(dlText.filtered):jQuery("#btn-f-state").prop("disabled",!0).html(dlText.nofilter)}function r(a){var b=jQuery("#annote");b.text(a);0<a.length?(jQuery("#btn-annote").button("enable"),b.show()):(jQuery("#btn-annote").button("disable"),
b.hide())}function M(a){var b=_.find(prspdata.p,function(b){return a==b.id});return b?b:null==g||0==c.length?null:(b=_.find(c,function(b){return a==b.id}))?b:null}function N(a,b){var d=jQuery("input[name=save-prspctv-dest]:checked").val();if(""==d)return null;var e=jQuery("#save-prspctv-note").val(),e=e.replace(/"/g,""),h={f:[],h0:null,h1:null,v0:null,v1:null};f.forEach(function(a,b){a&&(h["v"+b]={l:a.title(),s:a.getState()})});k.forEach(function(a){for(var b=[],e=jQuery('div.filter-instance[data-id="'+
a.id+'"]'),d=0;d<PData.eTNum();d++)b.push(e.find(".apply-tmplt-"+d).is(":checked"));h.f.push({id:a.attID,a:b,s:a.f.getState()})});for(var m=0;2>m;m++){var q=w[m];null!==q&&jQuery("#save-prspctv-h"+m).is(":checked")&&(h["h"+m]={id:v[m],s:q.getState()})}var E={id:a,l:b,n:e,s:h};"local"==d?(c.push(E),g.setItem(prspdata.e.id,JSON.stringify(c))):"server"==d&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_save_prspctv",id:a,l:b,x:prspdata.e.id,n:e,s:JSON.stringify(h)},success:function(a,
b,e){"0"!=a&&prspdata.p.push(E)},error:function(a,b,e){alert(e)}});return d}function O(){var a,b=[],d=!1;(function(){var a=jQuery("#prspctv-mlist");a.empty();c.forEach(function(b){a.append('<li data-type="l" data-id="'+b.id+'"><span class="label">'+b.l+'</span> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")});for(var d=0;d<g.length;d++){var m=g.key(d);if(m!=prspdata.e.id){var f=g.getItem(m);b.push({id:m,ps:JSON.parse(f)})}}b.forEach(function(b,d){b.ps.forEach(function(h){a.append('<li data-type="x" data-xid="'+
b.id+'" data-xindex="'+d+'" data-id="'+h.id+'"><i class="label">'+h.l+'</i> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")})})})();jQuery("#prspctv-mlist").click(function(a){if("BUTTON"==a.target.nodeName){var h=jQuery(a.target).hasClass("del"),m=jQuery(a.target).parent(),f=m.data("type"),k=m.data("id");if(h){switch(f){case "l":a=c.findIndex(function(a){return k==a.id});-1!=a&&(c.splice(a,1),0==c.length?g.removeItem(prspdata.e.id):g.setItem(prspdata.e.id,
JSON.stringify(c)));break;case "x":a=m.data("xindex"),h=b[a],a=h.ps.findIndex(function(a){return k==a.id}),-1!=a&&(h.ps.splice(a,1),d=!0)}m.remove()}else{var l;switch(f){case "l":l=_.find(c,function(a){return k==a.id});break;case "x":a=m.data("xindex"),h=b[a],l=_.find(h.ps,function(a){return k==a.id})}jQuery("#edit-prspctv-lbl").val(l.l);jQuery("#edit-prspctv-note").val(l.n);var n=jQuery("#dialog-edit-prsrctv").dialog({width:340,height:270,modal:!0,buttons:[{text:dlText.ok,click:function(){l.l=jQuery("#edit-prspctv-lbl").val();
l.n=jQuery("#edit-prspctv-note").val();m.find(".label").text(l.l);"x"==f?d=!0:g.setItem(prspdata.e.id,JSON.stringify(c));n.dialog("close")}},{text:dlText.cancel,click:function(){n.dialog("close")}}]})}}});a=jQuery("#dialog-manage-prsrctv").dialog({width:450,height:350,modal:!0,buttons:[{text:dlText.ok,click:function(){d&&b.forEach(function(a){0<a.ps.length?g.setItem(a.id,JSON.stringify(a.ps)):g.removeItem(a.id)});jQuery("#prspctv-mlist").off("click");a.dialog("close")}}]})}function B(a){window.location.href=
prspdata.e.g.hurl;a.preventDefault()}function P(a){jQuery(this).parent().next().slideToggle(400);a.preventDefault()}function Q(a){if(a=jQuery(this).closest("div.filter-instance")){var b=a.data("id");b&&""!==b&&(a=k.find(function(a){return a.id==b}),null==a?alert("Bad Filter ID "+b):a.f.isDirty(!0))}}function R(a){var b=jQuery(this).closest("div.filter-instance"),d=b.data("id"),e,h;e=k.findIndex(function(a){return a.id==d});if(-1===e)alert("Bad Filter ID "+d);else{h=k[e].f;h.teardown();k.splice(e,
1);if(e>=k.length){var c;c=0===k.length?x:k[e-1].out;f.forEach(function(a){a&&a.setStream(c)})}else k[e].f.isDirty(!0);b.remove();0===k.length?(jQuery("#btn-toggle-filters").button("disable"),f.forEach(function(a){a&&a.clearSel(c)}),u(),PState.set(PSTATE_READY)):jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters);a.preventDefault()}}function H(a,b,d){var e,h,c;if(null!==d)e=d;else{do e=Math.floor(1E3*Math.random()+2),-1!=k.findIndex(function(a){return a.id==e})&&(e=-1);while(-1==e)}if("_remove"==
a)h=new PFilterRemove(e),c={t:[!0,!0,!0,!0]};else switch(c=PData.aByID(a),c.def.t){case "V":h=new PFilterVocab(e,c);break;case "T":h=new PFilterText(e,c);break;case "g":h=new PFilterTags(e,c);break;case "N":h=new PFilterNum(e,c);break;case "D":h=new PFilterDates(e,c);break;case "P":h=new PFilterPtr(e,c)}if(null!==d)b=jQuery("#dialog-hilite-"+d+" span.filter-id").html(c.def.l),b=jQuery("#hilite-"+d),b.empty();else{k.push({id:e,attID:a,f:h,out:null});d=_.template(document.getElementById("dltext-filter-head").innerHTML);
jQuery("#filter-instances").append(d({newID:e,title:h.title(),apply:I}));d=jQuery('div.filter-instance[data-id="'+e+'"]');for(a=0;a<PData.eTNum();a++){var f=d.find(".apply-tmplt-"+a);f.prop("disabled",!c.t[a]);f.prop("checked",b[a]&&c.t[a]);f.click(Q)}d.find("button.btn-filter-toggle").button({text:!1,icons:{primary:"ui-icon-carat-2-n-s"}}).click(P);d.find("button.btn-filter-del").button({text:!1,icons:{primary:"ui-icon-trash"}}).click(R);jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters)}h.setup();
return h}function K(a,b,d,e){jQuery("#filter-list li").removeClass("selected");var c,f,g,k;jQuery("#filter-list li").each(function(b){c=jQuery(this);f=c.data("id");"_remove"==f?a?c.show():c.hide():d?(g=PData.aByID(f),k=!1,g.t.forEach(function(a,b){k=k||a&&d[b]}),k?c.show():c.hide()):c.show()});var l,n={height:300,width:350,modal:!0,buttons:[{text:dlText.add,click:function(){var a=jQuery("#filter-list li.selected");1===a.length&&e(a.data("id"));l.dialog("close")}},{text:dlText.cancel,click:function(){l.dialog("close")}}]};
b&&(n.appendTo="#dialog-2");l=jQuery("#dialog-choose-att").dialog(n)}function L(a){PState.set(PSTATE_PROCESS);var c=f[a],d=c.getBMData(),e=[];a=w[a];if(null!==b){a.evalPrep();var h=0,g,k,l=0,n=b.t[0];a:for(;h<b.l;){for(;!d.t[l]||0==n.n||n.i+n.n==h;){if(++l===PData.eTNum())break a;n=b.t[l];h=n.i}g=b.s[h++];d.r[g>>4]&1<<(g&15)&&(k=PData.rByN(g),a.eval(k)&&e.push(g))}a.evalDone(b.l)}PState.set(PSTATE_UPDATE);0<e.length?c.setSel(e):c.clearSel();PState.set(PSTATE_READY)}function S(a,b){var d;d=jQuery("#dialog-hilite-"+
a).dialog({height:275,width:Math.min(jQuery(window).width()-20,675),modal:!0,appendTo:"#dialog-1",buttons:[{text:dlText.chsatt,click:function(){K(!1,!0,b,function(b){v[a]=b;w[a]=H(b,null,a)})}},{text:dlText.ok,click:function(){d.dialog("close");null!==w[a]&&L(a)}},{text:dlText.cancel,click:function(){d.dialog("close")}}]})}function F(a){function b(a){return prspdata.e.vf.findIndex(function(b){return a==b.l})}a=M(a);if(null==a)return!1;PState.set(PSTATE_PROCESS);jQuery("#filter-frame").hide();k.forEach(function(a){a.f.teardown()});
k=[];jQuery("#filter-instances").empty();a.s.f.forEach(function(a){H(a.id,a.a,null).setState(a.s)});jQuery("#filter-instances").hide();jQuery("#btn-toggle-filters").button(0==a.s.f.length?"disable":"enable");for(var d=0;2>d;d++)if(null!=a.s["h"+d]){var c=a.s["h"+d];v[d]=c.id;var h=H(c.id,null,d);w[d]=h;h.setState(c.s)}else w[d]=null,v[d]=null;var c=f[0],h=f[1],g=!1;PState.set(PSTATE_BUILD);d=b(a.s.v0.l);c?(c.setViz(d,!1),c.selBtns(!1)):(f[0]=PViewFrame(0),c=f[0],c.initDOM(d));null!==a.s.v1?(d=b(a.s.v1.l),
h?(h.selBtns(!1),h.setViz(d,!1),h.setState(a.s.v1.s)):(c.flushLgnd(),f[1]=PViewFrame(1),h=f[1],h.initDOM(d),h.setState(a.s.v1.s),g=!0)):h&&(f[1]=null,jQuery("#view-frame-1").remove(),g=!0);g&&c.resize();c.setState(a.s.v0.s);r(a.n);if(PData.ready()&&x)for(u(),d=0;2>d;d++)null!==v[d]&&L(d);return!0}function G(a,b){var d=prspdata.bClrs[a];d&&0<d.length&&jQuery(b).css("background-color",d)}var f=[null,null],I,k=[],w=[null,null],v=[null,null],x,b,g=null,c=[],n;jQuery("body").addClass("waiting");G("cb",
"#command-bar");G("fs","#filter-frame");PState.init();"undefined"!==typeof PMapHub&&PMapHub.init(prspdata.m,prspdata.mg);(function(){function a(a,c){b=document.getElementById(a).innerHTML;dlText[c]=b.trim()}var b;a("dltext-removehideall","rha");a("dltext-showhideall","sha");a("dltext-ok","ok");a("dltext-cancel","cancel");a("dltext-next","next");a("dltext-prev","prev");a("dltext-choose-att","chsatt");a("dltext-seerec","seerec");a("dltext-close","close");a("dltext-add","add");a("dltext-manage","manage");
a("dltext-delete","del");a("dltext-edit","edit");a("dltext-markers","markers");a("dltext-hint-marker","markersize");a("dltext-hint-text","textsize");a("dltext-xaxis","xaxis");a("dltext-yaxis","yaxis");a("dltext-undefined","undef");a("dltext-orderedby","orderedby");a("dltext-grpblks","grpblks");a("dltext-reset","reset");a("dltext-nofilter","nofilter");a("dltext-dofilters","dofilters");a("dltext-filtered","filtered");b=document.getElementById("dltext-month-names").innerHTML;months=b.trim().split("|");
(b=document.getElementById("dltext-d3-local"))&&(b=b.innerHTML.trim())&&"no-d3-local"!==b&&(localD3=d3.locale(JSON.parse(b)).timeFormat.multi([["%H:%M",function(a){return a.getMinutes()}],["%H:%M",function(a){return a.getHours()}],["%a %d",function(a){return a.getDay()&&1!=a.getDate()}],["%b %d",function(a){return 1!=a.getDate()}],["%B",function(a){return a.getMonth()}],["%Y",function(){return!0}]]))})();xhbtURL=window.location.pathname;xhbtURL=xhbtURL.replace(/\&*prspctv=[\w\-]+/,"");xhbtURL=xhbtURL.replace(/\/$/,
"");xhbtURL=xhbtURL.replace(/^\//,"");xhbtURL="http://"+window.location.host+"/"+xhbtURL;(function(){var a=_.template(document.getElementById("dltext-filter-template").innerHTML),b=[];prspdata.t.forEach(function(c,e){b.push(a({ti:e,tl:c.def.l}))});I=b.join("&nbsp;")})();(function(){var a;prspdata.t.forEach(function(b,c){var e="";b.def.a.forEach(function(b){a=PData.aByID(b);switch(a.def.t){case "T":case "V":case "N":case "D":e+='<option value="'+b+'">'+a.def.l+"</option>"}});jQuery("#dialog-sortby").append("<b>"+
b.def.l+"</b>: <select data-ti="+c+">"+e+"</select><br/>")})})();"/"!=prspdata.site_url.charAt(prspdata.site_url.length-1)&&(prspdata.site_url+="/");""!=prspdata.e.g.l&&jQuery("#title").text(prspdata.e.g.l);try{var l=window.localStorage;l.setItem("__storage_test__","__storage_test__");l.removeItem("__storage_test__");var T=l.getItem(prspdata.e.id),g=l;0<T.length&&(c=JSON.parse(T))}catch(a){}jQuery("#btn-about").button({icons:{primary:"ui-icon-power"},text:!1}).click(function(a){var b;jQuery("#dialog-about img").removeClass("zoomin");
b=jQuery("#dialog-about").dialog({height:390,width:350,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close")}}]});jQuery("#dialog-about img").addClass("zoomin");a.preventDefault()});jQuery("#btn-set-layout").button({icons:{primary:"ui-icon-newwin"},text:!1}).click(function(){null!==f[1]?(f[1]=null,jQuery("#view-frame-1").remove()):(f[0].flushLgnd(),PState.set(PSTATE_BUILD),f[1]=PViewFrame(1),f[1].initDOM(0),f[1].showStream(b),PState.set(PSTATE_READY));f[0].resize()});jQuery("#btn-hs-bars").button({icons:{primary:"ui-icon-carat-2-n-s"},
text:!1}).click(function(a){jQuery("#filter-frame").slideToggle(400);a.preventDefault()});jQuery("#btn-show-prspctv").button({icons:{primary:"ui-icon-image"},text:!1}).click(function(a){var b=jQuery("#prspctv-slist");b.empty();prspdata.p.forEach(function(a){b.append('<li data-src="server" data-id="'+a.id+'">'+a.l+"</li>")});c.forEach(function(a){b.append('<li data-src="local" data-id="'+a.id+'">'+a.l+"</li>")});var d=[{text:dlText.ok,click:function(){e.dialog("close");var a=b.find("li.selected");
a.length&&(a=a.data("id"),F(a),PState.set(PSTATE_READY))}},{text:dlText.cancel,click:function(){e.dialog("close")}}];g&&d.push({text:dlText.manage,click:function(){e.dialog("close");O()}});var e=jQuery("#dialog-show-prsrctv").dialog({width:350,height:350,modal:!0,buttons:d});a.preventDefault()});jQuery("#btn-save-prspctv").button({icons:{primary:"ui-icon-pencil"},text:!1}).click(function(a){var b,c=/[^\w\-]/;jQuery("#save-prspctv-id").val("");jQuery("#save-prspctv-lbl").val("");jQuery("#save-prspctv-note").val("");
g||jQuery("#save-prspctv-d-1").prop("disabled",!0);prspdata.x.add_prspctv||jQuery("#save-prspctv-d-2").prop("disabled",!0);jQuery("#save-prspctv-h0").prop("checked",!1);jQuery("#save-prspctv-h1").prop("checked",!1);for(var e=0;2>e;e++){var h=null===w[e]||null===f[e];jQuery("#save-prspctv-h"+e).prop("disabled",h)}b=jQuery("#dialog-save-prsrctv").dialog({width:350,height:370,modal:!0,buttons:[{text:dlText.ok,click:function(){var a=jQuery("#save-prspctv-id").val().trim(),e=a.match(c),f=jQuery("#save-prspctv-lbl").val().trim(),
f=f.replace(/"/g,"");if(0===a.length||20<a.length||e)e="#dialog-prspctv-id-badchars";else if(M(a))e="#dialog-prspctv-id-used";else if(0===f.length||32<f.length)e="#dialog-prspctv-label-bad";if(e)var g=jQuery(e).dialog({width:320,height:210,modal:!0,buttons:[{text:dlText.ok,click:function(){g.dialog("close")}}]});else if(e=N(a,f),b.dialog("close"),"server"==e){a=xhbtURL+"/?prspctv="+a;jQuery("#save-prspctv-embed").val(a);var h=jQuery("#dialog-prspctv-url").dialog({width:480,height:230,modal:!0,buttons:[{text:dlText.ok,
click:function(){h.dialog("close")}}]})}}},{text:dlText.cancel,click:function(){b.dialog("close")}}]});a.preventDefault()});jQuery("#btn-annote").button({icons:{primary:"ui-icon-comment"},text:!1}).click(function(a){jQuery("#annote").toggle("slide",{direction:"right"});a.preventDefault()});0<prspdata.e.g.hbtn.length&&0<prspdata.e.g.hurl.length?(jQuery("#home-title").text(prspdata.e.g.hbtn),jQuery("#btn-home").button({icons:{primary:"ui-icon-home"},text:!1}).click(B)):jQuery("#btn-home").remove();
jQuery("#filter-list").click(function(a){"I"==a.target.nodeName?(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).parent().addClass("selected")):"LI"==a.target.nodeName&&(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).addClass("selected"))});jQuery("#prspctv-slist").click(function(a){"LI"==a.target.nodeName&&(jQuery("#prspctv-slist li").removeClass("selected"),jQuery(a.target).addClass("selected"))});jQuery("#btn-new-filter").button({icons:{primary:"ui-icon-plus"},
text:!1}).click(function(a){K(!0,!1,null,function(a){jQuery("#filter-instances").show(400);H(a,[!0,!0,!0,!0],null);jQuery("#btn-toggle-filters").button("enable")});a.preventDefault()});jQuery("#btn-toggle-filters").button({icons:{primary:"ui-icon-arrow-2-n-s"},text:!1}).click(function(a){jQuery("#filter-instances").slideToggle(400);a.preventDefault()});jQuery("#btn-f-state").click(function(a){f.forEach(function(a){a&&a.clearSel()});u();PState.set(PSTATE_READY);a.preventDefault()});jQuery("#dialog-about .logo").attr("src",
prspdata.assets+"prospectlogo.jpg");jQuery("#btn-inspect-left").button({icons:{primary:"ui-icon-arrowthick-1-w"},text:!1});jQuery("#btn-inspect-right").button({icons:{primary:"ui-icon-arrowthick-1-e"},text:!1});(function(){jQuery("#filter-list").append('<li class="remove" data-id="_remove"><i>'+dlText.rha+"</i></li>");prspdata.a.forEach(function(a){if("undefined"===typeof a.def.f||!0===a.def.f)switch(a.def.t){case "V":case "T":case "g":case "N":case "D":case "P":jQuery("#filter-list").append('<li data-id="'+
a.id+'">'+a.def.l+"</li>")}})})();0!=prspdata.show_prspctv.length&&F(prspdata.show_prspctv)||(f[0]=PViewFrame(0),f[0].initDOM(0),r(""));jQuery(window).resize(function(){f.forEach(function(a){a&&a.resize()})});jQuery("body").on("prospect",function(a,b){switch(b.s){case PSTATE_PROCESS:PState.set(PSTATE_PROCESS);u();for(var c=0;2>c;c++)null!==w[c]&&L(c);PState.set(PSTATE_READY);jQuery("body").removeClass("waiting");break;case PSTATE_FDIRTY:jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters);
break;case PSTATE_HILITE:S(b.v,b.t)}});PState.set(PSTATE_LOAD);PData.init();if(prspdata.x.tour){n={id:"ProspectTour",showPrevButton:!0,i18n:{nextBtn:dlText.next,prevBtn:dlText.prev,doneBtn:dlText.close},steps:[]};for(t=jQuery("#help-tour").children(":first");0!=t.length;)l={target:jQuery(t).data("t"),placement:jQuery(t).data("p"),title:jQuery(t).data("l"),xOffset:jQuery(t).data("x"),yOffset:jQuery(t).data("y"),content:jQuery(t).contents().text()},n.steps.push(l),t=t.next();jQuery("#command-bar .help").click(function(){jQuery("#filter-frame").slideDown(200);
hopscotch.startTour(n)})}else jQuery("#command-bar .help").hide()});function onYouTubeIframeAPIReady(){widgetData.ytCall&&widgetData.ytCall()};