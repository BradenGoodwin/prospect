Array.prototype.findIndex||(Array.prototype.findIndex=function(a,c){if(null==this)throw new TypeError("Array.prototype.find called on null or undefined");if("function"!==typeof a)throw new TypeError("predicate must be a function");for(var d=Object(this),e=d.length>>>0,f,g=0;g<e;g++)if(f=d[g],a.call(c,f,g,d))return g;return-1});
var EVENT_INSTANT=1,EVENT_F_START=2,EVENT_F_END=4,PSTATE_INIT=0,PSTATE_LOAD=1,PSTATE_PROCESS=2,PSTATE_BUILD=3,PSTATE_UPDATE=4,PSTATE_READY=5,PSTATE_FDIRTY=6,PSTATE_HILITE=7,D3FG_BAR_WIDTH=25,D3FG_MARGINS={top:4,right:7,bottom:22,left:30},D3SC_MARGINS={top:30,right:5,bottom:5,left:40},V_FLAG_LGND=1,V_FLAG_SEL=2,V_FLAG_LOC=4,V_FLAG_SLGND=8,V_FLAG_OPT=16,V_FLAG_VSCRL=32,V_FLAG_HSCRL=64,parseTC=/(\d\d)\:(\d\d)\:(\d\d)\.(\d\d?)/,MS_IN_DAY=86399990,TODAY=new Date,localD3,months,dlText={},xhbtURL,widgetData=
{ytLoaded:!1,ytCall:null,ytCode:null,timer:null,extract:null,sTime:null,eTime:null,playing:!1,widget:null,xscriptOn:!1,tcArray:null,tcIndex:-1},PState=function(){var a=PSTATE_INIT,c,d;return{init:function(){c=document.getElementById("dltext-pstates").innerHTML.trim().split("|");d=document.getElementById("pstate")},set:function(e){e!=a&&(a===PSTATE_READY?d.classList.add("attn"):e===PSTATE_READY&&d.classList.remove("attn"),d.textContent=c[e-1],a=e)}}}();
function PVizModel(a,c){this.vFrame=a;this.frameID=a.getFrameID()+" div.viz-content div.viz-result";this.settings=c;this.recSel=[];this.tUsed=[!1,!1,!1,!1];this.rMap=null}PVizModel.prototype.flags=function(){return 0};PVizModel.prototype.preRender=function(){var a;a=PData.rSize();var c=Math.floor((a+15)/16);for(a=0;4>a;a++)this.tUsed[a]=!1;null==this.rMap&&(this.rMap=new Uint16Array(c));for(a=0;a<c;a++)this.rMap[a]=0};PVizModel.prototype.isSel=function(a){return-1!=_.indexOf(this.recSel,a,!0)};
PVizModel.prototype.getSel=function(){return this.recSel};PVizModel.prototype.toggleSel=function(a){var c=this.recSel.length,d=_.sortedIndex(this.recSel,a);if(this.recSel[d]==a)return this.recSel.splice(d,1),0<c&&0==this.recSel.length&&this.vFrame.selBtns(!1),!1;this.recSel.splice(d,0,a);0==c&&0<this.recSel.length&&this.vFrame.selBtns(!0);return!0};PVizModel.prototype.clearSel=function(){this.recSel=[]};PVizModel.prototype.getLocAtts=function(a){return[]};PVizModel.prototype.getFeatureAtts=function(a){return[]};
PVizModel.prototype.teardown=function(){};PVizModel.prototype.resize=function(){};PVizModel.prototype.doOptions=function(){};PVizModel.prototype.getState=function(){return{}};PVizModel.prototype.setState=function(a){};PVizModel.prototype.hint=function(){return null};var VizMap=function(a,c){PVizModel.call(this,a,c)};VizMap.prototype=Object.create(PVizModel.prototype);VizMap.prototype.constructor=VizMap;VizMap.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_OPT};
VizMap.prototype.getLocAtts=function(a){return null!=a?(a=this.settings.cAtts[a],null==a?null:a):this.settings.cAtts};VizMap.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};
VizMap.prototype.setup=function(){var a=this,c=parseFloat(this.settings.clat),d=parseFloat(this.settings.clon),e;e="string"===typeof this.settings.zoom?parseInt(this.settings.zoom):this.settings.zoom;var f=this.vFrame.getIndex();jQuery(this.frameID).append('<div id="l-map-'+f+'" class="max-size"></div>');this.lMap=L.map("l-map-"+f,{zoomControl:!1}).setView([c,d],e);this.baseMap=PMapHub.createMapLayer(this.settings.base,1,this.lMap,null);var g;this.mapLayers=[];var h=jQuery("#dialog-opacities div.layer-list");
h.empty();var m=jQuery('<div class="op-layer" data-i="-1">Base Map <input type=range class="op-slider" min=0 max=100 value=100 step=5></div>');h.append(m);_.each(this.settings.lyrs,function(c,k){g=c.o||1;var e;e=PMapHub.createMapLayer(c.lid,g,a.lMap,null);a.mapLayers.push(e);m=jQuery('<div class="op-layer" data-i="'+k+'">'+e.options.layerName+' <input type=range class="op-slider" min=0 max=100 value='+100*c.o+" step=5></div>");h.append(m)});var q=_.template(document.getElementById("dltext-v-map").innerHTML);
jQuery("#view-frame-"+f+" div.view-controls").append(q({vi:f}));jQuery("#map-zoom-"+f).button({text:!1,icons:{primary:"ui-icon-plus"}}).click(function(){a.lMap.zoomIn()});jQuery("#map-unzoom-"+f).button({text:!1,icons:{primary:"ui-icon-minus"}}).click(function(){a.lMap.zoomOut()});jQuery("#map-reset-"+f).button({text:!1,icons:{primary:"ui-icon-arrowrefresh-1-w"}}).click(function(){a.lMap.setView([c,d],e)});jQuery("#map-cloc-"+f).button({text:!1,icons:{primary:"ui-icon-pin-s"}}).click(function(){navigator.geolocation.getCurrentPosition(function(c){a.lMap.setView([c.coords.latitude,
c.coords.longitude])})});this.markerLayer=f=L.featureGroup();f.options=f.options||{};f.options.layerName=dlText.markers;f.addTo(this.lMap);this.lineLayer=f=L.featureGroup();f.addTo(this.lMap);f=PData.eTNum();this.tLCnt=new Uint16Array(f)};
VizMap.prototype.render=function(a){function c(a){if(a.target&&a.target.options){var c=a.target.options._aid,k=d.toggleSel(c);a=PData.n2T(c);1<d.tLCnt[a]?(PState.set(PSTATE_UPDATE),e.eachLayer(function(a){a.options._aid===c&&(k?a.setStyle({color:"yellow",weight:2}):a.setStyle({color:"#000",weight:1}))}),PState.set(PSTATE_READY)):k?this.setStyle({color:"yellow",weight:2}):this.setStyle({color:"#000",weight:1})}}var d=this,e=this.markerLayer;0<this.recSel.length&&(this.recSel=[]);this.preRender();e.clearLayers();
var f=this.lineLayer;f.clearLayers();var g=PData.eTNum(),h=0,m,q=0,p,k,n,r,v,x,y,l,A,w,u,C,t,z,B,D,E;z=this.settings.min;"string"===typeof z&&(z=parseInt(z));q=this.settings.max;"string"===typeof q&&(q=parseInt(q));B=q-z;for(h=0;h<g;h++)this.tLCnt[h]=0;for(var F,h=0;h<g;h++)if("disable"!==this.settings.pAtts[h]){F=[];break}h=0;q=-1;a:for(;h<a.l;){if(null==x){do{if(++q==g)break a;p=a.t[q]}while(0===p.n||p.i+p.n===h);x=this.vFrame.getSelLocAtts(q);if(0===x.length){x=null;continue}y=d.vFrame.getSelFeatAtts(q);
if(0===y.length){x=null;continue}d.tLCnt[q]=x.length;d.tUsed[q]=!0;r=d.vFrame.getSelLegend(q);v=PData.aByID(r);l=d.settings.pAtts[q];k=d.settings.lClrs[q];if(C=d.settings.sAtts[q])t=PData.aByID(C),"number"===typeof t.r.min&&"number"===typeof t.r.max?(D=t.r.min,E=t.r.max-D):C=null}m=a.s[h];n=PData.rByN(m);var G;F&&(G={id:n.id,c:[],p:n.a[l],l:k});x.forEach(function(a){if(A=n.a[a])if(w=n.a[r],"undefined"!==typeof w&&(w=PData.lClr(w,v,y))){d.rMap[m>>4]|=1<<(m&15);if("number"===typeof A[0])C?(t=n.a[C],
t="number"===typeof t?Math.floor((t-D)*B/E)+z:z):t=z,u=L.circleMarker(A,{_aid:m,weight:1,radius:t,fillColor:w,color:"#000",opacity:1,fillOpacity:1}),G&&G.c.push(A);else if(u=2===A.length?L.polyline(A,{_aid:m,weight:1,fillColor:w,color:"#000",opacity:1,fillOpacity:1}):L.polygon(A,{_aid:m,weight:1,fillColor:w,color:"#000",opacity:1,fillOpacity:1}),G){var k=[0,0];A.forEach(function(a){k[0]+=a[0];k[1]+=a[1]});k[0]/=A.length;k[1]/=A.length;G.c.push(k)}u.on("click",c);e.addLayer(u)}});G&&0<G.c.length&&
F.push(G);++h==p.i+p.n&&(x=null)}if(F){F.sort(function(a,c){return PData.strcmp(c.id,a.id)});var I=[];F.forEach(function(a){a.p&&a.p.forEach(function(c){h=_.sortedIndex(F,{id:c},"id");if(h<F.length){var k=F[h];k.id===c&&a.c.forEach(function(c){k.c.forEach(function(k){c[0]===k[0]&&c[1]===k[1]||I.push({p:[c,k],c:a.l})})})}})});I.forEach(function(a){f.addLayer(L.polyline(a.p,{color:a.c,weight:2}))})}};VizMap.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-controls div.iconbar").remove()};
VizMap.prototype.resize=function(){this.lMap.invalidateSize(!1)};VizMap.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],this.markerLayer&&this.markerLayer.eachLayer(function(a){a.setStyle({color:"#000",weight:1})}))};VizMap.prototype.setSel=function(a){var c=this;this.recSel=a;this.markerLayer&&this.markerLayer.eachLayer(function(a){c.isSel(a.options._aid)?a.setStyle({color:"yellow",weight:2}):a.setStyle({color:"#000",weight:1})})};
VizMap.prototype.getState=function(){return{c:this.lMap.getCenter(),z:this.lMap.getZoom(),l:this.vFrame.getLgndSels()}};VizMap.prototype.setState=function(a){this.lMap.setView(a.c,a.z);this.vFrame.setLgndSels(a.l)};VizMap.prototype.hint=function(){for(var a="",c=PData.eTNum(),d=0;d<c;d++){var e=this.settings.sAtts[d];if(e)var a=0===a.length?dlText.markersize:a+",",e=PData.aByID(e),f=PData.eTByN(d),f=PData.tByID(f),a=a+(" "+e.def.l+" ("+f.l+")")}return 0<a.length?a:null};
VizMap.prototype.doOptions=function(){var a=this,c=jQuery("#dialog-opacities").dialog({height:300,width:500,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close");var d,e;d=jQuery('.op-layer[data-i="-1"] .op-slider').val();a.baseMap.setOpacity(d/100);e=a.settings.lyrs.length;for(var f=0;f<e;f++)d=jQuery('.op-layer[data-i="'+f+'"] .op-slider').val(),a.mapLayers[f].setOpacity(d/100)}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})};
var VizCards=function(a,c){PVizModel.call(this,a,c)};VizCards.prototype=Object.create(PVizModel.prototype);VizCards.prototype.constructor=VizCards;VizCards.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_OPT};VizCards.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};
VizCards.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(c){if("DIV"===c.target.nodeName||"IMG"===c.target.nodeName)if(c=jQuery(c.target).closest("div.card"),1==c.size()){var d=c.data("ai");null!=d&&(a.toggleSel(d)?c.addClass("obj-sel"):c.removeClass("obj-sel"))}});a.sAtts=[];for(var c=0;c<PData.eTNum();c++){var d=jQuery('#dialog-sortby select[data-ti="'+c+'"] :first').val();a.sAtts.push(d)}for(c=0;c<PData.eTNum();c++)jQuery('#dialog-sortby select[data-ti="'+c+'"]').val(this.sAtts[c])};
VizCards.prototype.render=function(a){var c=this;this.stream=a;var d=PData.eTNum(),e,f,g,h,m,q,p,k,n,r,v,x,y,l,A=jQuery(this.frameID);A.empty();0<this.recSel.length&&(this.recSel=[]);this.preRender();var w,u="w"+this.settings.w+" h"+this.settings.h;f=a.t[0];for(e=0;e<d;){for(;0===f.n;){if(++e===d)return;f=a.t[e]}f=PData.eTByN(e);f=PData.tByID(f);q=c.vFrame.getSelFeatAtts(e);0!==q.length&&(A.append('<div class="template-label">'+f.l+'</div><div class="cards" data-ti="'+e+'"></div>'),w=jQuery('div.cards[data-ti="'+
e+'"]'),this.tUsed[e]=!0,g=c.vFrame.getSelLegend(e),h=PData.aByID(g),m=c.settings.iAtts[e],r=c.settings.cnt[e],f=c.sAtts[e],f=PData.aByID(f),f=PData.rTOrder(f,a,e),f.forEach(function(a){p=PData.rByN(a.i);v=p.a[g];"undefined"!==typeof v&&(k=PData.lRecs(v,h,q,!1))&&(c.rMap[a.i>>4]|=1<<(a.i&15),y=c.settings.lOn?'<div class="card-title">'+p.l+"</div>":"",n=!1,x="",r&&0<r.length&&(l=k.b?' style="color:black"':"",r.forEach(function(a){if(v=p.a[a])if(v=PData.procAttTxt(a,v))n=!0,x+=v+"<br/>"})),x=m&&(v=
p.a[m])?n?'<div class="card-body"><img src="'+v+'"/><div class="card-cnt"'+l+">"+x+"</div></div>":'<div class="card-body"><img class="full" src="'+v+'"/></div>':'<div class="card-body"><div class="card-cnt"'+l+">"+x+"</div>",w.append('<div class="card '+u+'" style="background-color:'+k.v+'" data-ai="'+a.i+'">'+y+x+"</div>"))}));f=a.t[++e]}};VizCards.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")};
VizCards.prototype.rerender=function(a){var c=this,d=jQuery(this.frameID+' div.cards[data-ti="'+a+'"]');d.empty();var e,f,g,h,m,q,p,k,n,r,v,x,y,l="w"+this.settings.w+" h"+this.settings.h;e=c.vFrame.getSelFeatAtts(a);0!=e.length&&(f=c.vFrame.getSelLegend(a),g=PData.aByID(f),h=c.settings.iAtts[a],m=c.settings.cnt[a],q=c.sAtts[a],q=PData.aByID(q),a=PData.rTOrder(q,c.stream,a),a.forEach(function(a){p=PData.rByN(a.i);k=p.a[f];"undefined"!==typeof k&&(n=PData.lRecs(k,g,e,!1))&&(x=c.settings.lOn?'<div class="card-title">'+
p.l+"</div>":"",r=!1,v="",m&&0<m.length&&(y=n.b?' style="color:black"':"",m.forEach(function(a){if(k=p.a[a])if(k=PData.procAttTxt(a,k))r=!0,v+=k+"<br/>"})),v=h&&(k=p.a[h])?r?'<div class="card-body"><img src="'+k+'"/><div class="card-cnt"'+y+">"+v+"</div></div>":'<div class="card-body"><img class="full" src="'+k+'"/></div>':'<div class="card-body"><div class="card-cnt"'+y+">"+v+"</div>",d.append('<div class="card '+l+(c.isSel(a.i)?" obj-sel":"")+'" style="background-color:'+n.v+'" data-ai="'+a.i+'">'+
x+v+"</div>"))}))};VizCards.prototype.doOptions=function(){var a=this;this.sAtts.forEach(function(a,c){jQuery('#dialog-sortby select[data-ti="'+c+'"]').val(a)});var c=jQuery("#dialog-sortby").dialog({height:220,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close");PState.set(PSTATE_BUILD);for(var d=0;d<PData.eTNum();d++){var e=jQuery('#dialog-sortby select[data-ti="'+d+'"]').val();e!=a.sAtts[d]&&(a.sAtts[d]=e,a.rerender(d))}PState.set(PSTATE_READY)}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})};
VizCards.prototype.setSel=function(a){var c=this,d,e;this.recSel=a;jQuery(this.frameID).find("div.card").each(function(){e=jQuery(this);d=e.data("ai");null!=d&&(c.isSel(d)?e.addClass("obj-sel"):e.removeClass("obj-sel"))})};VizCards.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],jQuery(this.frameID).find("div.card").removeClass("obj-sel"))};VizCards.prototype.getState=function(){return{l:this.vFrame.getLgndSels(),s:this.sAtts}};
VizCards.prototype.setState=function(a){this.vFrame.setLgndSels(a.l);this.sAtts=a.s};var VizPinboard=function(a,c){PVizModel.call(this,a,c)};VizPinboard.prototype=Object.create(PVizModel.prototype);VizPinboard.prototype.constructor=VizPinboard;VizPinboard.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_HSCRL|V_FLAG_VSCRL|V_FLAG_OPT};VizPinboard.prototype.getLocAtts=function(a){return null!=a?(a=this.settings.cAtts[a],null==a?null:[a]):[this.settings.cAtts]};
VizPinboard.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};
VizPinboard.prototype.setup=function(){var a=this.settings,c=this,d=this.vFrame.getIndex(),e=jQuery("#dialog-opacities div.layer-list");e.empty();var f=jQuery('<div class="op-layer" data-i="-1">Base Image <input type=range class="op-slider" min=0 max=100 value=100 step=5></div>');e.append(f);this.settings.lyrs.forEach(function(a,c){f=jQuery('<div class="op-layer" data-i="'+c+'">Overlay '+(c+1)+' <input type=range class="op-slider" min=0 max=100 value='+100*a.o+" step=5></div>");e.append(f)});PData.eTNum();
this.xScale=d3.scale.linear().domain([0,a.iw-1]).rangeRound([0,a.dw-1]);this.yScale=d3.scale.linear().domain([0,a.ih-1]).range([0,a.dh-1]);this.xAxis=d3.svg.axis().scale(this.xScale).orient("top");this.yAxis=d3.svg.axis().scale(this.yScale).orient("left");this.chart=d3.select(this.frameID).append("svg").attr("width",a.dw+30+3).attr("height",a.dh+30+2).append("g").attr("transform","translate(30,30)");this.chart.append("g").attr("class","x axis").call(this.xAxis);this.chart.append("g").attr("class",
"y axis").call(this.yAxis);this.chart.append("image").attr("id","base-"+d).attr("xlink:href",a.img).attr("x",0).attr("y",0).attr("height",a.dh).attr("width",a.dw);this.settings.lyrs.forEach(function(a,e){c.chart.append("svg").attr("id","ol-"+d+"-"+e).attr("opacity",a.o)});this.settings.lyrs.forEach(function(a,c){d3.xml(a.url,function(a,e){if(!a){var f=e.getElementsByTagName("svg")[0];d3.select("#ol-"+d+"-"+c).node().appendChild(f)}})});this.gRecs=this.chart.append("g").attr("id","recs")};
VizPinboard.prototype.render=function(a){var c=this;this.gRecs.selectAll(".recobj").remove();this.gRecs.selectAll(".recline").remove();0<this.recSel.length&&(this.recSel=[]);this.preRender();var d=PData.eTNum(),e,f,g=0,h,m,q,p,k,n,r,v,x,y,l,A,w,u,C,t;for(e=0;e<d;e++)if("disable"!==this.settings.pAtts[e]){t=[];break}A=this.settings.min;"string"===typeof A&&(A=parseInt(A));f=this.settings.max;"string"===typeof f&&(f=parseInt(f));w=f-A;var z=[];e=0;g=-1;a:for(;e<a.l;){if(null==n){do{if(++g===d)break a;
h=a.t[g]}while(0===h.n||h.i+h.n===e);n=this.vFrame.getSelLocAtts(g);if(0===n.length){n=null;continue}n=n[0];r=c.vFrame.getSelFeatAtts(g);if(0===r.length){n=null;continue}c.tUsed[g]=!0;p=c.vFrame.getSelLegend(g);k=PData.aByID(p);v=c.settings.pAtts[g];m=c.settings.lClrs[g];if(l=c.settings.sAtts[g])q=PData.aByID(l),"number"===typeof q.r.min&&"number"===typeof q.r.max?(u=q.r.min,C=q.r.max-u):l=null}f=a.s[e];q=PData.rByN(f);var B;t&&(B={id:q.id,c:null,p:q.a[v],l:m});x=q.a[n];"undefined"!==typeof x&&(y=
q.a[p],"undefined"!==typeof y&&(y=PData.lClr(y,k,r)))&&(c.rMap[f>>4]|=1<<(f&15),l?(q=q.a[l],q="number"===typeof q?Math.floor((q-u)*w/C)+A:A):q=A,z.push({ai:f,v:y,x:x[0],y:x[1],r:q}),B&&(B.c=x));B&&B.c&&t.push(B);++e==h.i+h.n&&(n=null)}this.gRecs.selectAll(".recobj").data(z).enter().append("circle").attr("class","recobj").attr("cx",function(a){return c.xScale(a.x)}).attr("cy",function(a){return c.yScale(a.y)}).attr("r",function(a){return c.yScale(a.r)}).style("fill",function(a){return a.v}).on("click",
function(a,k){var e=c.toggleSel(a.ai);d3.select(this).classed("obj-sel",e)});if(t){t.sort(function(a,c){return PData.strcmp(c.id,a.id)});var D=[];t.forEach(function(a){a.p&&a.p.forEach(function(c){e=_.sortedIndex(t,{id:c},"id");if(e<t.length){var k=t[e];k.id===c&&D.push({f:a.c,t:k.c,c:a.l})}})});this.gRecs.selectAll(".recline").data(D).enter().append("line").attr("class","recline").attr("x1",function(a){return c.xScale(a.f[0])}).attr("y1",function(a){return c.yScale(a.f[1])}).attr("x2",function(a){return c.xScale(a.t[0])}).attr("y2",
function(a){return c.yScale(a.t[1])}).attr("stroke",function(a){return a.c})}};VizPinboard.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],this.gRecs.selectAll(".recobj").classed("obj-sel",!1))};VizPinboard.prototype.setSel=function(a){var c=this;this.recSel=a;this.gRecs.selectAll(".recobj").classed("obj-sel",function(a){return c.isSel(a.ai)})};
VizPinboard.prototype.doOptions=function(){var a=this,c=this.vFrame.getIndex(),d=jQuery("#dialog-opacities").dialog({height:300,width:320,modal:!0,buttons:[{text:dlText.ok,click:function(){d.dialog("close");var e,f;e=jQuery('.op-layer[data-i="-1"] .op-slider').val();d3.select("#base-"+c).attr("opacity",e/100);f=a.settings.lyrs.length;for(var g=0;g<f;g++)e=jQuery('.op-layer[data-i="'+g+'"] .op-slider').val(),d3.select("#ol-"+c+"-"+g).attr("opacity",e/100)}},{text:dlText.cancel,click:function(){d.dialog("close")}}]})};
VizPinboard.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}};VizPinboard.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)};VizPinboard.prototype.hint=function(){for(var a="",c=PData.eTNum(),d=0;d<c;d++){var e=this.settings.sAtts[d];if(e)var a=0===a.length?dlText.markersize:a+",",e=PData.aByID(e),f=PData.eTByN(d),f=PData.tByID(f),a=a+(" "+e.def.l+" ("+f.l+")")}return 0<a.length?a:null};var VizTime=function(a,c){PVizModel.call(this,a,c)};VizTime.prototype=Object.create(PVizModel.prototype);
VizTime.prototype.constructor=VizTime;VizTime.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_VSCRL};VizTime.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};VizTime.prototype.getLocAtts=function(a){return null!=a?(a=this.settings.dAtts[a],null==a?null:[a]):[this.settings.dAtts]};
VizTime.prototype.getWidths=function(){var a=[],c=jQuery(this.frameID).width();a.push(c);c-=4;a.push(c);this.threshold=c/(6.25*this.settings.xLbl);return a};
VizTime.prototype.setup=function(){function a(a){var c={id:a,l:0,t:0,h:0,w:g[1],svgID:"#tl-b-"+m+"-"+a,tHt:0,iHt:0,xScale:d3.time.scale(),yScale:function(a){return a*c.tHt},parts:[],g:null,labels:null,labelSVGs:null,redraw:function(){}};a?(c.tHt=e.settings.bHt,c.iHt=c.tHt-2):(c.tHt=3,c.iHt=2);if(1==a){var k=e.minDate,d=e.maxDate;0<e.settings.zFrom.length&&(k=PData.dStr(e.settings.zFrom,!1));0<e.settings.zTo.length&&(d=PData.dStr(e.settings.zTo,!0));c.xScale.domain([k,d]);e.zMinDate=k;e.zMaxDate=d}else c.xScale.domain([e.minDate,
e.maxDate]);c.xScale.range([0,c.w]);c.g=e.chart.append("g").attr("id",c.svgID.substring(1)).attr("class","tl-band").attr("width",c.w);e.bands[a]=c;e.cmpnts.push(c)}function c(a){var c=e.bands[a],k=d3.svg.axis().scale(c.xScale).orient("bottom").tickSize(6,0);localD3&&k.tickFormat(localD3);var d=c.g.append("g").attr("id","axis-"+m+"-"+a).attr("class","axis").style("font-size","10px");a={redraw:function(){d.call(k)}};c.parts.push(a);e.cmpnts.push(a)}function d(a){var c=e.bands[a],k;k=1===a?32:16;c.labels=
[{name:"s-"+m+"-"+a,x:function(){return 0},left:function(){return 0},anchor:"start",tDelta:2,whichDate:function(a,c){return a}},{name:"e-"+m+"-"+a,x:function(){return c.l+c.w},left:function(){return c.l+c.w-e.settings.xLbl},anchor:"end",tDelta:-3,whichDate:function(a,c){return c}}];var d=d3.select(c.svgID).selectAll(".bLblCntr").data(c.labels).enter().append("g").attr("class","bLblCntr");d.append("rect").attr("class","bLbl").attr("id",function(a){return"rect-"+a.name}).attr("x",function(a){return a.left()}).attr("width",
e.settings.xLbl).attr("height",k);var r=d.append("text").attr("class","bMinMaxLbl").attr("id",function(a){return"txt-"+a.name}).attr("x",function(a){return a.x()+a.tDelta}).attr("y",12).attr("text-anchor",function(a){return a.anchor}),f={redraw:function(){var a=c.xScale.domain(),k=a[0],e=a[1];r.text(function(a){return a.whichDate(k,e).getUTCFullYear()})}};c.parts.push(f);e.cmpnts.push(f);if(1===a){var x=d.append("text").attr("class","bMinMaxLbl").attr("id",function(a){return"m-txt-"+a.name}).attr("x",
function(a){return a.x()+a.tDelta}).attr("y",k-4).attr("text-anchor",function(a){return a.anchor});a={redraw:function(){var a=c.xScale.domain(),k=a[0],d=a[1];x.text(function(a){return d.getUTCFullYear()-k.getUTCFullYear()>e.threshold?"":months[a.whichDate(k,d).getMonth()]})}};c.parts.push(a);e.cmpnts.push(a)}c.labelSVGs=d}var e=this;"number"!==typeof this.settings.xLbl&&(this.settings.xLbl=parseInt(this.settings.xLbl));this.brushSVG=this.brush=null;var f=this.settings;"string"===typeof f.bHt&&(f.bHt=
parseInt(f.bHt,10));(function(){var a,c,k,d,r,v;f.dAtts.forEach(function(e){null!=e&&"disable"!==e&&(e=PData.aByID(e))&&(null==a||e.r.min.y<a?(a=e.r.min.y,"undefined"!==typeof e.r.min.m?(c=e.r.min.m,k="undefined"!==typeof e.r.min.d?e.r.min.d:1):k=c=1):e.r.min.y===a&&"undefined"!==typeof e.r.min.m&&(e.r.min.m<c?(c=e.r.min.m,k="undefined"!==typeof e.r.min.d?e.r.min.d:1):e.r.min.m===c&&"undefined"!==typeof e.r.min.d&&e.r.min.d<k&&(k=e.r.min.d)),null==d?"undefined"===typeof e.r.max.y?(d=TODAY.getUTCFullYear(),
r=TODAY.getMonth()+1,v=TODAY.getDate()):(d=e.r.max.y,"undefined"!==typeof e.r.max.m?(r=e.r.max.m,v="undefined"!==typeof e.r.max.d?e.r.max.d:PData.lenMnth(d,r)):(r=12,v=31)):e.r.max.y>d?(d=e.r.max.y,"undefined"!==typeof e.r.max.m?(r=e.r.max.m,v="undefined"!==typeof e.r.max.d?e.r.max.d:PData.lenMnth(d,r)):(r=12,v=31)):e.r.max.y===d&&"undefined"!==typeof e.r.max.m&&(e.r.max.m>r?(r=e.r.max.m,v="undefined"!==typeof e.r.max.d?e.r.max.d:PData.lenMnth(d,r)):e.r.max.m===r&&"undefined"!==typeof e.r.max.d&&
e.r.max.d>v&&(v=e.r.max.d)))});e.minDate=0<f.from.length?PData.dStr(f.from,!1):PData.d3Nums(a,c,k,!1);e.maxDate=0<f.to.length?PData.dStr(f.to,!0):PData.d3Nums(d,r,v,!0);e.instGap=.015*(e.maxDate-e.minDate)})();var g=e.getWidths(),h=d3.select(this.frameID).append("svg").attr("class","tl-vf").attr("width",g[1]);(function(){var a=[];f.lgnds.forEach(function(c){c.forEach(function(c){a.push(c)})});var a=_.uniq(a),c=[];a.forEach(function(a){(a=PData.aByID(a))&&a.l.forEach(function(a){c.push(a.v)})});c=
_.uniq(c);c.sort();var k=h.append("defs"),e,d;c.forEach(function(a){d=a.substr(1);e=k.append("linearGradient").attr("id",d+"-fs");e.append("stop").attr("offset","0%").attr("stop-color","#C0C0C0");e.append("stop").attr("offset","5%").attr("stop-color",a);e.append("stop").attr("offset","100%").attr("stop-color",a);e=k.append("linearGradient").attr("id",d+"-fe");e.append("stop").attr("offset","0%").attr("stop-color",a);e.append("stop").attr("offset","95%").attr("stop-color",a);e.append("stop").attr("offset",
"100%").attr("stop-color","#C0C0C0");e=k.append("linearGradient").attr("id",d+"-fb");e.append("stop").attr("offset","0%").attr("stop-color","#C0C0C0");e.append("stop").attr("offset","5%").attr("stop-color",a);e.append("stop").attr("offset","95%").attr("stop-color",a);e.append("stop").attr("offset","100%").attr("stop-color","#C0C0C0")})})();var m=this.vFrame.getIndex();h.append("clipPath").attr("id","tl-clip-"+m).append("rect").attr("width",g[1]);e.chart=h.append("g").attr("class","chart").attr("clip-path",
"url(#tl-clip-"+m+")");e.instRad=f.bHt/2-1;e.bands=Array(2);e.cmpnts=[];a(0);a(1);c(0);c(1);d(0);d(1)};
VizTime.prototype.render=function(a){function c(a,c){var k=a.s-c.s;if(0>k)return 1;if(0<k)return-1;k=c.e-a.e;return 0>k?1:0<k?-1:0}function d(a){function c(a){a=g.toggleSel(a.ai);d3.select(this).classed("obj-sel",a)}var k,e,d,f,x=g.bands[a];a?(k=g.bands[0],x.t=k.t+k.h+37,k=e=d=g.instRad,f=2*g.instRad+3):(x.t=0,k=e=d=1);x.h=m*x.tHt+2;x.g.attr("transform","translate(0,"+x.t+")").attr("height",x.h);var h,l;a&&(h=.75*x.iHt+"px",l=.8*x.iHt);var A;A=d3.select(x.svgID).selectAll(".lgBd").remove();A=d3.select(x.svgID).selectAll(".lgBd").data(g.lgBds).enter().append("svg").attr("class",
"lgBd").attr("y",function(a){return x.yScale(a.t)}).attr("height",function(a){return x.yScale(a.h)});A.append("rect").attr("width","100%").attr("height","100%").attr("fill",function(a){return a.d.v});1===a&&A.append("text").attr("class","lgBdLbl").attr("x",2).attr("y",l).attr("fill",function(a){return a.d.b?"#000000":"#FFFFFF"}).style("font-size",h).text(function(a){return a.d.l});var w;d3.select(x.svgID).selectAll(".event").remove();w=d3.select(x.svgID).selectAll(".event").data(g.events).enter().append("svg").attr("class",
function(a){return a.f&EVENT_INSTANT?"event instant":"event range"}).attr("y",function(a){return x.yScale(a.t)}).attr("height",x.iHt);if(1===a)w.on("click",c);var u=d3.select(x.svgID).selectAll(".range");u.append("rect").attr("width","100%").attr("height","100%").attr("fill",function(c){return 1===a&&c.f&(EVENT_F_START|EVENT_F_END)?(c.f&(EVENT_F_START|EVENT_F_END))===(EVENT_F_START|EVENT_F_END)?"url("+c.c.v+"-fb)":(c.f&EVENT_F_START)===EVENT_F_START?"url("+c.c.v+"-fs)":"url("+c.c.v+"-fe)":c.c.v});
1===a&&u.append("text").attr("class","rangeLbl").attr("x",4).attr("y",l).attr("fill",function(a){return a.c.b?"#000000":"#FFFFFF"}).style("font-size",h).text(function(a){return a.l});u=d3.select(x.svgID).selectAll(".instant");u.append("circle").attr("cx",k).attr("cy",e).attr("r",d).attr("fill",function(a){return a.c.v});1===a&&u.append("text").attr("class","instantLbl").attr("x",f).attr("y",l).style("font-size",h).text(function(a){return a.l});x.redraw=function(){A.attr("x",function(a){return x.xScale(a.s)}).attr("width",
function(a){return x.xScale(a.e)-x.xScale(a.s)});w.attr("x",function(a){return x.xScale(a.s)}).attr("width",function(a){return x.xScale(a.e)-x.xScale(a.s)});x.parts.forEach(function(a){a.redraw()})}}function e(a){a=g.bands[a];d3.select(a.svgID).selectAll(".axis").attr("transform","translate(0,"+a.h+")")}function f(a){a=g.bands[a];d3.select(a.svgID).selectAll(".bLblCntr").attr("transform","translate(0,"+(a.h+1).toString()+")")}var g=this,h=this.vFrame.getIndex();0<this.recSel.length&&(this.recSel=
[]);this.preRender();this.events=[];this.lgBds=[];var m=0;(function(){for(var e=PData.eTNum(),d=0,k,n,r,f,h,y,l,A;d<e;){for(k=a.t[d];0===k.n;){if(++d==e)return;k=a.t[d]}r=g.vFrame.getSelLocAtts(d);if(0!==r.length&&(r=g.vFrame.getSelFeatAtts(d),0!==r.length)){g.tUsed[d]=!0;A=g.vFrame.getSelLegend(d);l=PData.aByID(A);f=g.settings.dAtts[d];for(var w,u,C,t,z,B,D,E,F=[],G=k.i;G<k.i+k.n;G++)n=a.s[G],E=PData.rByN(n),h=E.a[A],"undefined"!==typeof h&&(h=PData.lRecs(h,l,r,!1))&&(y=E.a[f])&&"?"!==y&&(g.rMap[n>>
4]|=1<<(n&15),B=y.min.f?EVENT_F_START:0,w=y.min.y,"undefined"===typeof y.min.m?C=u=1:(u=y.min.m,C="undefined"===typeof y.min.d?1:y.min.d),t=PData.d3Nums(w,u,C,!1),"undefined"===typeof y.max?(B|=EVENT_INSTANT,z=t.getTime()+g.instGap):"open"===y.max?z=TODAY:(y.max.f&&(B|=EVENT_F_END),w=y.max.y,"undefined"===typeof y.max.m?(u=12,C=31):(u=y.max.m,C="undefined"===typeof y.max.d?PData.lenMnth(w,u):y.max.d),z=PData.d3Nums(w,u,C,!0)),F.push({s:t,e:z,ai:n,f:B,c:h,l:E.l,t:0}));F.sort(c);var I=[],K;F.forEach(function(a){for(K=
0;K<I.length&&!(a.e<I[K]);K++);a.t=K+m+1;I[K]=a.s});k=PData.aByID(f);k.l.forEach(function(a){D=a.d;w=D.min.y;"undefined"===typeof D.min.m?C=u=1:(u=D.min.m,C="undefined"===typeof D.min.d?1:D.min.d);t=PData.d3Nums(w,u,C,!1);"undefined"===typeof D.max.y?z=TODAY:(w=D.max.y,"undefined"===typeof D.max.m?(u=12,C=31):(u=D.max.m,C="undefined"===typeof D.max.d?PData.lenMnth(w,u):D.max.d),z=PData.d3Nums(w,u,C,!0));g.lgBds.push({s:t,e:z,t:m,h:I.length+1,d:a})});m+=I.length+1;g.events=g.events.concat(F)}d++}})();
g.getWidths();d(0);d(1);(function(){var a=g.bands[0];null!=g.brushSVG&&g.brushSVG.remove();g.brush=d3.svg.brush().x(a.xScale.range([0,a.w])).extent([g.zMinDate,g.zMaxDate]).on("brush",function(){var a=g.brush.extent(),c;"move"===d3.event.mode?(c=d3.time.day.round(a[0]),a=d3.time.day.offset(c,Math.round((a[1]-a[0])/864E5)),c=[c,a]):(c=a.map(d3.time.day.round),c[0]>=c[1]&&(c[0]=d3.time.day.floor(a[0]),c[1]=d3.time.day.ceil(d3.time.day.offset(c[0],Math.round(g.instGap/864E5)))));g.zMinDate=c[0];g.zMaxDate=
c[1];d3.select(this).call(g.brush.extent(c));zoom=g.bands[1];zoom.xScale.domain(c);zoom.redraw()});g.brushSVG=a.g.append("g");g.brushSVG.attr("class","brush").call(g.brush);g.brushSVG.selectAll("rect").attr("y",-1).attr("height",a.h);g.brushSVG.selectAll(".resize").append("path").attr("d",function(c){var e=(c=+("e"==c))?1:-1,d=a.h/4;return"M"+.5*e+","+d+"A6,6 0 0 "+c+" "+6.5*e+","+(d+6)+"V"+(2*d-6)+"A6,6 0 0 "+c+" "+.5*e+","+2*d+"ZM"+2.5*e+","+(d+8)+"V"+(2*d-8)+"M"+4.5*e+","+(d+8)+"V"+(2*d-8)})})();
(function(){var a=g.bands[1],a=a.t+a.h+45;d3.select(g.frameID+" svg.tl-vf").attr("height",a);d3.select("#tl-clip-"+h+" rect").attr("height",a)})();e(0);e(1);f(0);f(1);g.cmpnts.forEach(function(a){a.redraw()})};
VizTime.prototype.resize=function(){var a=this.getWidths(),c=d3.select(this.frameID+" svg.tl-vf");c.attr("width",a[1]);c.select("#tl-clip-"+this.vFrame.getIndex()+" rect").attr("width",a[1]);for(var d=0;2>d;d++){b=this.bands[d];b.w=a[1];c.select(b.svgID).attr("width",a[1]);b.xScale.range([0,a[1]]);var e=b.labels[1],f=e.x()+e.tDelta;b.labelSVGs.select("#rect-"+e.name).attr("x",e.left());b.labelSVGs.select("#txt-"+e.name).attr("x",f);if(0===d){if(this.brush){if(this.brushSVG){var g=this.brush.extent();
this.brushSVG.call(this.brush.extent(g))}this.brushHandler&&this.brushHandler.redraw()}b.labelSVGs.select("#m-txt-"+e.name).attr("x",f)}}this.cmpnts.forEach(function(a){a.redraw()})};VizTime.prototype.setSel=function(a){var c=this;c.recSel=a;d3.select(this.bands[1].svgID).selectAll(".event").attr("class",function(a){return c.isSel(a.ai)?a.f&EVENT_INSTANT?"event instant obj-sel":"event range obj-sel":a.f&EVENT_INSTANT?"event instant":"event range"})};
VizTime.prototype.clearSel=function(){function a(a){return a.f&EVENT_INSTANT?"event instant":"event range"}0<this.recSel.length&&(this.recSel=[],d3.select(this.bands[1].svgID).selectAll(".event").attr("class",a))};
VizTime.prototype.getState=function(){var a=this.brush.extent(),c=a[0],a=a[1],d=c.getUTCMonth()+1,c=c.getUTCFullYear().toString()+"-"+d.toString()+"-"+c.getDate().toString(),d=a.getUTCMonth()+1,a=a.getUTCFullYear().toString()+"-"+d.toString()+"-"+a.getDate().toString();return{d0:c,d1:a,l:this.vFrame.getLgndSels()}};VizTime.prototype.setState=function(a){var c=PData.dStr(a.d0,!1),d=PData.dStr(a.d1,!0);this.bands[1].xScale.domain([c,d]);this.zMinDate=c;this.zMaxDate=d;this.vFrame.setLgndSels(a.l)};
var VizDirectory=function(a,c){PVizModel.call(this,a,c)};VizDirectory.prototype=Object.create(PVizModel.prototype);VizDirectory.prototype.constructor=VizDirectory;VizDirectory.prototype.flags=function(){return V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_OPT};
VizDirectory.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(c){if("TD"===c.target.nodeName){c=jQuery(c.target).closest("tr");var d=c.data("ai");null!=d&&(a.toggleSel(d)?c.addClass("obj-sel"):c.removeClass("obj-sel"))}else if("TH"===c.target.nodeName){c=jQuery(c.target);var d=c.data("aid"),g=c.closest("table").data("ti");switch(PData.aByID(d).def.t){case "T":case "V":case "N":case "D":c.closest("tr").find("th").removeClass("sel"),c.addClass("sel"),a.sAtts[g]=d,a.rerender(g)}}});
a.sAtts=[];for(var c=0;c<PData.eTNum();c++){var d=jQuery('#dialog-sortby select[data-ti="'+c+'"] :first').val();a.sAtts.push(d)}};
VizDirectory.prototype.render=function(a){var c=this,d=PData.eTNum(),e=0,f,g,h,m,q,p,k,n=jQuery(this.frameID);n.empty();0<this.recSel.length&&(this.recSel=[]);this.preRender();this.stream=a;for(f=a.t[0];e<d;){for(;0===f.n;){if(++e===d)return;f=a.t[e]}c.tUsed[e]=!0;f=PData.eTByN(e);f=PData.tByID(f);n.append('<div class="template-label">'+f.l+'</div><table cellspacing="0" class="viz-directory" data-ti='+e+"></table>");g=n.find('table[data-ti="'+e+'"]');h=c.settings.cnt[e];k=c.sAtts[e];p="<thead><tr>";
h.forEach(function(a){var c=PData.aByID(a);p+='<th data-aid="'+a;a===k&&(p+='" class="sel');p+='">'+c.def.l+"</th>"});g.append(p+"</tr></thead><tbody></tbody>");g=g.find("tbody");f=PData.aByID(k);f=PData.rTOrder(f,c.stream,e);f.forEach(function(a){q=PData.rByN(a.i);c.rMap[a.i>>4]|=1<<(a.i&15);p='<tr data-id="'+q.id+'" data-ai='+a.i+">";h.forEach(function(a){m=q.a[a];"undefined"!==typeof m?p=(m=PData.procAttTxt(a,m))?p+("<td>"+m+"</td>"):p+"<td></td>":p+="<td></td>"});g.append(p+"</tr>")});f=a.t[++e]}};
VizDirectory.prototype.rerender=function(a){var c=this,d,e,f,g,h,m=jQuery(this.frameID+' table.viz-directory[data-ti="'+a+'"] tbody');m.empty();tRec=this.stream.t[a];d=c.settings.cnt[a];e=PData.aByID(c.sAtts[a]);PData.rTOrder(e,c.stream,a).forEach(function(a){g=PData.rByN(a.i);h="<tr "+(c.isSel(a.i)?'class="obj-sel" ':"")+'data-id="'+g.id+'" data-ai='+a.i+">";d.forEach(function(a){f=g.a[a];"undefined"!==typeof f?h=(f=PData.procAttTxt(a,f))?h+("<td>"+f+"</td>"):h+"<td></td>":h+="<td></td>"});m.append(h+
"</tr>")})};VizDirectory.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")};
VizDirectory.prototype.doOptions=function(){for(var a=this,c=0;c<PData.eTNum();c++)jQuery('#dialog-sortby select[data-ti="'+c+'"]').val(a.sAtts[c]);var d=jQuery("#dialog-sortby").dialog({height:220,width:400,modal:!0,buttons:[{text:dlText.ok,click:function(){d.dialog("close");PState.set(PSTATE_BUILD);for(var c=0;c<PData.eTNum();c++){var f=jQuery('#dialog-sortby select[data-ti="'+c+'"]').val();if(f!==a.sAtts[c]){a.sAtts[c]=f;var g=jQuery(a.frameID+' table[data-ti="'+c+'"] thead tr');g.find("th").removeClass("sel");
g.find('th[data-aid="'+f+'"]').addClass("sel");a.rerender(c)}}PState.set(PSTATE_READY)}},{text:dlText.cancel,click:function(){d.dialog("close")}}]})};VizDirectory.prototype.setSel=function(a){var c=this,d,e;this.recSel=a;jQuery(this.frameID).find("tr").each(function(){e=jQuery(this);d=e.data("ai");null!=d&&(c.isSel(d)?e.addClass("obj-sel"):e.removeClass("obj-sel"))})};VizDirectory.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],jQuery(this.frameID).find("tr").removeClass("obj-sel"))};
VizDirectory.prototype.getState=function(){return{s:this.sAtts}};VizDirectory.prototype.setState=function(a){this.sAtts=a.s};var VizTextStream=function(a,c){PVizModel.call(this,a,c)};VizTextStream.prototype=Object.create(PVizModel.prototype);VizTextStream.prototype.constructor=VizTextStream;VizTextStream.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_LOC|V_FLAG_VSCRL};
VizTextStream.prototype.getLocAtts=function(a){return null!=a?(a=this.settings.order[a],null==a?null:[a]):_.map(this.settings.order,function(a){return[a]})};VizTextStream.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};
VizTextStream.prototype.setup=function(){var a=this;jQuery(this.frameID).on("click.vf",function(c){if("DIV"===c.target.nodeName){c=jQuery(c.target);var d=c.data("ai");"undefined"!==typeof d&&0<=d&&(a.toggleSel(d)?c.addClass("obj-sel"):c.removeClass("obj-sel"))}})};
VizTextStream.prototype.render=function(a){var c=this,d=PData.eTNum(),e=0,f,g,h,m,q,p,k,n,r,v,x,y,l,A,w,u,C,t=jQuery(this.frameID);t.empty();0<this.recSel.length&&(this.recSel=[]);this.preRender();u=this.settings.max-this.settings.min;for(g=a.t[0];e<d;){for(;0===g.n;){if(++e===d)return;g=a.t[e]}r=c.vFrame.getSelLocAtts(e);if(0!==r.length&&(r=c.vFrame.getSelFeatAtts(e),0!==r.length)){c.tUsed[e]=!0;v=c.vFrame.getSelLegend(e);x=PData.aByID(v);t.append('<div class="viz-textstream" data-ti='+e+"></div>");
h=t.find("div.viz-textstream[data-ti="+e+"]");f=PData.eTByN(e);f=PData.tByID(f);h.append('<div class="template-label">'+f.l+"</div>");n=c.settings.cnt[e];if(A=c.settings.sAtts[e])l=PData.aByID(A),"number"===typeof l.r.min&&"number"===typeof l.r.max?w=l.r.max-l.r.min:A=null;n&&(f=PData.aByID(c.settings.order[e]),f=PData.rTOrder(f,a,e),f.forEach(function(a){m=PData.rByN(a.i);q=m.a[v];"undefined"!==typeof q&&(y=PData.lRecs(q,x,r,!1))&&((p=m.a[n])&&(p=PData.procAttTxt(n,p)),p&&(c.rMap[a.i>>4]|=1<<(a.i&
15),A?(k=m.a[A],k="number"===typeof k?Math.floor((k-l.r.min)*u/w)+c.settings.min:c.settings.min):k=c.settings.min,C=y.b?";background-color:black":"",h.append('<div class="recitem" data-ai='+a.i+' style="color:'+y.v+C+";font-size:"+k+'px">'+p+"</div>")))}))}e++}};VizTextStream.prototype.teardown=function(){jQuery(this.frameID).off("click.vf")};
VizTextStream.prototype.setSel=function(a){var c=this;this.vFrame.getIndex();var d,e;this.recSel=a;jQuery(this.frameID).find("div.recitem").each(function(){e=jQuery(this);d=e.data("ai");null!=d&&(c.isSel(d)?e.addClass("obj-sel"):e.removeClass("obj-sel"))})};VizTextStream.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],jQuery(this.frameID).find("div.recitem").removeClass("obj-sel"))};VizTextStream.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}};
VizTextStream.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)};VizTextStream.prototype.hint=function(){for(var a="",c,d,e=PData.eTNum(),f=0;f<e;f++)if(c=this.settings.order[f])if(c=PData.aByID(c),d=PData.eTByN(f),d=PData.tByID(d),0<a.length&&(a+="; "),a+=d.l+": "+dlText.orderedby+" "+c.def.l,c=this.settings.sAtts[f])c=PData.aByID(c),a+=", "+dlText.textsize+" "+c.def.l;return a};var VizStackChart=function(a,c){PVizModel.call(this,a,c);this.bSel=[]};VizStackChart.prototype=Object.create(PVizModel.prototype);
VizStackChart.prototype.constructor=VizStackChart;VizStackChart.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SLGND|V_FLAG_VSCRL|V_FLAG_HSCRL};VizStackChart.prototype.getFeatureAtts=function(a){return this.settings.sAtt};
VizStackChart.prototype.setup2=function(){var a=0;this.cats.forEach(function(c){a=Math.max(a,c.l.length)});this.colW=a=Math.max(D3FG_BAR_WIDTH,8*a+4);var c=this.cats.length*a,d=this.settings.h;this.xScale=d3.scale.linear().domain([0,this.cats.length]).rangeRound([0,c]);this.yScale=d3.scale.linear().range([0,d-1]);this.rScale=d3.scale.ordinal().rangeRoundBands([0,c]);this.rScale.domain(this.cats.map(function(a){return a.l}));this.xAxis=d3.svg.axis().scale(this.rScale).orient("top");this.yAxis=d3.svg.axis().scale(this.yScale).orient("left").ticks(10);
this.svg=d3.select(this.frameID).append("svg").attr("width",c+D3SC_MARGINS.left+D3SC_MARGINS.right).attr("height",d+D3SC_MARGINS.top+D3SC_MARGINS.bottom);this.svg.append("g").attr("class","chart").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")");this.svg.append("g").attr("class","x axis").attr("transform","translate("+D3SC_MARGINS.left+","+D3SC_MARGINS.top+")").call(this.xAxis);this.svg.append("g").attr("class","y axis").attr("transform","translate("+D3SC_MARGINS.left+","+
D3SC_MARGINS.top+")")};VizStackChart.prototype.setup=function(){var a=PData.aByID(this.settings.oAtt);"g"!==a.def.t?(this.cats=this.settings.gr?PData.cRNew(a,!0,!0):PData.cLNew(a,null,!0),this.setup2()):this.cats=null};
VizStackChart.prototype.render=function(a){var c=this;this.bSel=[];var d=this.settings.oAtt,e=this.settings.sAtt;null==this.cats?(this.cats=[],PData.cFill(this.cats,d,e,a),this.setup2()):PData.cFill(this.cats,d,e,a);this.svg.selectAll(".block").remove();this.blocks=[];a=PData.aByID(e);for(var d=0,e=c.vFrame.getSelFeatAtts(0),e=PData.cLNew(a,e,!0),f=0;f<this.cats.length;f++){if(0<f)for(var g=0;g<e.length;g++)e[g].i=[];PData.cSort(c.cats[f].i,a,e);var h=0;e.forEach(function(a){0<a.i.length&&(c.blocks.push({x:f,
c:a.c,y:h,h:a.i.length,a:a.i}),h+=a.i.length)});d=Math.max(d,h)}c.yScale.domain([0,d]);c.svg.select(".y.axis").call(c.yAxis);a=c.colW-7;this.svg.selectAll(".block").data(c.blocks).enter().append("rect").attr("class","block").attr("x",function(a){return D3SC_MARGINS.left+5+c.xScale(a.x)}).attr("y",function(a){return c.yScale(a.y)+D3SC_MARGINS.top}).attr("fill",function(a){return a.c}).attr("height",function(a){return Math.max(1,c.yScale(a.h)-1)}).attr("width",a).on("click",function(a,e){var d=c.bSel.length,
k=_.sortedIndex(c.bSel,e);c.bSel[k]===e?(d3.select(this).classed("obj-sel",!1),c.bSel.splice(k,1),0<d&&0==c.bSel.length&&c.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),c.bSel.splice(k,0,e),0==d&&0<c.bSel.length&&c.vFrame.selBtns(!0))})};VizStackChart.prototype.setSel=function(a){};VizStackChart.prototype.clearSel=function(){0<this.bSel.length&&(this.bSel=[],this.svg.selectAll(".block").classed("obj-sel",!1))};
VizStackChart.prototype.getSel=function(){var a=this,c=[];this.bSel.forEach(function(d){c=PData.union(c,a.blocks[d].a)});return c};VizStackChart.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}};VizStackChart.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)};VizStackChart.prototype.hint=function(){var a=dlText.xaxis+": ",c=PData.aByID(this.settings.oAtt),a=a+(c.def.l+", "+dlText.yaxis+": "),c=PData.aByID(this.settings.sAtt);return a+=c.def.l};
var VizNetWheel=function(a,c){PVizModel.call(this,a,c);this.bSel=[]};VizNetWheel.prototype=Object.create(PVizModel.prototype);VizNetWheel.prototype.constructor=VizNetWheel;VizNetWheel.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_HSCRL};VizNetWheel.prototype.getFeatureAtts=function(a){return null!=a?this.settings.lgnds[a]:this.settings.lgnds};
VizNetWheel.prototype.setup=function(){function a(){360<c.spin?c.spin-=360:0>c.spin&&(c.spin+=360);c.center.attr("transform","translate("+c.cr+","+c.cr+")rotate("+c.spin+")")}var c=this;this.spin=0;var d=this.vFrame.getIndex(),e=_.template(document.getElementById("dltext-v-nwheel").innerHTML);jQuery("#view-frame-"+d+" div.view-controls").append(e({vi:d}));jQuery("#nw-prev-"+d).button({text:!1,icons:{primary:" ui-icon-arrowreturnthick-1-s"}}).click(function(){jQuery("#nw-size-"+d+" :radio:checked").attr("id")==
"nw-size-1-"+d?c.spin+=c.inc:c.spin+=90;a()});jQuery("#nw-for-"+d).button({text:!1,icons:{primary:" ui-icon-arrowreturnthick-1-n"}}).click(function(){jQuery("#nw-size-"+d+" :radio:checked").attr("id")=="nw-size-1-"+d?c.spin-=c.inc:c.spin-=90;a()});jQuery("#nw-size-"+d).buttonset();this.svg=d3.select(this.frameID).append("svg");this.center=this.svg.append("g")};
VizNetWheel.prototype.render=function(a){var c=this,d=[],e,f,g;this.svg.selectAll(".node").remove();this.svg.selectAll(".link").remove();this.inc=360/(a.l+a.t.length);f=Math.max((14*a.l+20)/(2*Math.PI),30);var h=this.settings.lw;"string"===typeof h&&(h=parseInt(h));this.cr=h+12+f;h=2*this.cr;this.svg.attr("width",h).attr("height",h);this.center.attr("transform","translate("+this.cr+","+this.cr+")");0<this.recSel.length&&(this.recSel=[]);this.preRender();var m={children:[]};(function(){var e,d=0,k=
0,n,r,f,g=[],h=null,l,A;e=a.t[0];A=c.vFrame.getSelLegend(0);l=PData.aByID(A);h=c.vFrame.getSelFeatAtts(0);0<h.length&&0<e.n&&(c.tUsed[0]=!0);a:for(;k<a.l;){for(;0===e.n||e.i+e.n===k||0===h.length;){0<g.length&&(m.children.push({ti:d,children:g}),g=[]);if(++d===PData.eTNum())break a;g=[];e=a.t[d];A=c.vFrame.getSelLegend(d);l=PData.aByID(A);h=c.vFrame.getSelFeatAtts(d);0<h.length&&0<e.n&&(c.tUsed[d]=!0)}f=a.s[k];n=PData.rByN(f);r=n.a[A];"undefined"!==typeof r&&(fData=PData.lRecs(r,l,h,!1))&&(c.rMap[f>>
4]|=1<<(f&15),g.push({r:n,ai:f,c:fData.v,children:[]}));k++}0<g.length&&m.children.push({ti:d,children:g})})();f=d3.layout.cluster().size([360,f]).sort(null).nodes(m);g=this.center.append("g").selectAll(".node").data(f.filter(function(a){return!a.children})).enter().append("g").attr("class","node").attr("transform",function(a){return"rotate("+(a.x-90)+")translate("+(a.y+8)+",0)"});g.append("circle").attr("r","5").style("fill",function(a){return a.c}).on("click",function(a){a=c.toggleSel(a.ai);d3.select(this).classed("obj-sel",
a)});g.append("text").attr("dy",".31em").attr("dx",function(a){return 180>a.x?"10":"-10"}).attr("transform",function(a){return 180>a.x?"":"rotate(180)"}).style("text-anchor",function(a){return 180>a.x?"start":"end"}).attr("fill","black").text(function(a){return a.r.l}).on("click",function(a){PState.set(PSTATE_UPDATE);g.each(function(a){a.linked=!1});e.each(function(c){if(c.s===a){c.t.linked=!0;for(var e=0;e<d.length;e++){var n=d[e];if(n.source===a&&n.target===c.t){d3.select(this).attr("stroke",n.c).classed("thick",
!0);this.parentElement.appendChild(this);break}}}else if(c.t===a)for(c.s.linked=!0,e=0;e<d.length;e++){if(n=d[e],n.target===a&&n.source===c.s){d3.select(this).attr("stroke",n.c).classed("thick",!0);this.parentElement.appendChild(this);break}}else d3.select(this).attr("stroke","black").classed("thick",!1)});g.select("text").attr("fill",function(a){return a.linked?"white":"black"});d3.select(this).attr("fill","yellow");PState.set(PSTATE_READY)});f=d3.layout.bundle();h=d3.svg.line.radial().interpolate("bundle").tension(.85).radius(function(a){return a.y}).angle(function(a){return a.x/
180*Math.PI});m.children.forEach(function(a){var e=c.settings.pAtts[a.ti],k;a.children.forEach(function(a){e.forEach(function(c){k=a.r.a[c.pid];"undefined"!==typeof k&&k.forEach(function(e){var k=!1,f,l=0;a:for(;l<m.children.length;l++)for(var g=m.children[l],h=0;h<g.children.length;h++)if(f=g.children[h],f.r.id==e){k=!0;break a}k&&d.push({source:a,target:f,c:c.clr})})})})});e=this.center.append("g").selectAll(".link").data(f(d)).enter().append("path").each(function(a){a.s=a[0];a.t=a[a.length-1]}).attr("class",
"link").attr("d",h).attr("stroke","black")};VizNetWheel.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-controls div.iconbar").remove()};VizNetWheel.prototype.setSel=function(a){var c=this;c.recSel=a;this.svg.selectAll(".node circle").attr("class",function(a){return c.isSel(a.ai)?"obj-sel":""})};VizNetWheel.prototype.clearSel=function(){0<this.recSel.length&&(this.recSel=[],this.svg.selectAll(".node circle").attr("class",""))};
VizNetWheel.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}};VizNetWheel.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)};var VizFlow=function(a,c){PVizModel.call(this,a,c);this.bSel=[];this.fSel=[]};VizFlow.prototype=Object.create(PVizModel.prototype);VizFlow.prototype.constructor=VizFlow;VizFlow.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL};
VizFlow.prototype.setup=function(){this.bH=Math.max(120,Math.ceil(this.settings.w/3));var a=40+(this.settings.fcts.length-1)*this.bH;this.svg=d3.select(this.frameID).append("svg").attr("width",this.settings.w+10).attr("height",a);this.barG=this.svg.append("g");this.flowG=this.svg.append("g");this.titleG=this.svg.append("g")};
VizFlow.prototype.render=function(a){var c=this;this.bSel=[];this.fSel=[];this.barG.selectAll(".bar").remove();this.flowG.selectAll(".flow").remove();this.titleG.selectAll(".att-title").remove();var d=this.settings.w;c.bars=[];c.atts=[];c.settings.fcts.forEach(function(e,f){var g,h=PData.aByID(e);g="g"!==h.def.t?c.settings.gr?PData.cRNew(h,!0,!0):PData.cLNew(h,null,!0):[];PData.cFill(g,e,null,a);var m=[],q=0;g.forEach(function(a){0<a.i.length&&(m.push(a),q+=a.i.length)});var p=0,k=31+f*c.bH;m.forEach(function(a){c.bars.push({x:5+
p*d/q,w:a.i.length*d/q,y:k,c:a});p+=a.i.length});c.atts.push({l:h.def.l,c:m,t:q,y:k})});this.barG.selectAll(".bar").data(c.bars).enter().append("rect").attr("class","bar").attr("x",function(a){return a.x}).attr("y",function(a){return a.y}).attr("fill",function(a){return a.c.c}).attr("height","8").attr("width",function(a){return a.w}).on("click",function(a,d){var g=c.bSel.length,h=_.sortedIndex(c.bSel,d);c.bSel[h]===d?(d3.select(this).classed("obj-sel",!1),c.bSel.splice(h,1),0<g&&0===c.bSel.length&&
0===c.fSel.length&&c.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),c.bSel.splice(h,0,d),0===g&&0===c.fSel.length&&0<c.bSel.length&&c.vFrame.selBtns(!0))}).append("title").text(function(a){return a.c.l+" ("+a.c.i.length+")"});c.ints=[];c.atts.forEach(function(a,f){if(f!==c.atts.length-1){for(var g=c.atts[f+1],h=Array(a.c.length),m=0;m<a.c.length;m++)h[m]=Array(g.c.length);a.c.forEach(function(a,c){g.c.forEach(function(d,e){h[c][e]=PData.intersect(a.i,d.i)})});for(var q=Array(g.c.length),
p=0;p<g.c.length;p++){for(var k=0,m=0;m<a.c.length;m++)0<h[m][p].length&&k++;q[p]=k-1}for(var n=Array(g.c.length),p=0;p<g.c.length;p++)n[p]=0;var r=0;a.c.forEach(function(k,f){for(var y=0,l=0;l<g.c.length;l++)0<h[f][l].length&&y++;--y;var p=k.i.length*d/a.t,m=0,u=0;g.c.forEach(function(l,t){var z=h[f][t];if(0<z.length){var B=z.length*d,D=B/a.t,B=B/g.t,E=l.i.length*d/g.t;c.ints.push({i:z,c:k.c,l:k.l+" > "+l.l,x1:5+r*d/a.t+(y?(p-D)*m/y:0),x2:5+u*d/g.t+(q[t]?(E-B)*n[t]/q[t]:0),w1:D,w2:B,y1:a.y+10,y2:g.y-
1});m++;n[t]++}u+=l.i.length});r+=k.i.length})}});this.flowG.selectAll(".flow").data(c.ints).enter().append("path").attr("class","flow").attr("d",function(a){return"M "+a.x1+" "+a.y1+"  L "+(a.x1+a.w1)+" "+a.y1+" L "+(a.x2+a.w2)+" "+a.y2+" L "+a.x2+" "+a.y2+" L "+a.x1+" "+a.y1}).attr("fill",function(a){return a.c}).on("click",function(a,d){var g=c.fSel.length,h=_.sortedIndex(c.fSel,d);c.fSel[h]===d?(d3.select(this).classed("obj-sel",!1),c.fSel.splice(h,1),0<g&&0===c.fSel.length&&0===c.bSel.length&&
c.vFrame.selBtns(!1)):(d3.select(this).classed("obj-sel",!0),c.fSel.splice(h,0,d),0===g&&0===c.bSel.length&&0<c.fSel.length&&c.vFrame.selBtns(!0))}).on("mouseover",function(){d3.select(this).classed("active",!0);this.parentElement.appendChild(this)}).on("mouseout",function(){d3.select(this).classed("active",!1)}).append("title").text(function(a){return a.l+" ("+a.i.length+")"});this.titleG.selectAll(".att-title").data(c.atts).enter().append("text").attr("class","att-title").attr("x","5").attr("y",
function(a){return a.y-8}).text(function(a){return a.l})};VizFlow.prototype.setSel=function(a){};VizFlow.prototype.clearSel=function(){0<this.bSel.length&&(this.bSel=[],this.svg.selectAll(".bar").classed("obj-sel",!1));0<this.fSel.length&&(this.fSel=[],this.svg.selectAll(".flow").classed("obj-sel",!1))};VizFlow.prototype.getSel=function(){var a=this,c=[];this.bSel.forEach(function(d){c=PData.union(c,a.bars[d].c.i)});this.fSel.forEach(function(d){c=PData.union(c,a.ints[d].i)});return c};
var VizBrowser=function(a,c){PVizModel.call(this,a,c);this.stream=null};VizBrowser.prototype=Object.create(PVizModel.prototype);VizBrowser.prototype.constructor=VizBrowser;VizBrowser.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL};VizBrowser.prototype.setup=function(){var a=250*this.settings.fcts.length;this.svg=d3.select(this.frameID).append("svg").attr("width",a);this.pState=null};
VizBrowser.prototype.update=function(){var a=this,c=this.vFrame.getIndex();PState.set(PSTATE_UPDATE);var d=null,e,f=!1;this.fcts.forEach(function(a){-1!=a.s&&(f=!0,e=a.c[a.s].i,d=d?PData.intersect(d,e):e)});f?this.vFrame.selBtns(0<d.length):(this.vFrame.selBtns(!1),d=this.stream.s);this.recSel=d;this.fcts.forEach(function(e){a.svg.select("#facet-"+c+"-"+e.i).selectAll(".facet-val-bar").data(e.c).transition().attr("width",function(a){return 0<d.length?242*PData.intersect(d,a.i).length/d.length:0})});
PState.set(PSTATE_READY)};
VizBrowser.prototype.render=function(a){var c=this,d=this.vFrame.getIndex();this.recSel=[];this.stream=a;this.svg.selectAll(".facet-col").remove();var e=0;this.fcts=[];this.settings.fcts.forEach(function(d,f){var g,p=PData.aByID(d);g="g"===p.def.t?[]:c.settings.gr?PData.cRNew(p,!0,!0):PData.cLNew(p,null,!0);PData.cFill(g,d,null,a);var k=[],n=0;g.forEach(function(a){0<a.i.length&&(a.n=n++,k.push(a))});c.fcts.push({c:k,x:250*f,i:f,l:p.def.l,n:p.id,s:-1});e=Math.max(e,27+22*(k.length+1))});c.svg.attr("height",
e);var f=c.svg.selectAll(".facet-col").data(c.fcts).enter().append("g").attr("transform",function(a){return"translate("+a.x+", 0)"}).attr("class","facet-col").attr("id",function(a){return"facet-"+d+"-"+a.i});f.append("rect").attr("class","facet-lbl").attr("height",24).attr("width",242);f.append("text").attr("class","facet-lbl-txt").attr("x",3).attr("y",18).attr("text-anchor","start").text(function(a){return a.l});var g;c.fcts.forEach(function(e){var f="#facet-"+d+"-"+e.i,q=null,p;null!=c.pState&&
c.pState.p.find(function(a){return e.n===a.f?(-1!==(p=e.c.findIndex(function(c){return a.v===c.l}))&&(e.s=p,q=a),!0):!1});g=c.svg.select(f).selectAll(".facet-reset").data([1]).enter().append("g").attr("transform","translate(0,26)").attr("class",function(a){return q?"facet-reset":"facet-reset inactive"}).attr("height",19).on("click",function(a){-1!==e.s&&(e.s=-1,c.svg.select(f).selectAll(".facet-val").classed("inactive",!1),d3.select(this).classed("inactive",!0),c.update())});g.append("rect").attr("class",
"facet-reset-btn").attr("height",19).attr("width",242);g.append("text").attr("class","facet-reset-txt").attr("x",3).attr("y",13).text(dlText.reset);g=c.svg.select(f).selectAll(".facet-val").data(e.c).enter().append("g").attr("transform",function(a,c){return"translate(0,"+(27+22*(c+1))+")"}).attr("class",function(a,c){return q?c===p?"facet-val":"facet-val inactive":"facet-val"}).on("click",function(a,d){var r=c.svg.select(f).select(".facet-reset");e.s!==d?(e.s=d,c.svg.select(f).selectAll(".facet-val").classed("inactive",
function(a){return d!==a.n}),r.classed("inactive",!1)):(c.svg.select(f).selectAll(".facet-val").classed("inactive",!1),e.s=-1,r.classed("inactive",!0));c.update()});g.append("rect").attr("class","facet-val-btn").attr("height",21).attr("width",242);g.append("rect").attr("class","facet-val-bar").attr("height",21).attr("width",function(c){return 0<a.l?242*c.i.length/a.l:0});g.append("text").attr("class","facet-val-txt").attr("x",3).attr("y",16).text(function(a){return a.l});g.append("text").attr("class",
"facet-val-num").attr("x",239).attr("y",16).text(function(a){return a.i.length})});null!=this.pState&&(this.update(),this.pState=null)};VizBrowser.prototype.setSel=function(a){};VizBrowser.prototype.clearSel=function(){var a=this,c=this.vFrame.getIndex();this.fcts.forEach(function(d){d.s=-1;d="#facet-"+c+"-"+d.i;a.svg.select(d).select(".facet-reset").classed("inactive",!0);a.svg.select(d).selectAll(".facet-val").classed("inactive",!1)});this.update()};VizBrowser.prototype.getSel=function(){return this.recSel};
VizBrowser.prototype.getState=function(){var a=[];this.fcts.forEach(function(c){-1!==c.s&&a.push({f:c.n,v:c.c[c.s].l})});return{p:a}};VizBrowser.prototype.setState=function(a){this.pState=a};var VizMBMap=function(a,c){PVizModel.call(this,a,c)};VizMBMap.prototype=Object.create(PVizModel.prototype);VizMBMap.prototype.constructor=VizMBMap;VizMBMap.prototype.flags=function(){return V_FLAG_VSCRL|V_FLAG_HSCRL};
VizMBMap.prototype.setup=function(){function a(){c.bkSel&&(c.bkSel.s=!1);c.clearSel()}var c=this,d=this.settings.h+40+30*this.settings.fcts.length;this.svg=d3.select(this.frameID).append("svg").attr("width",this.settings.w+10).attr("height",d);this.infoG=this.svg.append("g");this.infoG.attr("transform","translate(5,"+(3+this.settings.h)+")");this.attsG=this.svg.append("g");this.attsG.attr("transform","translate(5,"+(40+this.settings.h)+")");this.infoG.append("rect").attr("class","mbm-reset").attr("x",
"0").attr("y","8").attr("width","60").attr("height","20").attr("rx","4").attr("ry","4").on("click",a);this.infoG.append("text").attr("class","mbm-reset-text").attr("x","30").attr("y","23").text(dlText.reset).on("click",a)};VizMBMap.prototype.resetAttBars=function(){this.attsG.selectAll(".bar").transition().attr("x",function(a){return a.x0}).attr("width",function(a){return a.w0})};
VizMBMap.prototype.refreshTitles=function(){this.svg.selectAll(".mbm-title").attr("class",function(a){return a.s?"mbm-title obj-sel":"mbm-title"})};
VizMBMap.prototype.renderTree=function(a){function c(){var a=0,c=d.settings.w,g=null!==d.sbkSel?d.sbkSel.i:d.bkSel.i;PState.set(PSTATE_UPDATE);d.fcts.forEach(function(h,m){var q=[],p=0;h.c.forEach(function(a){a=PData.intersect(g,a.i);q.push(a);p+=a.length});var k=0,n;q.forEach(function(r){n=d.bars[a++];n.x=p?k*c/p:0;n.w=p?r.length*c/p:0;k+=r.length})});d.attsG.selectAll(".bar").transition().attr("x",function(a){return a.x}).attr("width",function(a){return a.w});PState.set(PSTATE_READY)}var d=this;
this.svg.selectAll(".mbm-g").remove();a=this.treemaps[a];a=this.svg.selectAll(".mbm-g").data(a,function(a){return a.id}).enter().append("g").attr("class","mbm-g").attr("transform",function(a){return"translate("+a.x+","+a.y+")"});a.append("rect").attr("class","mbm-cell").attr("width",function(a){return a.dx-1}).attr("height",function(a){return a.dy-1}).attr("rx","3").attr("ry","3").style("fill",function(a){return 2===a.depth?a.c:"#888888"}).on("click",function(a){2===a.depth&&(d.sbkSel===a?d.clearSel():
(d.svg.selectAll(".mbm-cell").classed("obj-sel",!1),d.bkSel&&(d.bkSel.s=!1),d.sbkSel=a,d3.select(this).classed("obj-sel",!0),d.infoG.select(".mbm-select").remove(),d.infoG.append("text").attr("class","mbm-select").attr("x","70").attr("y","23").text(a.l),a.p.s=!0,d.bkSel=a.p,d.refreshTitles(),c(),d.vFrame.selBtns(!0)))}).append("title").text(function(a){return a.l});a.filter(function(a){return 1===a.depth}).append("text").attr("class","mbm-title").attr("x","3").attr("y","11").text(function(a){return a.l}).on("click",
function(a){d.bkSel===a?d.clearSel():(d.svg.selectAll(".mbm-cell").classed("obj-sel",!1),d.bkSel&&(d.bkSel.s=!1),a.s=!0,d.bkSel=a,d.sbkSel=null,d.refreshTitles(),d.infoG.select(".mbm-select").remove(),d.infoG.append("text").attr("class","mbm-select").attr("x","70").attr("y","23").text(a.l+" ("+a.i.length+")"),c(),d.vFrame.selBtns(!0))})};
VizMBMap.prototype.render=function(a){var c=this;this.sbkSel=this.bkSel=null;this.attSel=0;var d=this.settings.w;this.attsG.selectAll(".bar").remove();this.attsG.selectAll(".mbm-att-title").remove();this.infoG.select(".mbm-select").remove();this.fcts=[];this.bars=[];this.settings.fcts.forEach(function(e,f){var k,n=PData.aByID(e),r=30*f;k="g"!==n.def.t?c.settings.gr?PData.cRNew(n,!0,!0):PData.cLNew(n,null,!0):[];PData.cFill(k,e,null,a);var g=[],h=0;k.forEach(function(a){0<a.i.length&&(g.push(a),h+=
a.i.length)});var y=0;g.forEach(function(a){c.bars.push({x0:y*d/h,w0:a.i.length*d/h,x:0,w:0,y:r+18,c:a});y+=a.i.length});c.fcts.push({i:f,l:n.def.l,y:r+14,c:g})});this.attsG.selectAll(".mbm-att-title").data(c.fcts).enter().append("text").attr("class",function(a,c){return 0===c?"mbm-att-title obj-sel":"mbm-att-title"}).attr("x","0").attr("y",function(a){return a.y}).text(function(a){return a.l}).on("click",function(a,d){c.attSel!=d&&(PState.set(PSTATE_UPDATE),c.attsG.selectAll(".mbm-att-title").classed("obj-sel",
!1),c.clearSel(),c.resetAttBars(),c.renderTree(d),d3.select(this).classed("obj-sel",!0),c.attSel=d,PState.set(PSTATE_READY))});this.attsG.selectAll(".bar").data(c.bars).enter().append("rect").attr("class","bar").attr("x",function(a){return a.x0}).attr("y",function(a){return a.y}).attr("fill",function(a){return a.c.c}).attr("height","8").attr("width",function(a){return a.w0}).append("title").text(function(a){return a.c.l});var e=this.settings.p,f=PData.aByID(e),g;g="g"!==f.def.t?c.settings.gr?PData.cRNew(f,
!0,!0):PData.cLNew(f,null,!0):[];PData.cFill(g,e,null,a);var h=this.vFrame.getIndex();c.trees=[];c.fcts.forEach(function(a,d){var k={z:[],id:h+"."+d};g.forEach(function(c,e){if(0<c.i.length){var f=[],g={i:c.i,l:c.l,s:!1,z:f,id:h+"."+d+"."+e};a.c.forEach(function(a,k){var m=[],m=PData.intersect(c.i,a.i);0<m.length&&f.push({i:m,p:g,c:a.c,l:c.l+" + "+a.l+" ("+m.length+")",id:h+"."+d+"."+e+"."+k})});k.z.push(g)}});c.trees.push(k)});var m=d3.layout.treemap().padding([14,3,3,3]).size([d,this.settings.h]).round(!0).children(function(a,
c){return 2===c?null:a.z}).value(function(a){return a.i.length});c.treemaps=[];c.trees.forEach(function(a){c.treemaps.push(m.nodes(a))});c.renderTree(0)};VizMBMap.prototype.setSel=function(a){};VizMBMap.prototype.clearSel=function(){this.bkSel&&(this.bkSel.s=!1);this.infoG.select(".mbm-select").remove();this.sbkSel=this.bkSel=null;this.svg.selectAll(".mbm-cell").classed("obj-sel",!1);this.svg.selectAll(".mbm-title").classed("obj-sel",!1);this.resetAttBars();this.vFrame.selBtns(!1)};
VizMBMap.prototype.getSel=function(){return null!==this.sbkSel?this.sbkSel.i:null!==this.bkSel?this.bkSel.i:[]};VizMBMap.prototype.hint=function(){var a=PData.aByID(this.settings.p);return dlText.grpblks+" "+a.def.l};function PFilterModel(a,c){this.id=a;this.att=c;this.dirty=!0}PFilterModel.prototype.isDirty=function(a){null!=a&&(!this.dirty&&a&&0<this.id&&jQuery("body").trigger("prospect",{s:PSTATE_FDIRTY}),this.dirty=a);return this.dirty};PFilterModel.prototype.title=function(){return this.att.def.l};
PFilterModel.prototype.evalPrep=function(){};PFilterModel.prototype.evalDone=function(){};PFilterModel.prototype.insertPt=function(){return jQuery('div.filter-instance[data-id="'+this.id+'"] div.filter-body')};PFilterModel.prototype.teardown=function(){};PFilterModel.prototype.getState=function(){return{}};PFilterModel.prototype.setState=function(a){};var PFilterRemove=function(a){PFilterModel.call(this,a,null)};PFilterRemove.prototype=Object.create(PFilterModel.prototype);
PFilterRemove.prototype.constructor=PFilterRemove;PFilterRemove.prototype.title=function(){return dlText.rha};PFilterRemove.prototype.eval=function(a){return!1};PFilterRemove.prototype.setup=function(){var a=this.insertPt(),c=document.getElementById("dltext-filter-remove").innerHTML;a.append(c)};var PFilterText=function(a,c){PFilterModel.call(this,a,c)};PFilterText.prototype=Object.create(PFilterModel.prototype);PFilterText.prototype.constructor=PFilterText;
PFilterText.prototype.evalPrep=function(){var a=this.insertPt();this.cs=a.find("input.filter-text-cs").prop("checked");this.s=a.find("input.filter-text").val();this.cs||(this.s=this.s.toLocaleLowerCase())};PFilterText.prototype.eval=function(a){var c=this.s;if(null==c||""===c)return!0;a=a.a[this.att.id];if("undefined"===typeof a)return!1;this.cs||(a=a.toLocaleLowerCase());return-1!==a.indexOf(c)};
PFilterText.prototype.setup=function(){var a=this,c=this.insertPt(),d=document.getElementById("dltext-filter-text").innerHTML;c.append(d);c.find("input.filter-text").change(function(){a.isDirty(!0)});c.find("input.filter-text-cs").click(function(c){a.isDirty(!0)})};PFilterText.prototype.getState=function(){var a=this.insertPt();return{cs:a.find("input.filter-text-cs").prop("checked"),t:a.find("input.filter-text").val()}};
PFilterText.prototype.setState=function(a){var c=this.insertPt();c.find("input.filter-text-cs").prop("checked",a.cs);c.find("input.filter-text").val(a.t)};var PFilterTags=function(a,c){PFilterModel.call(this,a,c)};PFilterTags.prototype=Object.create(PFilterModel.prototype);PFilterTags.prototype.constructor=PFilterTags;PFilterTags.prototype.evalPrep=function(){var a=this.insertPt();this.cs=a.find("input.filter-text-cs").prop("checked");this.s=a.find("input.filter-text").val();this.cs||(this.s=this.s.toLocaleLowerCase())};
PFilterTags.prototype.eval=function(a){var c=this.s;if(null==c||""===c)return!0;a=a.a[this.att.id];if("undefined"===typeof a)return!1;for(var d=0;d<a.length;d++){var e=a[d];this.cs||(e=e.toLocaleLowerCase());if(e===c)return!0}return!1};PFilterTags.prototype.setup=function(){var a=this,c=this.insertPt(),d=document.getElementById("dltext-filter-tags").innerHTML;c.append(d);c.find("input.filter-text").change(function(){a.isDirty(!0)});c.find("input.filter-text-cs").click(function(c){a.isDirty(!0)})};
PFilterTags.prototype.getState=function(){var a=this.insertPt();return{cs:a.find("input.filter-text-cs").prop("checked"),t:a.find("input.filter-text").val()}};PFilterTags.prototype.setState=function(a){var c=this.insertPt();c.find("input.filter-text-cs").prop("checked",a.cs);c.find("input.filter-text").val(a.t)};var PFilterVocab=function(a,c){PFilterModel.call(this,a,c)};PFilterVocab.prototype=Object.create(PFilterModel.prototype);PFilterVocab.prototype.constructor=PFilterVocab;
PFilterVocab.prototype.evalPrep=function(){var a=this;this.sel=[];this.insertPt().find("div.filter-vocab-row input:checked").each(function(){var c=jQuery(this).parent().data("id");c&&a.sel.push(c)});this.sel.sort();this.ctrs=new Uint16Array(this.sel.length);for(var c=0;c<this.sel.length;c++)this.ctrs[c]=0};
PFilterVocab.prototype.eval=function(a){if(0===this.sel.length)return!1;a=a.a[this.att.id];if("undefined"===typeof a)return!1;for(var c,d,e=0;e<a.length;e++)if(d=a[e],c=_.sortedIndex(this.sel,d),this.sel[c]===d)return this.ctrs[c]++,!0;return!1};PFilterVocab.prototype.evalDone=function(a){var c=this,d,e,f,g;this.insertPt().find("div.filter-vocab-row").each(function(){g=jQuery(this);if(d=g.data("id"))e=_.sortedIndex(c.sel,d),f=c.sel[e]===d?0<a?Math.round(100*c.ctrs[e]/a):0:0,g.next().width(f+"%")})};
PFilterVocab.prototype.setup=function(){var a=this,c='<div class="filter-vocab-container"><div class="filter-vocab-hsa"><input type="checkbox" checked="checked" data-index=-1><i> '+dlText.sha+"</i></div>";this.att.l.forEach(function(a,d){c+='<div class="filter-vocab-entry" data-index="'+d+'"><div class="filter-vocab-row" data-id="'+a.l+'"><input type="checkbox" class="term-parent" checked="checked">'+a.l+'</div><div class="filter-vocab-bar" style="background-color:'+a.v+'"></div>';a.z.forEach(function(g,
h){c+='<div class="filter-vocab-row" data-id="'+g.l+'"><input type="checkbox" data-parent="'+d+'" checked="checked">'+g.l+"</div>";c=null==g.v||""===g.v?c+('<div class="filter-vocab-bar" style="background-color:'+a.v+'"></div>'):c+('<div class="filter-vocab-bar" style="background-color:'+g.v+'"></div>')});c+="</div>"});var d=this.insertPt();d.append(c+"</div>");d.click(function(c){var f=c.target;"INPUT"===f.nodeName&&("undefined"!==typeof f.dataset.index&&-1==f.dataset.index?(c=f.checked,d.find("div.filter-vocab-row input").prop("checked",
c)):"term-parent"===c.target.className&&f.checked&&d.find('input[data-parent="'+c.target.parentElement.parentElement.dataset.index+'"]').prop("checked",!0),a.isDirty(!0))})};PFilterVocab.prototype.getState=function(){var a=[];this.insertPt().find("div.filter-vocab-row input:checked").each(function(){var c=jQuery(this).parent().data("id");c&&a.push(c)});a.sort();return{s:a}};
PFilterVocab.prototype.setState=function(a){this.insertPt().find("div.filter-vocab-row").each(function(){var c=jQuery(this),d=c.data("id"),d=_.indexOf(a.s,d,!0);c.find("input").prop("checked",-1!==d)})};var PFilterNum=function(a,c){PFilterModel.call(this,a,c)};PFilterNum.prototype=Object.create(PFilterModel.prototype);PFilterNum.prototype.constructor=PFilterNum;
PFilterNum.prototype.refreshBoxes=function(){var a=this.insertPt();a.find(".from").removeClass("error").val(this.min);a.find(".to").removeClass("error").val(this.max);a.find(".filter-update").prop("disabled",!0)};
PFilterNum.prototype.evalBoxes=function(a){function c(c,h){function k(){n=!0;a.find(c).addClass("error")}var n=!1,r,v=a.find(c).val();(v=e.exec(v))?(a.find(c).removeClass("error"),r=parseInt(v[1],10)):k();n||(0==h?null!==f&&r<f&&k():null!==g&&r>g&&k());d.uNums[h]=r;return n}var d=this,e=/^(\d+)$/,f="undefined"===typeof this.att.r.min?null:this.att.r.min,g="undefined"===typeof this.att.r.max?null:this.att.r.max,h,m;h=c(".from",0);m=c(".to",1);this.uNums[0]>this.uNums[1]&&(m=!0);a.find(".filter-update").prop("disabled",
h||m);return!(h||m)};PFilterNum.prototype.useBoxes=function(a){if(this.evalBoxes(a)){this.isDirty(!0);this.min=this.uNums[0];this.max=this.uNums[1];if(null!==this.rCats){var c,d;for(c=0;c<this.rCats.length&&!(this.min<=this.rCats[c].max);c++);for(d=c;d<this.rCats.length&&!(this.max<=this.rCats[d].max);d++);d=d===this.rCats.length?this.rCats.length-1:d;this.b0=c;this.b1=d;this.brushg.call(this.brush.extent([c,d+1]))}a.find(".filter-update").prop("disabled",!0)}};
PFilterNum.prototype.evalPrep=function(){if(null!==this.rCats)for(var a=0;a<this.rCats.length;a++)this.ctrs[a]=0};PFilterNum.prototype.eval=function(a){a=a.a[this.att.id];if("undefined"===typeof a)return!1;if("?"===a)return this.u;if(a<this.min||a>this.max)return!1;if(null===this.rCats)return!0;for(var c,d=this.b0;d<=this.b1;d++)if(c=this.rCats[d],c.min<=a&&a<=c.max){this.ctrs[d]++;break}return!0};
PFilterNum.prototype.evalDone=function(a){if(null!==this.rCats){for(var c=this,d=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,e=new Uint16Array(this.ctrs.length),f=0;f<this.ctrs.length;f++)e[f]=0<a?Math.round(100*this.ctrs[f]/a):0;this.chart.selectAll(".bar").transition().duration(500).attr("height",function(a,f){return d-c.yScale(e[f])}).attr("y",function(a,d){return c.yScale(e[d])})}};
PFilterNum.prototype.setup=function(){var a=this;this.u=!1;this.uNums=Array(2);var c=this.insertPt();c.append(document.getElementById("dltext-filter-nums").innerHTML);"undefined"===typeof this.att.r.u?c.find(".allow-undef").prop("disabled",!0):c.find(".allow-undef").click(function(){a.u=c.find("input.allow-undef").prop("checked");a.isDirty(!0)});this.rCats=PData.cRNew(this.att,!1,!1);if(null!==this.rCats){this.ctrs=new Uint16Array(this.rCats.length);this.b0=0;this.b1=this.rCats.length-1;this.min=
this.rCats[0].min;this.max=this.rCats[this.b1].max;var d=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,e=0;this.rCats.forEach(function(a){e=Math.max(e,a.l.length)});var e=Math.max(D3FG_BAR_WIDTH,7*e),f=this.rCats.length*e,g=d3.scale.linear().domain([0,this.rCats.length]).rangeRound([0,f]),h=d3.scale.linear().domain([0,100]).range([d,0]);this.yScale=h;var m=d3.scale.ordinal().rangeRoundBands([0,f]);m.domain(this.rCats.map(function(a){return a.l}));var m=d3.svg.axis().scale(m).orient("bottom"),q=d3.svg.axis().scale(h).orient("left").ticks(4);
this.chart=f=d3.select(c.get(0)).append("svg").attr("width",f+D3FG_MARGINS.left+D3FG_MARGINS.right).attr("height",d+D3FG_MARGINS.top+D3FG_MARGINS.bottom).append("g").attr("transform","translate("+D3FG_MARGINS.left+","+D3FG_MARGINS.top+")");f.append("g").attr("class","x axis").attr("transform","translate(0,"+d+")").call(m);f.append("g").attr("class","y axis").call(q);f.selectAll(".bar").data(this.rCats).enter().append("rect").attr("class","bar").attr("x",function(a,c){return g(c)+2}).attr("y",function(a){return h(100)}).attr("fill",
function(a){return a.c}).attr("height",function(a){return d-h(100)}).attr("width",e-4);a.brush=d3.svg.brush().x(g).extent([0,this.rCats.length]).on("brushend",function(){if(d3.event.sourceEvent){var c=a.brush.extent(),d=[Math.floor(c[0]),Math.floor(c[1])];d[0]>=d[1]&&(d[0]=Math.floor(c[0]),d[1]=Math.ceil(c[1]));d[1]=Math.max(d[1],d[0]+1);d3.select(this).transition().call(a.brush.extent(d));a.b0=d[0];a.b1=d[1]-1;a.min=a.rCats[a.b0].min;a.max=a.rCats[a.b1].max;a.refreshBoxes();a.isDirty(!0)}});a.brushg=
f.append("g");a.brushg.attr("class","brush").call(a.brush);a.brushg.selectAll("rect").attr("y",-1).attr("height",d+4);a.brushg.selectAll(".resize").append("path").attr("d",function(a){var c=(a=+("e"==a))?1:-1,e=d/4;return"M"+.5*c+","+e+"A6,6 0 0 "+a+" "+6.5*c+","+(e+6)+"V"+(2*e-6)+"A6,6 0 0 "+a+" "+.5*c+","+2*e+"ZM"+2.5*c+","+(e+8)+"V"+(2*e-8)+"M"+4.5*c+","+(e+8)+"V"+(2*e-8)})}else this.min="undefined"===typeof att.r.min?0:att.r.min,this.max="undefined"===typeof att.r.max?100:att.r.max;this.refreshBoxes();
c.find("input[type=text]").change(function(){a.evalBoxes(c)});c.find(".filter-update").click(function(){a.useBoxes(c)})};PFilterNum.prototype.getState=function(){return{min:this.min,max:this.max,u:this.u}};PFilterNum.prototype.setState=function(a){var c=this.insertPt();c.find("input.allow-undef").prop("checked",a.u);this.u=a.u;c.find(".from").removeClass("error").val(a.min);c.find(".to").removeClass("error").val(a.max);this.useBoxes(c)};
var PFilterDates=function(a,c,d){PFilterModel.call(this,a,c,d)};PFilterDates.prototype=Object.create(PFilterModel.prototype);PFilterDates.prototype.constructor=PFilterDates;
PFilterDates.prototype.refreshBoxes=function(){function a(a,e){var f=a.getUTCFullYear(),g=a.getUTCMonth()+1,h=a.getUTCDate();c.find(e+"-y").removeClass("error").val(f);c.find(e+"-m").removeClass("error").val(g);c.find(e+"-d").removeClass("error").val(h)}var c=this.insertPt();a(this.min,".from");a(this.max,".to");c.find(".filter-update").prop("disabled",!0)};
PFilterDates.prototype.evalBoxes=function(a){function c(c,g){function h(d){n=!0;a.find(c+d).addClass("error")}function k(d){a.find(c+d).removeClass("error")}var n=!1,r={y:0,m:0,d:0,ms:null},v=a.find(c+"-y"),v=v.val();(v=e.exec(v))?(k("-y"),r.y=parseInt(v[1],10)):h("-y");v=a.find(c+"-m");v=v.val();(v=f.exec(v))?(r.m=parseInt(v[1],10),1>r.m||12<r.m?h("-m"):k("-m")):h("-m");v=a.find(c+"-d");v=v.val();(v=f.exec(v))?(r.d=parseInt(v[1],10),1>r.d||31<r.d?h("-d"):k("-d")):h("-d");n||(r.ms=PData.d3Nums(r.y,
r.m,r.d,!1),0==g?r.ms<d.rCats[0].min&&(h("-y"),h("-m"),h("-d")):r.ms>d.rCats[d.rCats.length-1].max&&(h("-y"),h("-m"),h("-d")));d.uDates[g]=r;return n}var d=this,e=/^(-?\d+)$/,f=/^(\d{1,2})$/,g,h;g=c(".from",0);h=c(".to",1);this.uDates[0].ms>this.uDates[1].ms&&(h=!0);a.find(".filter-update").prop("disabled",g||h);return!(g||h)};
PFilterDates.prototype.useBoxes=function(a){if(this.evalBoxes(a)){this.isDirty(!0);this.min=this.uDates[0].ms;var c=this.uDates[1].ms;c.setTime(c.getTime()+10);this.max=c;for(var d,c=0;c<this.rCats.length&&!(this.min<this.rCats[c].max);c++);for(d=c;d<this.rCats.length&&!(this.max<=this.rCats[d].max);d++);d=d===this.rCats.length?this.rCats.length-1:d;this.b0=c;this.b1=d;this.brushg.call(this.brush.extent([c,d+1]));a.find(".filter-update").prop("disabled",!0)}};
PFilterDates.prototype.evalPrep=function(){this.c=jQuery("input[name=dctrl-"+this.id+"]:checked").val();for(var a=0;a<this.rCats.length;a++)this.ctrs[a]=0};
PFilterDates.prototype.eval=function(a){function c(a,c,d,e,q){"undefined"!=typeof e.m&&(c=e.m,"undefined"!=typeof e.d&&(d=e.d));return PData.d3Nums(a,c,d,q)}var d=a.a[this.att.id];if("undefined"===typeof d)return!1;if("?"===d)return this.u;if("undefined"===typeof d.max){if(a=c(d.min.y,1,1,d.min,!1),a<this.min||a>=this.max)return!1}else if(a=c(d.min.y,1,1,d.min,!1),d="open"===d.max?TODAY:c(d.max.y,12,31,d.max,!0),"o"===this.c){if(d<this.min||a>=this.max)return!1}else if(this.min>a||d>this.max)return!1;
for(var e=this.b0;e<=this.b1;e++)if(d=this.rCats[e],d.min<=a&&a<d.max){this.ctrs[e]++;break}return!0};PFilterDates.prototype.evalDone=function(a){for(var c=this,d=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,e=new Uint16Array(this.ctrs.length),f=0;f<this.ctrs.length;f++)e[f]=0<a?Math.round(100*this.ctrs[f]/a):0;this.chart.selectAll(".bar").transition().duration(500).attr("height",function(a,f){return d-c.yScale(e[f])}).attr("y",function(a,d){return c.yScale(e[d])})};
PFilterDates.prototype.setup=function(){var a=this;this.rCats=PData.cRNew(this.att,!1,!1);this.ctrs=new Uint16Array(this.rCats.length);this.b0=0;this.b1=this.rCats.length-1;this.u=!1;this.min=this.rCats[0].min;this.max=this.rCats[this.b1].max;this.uDates=Array(2);var c=80-D3FG_MARGINS.top-D3FG_MARGINS.bottom,d=this.insertPt(),e=0;this.rCats.forEach(function(a){e=Math.max(e,a.l.length)});var e=Math.max(D3FG_BAR_WIDTH,7*e),f=this.rCats.length*e,g=d3.scale.linear().domain([0,this.rCats.length]).rangeRound([0,
f]),h=d3.scale.linear().domain([0,100]).range([c,0]);this.yScale=h;var m=d3.scale.ordinal().rangeRoundBands([0,f]);m.domain(this.rCats.map(function(a){return a.l}));var m=d3.svg.axis().scale(m).orient("bottom"),q=d3.svg.axis().scale(h).orient("left").ticks(4),p=_.template(document.getElementById("dltext-filter-dates").innerHTML);d.append(p({id:this.id}));d.find("input[name=dctrl-"+a.id+"]").change(function(){a.isDirty(!0)});"undefined"===typeof this.att.r.u?d.find(".allow-undef").prop("disabled",
!0):d.find(".allow-undef").click(function(){a.u=d.find("input.allow-undef").prop("checked");a.isDirty(!0)});this.refreshBoxes();d.find("input[type=text]").change(function(){a.evalBoxes(d)});d.find(".filter-update").click(function(){a.useBoxes(d)});this.chart=f=d3.select(d.get(0)).append("svg").attr("width",f+D3FG_MARGINS.left+D3FG_MARGINS.right).attr("height",c+D3FG_MARGINS.top+D3FG_MARGINS.bottom).append("g").attr("transform","translate("+D3FG_MARGINS.left+","+D3FG_MARGINS.top+")");f.append("g").attr("class",
"x axis").attr("transform","translate(0,"+c+")").call(m);f.append("g").attr("class","y axis").call(q);f.selectAll(".bar").data(this.rCats).enter().append("rect").attr("class","bar").attr("x",function(a,c){return g(c)+2}).attr("y",function(a){return h(100)}).attr("fill",function(a){return a.c}).attr("height",function(a){return c-h(100)}).attr("width",e-4);a.brush=d3.svg.brush().x(g).extent([0,this.rCats.length]).on("brushend",function(){if(d3.event.sourceEvent){var c=a.brush.extent(),d=[Math.floor(c[0]),
Math.floor(c[1])];d[0]>=d[1]&&(d[0]=Math.floor(c[0]),d[1]=Math.ceil(c[1]));d[1]=Math.max(d[1],d[0]+1);d3.select(this).transition().call(a.brush.extent(d));a.b0=d[0];a.b1=d[1]-1;a.min=a.rCats[a.b0].min;a.max=a.rCats[a.b1].max;a.refreshBoxes();a.isDirty(!0)}});a.brushg=f.append("g");a.brushg.attr("class","brush").call(a.brush);a.brushg.selectAll("rect").attr("y",-1).attr("height",c+4);a.brushg.selectAll(".resize").append("path").attr("d",function(a){var d=(a=+("e"==a))?1:-1,e=c/4;return"M"+.5*d+","+
e+"A6,6 0 0 "+a+" "+6.5*d+","+(e+6)+"V"+(2*e-6)+"A6,6 0 0 "+a+" "+.5*d+","+2*e+"ZM"+2.5*d+","+(e+8)+"V"+(2*e-8)+"M"+4.5*d+","+(e+8)+"V"+(2*e-8)})};PFilterDates.prototype.getState=function(){function a(a){return a.getUTCFullYear()+"-"+(a.getUTCMonth()+1)+"-"+a.getUTCDate()}var c=jQuery("input[name=dctrl-"+this.id+"]:checked").val();return{min:a(this.min),max:a(this.max),c:c,u:this.u}};
PFilterDates.prototype.setState=function(a){function c(a,c){var g=c.split("-"),h=0;4===g.length?(d.find(a+"-y").removeClass("error").val("-"+g[1]),h=1):d.find(a+"-y").removeClass("error").val(g[0]);d.find(a+"-m").removeClass("error").val(g[++h]);d.find(a+"-d").removeClass("error").val(g[++h])}var d=this.insertPt();jQuery('input[name="dctrl-'+this.id+'"]').val([a.c]);d.find("input.allow-undef").prop("checked",a.u);this.u=a.u;c(".from",a.min);c(".to",a.max);this.useBoxes(d)};
function PViewFrame(a){function c(a){a!==C&&(C=a,jQuery(d()+" div.lgnd-container div.lgnd-handle button.lgnd-update").prop("disabled",!a))}function d(){return"#view-frame-"+a}function e(a){a=jQuery(d()+" div.view-controls select.view-viz-select option:selected").val();PState.set(PSTATE_BUILD);y(a,!0);PState.set(PSTATE_READY)}function f(a){w.flags()&V_FLAG_LGND&&jQuery(d()+" div.lgnd-container").toggle("slide",{direction:"left"});a.preventDefault()}function g(a){function c(a){return a.replace(/^[ \f\t\v\u200b]+|[ \f\t\v\u200b]+$/g,
"")}function d(a){var c=new Number,e=parseTC.exec(a);if(null!==e)c=1E3*(3600*parseInt(e[1])+60*parseInt(e[2])+parseFloat(e[3])),c=1==e[4].length?c+100*parseInt(e[4]):c+10*parseInt(e[4]);else throw Error("Error in transcript file: Cannot parse "+a+" as timecode.");return c}function e(a,d){var k=new String(a),k=c(k).split(/\r\n|\r|\n/g),f=[];if(k){var n,l=0;_.each(k,function(a){a=c(a);0<a.length&&("["===a.charAt(0)?(0<l&&f.push(n),n=""):(0<n.length&&(n+="<br/>"),n+=a),l++)})}_.each(f,function(a,c){d.find('div.timecode[data-tcindex="'+
c+'"]').next().after('<div class="xscript">'+a+"</div>")})}function k(a){widgetData.tcArray=[];widgetData.tcIndex=-1;var f=widgetData.tcArray;a=new String(a);if(a=c(a).split(/\r\n|\r|\n/g)){var n=jQuery("#xscript-tbl"),l=0,r,g=0,v=0,h="";_.each(a,function(a){a=c(a);1<a.length&&("["===a.charAt(0)&&"0"<=a.charAt(1)&&"9">=a.charAt(1)?(r=d(a),0<h.length&&(v&&f.push({s:g,e:r}),n.append('<div class="row"><div class="timecode" data-timecode="'+g+'" data-tcindex="'+l++ +'">'+v+'</div><div class="xscript">'+
h+"</div></div>"),h=""),v=a,g=r):(0<h.length&&(h+="<br/>"),h+=a))});0<h.length&&(f.push({s:g,e:324E5}),n.append('<div class="row"><div class="timecode" data-timecode="'+g+'" data-tcindex="'+l+'">'+v+'</div><div class="xscript">'+h+"</div></div>"));"undefined"!==typeof C&&null!=C&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:C,excerpt:widgetData.extract},success:function(a,c,d){e(JSON.parse(a),n)},error:function(a,c,d){alert(d)}})}}function f(a){var c,
d=widgetData.tcIndex;_.find(widgetData.tcArray,function(e,k){if((c=e.s<=a&&a<e.e)&&k!=d){var f=jQuery("#xscript-tbl");if(document.getElementById("sync-xscript").checked){var n=f.find('[data-tcindex="'+k+'"]').offset().top-f.offset().top,n=f.scrollTop()+n;f.animate({scrollTop:n},300)}-1!=d&&f.find('[data-tcindex="'+d+'"]').removeClass("current");f.find('[data-tcindex="'+k+'"]').addClass("current");widgetData.tcIndex=k}return c})}function n(){widgetData.widget=new YT.Player("yt-widget",{width:p-40,
height:Math.floor(9*(p-40)/16),videoId:widgetData.ytCode,events:{onError:function(a){console.log("YouTube Error: "+a.data)},onStateChange:function(a){var c;switch(a.data){case 1:widgetData.playing=!0;null==widgetData.timer&&(widgetData.timer=setInterval(function(){c=1E3*widgetData.widget.getCurrentTime();widgetData.playing&&widgetData.xscriptOn&&f(c)},300));break;case 0:case 2:widgetData.playing=!1;window.clearInterval(widgetData.timer);widgetData.timer=null;break;case 3:case 5:widgetData.playing=
!1}},onReady:function(){widgetData.extract&&widgetData.widget.cueVideoById({videoId:widgetData.ytCode,startSeconds:widgetData.sTime/1E3,endSeconds:widgetData.eTime/1E3})}}})}function l(){widgetData.playing=!0}function r(){widgetData.playing=!1}function g(){widgetData.playing&&widgetData.xscriptOn&&f(1E3*widgetData.widget.currentTime)}function v(){switch(q){case 3:null!=widgetData.widget&&(widgetData.widget.removeEventListener("ended",r),widgetData.widget.removeEventListener("pause",r),widgetData.widget.removeEventListener("playing",
l),widgetData.widget.removeEventListener("timeupdate",g));case 1:null!=widgetData.widget&&widgetData.playing&&widgetData.widget.pause();widgetData.playing=!1;widgetData.widget=null;break;case 2:widgetData.ytCall=null,null!=widgetData.widget&&widgetData.playing&&widgetData.widget.stopVideo(),widgetData.widget=null,widgetData.playing=!1,null!=widgetData.timer&&(window.clearInterval(widgetData.timer),widgetData.timer=null)}}function x(){function a(){widgetData.sTime=widgetData.eTime=null;var c;(c=prspdata.e.i.t.tcAtts[h])&&
(c=H.a[c])&&""!==c&&(widgetData.extract=c,c=c.split("-"),widgetData.sTime=d(c[0]),widgetData.eTime=d(c[1]))}var c=J[M];H=PData.rByN(c);var e=" "+H.l+" ("+(M+1)+"/"+J.length+") ",v=jQuery("#inspect-name");v.text(e);v.prop("title",H.id);var h=PData.n2T(c);u.empty();t=null;q=0;widgetData.extract=null;widgetData.xscriptOn=!1;widgetData.playing=!1;if(prspdata.e.i.modal.scOn||"boolean"===typeof prspdata.e.i.modal.aOn&&prspdata.e.i.modal.aOn)if(t=prspdata.e.i.sc.atts[h])if(e=H.a[t])if(a(),e.match(/soundcloud\.com/)){var y=
!0;q=1;u.append('<iframe id="sc-widget" class="player" width="100%" height="110" src="http://w.soundcloud.com/player/?url='+e+'"></iframe>');var z=SC.Widget(document.getElementById("sc-widget"));widgetData.widget=z;z.bind(SC.Widget.Events.READY,function(){z.play();z.bind(SC.Widget.Events.PLAY,function(){widgetData.playing=!0});z.bind(SC.Widget.Events.PAUSE,function(){widgetData.playing=!1});z.bind(SC.Widget.Events.PLAY_PROGRESS,function(a){y&&(z.pause(),y=!1,widgetData.playing=!1);widgetData.extract&&
(a.currentPosition<widgetData.sTime?z.seekTo(widgetData.sTime):a.currentPosition>widgetData.eTime&&(z.pause(),widgetData.playing=!1));widgetData.playing&&widgetData.xscriptOn&&f(a.currentPosition)});z.bind(SC.Widget.Events.FINISH,function(){widgetData.playing=!1})})}else q=3,widgetData.extract&&(v=widgetData.extract.split("-"),e+="#t="+v[0]+","+v[1]),u.append('<audio id="na-widget" controls src="'+e+'"></audio>'),widgetData.widget=document.getElementById("na-widget"),widgetData.widget.addEventListener("ended",
r),widgetData.widget.addEventListener("pause",r),widgetData.widget.addEventListener("playing",l),widgetData.widget.addEventListener("timeupdate",g);0===q&&prspdata.e.i.modal.ytOn&&(t=prspdata.e.i.yt.atts[h])&&(e=H.a[t])&&(a(),widgetData.ytCode=e,u.append('<div id="yt-widget"></div>'),widgetData.ytCall=n,widgetData.ytLoaded?n():(widgetData.ytLoaded=!0,e=document.createElement("script"),e.src="https://www.youtube.com/iframe_api",v=document.getElementsByTagName("script")[0],v.parentNode.insertBefore(e,
v)),q=2);prspdata.e.i.modal.tOn&&(e=prspdata.e.i.t.t1Atts[h])&&""!==e&&"disable"!==e&&(e=H.a[e],"string"===typeof e&&""!==e&&(0<q&&u.append("<div>"+document.getElementById("dltext-sync-xscript").innerHTML+"</div>"),u.find("#xscript-tbl").remove(),u.append('<div id="xscript-tbl"><div>'),widgetData.xscriptOn=!0,jQuery("#xscript-tbl").click(function(a){if(q&&jQuery(a.target).hasClass("timecode"))switch(a=jQuery(a.target).data("timecode"),q){case 1:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play());
widgetData.widget.seekTo(a);break;case 2:widgetData.playing||(widgetData.playing=!0,widgetData.widget.playVideo());widgetData.widget.seekTo(a/1E3);break;case 3:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play()),widgetData.widget.currentTime=a/1E3}}),C=null,(v=prspdata.e.i.t.t2Atts[h])&&""!==v&&"disable"!==v&&(C=H.a[v]),jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:e,excerpt:widgetData.extract},success:function(a,c,d){k(JSON.parse(a))},
error:function(a,c,d){alert(d)}})));prspdata.e.i.modal.atts[h].forEach(function(a){var d=PData.rAV(c,a,!1);if(d){a=PData.aByID(a);var e;"_"==a.def.l.charAt(0)?e="<div>"+d+"</div>":(e='<div><span class="att-label">'+a.def.l+":</span> ","I"==a.def.t&&(e+="<br/>"),e+=d+"</div>");u.append(e)}})}function y(a){a=M+a;-1==a?a=J.length-1:a==J.length&&(a=0);a!=M&&(M=a,v(),x())}function m(a){y(-1)}function A(a){y(1)}var u=jQuery("#inspect-content"),t=null,q=0,C,p=450,N=400,J=null;w&&(J=w.getSel());if(null!=
J&&0!=J.length){var O,H,M=0;prspdata.e.i.modal.scOn&&(p=550);prspdata.e.i.modal.ytOn&&(p=Math.max(p,475),N=500);prspdata.e.i.modal.tOn&&(N+=100,prspdata.e.i.modal.t2On?(p=Math.max(750,Math.floor(.8*jQuery(document).width())),p=Math.min(900,p)):p=Math.max(p,550));"number"===typeof prspdata.e.i.modal.w&&(p=prspdata.e.i.modal.w);"number"===typeof prspdata.e.i.modal.h&&(N=prspdata.e.i.modal.h);h(!1);x();jQuery("#btn-inspect-left").click(m);jQuery("#btn-inspect-right").click(A);O=jQuery("#dialog-inspector").dialog({width:p,
height:N,modal:!0,buttons:[{text:dlText.seerec,click:function(){window.open(prspdata.site_url+"?p="+H.wp,"_blank")}},{text:dlText.close,click:function(){O.dialog("close")}}]});O.on("dialogclose",function(a,c){v();jQuery("#btn-inspect-left").off("click");jQuery("#btn-inspect-right").off("click");h(!0);O.off("dialogclose")});a.preventDefault()}}function h(a){var c=jQuery(d()+" div.view-controls");a?(c.find(".osel").button("enable"),c.find(".osel").addClass("pulse"),c.find(".xsel").button("enable")):
(c.find(".osel").button("disable"),c.find(".osel").removeClass("pulse"),c.find(".xsel").button("disable"))}function m(c){jQuery("body").trigger("prospect",{s:PSTATE_HILITE,v:a,t:w.tUsed});c.preventDefault()}function q(a){PState.set(PSTATE_UPDATE);w&&w.clearSel();h(!1);PState.set(PSTATE_READY);a.preventDefault()}function p(a){w&&w.doOptions();a.preventDefault()}function k(a){var c=jQuery("#dialog-vnotes").dialog({width:300,height:300,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close")}}]});
a.preventDefault()}function n(a,e){jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",e);c(!0)}function r(a){var e=jQuery(a.target).closest("div.lgnd-template").data("index"),k=a.target.className;switch(k){case "lgnd-update":w&&t&&(PState.set(PSTATE_BUILD),h(!1),w.render(t),c(!1),PState.set(PSTATE_READY));break;case "lgnd-entry-check":k=jQuery(a.target).closest("div.lgnd-entry");a=jQuery(a.target).is(":checked");
k.hasClass("lgnd-sh")?n(e,a):k.hasClass("lgnd-locate")?(k.data("id"),c(!0)):k.hasClass("lgnd-value")&&(k.data("index"),c(!0));break;case "lgnd-viz":case "lgnd-value-title":k=jQuery(a.target).closest("div.lgnd-entry");k.hasClass("lgnd-locate")?(a=k.data("id"),jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+e+'"] div.lgnd-locate input.lgnd-entry-check').prop("checked",!1),jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+e+'"] div.lgnd-locate[data-id="'+
a+'"] input.lgnd-entry-check').prop("checked",!0),c(!0)):k.hasClass("lgnd-value")&&(a=k.data("index"),jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+e+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",!1),jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+e+'"] div.lgnd-group div.lgnd-value[data-index="'+a+'"] input.lgnd-entry-check').prop("checked",!0),c(!0));break;case "lgnd-template":case "lgnd-select":case "":break;default:k.match(/lgnd-sh/i)&&
(k=jQuery(a.target).find("input.lgnd-entry-check"),a=!k.is(":checked"),k.prop("checked",a),n(e,a))}}function v(a){var d=jQuery(a.target).closest("div.lgnd-template").data("index");a=jQuery(a.target).val();x(d,a);c(!0)}function x(a,c){var e,k=jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group');k.empty();u[a]=c;var f=PData.aByID(c);"undefined"!==typeof f.r.u&&(e='<div class="lgnd-value lgnd-entry" data-index="-1"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+
f.r.u.v+'"> </div> <span class="lgnd-value-title">'+dlText.undef+"</span></div>",k.append(e));f.l.forEach(function(a,c){e='<div class="lgnd-value lgnd-entry" data-index="'+c+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+a.v+'"> </div> <span class="lgnd-value-title">'+a.l+"</span></div>";k.append(e);a.z&&0<a.z.length&&a.z.forEach(function(a,d){e='<div class="lgnd-value lgnd-entry" data-index="'+c+","+d+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/>';
e=a.v&&""!==a.v?e+('<div class="lgnd-viz" style="background-color: '+a.v+'"></div>'):e+'<div class="lgnd-viz lgnd-viz-empty"></div>';e+=' <span class="lgnd-value-title">&raquo; '+a.l+"</span></div>";k.append(e)})});jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-sh input').prop("checked",!0)}function y(e,k){var f=PData.vByN(e);w&&(w.teardown(),w=null);var n=jQuery(d());n.find("div.viz-content div.viz-result").empty();var r;switch(f.vf){case "M":r=new VizMap(l,
f.c);break;case "C":r=new VizCards(l,f.c);break;case "P":r=new VizPinboard(l,f.c);break;case "T":r=new VizTime(l,f.c);break;case "D":r=new VizDirectory(l,f.c);break;case "t":r=new VizTextStream(l,f.c);break;case "S":r=new VizStackChart(l,f.c);break;case "N":r=new VizNetWheel(l,f.c);break;case "F":r=new VizFlow(l,f.c);break;case "B":r=new VizBrowser(l,f.c);break;case "m":r=new VizMBMap(l,f.c)}A=e;var g=r.flags();g&V_FLAG_HSCRL?(n.find("div.viz-content").addClass("h-scroll"),n.find("div.viz-result").addClass("viz-fit-w"),
n.find("div.viz-result").removeClass("viz-max-w")):(n.find("div.viz-content").removeClass("h-scroll"),n.find("div.viz-result").removeClass("viz-fit-w"),n.find("div.viz-result").addClass("viz-max-w"));g&V_FLAG_VSCRL?(n.find("div.viz-content").addClass("v-scroll"),n.find("div.viz-result").addClass("viz-fit-h"),n.find("div.viz-result").removeClass("viz-max-h")):(n.find("div.viz-content").removeClass("v-scroll"),n.find("div.viz-result").removeClass("viz-fit-h"),n.find("div.viz-result").addClass("viz-max-h"));
u=[];if(g&V_FLAG_LGND){n.find(".hslgnd").button("enable");var y=n.find("div.lgnd-container div.lgnd-scroll");y.empty();if(g&V_FLAG_SLGND){var m=r.getFeatureAtts(),P=PData.aByID(m);y.append('<div class="lgnd-template" data-index="0"><div class="lgnd-title">'+P.def.l+'</div><div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div></div>');u.push(m);x(0,m)}else{var p=!1;prspdata.e.g.ts.forEach(function(a,
c){var d=PData.tByID(a),e=r.getLocAtts(c);if(e&&0<e.length||!(g&V_FLAG_LOC)){var k=r.getFeatureAtts(c);if(0<k.length){p&&y.append("<hr/>");var f=jQuery('<div class="lgnd-template" data-index="'+c+'"><div class="lgnd-title">'+d.l+"</div></div>");e&&e.forEach(function(a,c){var d=PData.aByID(a);f.append('<div class="lgnd-entry lgnd-locate" data-id="'+a+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><span class="lgnd-value-title">'+d.def.l+"</span></div>")});var n='<select class="lgnd-select">';
k.forEach(function(a,c){var d=PData.aByID(a);n+='<option value="'+a+'">'+d.def.l+"</option>"});n+="</select>";d=jQuery(n);d.change(v);jQuery(f).append(d);jQuery(f).append('<div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div>');y.append(f);k=k[0];u.push(k);x(c,k);p=!0}}})}n.find("div.lgnd-container").show()}else n.find("button.hslgnd").button("disable"),n.find("div.lgnd-container").hide();c(!1);
g&V_FLAG_SEL?(n.find(".hilite").button("enable"),jQuery("#save-prspctv-h"+a).prop("disabled",!1).prop("checked",!1)):(n.find(".hilite").button("disable"),jQuery("#save-prspctv-h"+a).prop("disabled",!0).prop("checked",!1));g&V_FLAG_OPT?n.find(".vopts").button("enable"):n.find(".vopts").button("disable");(m=r.hint())||"string"===typeof f.n&&""!==f.n?(n.find(".vnote").button("enable"),m=m?"string"===typeof f.n&&""!==f.n?m+(".<br/>"+f.n):m+".":f.n,jQuery("#vnotes-txt").empty().append(m)):n.find(".vnote").button("disable");
r.setup();h(!1);t&&k&&r.render(t);w=r}var l={},A=0,w=null,u=[],C=null,t=null;l.getFrameID=d;l.getIndex=function(){return a};l.setViz=function(a,c){a!=A&&(jQuery(d()+" div.view-controls select.view-viz-select").val(a),y(a,c))};l.initDOM=function(c){var n=document.getElementById("dltext-view-controls").innerHTML;jQuery("#viz-frame").append('<div id="view-frame-'+a+'">'+n+"</div>");var n=jQuery(d()),l=prspdata.bClrs.vf;l&&0<l.length&&n.find("div.view-controls").css("background-color",l);n.find("div.lgnd-container").draggable({handle:n.find("div.lgnd-handle"),
containment:"parent"});var v=n.find("div.view-controls select.view-viz-select");prspdata.e.vf.forEach(function(a,c){v.append('<option value="'+c+'">'+a.l+"</option>")});v.val(c);v.change(e);n.find("div.view-controls button:first").button({icons:{primary:"ui-icon-bookmark"},text:!1}).click(f).next().button({icons:{primary:"ui-icon-wrench"},text:!1}).click(p).next().button({icons:{primary:"ui-icon-info"},text:!1}).click(k).next().button({icons:{primary:"ui-icon-star"},text:!1}).click(m).next().button({icons:{primary:"ui-icon-cancel"},
text:!1}).click(q).next().button({icons:{primary:"ui-icon-search"},text:!1}).click(g).next();n.find("div.lgnd-container").click(r);y(c,!1)};l.getSelLocAtts=function(a){var c=[];jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-locate input:checked').each(function(){var a=jQuery(this).parent().data("id");c.push(a)});return c};l.getSelFeatAtts=function(a){var c=[],e,k;jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group div.lgnd-value input:checked').each(function(){e=
jQuery(this).parent().data("index");"number"==typeof e?c.push(e):-1!=(k=e.indexOf(","))?c.push([parseInt(e.substring(0,k),10),parseInt(e.substring(k+1),10)]):c.push(parseInt(e,10))});return c};l.getSelLegend=function(a){return u[a]};l.getLgndSels=function(){return u.slice(0)};l.setLgndSels=function(a){a.forEach(function(a,c){a&&(jQuery(d()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+c+'"] select.lgnd-select').val(a),x(c,a))})};l.getState=function(){return w?w.getState():null};
l.setState=function(a){w&&w.setState(a)};l.showStream=function(a){t=a;w&&w.render(a);c(!1)};l.setStream=function(a){t=a};l.selBtns=function(a){h(a)};l.clearSel=function(){w&&w.clearSel();h(!1)};l.setSel=function(a){return w&&w.flags()&V_FLAG_SEL?(w.setSel(a),h(0<a.length),!0):!1};l.resize=function(){w&&w.resize()};l.title=function(){return PData.vByN(A).l};l.flushLgnd=function(){jQuery(d()).find("div.lgnd-container").css("left","10px")};l.getBMData=function(){return w?{t:w.tUsed,r:w.rMap}:null};return l}
var PData=function(){function a(a,d,e){jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_records",tmplt_id:prspdata.t[a].id,from:d,count:e},success:function(d,n,f){n=m[a];d=JSON.parse(d);n.d=n.d?n.d.concat(d):d;n.n+=e;c()},error:function(a,c,d){alert(d)}})}function c(){for(var c=!0,e=0;e<prspdata.t.length;e++){var f=m[e].n,g=prspdata.t[e].n;if(f<g){c=!1;g-=f;a(e,f,g<d?g:d);break}}c&&(p=!0,setTimeout(function(){jQuery("body").trigger("prospect",{s:PSTATE_PROCESS})},500))}var d=
1E3,e,f,g,h=[31,28,31,30,31,30,31,31,30,31,30,31],m=[],q=0,p=!1;return{init:function(){e=document.getElementById("dltext-to").innerHTML;f=document.getElementById("dltext-approximately").innerHTML;g=document.getElementById("dltext-now").innerHTML;"number"==typeof prspdata.chunk&&0<prspdata.chunk&&(d=prspdata.chunk);prspdata.t.forEach(function(a){m.push({i:q,n:0,d:null});q+=a.n});c()},rSize:function(){return q},intersect:function(a,c){for(var d=[],e=a.length,f=c.length,g,l,h=0,m=0;h<e&&m<f;)g=a[h],
l=c[m],g>l?m++:l>g?h++:(d.push(g),h++,m++);return d},union:function(a,c){for(var d=[],e=0,f=0,g,l;e<a.length&&f<c.length;)g=a[e],l=c[f],g<l?(d.push(g),e++):(g==l?(d.push(g),e++):d.push(l),f++);for(;e<a.length;e++)d.push(a[e]);for(;f<c.length;f++)d.push(c[f]);return d},strcmp:function(a,c){for(var d=0,e=Math.max(a.length,c.length);d<e&&a.charAt(d)===c.charAt(d);++d);return d===e?0:a.charAt(d)>c.charAt(d)?-1:1},sNew:function(a){var c={};c.s=new Uint16Array(q);c.t=[];c.l=0;if(a){for(a=0;a<q;a++)c.s[a]=
a;for(a=0;a<m.length;a++){var d=m[a];c.t.push({i:d.i,n:d.n})}c.l=q}return c},s1stT:function(a,c){var d=a.t[c];return 0==d.n?-1:d.i},n2T:function(a){for(var c=0;c<m.length;c++){var d=m[c];if(d.i<=a&&a<d.i+d.n)return c}},aInT:function(a,c){return-1!=prspdata.t[c].def.a.findIndex(function(c){return c==a})},rByN:function(a){for(var c=0;c<m.length;c++){var d=m[c];if(0<d.n&&d.i<=a&&a<d.i+d.n)return d.d[a-d.i]}return null},procAttTxt:function(a,c){var d=PData.aByID(a);switch(d.def.t){case "V":case "g":return c.join(", ");
case "T":return c;case "N":return"?"===c?dlText.undef:c.toString();case "D":if("?"===c)return dlText.undef;d="";c.max?(c.min.f&&(d=f),d+=c.min.y.toString(),c.min.m&&(d+="-"+c.min.m.toString(),c.min.d&&(d+="-"+c.min.d.toString())),d+=e,"open"==c.max?d+=g:(c.max.f&&(d+=f+" "),d+=c.max.y.toString(),c.max.m&&(d+="-"+c.max.m.toString(),c.max.d&&(d+="-"+c.max.d.toString())))):(d=c.min.f?f:"",d+=c.min.y.toString(),c.min.m&&(d+="-"+c.min.m.toString(),c.min.d&&(d+="-"+c.min.d.toString())));return d;case "L":case "X":return null!=
d.def.d&""!==d.def.d?"number"===typeof c[0]?c.join(", "):c.map(function(a){return a.join(", ")}).join(d.def.d+" "):c.join(", ");case "I":return'<img src="'+c+'" alt="'+d.def.l+'"/>';case "l":return'<a href="'+c+'" target="_blank">(See Link)</a>';case "S":return'<a href="'+c+'" target="_blank">(SoundCloud)</a>';case "Y":return'<a href="https://www.youtube.com/watch?v='+c+'" target="_blank">(YouTube)</a>';case "x":return'<a href="'+c+'" target="_blank">(See Transcript File)</a>';case "t":return c;case "P":if(0<
c.length){var h="";c.forEach(function(a){if(a=PData.rByID(a))0<h.length&&(h+=", "),h+='<a href="'+prspdata.site_url+"?p="+a.wp+'" target="_blank">'+a.l+"</a>"});return h}}return null},rAV:function(a,c,d){for(var e=0;e<m.length;e++){var f=m[e];if(0<f.n&&f.i<=a&&a<f.i+f.n){a=f.d[a-f.i].a[c];if(null==a||"undefined"===typeof a)break;return d?a:PData.procAttTxt(c,a)}}return null},nByID:function(a){for(var c=0;c<m.length;c++){var d=m[c];if(0<d.n)for(var e=0,f=d.n-1,g,l;e<=f;)if(g=e+f>>1,l=d.d[g],l=PData.strcmp(a,
l.id),0>l)e=g+1;else if(0<l)f=g-1;else return d.i+g}return null},rByID:function(a){for(var c=0;c<m.length;c++){var d=m[c];if(0<d.n)for(var e=0,f=d.n-1,g,l,h;e<=f;)if(g=e+f>>1,h=d.d[g],l=PData.strcmp(a,h.id),0>l)e=g+1;else if(0<l)f=g-1;else return h}return null},aByID:function(a){for(var c=0,d=prspdata.a.length-1,e,f;c<=d;)if(e=c+d>>1,f=PData.strcmp(a,prspdata.a[e].id),0>f)c=e+1;else if(0<f)d=e-1;else return prspdata.a[e];return null},aByN:function(a){return prspdata.a[a]},eTNum:function(){return prspdata.e.g.ts.length},
eTByN:function(a){return prspdata.e.g.ts[a]},tByID:function(a){for(var c=0;c<prspdata.t.length;c++)if(a==prspdata.t[c].id)return prspdata.t[c].def},lRecs:function(a,c,d,e){var f,g=d.length,l;switch(c.def.t){case "V":var h=function(a){for(var e=0;e<g;e++)if(f=d[e],"number"===typeof f){if(l=c.l[f],l.l===a)return l}else{l=c.l[f[0]];var k=l.z[f[1]];if(k.l===a)return k.v&&""!==k.v?k:l}return null};if(e&&""!==c.def.d){var m=[],u;a.forEach(function(a){u=h(a);null!=u&&m.push(u)});return 0<m.length?m:null}if(""!=
c.def.d){for(e=0;e<a.length;e++)if(u=h(a[e]),null!=u)return u;break}else return h(a[0]);case "T":for(u=0;u<g;u++)if(f=d[u],l=c.l[f],-1!=a.indexOf(l.d))return l;break;case "N":u=0;if(-1===d[0]){if("?"===a){if("undefined"===typeof c.r.u)break;return c.r.u}u=1}if("?"===a)break;for(;u<g;u++)if(f=d[u],l=c.l[f],"undefined"!==typeof l.d.min){if(l.d.min<=a)if("undefined"!==typeof l.d.max){if(a<=l.d.max)return l}else return l}else if(a<=l.d.max)return l;break;case "D":u=0;if(-1===d[0]){if("?"===a){if("undefined"===
typeof c.r.u)break;return c.r.u}u=1}if("?"!==a)for(;u<g;u++)if(f=d[u],l=c.l[f],"undefined"!==typeof l.d.max.y){if("undefined"!==typeof a.max&&"open"!==a.max){if(a.max.y<l.d.min.y)continue;if(a.max.y===l.d.min.y&&a.max.m&&l.d.min.m){if(a.max.m<l.d.min.m)continue;if(a.max.m==l.d.min.m&&a.max.d&&l.d.min.d&&a.max.d<l.d.min.d)continue}}if(!(a.min.y>l.d.max.y)){if(a.min.y===l.d.max.y&&a.min.m&&l.d.max.m){if(a.min.m>l.d.max.m)continue;if(a.min.m===l.d.max.m&&a.min.d&&l.d.max.d&&a.min.d>l.d.max.d)continue}return l}}else if("undefined"!==
typeof a.max){if("open"===a.max)return l;if(!(a.max.y<l.d.min.y)){if(a.max.y===l.d.min.y&&a.max.m&&l.d.min.m){if(a.max.m<l.d.min.m)continue;if(a.max.m===l.d.min.m&&a.max.d&&l.d.min.d&&a.max.d<l.d.min.d)continue}return l}}else if(!(a.min.y<l.d.min.y)){if(a.min.y===l.d.min.y&&a.min.m&&l.d.min.m){if(a.min.m<l.d.min.m)continue;if(a.min.m===l.d.min.m&&a.min.d&&l.d.min.d&&a.min.d<l.d.min.d)continue}return l}}return null},lClr:function(a,c,d){var e;return(e=PData.lRecs(a,c,d,!1))?e.v:null},lenMnth:function(a,
c){return 2===c&&0===a%4&&0!==a%100||0===a%400?29:h[c-1]},d3Nums:function(a,c,d,e){0>a||99<a?c=new Date(a,c-1,d):0==a?c=new Date(-1,c-1,d):(c=new Date(a,c-1,d),c.setUTCFullYear(("0000"+a).slice(-4)));e&&c.setTime(c.getTime()+MS_IN_DAY);return c},dObj:function(a,c,d){var e;"undefined"!==typeof a.m&&null!==a.m?(c=a.m,e="undefined"!==typeof a.d&&null!==a.d?a.d:PData.lenMnth(a.y,c)):e=PData.lenMnth(a.y,c);return PData.d3Nums(a.y,c,e,d)},dStr:function(a,c){var d,e;if("open"==a)return TODAY;d=1;"-"===a.charAt(0)&&
(d=-1,a=a.substring(1));e=a.split("-");var f=parseInt(e[0])*d;1<e.length?(d=parseInt(e[1]),e=3==e.length?parseInt(e[2]):c?PData.lenMnth(f,d):1):c?(d=12,e=31):e=d=1;return PData.d3Nums(f,d,e,c)},cLNew:function(a,c,d){var e=[];switch(a.def.t){case "T":return a.l.forEach(function(d){(null==c||PData.lRecs(d.d,a,c,!1))&&e.push({l:d.l,x:d.d,c:d.v,i:[]})}),e;case "g":return e;case "V":return a.l.forEach(function(d){(null==c||PData.lRecs([d.l],a,c,!1))&&e.push({l:d.l,c:d.v,i:[]});d.z.forEach(function(f){if(null==
c||PData.lRecs([f.l],a,c,!1))""===f.v?e.push({l:f.l,c:d.v,i:[]}):e.push({l:f.l,c:f.v,i:[]})})}),e;case "N":return d&&"undefined"!==typeof a.r.u&&(null==c||PData.lRecs("?",a,c,!1))&&e.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]}),a.l.forEach(function(d){(null==c||PData.lRecs(d.d.min,a,c,!1))&&e.push({l:d.l,c:d.v,min:d.d.min,max:d.d.max,i:[]})}),e;case "D":d&&"undefined"!==typeof a.r.u&&(null==c||PData.lRecs("?",a,c,!1))&&e.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]});var f,g;a.l.forEach(function(d){f=
PData.dObj(d.d.min,1,!1);if(null===c||PData.lRecs(f,a,c,!1))g=null==d.d.max.y?TODAY:PData.dObj(d.d.max,12,!1),g.setTime(g.getTime()+10),e.push({l:d.l,c:d.v,min:f,max:g,i:[]})});return e}},cRNew:function(a,c,d){var e=[];switch(a.def.t){case "T":return a.l.forEach(function(a){c?e.push({l:a.l,x:a.d,c:a.v,i:[]}):e.push({l:a.l,x:a.d,c:a.v})}),e;case "g":return e;case "V":return a.l.forEach(function(a){c?e.push({l:a.l,c:a.v,i:[]}):e.push({l:a.l,c:a.v});a.z.forEach(function(d){var f=""===d?a.v:d.v;c?e.push({l:d.l,
c:f,i:[]}):e.push({l:d.l,c:f})})}),e;case "N":if("undefined"===typeof a.r.min||"undefined"===typeof a.r.max)return null;d&&"undefined"!==typeof a.r.u&&(c?e.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]}):e.push({l:"?",c:a.r.u.v,min:"?",max:"?"}));var f=Math.pow(10,a.r.g),g=a.r.min,l=0,h,m,u;for(0<a.l.length&&(h=a.l[0]);g<=a.r.max;){for(;l<a.l.length&&"undefined"!==typeof h.d.max&&g>h.d.max;)h=a.l[++l];u=0==a.l.length||g<h.d.min?"#777777":l===a.l.length?"#777777":"undefined"===typeof h.d.max||g<=h.d.max?
h.v:"#777777";m=g;g+=f;max=g-1;max>a.r.max&&(max=a.r.max);var p=m.toString();1<f&&4>p.length&&m!==max&&(p+="-"+max.toString());c?e.push({l:p,c:u,min:m,max:max,i:[]}):e.push({l:p,c:u,min:m,max:max})}return e;case "D":g=function(a){var c,d;if("undefined"===typeof a.y)return TODAY;c=a.y;"undefined"===typeof a.m?(d=12,a=31):(d=a.m,a="undefined"===typeof a.d?PData.lenMnth(c,d):a.d);return PData.d3Nums(c,d,a,!1)};m=function(a,c,d,e){"undefined"!==typeof e.m&&(c=e.m,"undefined"!==typeof e.d&&(d=e.d));return PData.d3Nums(a,
c,d,!1)};u=g(a.r.max);var f=a.r.g,p=a.r.min.y,t=1,q=1;"undefined"!==typeof a.r.min.m&&(t=a.r.min.m,"undefined"!==typeof a.r.min.d&&(q=a.r.min.d));var B=PData.d3Nums(p,t,q,!1),l=0,D,E;0<a.l.length&&(h=a.l[0],D=m(h.d.min.y,1,1,h.d.min),E=g(h.d.max));for(d&&"undefined"!==typeof a.r.u&&(c?e.push({l:"?",c:a.r.u.v,min:"?",max:"?",i:[]}):e.push({l:"?",c:a.r.u.v,min:"?",max:"?"}));B<=u;){d={};c&&(d.i=[]);switch(f){case "d":d.l=p.toString()+"-"+t.toString()+"-"+q.toString();break;case "m":d.l=p.toString()+
"-"+t.toString();break;case "y":case "t":case "c":d.l=p.toString()}for(;l<a.l.length&&B>E;)h=a.l[++l],l<a.l.length&&(D=m(h.d.min.y,1,1,h.d.min),E=g(h.d.max));d.c=0==a.l.length||B<D?"#777777":l==a.l.length?"#777777":B<=E?h.v:"#777777";d.min=B;switch(f){case "d":++q>PData.lenMnth(p,t)&&(q=1,12<++t&&(t=1,p++));break;case "m":12<++t&&(t=1,p++);break;case "y":p++;break;case "t":p+=10;break;case "c":p+=100}B=PData.d3Nums(p,t,q,!1);B>TODAY&&(B=TODAY);B.setTime(B.getTime()+10);d.max=B;e.push(d);B=PData.d3Nums(p,
t,q,!1)}return e}},cFill:function(a,c,d,e){var f=PData.eTNum(),g=0,l,h=0,m,p,q,t,z=PData.aByID(c);for(l=e.t[0];h<e.l;){for(;0==l.n||l.i+l.n==h||!PData.aInT(c,g)||d&&!PData.aInT(d,g);){if(++g==f)return;l=e.t[g];h=l.i}m=e.s[h];p=PData.rByN(m);p=p.a[c];if("undefined"!==typeof p)switch(z.def.t){case "T":for(q=0;q<a.length;q++)if(t=a[q],-1!==p.indexOf(t.x)){t.i.push(m);break}break;case "g":p.forEach(function(c){for(q=0;q<a.length;q++)if(t=a[q],c===t.l){t.i.push(m);break}q===a.length&&a.push({l:c,i:[m],
c:"#"+Math.floor(16777215*Math.random()).toString(16)})});break;case "V":p.forEach(function(c){for(q=0;q<a.length;q++)if(t=a[q],c==t.l){t.i.push(m);break}});break;case "N":q=0;t=a[0];if("?"===t.min){if("?"===p){t.i.push(m);break}q=1}if("?"===p)break;for(;q<a.length;q++){t=a[q];if(p<t.min)break;if(t.min<=p&&p<=t.max){t.i.push(m);break}}break;case "D":q=0;t=a[0];if("?"===t.min){if("?"===p){t.i.push(m);break}q=1}if("?"!==p)for(p=PData.dObj(p.min,1,!1);q<a.length;q++){t=a[q];if(p<t.min)break;if(t.min<=
p&&p<t.max){t.i.push(m);break}}}h++}"g"==z.def.t&&a.sort(function(a,c){return PData.strcmp(c.l,a.l)})},cSort:function(a,c,d){var e=c.id,f,g,h;a.forEach(function(a){f=PData.rByN(a);datum=f.a[e];if("undefined"!==typeof datum)switch(c.def.t){case "T":for(g=0;g<d.length;g++)if(h=d[g],-1!==datum.indexOf(h.x)){h.i.push(a);break}break;case "g":datum.forEach(function(c){for(g=0;g<d.length;g++)if(h=d[g],c===h.l){h.i.push(a);break}g===d.length&&d.push({l:c,i:[a],c:"#777777"})});break;case "V":datum.forEach(function(c){for(g=
0;g<d.length;g++)if(h=d[g],c===h.l){h.i.push(a);break}});break;case "N":g=0;h=d[0];if("?"===h.min){if("?"===datum){h.i.push(a);break}g=1}if("?"===datum)break;for(;g<d.length;g++){h=d[g];if(datum<h.min)break;if(h.min<=datum&&datum<=h.max){h.i.push(a);break}}break;case "D":g=0;h=d[0];if("?"===h.min){if("?"===datum){h.i.push(a);break}g=1}if("?"!==datum){var k=PData.dObj(datum.min,1,!1);for(g=0;g<d.length;g++){h=d[g];if(k<h.min)break;if(h.min<=k&&k<h.max){h.i.push(a);break}}}}});"g"==c.def.t&&d.sort(function(a,
c){return PData.strcmp(c.l,a.l)})},rTOrder:function(a,c,d){function e(a){return a}function f(a){return a[0]}function g(a){if("?"===a)return"?";var c=1,d=1;"undefined"!==typeof a.min.m&&(c=a.min.m,"undefined"!==typeof a.min.d&&(d=a.min.d));return PData.d3Nums(a.min.y,c,d,!1)}var h,p;switch(a.def.t){case "T":h=e;p="~";break;case "V":h=f;p="~";break;case "g":h=f;p="~";break;case "N":h=e;p=a.r.max;break;case "D":h=g,p=TODAY}var q=[],u=c.t[d];d=m[d];for(var C=0,t,z;C<u.n;)t=c.s[u.i+C++],z=d.d[t-d.i],z=
z.a[a.id],"undefined"===typeof z?q.push({i:t,v:p}):q.push({i:t,v:h(z)});switch(a.def.t){case "T":case "g":case "V":q.sort(function(a,c){return PData.strcmp(c.v,a.v)});break;case "D":case "N":q.sort(function(a,c){return"?"===a.v?-1:"?"===c.v?1:a.v-c.v})}return q},vByN:function(a){return prspdata.e.vf[a]},ready:function(){return p}}}();
jQuery(document).ready(function(a){function c(){var a;PState.set(PSTATE_PROCESS);null==t&&(t=PData.sNew(!0));z=t;var c=!1,d,e;for(d=0;d<w.length;d++)if(e=w[d],a=jQuery('div.filter-instance[data-id="'+e.id+'"]'),c||e.f.isDirty(null)){c=!0;e=e.f;e.evalPrep();for(var f=PData.sNew(!1),g=0,h,k,m=0,p=z.t[0],n=0,q=0,r=a.find(".apply-tmplt-0").is(":checked");g<z.l;){for(;0==p.n||p.i+p.n==g;)f.t.push({i:f.l-n,n:n}),n=0,p=z.t[++m],r=a.find(".apply-tmplt-"+m).is(":checked");h=z.s[g++];r?(k=PData.rByN(h),e.eval(k)&&
(f.s[f.l++]=h,n++),q++):(f.s[f.l++]=h,n++)}for(;m++<PData.eTNum();)f.t.push({i:f.l-n,n:n}),n=0;e.isDirty(!1);e.out=f;e.evalDone(q);z=f}else z=e.f.out;PState.set(PSTATE_BUILD);l.forEach(function(a){a&&a.showStream(z)});0<w.length?jQuery("#btn-f-state").prop("disabled",!0).html(dlText.filtered):jQuery("#btn-f-state").prop("disabled",!0).html(dlText.nofilter)}function d(a){var c=jQuery("#annote");c.text(a);0<a.length?(jQuery("#btn-annote").button("enable"),c.show()):(jQuery("#btn-annote").button("disable"),
c.hide())}function e(a){var c=_.find(prspdata.p,function(c){return a==c.id});return c?c:null==B||0==D.length?null:(c=_.find(D,function(c){return a==c.id}))?c:null}function f(a,c){var d=jQuery("input[name=save-prspctv-dest]:checked").val();if(""==d)return null;var e=jQuery("#save-prspctv-note").val(),e=e.replace(/"/g,""),f={f:[],h0:null,h1:null,v0:null,v1:null};l.forEach(function(a,c){a&&(f["v"+c]={l:a.title(),s:a.getState()})});w.forEach(function(a){for(var c=[],d=jQuery('div.filter-instance[data-id="'+
a.id+'"]'),e=0;e<PData.eTNum();e++)c.push(d.find(".apply-tmplt-"+e).is(":checked"));f.f.push({id:a.attID,a:c,s:a.f.getState()})});for(var g=0;2>g;g++){var h=u[g];null!==h&&jQuery("#save-prspctv-h"+g).is(":checked")&&(f["h"+g]={id:C[g],s:h.getState()})}var k={id:a,l:c,n:e,s:f};"local"==d?(D.push(k),B.setItem(prspdata.e.id,JSON.stringify(D))):"server"==d&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_save_prspctv",id:a,l:c,x:prspdata.e.id,n:e,s:JSON.stringify(f)},success:function(a,
c,d){"0"!=a&&prspdata.p.push(k)},error:function(a,c,d){alert(d)}});return d}function g(){var a,c=[],d=!1;(function(){var a=jQuery("#prspctv-mlist");a.empty();D.forEach(function(c){a.append('<li data-type="l" data-id="'+c.id+'"><span class="label">'+c.l+'</span> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")});for(var d=0;d<B.length;d++){var e=B.key(d);if(e!=prspdata.e.id){var f=B.getItem(e);c.push({id:e,ps:JSON.parse(f)})}}c.forEach(function(c,d){c.ps.forEach(function(e){a.append('<li data-type="x" data-xid="'+
c.id+'" data-xindex="'+d+'" data-id="'+e.id+'"><i class="label">'+e.l+'</i> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")})})})();jQuery("#prspctv-mlist").click(function(a){if("BUTTON"==a.target.nodeName){var e=jQuery(a.target).hasClass("del"),f=jQuery(a.target).parent(),g=f.data("type"),h=f.data("id");if(e){switch(g){case "l":a=D.findIndex(function(a){return h==a.id});-1!=a&&(D.splice(a,1),0==D.length?B.removeItem(prspdata.e.id):B.setItem(prspdata.e.id,
JSON.stringify(D)));break;case "x":a=f.data("xindex"),e=c[a],a=e.ps.findIndex(function(a){return h==a.id}),-1!=a&&(e.ps.splice(a,1),d=!0)}f.remove()}else{var k;switch(g){case "l":k=_.find(D,function(a){return h==a.id});break;case "x":a=f.data("xindex"),e=c[a],k=_.find(e.ps,function(a){return h==a.id})}jQuery("#edit-prspctv-lbl").val(k.l);jQuery("#edit-prspctv-note").val(k.n);var l=jQuery("#dialog-edit-prsrctv").dialog({width:340,height:270,modal:!0,buttons:[{text:dlText.ok,click:function(){k.l=jQuery("#edit-prspctv-lbl").val();
k.n=jQuery("#edit-prspctv-note").val();f.find(".label").text(k.l);"x"==g?d=!0:B.setItem(prspdata.e.id,JSON.stringify(D));l.dialog("close")}},{text:dlText.cancel,click:function(){l.dialog("close")}}]})}}});a=jQuery("#dialog-manage-prsrctv").dialog({width:450,height:350,modal:!0,buttons:[{text:dlText.ok,click:function(){d&&c.forEach(function(a){0<a.ps.length?B.setItem(a.id,JSON.stringify(a.ps)):B.removeItem(a.id)});jQuery("#prspctv-mlist").off("click");a.dialog("close")}}]})}function h(a){window.location.href=
prspdata.e.g.hurl;a.preventDefault()}function m(a){jQuery(this).parent().next().slideToggle(400);a.preventDefault()}function q(a){if(a=jQuery(this).closest("div.filter-instance")){var c=a.data("id");c&&""!==c&&(a=w.find(function(a){return a.id==c}),null==a?alert("Bad Filter ID "+c):a.f.isDirty(!0))}}function p(a){var d=jQuery(this).closest("div.filter-instance"),e=d.data("id"),f,g;f=w.findIndex(function(a){return a.id==e});if(-1===f)alert("Bad Filter ID "+e);else{g=w[f].f;g.teardown();w.splice(f,
1);if(f>=w.length){var h;h=0===w.length?t:w[f-1].out;l.forEach(function(a){a&&a.setStream(h)})}else w[f].f.isDirty(!0);d.remove();0===w.length?(jQuery("#btn-toggle-filters").button("disable"),l.forEach(function(a){a&&a.clearSel(h)}),c(),PState.set(PSTATE_READY)):jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters);a.preventDefault()}}function k(a,c,d){var e,f,g;if(null!==d)e=d;else{do e=Math.floor(1E3*Math.random()+2),-1!=w.findIndex(function(a){return a.id==e})&&(e=-1);while(-1==e)}if("_remove"==
a)f=new PFilterRemove(e),g={t:[!0,!0,!0,!0]};else switch(g=PData.aByID(a),g.def.t){case "V":f=new PFilterVocab(e,g);break;case "T":f=new PFilterText(e,g);break;case "g":f=new PFilterTags(e,g);break;case "N":f=new PFilterNum(e,g);break;case "D":f=new PFilterDates(e,g)}if(null!==d)c=jQuery("#dialog-hilite-"+d+" span.filter-id").html(g.def.l),c=jQuery("#hilite-"+d),c.empty();else{w.push({id:e,attID:a,f:f,out:null});d=_.template(document.getElementById("dltext-filter-head").innerHTML);jQuery("#filter-instances").append(d({newID:e,
title:f.title(),apply:A}));d=jQuery('div.filter-instance[data-id="'+e+'"]');for(a=0;a<PData.eTNum();a++){var h=d.find(".apply-tmplt-"+a);h.prop("disabled",!g.t[a]);h.prop("checked",c[a]&&g.t[a]);h.click(q)}d.find("button.btn-filter-toggle").button({text:!1,icons:{primary:"ui-icon-carat-2-n-s"}}).click(m);d.find("button.btn-filter-del").button({text:!1,icons:{primary:"ui-icon-trash"}}).click(p);jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters)}f.setup();return f}function n(a,c,d,e){jQuery("#filter-list li").removeClass("selected");
var f,g,h,k;jQuery("#filter-list li").each(function(c){f=jQuery(this);g=f.data("id");"_remove"==g?a?f.show():f.hide():d?(h=PData.aByID(g),k=!1,h.t.forEach(function(a,c){k=k||a&&d[c]}),k?f.show():f.hide()):f.show()});var l,m={height:300,width:350,modal:!0,buttons:[{text:dlText.add,click:function(){var a=jQuery("#filter-list li.selected");1===a.length&&e(a.data("id"));l.dialog("close")}},{text:dlText.cancel,click:function(){l.dialog("close")}}]};c&&(m.appendTo="#dialog-2");l=jQuery("#dialog-choose-att").dialog(m)}
function r(a){PState.set(PSTATE_PROCESS);var c=l[a],d=c.getBMData(),e=[];a=u[a];if(null!==z){a.evalPrep();var f=0,g,h,k=0,m=z.t[0];a:for(;f<z.l;){for(;!d.t[k]||0==m.n||m.i+m.n==f;){if(++k===PData.eTNum())break a;m=z.t[k];f=m.i}g=z.s[f++];d.r[g>>4]&1<<(g&15)&&(h=PData.rByN(g),a.eval(h)&&e.push(g))}a.evalDone(z.l)}PState.set(PSTATE_UPDATE);0<e.length?c.setSel(e):c.clearSel();PState.set(PSTATE_READY)}function v(a,c){var d;d=jQuery("#dialog-hilite-"+a).dialog({height:275,width:Math.min(jQuery(window).width()-
20,675),modal:!0,appendTo:"#dialog-1",buttons:[{text:dlText.chsatt,click:function(){n(!1,!0,c,function(c){C[a]=c;u[a]=k(c,null,a)})}},{text:dlText.ok,click:function(){d.dialog("close");null!==u[a]&&r(a)}},{text:dlText.cancel,click:function(){d.dialog("close")}}]})}function x(a){function f(a){return prspdata.e.vf.findIndex(function(c){return a==c.l})}a=e(a);if(null==a)return!1;PState.set(PSTATE_PROCESS);jQuery("#filter-frame").hide();w.forEach(function(a){a.f.teardown()});w=[];jQuery("#filter-instances").empty();
a.s.f.forEach(function(a){k(a.id,a.a,null).setState(a.s)});jQuery("#filter-instances").hide();jQuery("#btn-toggle-filters").button(0==a.s.f.length?"disable":"enable");for(var g=0;2>g;g++)if(null!=a.s["h"+g]){var h=a.s["h"+g];C[g]=h.id;var m=k(h.id,null,g);u[g]=m;m.setState(h.s)}else u[g]=null,C[g]=null;var h=l[0],m=l[1],n=!1;PState.set(PSTATE_BUILD);g=f(a.s.v0.l);h?(h.setViz(g,!1),h.selBtns(!1)):(l[0]=PViewFrame(0),h=l[0],h.initDOM(g));null!==a.s.v1?(g=f(a.s.v1.l),m?(m.selBtns(!1),m.setViz(g,!1),
m.setState(a.s.v1.s)):(h.flushLgnd(),l[1]=PViewFrame(1),m=l[1],m.initDOM(g),m.setState(a.s.v1.s),n=!0)):m&&(l[1]=null,jQuery("#view-frame-1").remove(),n=!0);n&&h.resize();h.setState(a.s.v0.s);d(a.n);if(PData.ready()&&t)for(c(),g=0;2>g;g++)null!==C[g]&&r(g);return!0}function y(a,c){var d=prspdata.bClrs[a];d&&0<d.length&&jQuery(c).css("background-color",d)}var l=[null,null],A,w=[],u=[null,null],C=[null,null],t,z,B=null,D=[];jQuery("body").addClass("waiting");y("cb","#command-bar");y("fs","#filter-frame");
PState.init();PMapHub.init(prspdata.m);(function(){function a(d,e){c=document.getElementById(d).innerHTML;dlText[e]=c.trim()}var c;a("dltext-removehideall","rha");a("dltext-showhideall","sha");a("dltext-ok","ok");a("dltext-cancel","cancel");a("dltext-choose-att","chsatt");a("dltext-seerec","seerec");a("dltext-close","close");a("dltext-add","add");a("dltext-manage","manage");a("dltext-delete","del");a("dltext-edit","edit");a("dltext-markers","markers");a("dltext-hint-marker","markersize");a("dltext-hint-text",
"textsize");a("dltext-xaxis","xaxis");a("dltext-yaxis","yaxis");a("dltext-undefined","undef");a("dltext-orderedby","orderedby");a("dltext-grpblks","grpblks");a("dltext-reset","reset");a("dltext-nofilter","nofilter");a("dltext-dofilters","dofilters");a("dltext-filtered","filtered");c=document.getElementById("dltext-month-names").innerHTML;months=c.trim().split("|");(c=document.getElementById("dltext-d3-local"))&&(c=c.innerHTML)&&1<c.length&&(localD3=d3.locale(JSON.parse(c)).timeFormat.multi([["%H:%M",
function(a){return a.getMinutes()}],["%H:%M",function(a){return a.getHours()}],["%a %d",function(a){return a.getDay()&&1!=a.getDate()}],["%b %d",function(a){return 1!=a.getDate()}],["%B",function(a){return a.getMonth()}],["%Y",function(){return!0}]]))})();xhbtURL=window.location.pathname;xhbtURL=xhbtURL.replace(/\&*prspctv=[\w\-]+/,"");xhbtURL=xhbtURL.replace(/\/$/,"");xhbtURL=xhbtURL.replace(/^\//,"");xhbtURL="http://"+window.location.host+"/"+xhbtURL;(function(){var a=_.template(document.getElementById("dltext-filter-template").innerHTML),
c=[];prspdata.t.forEach(function(d,e){c.push(a({ti:e,tl:d.def.l}))});A=c.join("&nbsp;")})();(function(){var a;prspdata.t.forEach(function(c,d){var e="";c.def.a.forEach(function(c){a=PData.aByID(c);switch(a.def.t){case "T":case "V":case "N":case "D":e+='<option value="'+c+'">'+a.def.l+"</option>"}});jQuery("#dialog-sortby").append("<b>"+c.def.l+"</b>: <select data-ti="+d+">"+e+"</select><br/>")})})();"/"!=prspdata.site_url.charAt(prspdata.site_url.length-1)&&(prspdata.site_url+="/");""!=prspdata.e.g.l&&
jQuery("#title").text(prspdata.e.g.l);try{var E=window.localStorage;E.setItem("__storage_test__","__storage_test__");E.removeItem("__storage_test__");var F=E.getItem(prspdata.e.id),B=E;0<F.length&&(D=JSON.parse(F))}catch(G){}jQuery("#btn-about").button({icons:{primary:"ui-icon-power"},text:!1}).click(function(a){var c;jQuery("#dialog-about img").removeClass("zoomin");c=jQuery("#dialog-about").dialog({height:390,width:350,modal:!0,buttons:[{text:dlText.ok,click:function(){c.dialog("close")}}]});jQuery("#dialog-about img").addClass("zoomin");
a.preventDefault()});jQuery("#btn-set-layout").button({icons:{primary:"ui-icon-newwin"},text:!1}).click(function(){null!==l[1]?(l[1]=null,jQuery("#view-frame-1").remove()):(l[0].flushLgnd(),PState.set(PSTATE_BUILD),l[1]=PViewFrame(1),l[1].initDOM(0),l[1].showStream(z),PState.set(PSTATE_READY));l[0].resize()});jQuery("#btn-hs-bars").button({icons:{primary:"ui-icon-carat-2-n-s"},text:!1}).click(function(a){jQuery("#filter-frame").slideToggle(400);a.preventDefault()});jQuery("#btn-show-prspctv").button({icons:{primary:"ui-icon-image"},
text:!1}).click(function(a){var c=jQuery("#prspctv-slist");c.empty();prspdata.p.forEach(function(a){c.append('<li data-src="server" data-id="'+a.id+'">'+a.l+"</li>")});D.forEach(function(a){c.append('<li data-src="local" data-id="'+a.id+'">'+a.l+"</li>")});var d=[{text:dlText.ok,click:function(){e.dialog("close");var a=c.find("li.selected");a.length&&(a=a.data("id"),x(a),PState.set(PSTATE_READY))}},{text:dlText.cancel,click:function(){e.dialog("close")}}];B&&d.push({text:dlText.manage,click:function(){e.dialog("close");
g()}});var e=jQuery("#dialog-show-prsrctv").dialog({width:350,height:350,modal:!0,buttons:d});a.preventDefault()});jQuery("#btn-save-prspctv").button({icons:{primary:"ui-icon-pencil"},text:!1}).click(function(a){var c,d=/[^\w\-]/;jQuery("#save-prspctv-id").val("");jQuery("#save-prspctv-lbl").val("");jQuery("#save-prspctv-note").val("");B||jQuery("#save-prspctv-d-1").prop("disabled",!0);prspdata.add_prspctv||jQuery("#save-prspctv-d-2").prop("disabled",!0);jQuery("#save-prspctv-h0").prop("checked",
!1);jQuery("#save-prspctv-h1").prop("checked",!1);for(var g=0;2>g;g++){var h=null===u[g]||null===l[g];jQuery("#save-prspctv-h"+g).prop("disabled",h)}c=jQuery("#dialog-save-prsrctv").dialog({width:350,height:370,modal:!0,buttons:[{text:dlText.ok,click:function(){var a=jQuery("#save-prspctv-id").val().trim(),g=a.match(d),h=jQuery("#save-prspctv-lbl").val().trim(),h=h.replace(/"/g,"");if(0===a.length||20<a.length||g)g="#dialog-prspctv-id-badchars";else if(e(a))g="#dialog-prspctv-id-used";else if(0===
h.length||32<h.length)g="#dialog-prspctv-label-bad";if(g)var k=jQuery(g).dialog({width:320,height:210,modal:!0,buttons:[{text:dlText.ok,click:function(){k.dialog("close")}}]});else if(g=f(a,h),c.dialog("close"),"server"==g){a=xhbtURL+"/?prspctv="+a;jQuery("#save-prspctv-embed").val(a);var l=jQuery("#dialog-prspctv-url").dialog({width:480,height:230,modal:!0,buttons:[{text:dlText.ok,click:function(){l.dialog("close")}}]})}}},{text:dlText.cancel,click:function(){c.dialog("close")}}]});a.preventDefault()});
jQuery("#btn-annote").button({icons:{primary:"ui-icon-comment"},text:!1}).click(function(a){jQuery("#annote").toggle("slide",{direction:"right"});a.preventDefault()});0<prspdata.e.g.hbtn.length&&0<prspdata.e.g.hurl.length?(jQuery("#home-title").text(prspdata.e.g.hbtn),jQuery("#btn-home").button({icons:{primary:"ui-icon-home"},text:!1}).click(h)):jQuery("#btn-home").remove();jQuery("#filter-list").click(function(a){"I"==a.target.nodeName?(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).parent().addClass("selected")):
"LI"==a.target.nodeName&&(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).addClass("selected"))});jQuery("#prspctv-slist").click(function(a){"LI"==a.target.nodeName&&(jQuery("#prspctv-slist li").removeClass("selected"),jQuery(a.target).addClass("selected"))});jQuery("#btn-new-filter").button({icons:{primary:"ui-icon-plus"},text:!1}).click(function(a){n(!0,!1,null,function(a){jQuery("#filter-instances").show(400);k(a,[!0,!0,!0,!0],null);jQuery("#btn-toggle-filters").button("enable")});
a.preventDefault()});jQuery("#btn-toggle-filters").button({icons:{primary:"ui-icon-arrow-2-n-s"},text:!1}).click(function(a){jQuery("#filter-instances").slideToggle(400);a.preventDefault()});jQuery("#btn-f-state").click(function(a){l.forEach(function(a){a&&a.clearSel()});c();PState.set(PSTATE_READY);a.preventDefault()});jQuery("#dialog-about .logo").attr("src",prspdata.assets+"prospectlogo.jpg");jQuery("#btn-inspect-left").button({icons:{primary:"ui-icon-arrowthick-1-w"},text:!1});jQuery("#btn-inspect-right").button({icons:{primary:"ui-icon-arrowthick-1-e"},
text:!1});(function(){jQuery("#filter-list").append('<li class="remove" data-id="_remove"><i>'+dlText.rha+"</i></li>");prspdata.a.forEach(function(a){switch(a.def.t){case "V":case "T":case "g":case "N":case "D":jQuery("#filter-list").append('<li data-id="'+a.id+'">'+a.def.l+"</li>")}})})();0!=prspdata.show_prspctv.length&&x(prspdata.show_prspctv)||(l[0]=PViewFrame(0),l[0].initDOM(0),d(""));jQuery(window).resize(function(){l.forEach(function(a){a&&a.resize()})});jQuery("body").on("prospect",function(a,
d){switch(d.s){case PSTATE_PROCESS:PState.set(PSTATE_PROCESS);c();for(var e=0;2>e;e++)null!==u[e]&&r(e);PState.set(PSTATE_READY);jQuery("body").removeClass("waiting");break;case PSTATE_FDIRTY:jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters);break;case PSTATE_HILITE:v(d.v,d.t)}});PState.set(PSTATE_LOAD);PData.init()});function onYouTubeIframeAPIReady(){widgetData.ytCall&&widgetData.ytCall()};