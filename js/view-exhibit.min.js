/*! prospect 2016-07-08 */
function PViewFrame(a){function b(a){a!==y&&(y=a,jQuery(c()+" div.lgnd-container div.lgnd-handle button.lgnd-update").prop("disabled",!a))}function c(){return"#view-frame-"+a}function d(a){var b=jQuery(c()+" div.view-controls select.view-viz-select option:selected"),d=b.val();PState.set(PSTATE_BUILD),t(d,!0),PState.set(PSTATE_READY)}function e(a){w.flags()&V_FLAG_LGND&&jQuery(c()+" div.lgnd-container").toggle("slide",{direction:"left"}),a.preventDefault()}function f(a){function b(a){return a.replace(/^[ \f\t\v​]+|[ \f\t\v​]+$/g,"")}function c(a){var b=new Number,c=parseTC.exec(a);if(null===c)throw new Error("Error in transcript file: Cannot parse "+a+" as timecode.");return b=1e3*(3600*parseInt(c[1])+60*parseInt(c[2])+parseFloat(c[3])),b+=1==c[4].length?100*parseInt(c[4]):10*parseInt(c[4])}function d(a,c){var d=new String(a);d=b(d).split(/\r\n|\r|\n/g);var e=[];if(d){var f,g=0;_.each(d,function(a){a=b(a),a.length>0&&("["===a.charAt(0)?(g>0&&e.push(f),f=""):(f.length>0&&(f+="<br/>"),f+=a),g++)})}_.each(e,function(a,b){c.find('div.timecode[data-tcindex="'+b+'"]').next().after('<div class="xscript">'+a+"</div>")})}function e(a){widgetData.tcArray=[],widgetData.tcIndex=-1;var e=widgetData.tcArray,f=new String(a);if(f=b(f).split(/\r\n|\r|\n/g)){var g,h=jQuery("#xscript-tbl"),i=0,j=0,k=0,l="";_.each(f,function(a){a=b(a),a.length>1&&("["===a.charAt(0)&&a.charAt(1)>="0"&&a.charAt(1)<="9"?(g=c(a),l.length>0&&(k&&e.push({s:j,e:g}),h.append('<div class="row"><div class="timecode" data-timecode="'+j+'" data-tcindex="'+i++ +'">'+k+'</div><div class="xscript">'+l+"</div></div>"),l=""),k=a,j=g):(l.length>0&&(l+="<br/>"),l+=a))}),l.length>0&&(e.push({s:j,e:324e5}),h.append('<div class="row"><div class="timecode" data-timecode="'+j+'" data-tcindex="'+i+'">'+k+'</div><div class="xscript">'+l+"</div></div>")),"undefined"!=typeof q&&null!=q&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:q,excerpt:widgetData.extract},success:function(a,b,c){d(JSON.parse(a),h)},error:function(a,b,c){alert(c)}})}}function f(a){var b,c=widgetData.tcIndex;_.find(widgetData.tcArray,function(d,e){if(b=d.s<=a&&a<d.e,b&&e!=c){var f=jQuery("#xscript-tbl");if(document.getElementById("sync-xscript").checked){var g=f.find('[data-tcindex="'+e+'"]'),h=g.offset().top-f.offset().top,i=f.scrollTop()+h;f.animate({scrollTop:i},300)}-1!=c&&f.find('[data-tcindex="'+c+'"]').removeClass("current"),f.find('[data-tcindex="'+e+'"]').addClass("current"),widgetData.tcIndex=e}return b})}function h(){function a(a){var b;switch(a.data){case 1:widgetData.playing=!0,null==widgetData.timer&&(widgetData.timer=setInterval(function(){b=1e3*widgetData.widget.getCurrentTime(),widgetData.playing&&widgetData.xscriptOn&&f(b)},300));break;case 0:case 2:widgetData.playing=!1,window.clearInterval(widgetData.timer),widgetData.timer=null;break;case 3:case 5:widgetData.playing=!1}}widgetData.widget=new YT.Player("yt-widget",{width:u-40,height:Math.floor(9*(u-40)/16),videoId:widgetData.ytCode,events:{onError:function(a){console.log("YouTube Error: "+a.data)},onStateChange:a,onReady:function(){widgetData.extract&&widgetData.widget.cueVideoById({videoId:widgetData.ytCode,startSeconds:widgetData.sTime/1e3,endSeconds:widgetData.eTime/1e3})}}})}function i(){widgetData.playing=!0}function j(){widgetData.playing=!1}function k(){widgetData.playing&&widgetData.xscriptOn&&f(1e3*widgetData.widget.currentTime)}function l(){switch(t){case 3:null!=widgetData.widget&&(widgetData.widget.removeEventListener("ended",j),widgetData.widget.removeEventListener("pause",j),widgetData.widget.removeEventListener("playing",i),widgetData.widget.removeEventListener("timeupdate",k));case 1:null!=widgetData.widget&&widgetData.playing&&widgetData.widget.pause(),widgetData.playing=!1,widgetData.widget=null;break;case 2:widgetData.ytCall=null,null!=widgetData.widget&&widgetData.playing&&widgetData.widget.stopVideo(),widgetData.widget=null,widgetData.playing=!1,null!=widgetData.timer&&(window.clearInterval(widgetData.timer),widgetData.timer=null)}}function m(){function a(){widgetData.sTime=widgetData.eTime=null;var a;if(a=prspdata.e.i.t.tcAtts[l]){var b=z.a[a];if(b&&""!==b){widgetData.extract=b;var d=b.split("-");widgetData.sTime=c(d[0]),widgetData.eTime=c(d[1])}}}var b=x[A];z=PData.rByN(b);var d=" "+z.l+" ("+(A+1)+"/"+x.length+") ",g=jQuery("#inspect-name");g.text(d),g.prop("title",z.id);var l=PData.n2T(b);if(r.empty(),s=null,t=0,widgetData.extract=null,widgetData.xscriptOn=!1,widgetData.playing=!1,(prspdata.e.i.modal.scOn||"boolean"==typeof prspdata.e.i.modal.aOn&&prspdata.e.i.modal.aOn)&&(s=prspdata.e.i.sc.atts[l])){var m;if(m=z.a[s])if(a(),m.match(/soundcloud\.com/)){t=1,r.append('<iframe id="sc-widget" class="player" width="100%" height="110" src="//w.soundcloud.com/player/?url='+m+'"></iframe>');var n=SC.Widget(document.getElementById("sc-widget"));widgetData.widget=n,n.bind(SC.Widget.Events.READY,function(){n.bind(SC.Widget.Events.PLAY,function(){widgetData.playing=!0}),n.bind(SC.Widget.Events.PAUSE,function(){widgetData.playing=!1}),n.bind(SC.Widget.Events.PLAY_PROGRESS,function(a){widgetData.extract&&(a.currentPosition<widgetData.sTime?n.seekTo(widgetData.sTime):a.currentPosition>widgetData.eTime&&(n.pause(),widgetData.playing=!1)),widgetData.playing&&widgetData.xscriptOn&&f(a.currentPosition)}),n.bind(SC.Widget.Events.FINISH,function(){widgetData.playing=!1})})}else{if(t=3,widgetData.extract){var o=widgetData.extract.split("-");m+="#t="+o[0]+","+o[1]}r.append('<audio id="na-widget" controls src="'+m+'"></audio>'),widgetData.widget=document.getElementById("na-widget"),widgetData.widget.addEventListener("ended",j),widgetData.widget.addEventListener("pause",j),widgetData.widget.addEventListener("playing",i),widgetData.widget.addEventListener("timeupdate",k)}}if(0===t&&prspdata.e.i.modal.ytOn&&(s=prspdata.e.i.yt.atts[l])){var p=z.a[s];if(p){if(a(),widgetData.ytCode=p,r.append('<div id="yt-widget"></div>'),widgetData.ytCall=h,widgetData.ytLoaded)h();else{widgetData.ytLoaded=!0;var u=document.createElement("script");u.src="https://www.youtube.com/iframe_api";var v=document.getElementsByTagName("script")[0];v.parentNode.insertBefore(u,v)}t=2}}if(prspdata.e.i.modal.tOn){var w=prspdata.e.i.t.t1Atts[l];if(w&&""!==w&&"disable"!==w){var y=z.a[w];if("string"==typeof y&&""!==y){t>0&&r.append("<div>"+document.getElementById("dltext-sync-xscript").innerHTML+"</div>"),r.find("#xscript-tbl").remove(),r.append('<div id="xscript-tbl"></div>'),widgetData.xscriptOn=!0,jQuery("#xscript-tbl").click(function(a){if(t&&jQuery(a.target).hasClass("timecode")){var b=jQuery(a.target).data("timecode");switch(t){case 1:widgetData.widget.seekTo(b),widgetData.playing||widgetData.widget.play();break;case 2:widgetData.playing||(widgetData.playing=!0,widgetData.widget.playVideo()),widgetData.widget.seekTo(b/1e3);break;case 3:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play()),widgetData.widget.currentTime=b/1e3}}}),q=null;var B=prspdata.e.i.t.t2Atts[l];B&&""!==B&&"disable"!==B&&(q=z.a[B]),jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:y,excerpt:widgetData.extract},success:function(a,b,c){e(JSON.parse(a))},error:function(a,b,c){alert(c)}})}}}prspdata.e.i.modal.atts[l].forEach(function(a){var c=PData.rAV(b,a,!1);if(c){var d,e=PData.aByID(a);"_"==e.def.l.charAt(0)?d="<div>"+c+"</div>":(d='<div><span class="att-label">'+e.def.l+":</span> ","I"==e.def.t&&(d+="<br/>"),d+=c+"</div>"),r.append(d)}})}function n(a){var b=A+a;-1==b?b=x.length-1:b==x.length&&(b=0),b!=A&&(A=b,l(),m())}function o(a){n(-1)}function p(a){n(1)}var q,r=jQuery("#inspect-content"),s=null,t=0,u=450,v=400,x=null;if(w&&(x=w.getSel()),null!=x&&0!=x.length){var y,z,A=0;prspdata.e.i.modal.scOn&&(u=550),prspdata.e.i.modal.ytOn&&(u=Math.max(u,475),v=500),prspdata.e.i.modal.tOn&&(v+=100,prspdata.e.i.modal.t2On?(u=Math.max(750,Math.floor(.8*jQuery(document).width())),u=Math.min(900,u)):u=Math.max(u,550)),"number"==typeof prspdata.e.i.modal.w&&(u=prspdata.e.i.modal.w),"number"==typeof prspdata.e.i.modal.h&&(v=prspdata.e.i.modal.h),g(!1),m(),jQuery("#btn-inspect-left").click(o),jQuery("#btn-inspect-right").click(p),y=jQuery("#dialog-inspector").dialog({width:u,height:v,modal:!0,buttons:[{text:dlText.seerec,click:function(){window.open(prspdata.site_url+"?p="+z.wp,"_blank")}},{text:dlText.close,click:function(){y.dialog("close")}}]}),y.on("dialogclose",function(a,b){l(),jQuery("#btn-inspect-left").off("click"),jQuery("#btn-inspect-right").off("click"),g(!0),y.off("dialogclose")}),a.preventDefault()}}function g(a){var b=jQuery(c()+" div.view-controls");a?(b.find(".osel").button("enable"),b.find(".osel").addClass("pulse"),b.find(".xsel").button("enable")):(b.find(".osel").button("disable"),b.find(".osel").removeClass("pulse"),b.find(".xsel").button("disable"))}function h(b){jQuery("body").trigger("prospect",{s:PSTATE_HILITE,v:a,t:w.tUsed}),b.preventDefault()}function i(a){PState.set(PSTATE_UPDATE),w&&w.clearSel(),g(!1),PState.set(PSTATE_READY),a.preventDefault()}function j(a){w&&w.doOptions(),a.preventDefault()}function k(a){var b=jQuery("#dialog-vnotes").dialog({width:300,height:300,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close")}}]});a.preventDefault()}function l(a,d){jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",d),b(!0)}function m(a,c,d){b(!0)}function n(a,d){jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-locate input.lgnd-entry-check').prop("checked",!1),jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-locate[data-id="'+d+'"] input.lgnd-entry-check').prop("checked",!0),b(!0)}function o(a,c,d){b(!0)}function p(a,d){jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",!1),jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group div.lgnd-value[data-index="'+d+'"] input.lgnd-entry-check').prop("checked",!0),b(!0)}function q(a){var c=jQuery(a.target).closest("div.lgnd-template").data("index"),d=a.target.className;switch(d){case"lgnd-update":w&&z&&(PState.set(PSTATE_BUILD),g(!1),w.render(z),b(!1),PState.set(PSTATE_READY));break;case"lgnd-entry-check":var e=jQuery(a.target).closest("div.lgnd-entry"),f=jQuery(a.target).is(":checked");e.hasClass("lgnd-sh")?l(c,f):e.hasClass("lgnd-locate")?m(c,e.data("id"),f):e.hasClass("lgnd-value")&&o(c,e.data("index"),f);break;case"lgnd-viz":case"lgnd-value-title":var e=jQuery(a.target).closest("div.lgnd-entry");e.hasClass("lgnd-locate")?n(c,e.data("id")):e.hasClass("lgnd-value")&&p(c,e.data("index"));break;case"lgnd-template":case"lgnd-select":case"":break;default:if(d.match(/lgnd-sh/i)){var h=jQuery(a.target).find("input.lgnd-entry-check"),f=!h.is(":checked");h.prop("checked",f),l(c,f)}}}function r(a){var c=jQuery(a.target).closest("div.lgnd-template").data("index"),d=jQuery(a.target).val();s(c,d),b(!0)}function s(a,b){var d,e=jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group');e.empty(),x[a]=b;var f=PData.aByID(b);"undefined"!=typeof f.r.u&&(d='<div class="lgnd-value lgnd-entry" data-index="-1"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+f.r.u.v+'"> </div> <span class="lgnd-value-title">'+dlText.undef+"</span></div>",e.append(d)),f.l.forEach(function(a,b){d='<div class="lgnd-value lgnd-entry" data-index="'+b+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+a.v+'"> </div> <span class="lgnd-value-title">'+a.l+"</span></div>",e.append(d),a.z&&a.z.length>0&&a.z.forEach(function(a,c){d='<div class="lgnd-value lgnd-entry" data-index="'+b+","+c+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/>',d+=a.v&&""!==a.v?'<div class="lgnd-viz" style="background-color: '+a.v+'"></div>':'<div class="lgnd-viz lgnd-viz-empty"></div>',d+=' <span class="lgnd-value-title">&raquo; '+a.l+"</span></div>",e.append(d)})}),jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-sh input').prop("checked",!0)}function t(d,e){var f=PData.vByN(d);w&&(A[v]=w.getState(),w.teardown(),w=null);var h=jQuery(c());h.find("div.viz-content div.viz-result").empty();var i;switch(f.vf){case"M":i=new VizMap(u,f.c);break;case"p":i=new VizMap2(u,f.c);break;case"C":i=new VizCards(u,f.c);break;case"P":i=new VizPinboard(u,f.c);break;case"T":i=new VizTime(u,f.c);break;case"D":i=new VizDirectory(u,f.c);break;case"t":i=new VizTextStream(u,f.c);break;case"S":i=new VizStackChart(u,f.c);break;case"N":i=new VizNetWheel(u,f.c);break;case"n":i=new VizNetGraph(u,f.c);break;case"F":i=new VizFlow(u,f.c);break;case"B":i=new VizBrowser(u,f.c);break;case"m":i=new VizMBMap(u,f.c);break;case"b":i=new VizBMatrix(u,f.c)}v=d;var j=i.flags();if(j&V_FLAG_HSCRL?(h.find("div.viz-content").addClass("h-scroll"),h.find("div.viz-result").addClass("viz-fit-w"),h.find("div.viz-result").removeClass("viz-max-w")):(h.find("div.viz-content").removeClass("h-scroll"),h.find("div.viz-result").removeClass("viz-fit-w"),h.find("div.viz-result").addClass("viz-max-w")),j&V_FLAG_VSCRL?(h.find("div.viz-content").addClass("v-scroll"),h.find("div.viz-result").addClass("viz-fit-h"),h.find("div.viz-result").removeClass("viz-max-h")):(h.find("div.viz-content").removeClass("v-scroll"),h.find("div.viz-result").removeClass("viz-fit-h"),h.find("div.viz-result").addClass("viz-max-h")),x=[],j&V_FLAG_LGND){h.find(".hslgnd").button("enable");var k=h.find("div.lgnd-container div.lgnd-scroll");if(k.empty(),j&V_FLAG_SLGND){var l=i.getFeatureAtts(),m=PData.aByID(l);k.append('<div class="lgnd-template" data-index="0"><div class="lgnd-title">'+m.def.l+'</div><div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div></div>'),x.push(l),s(0,l)}else{var n=!1;prspdata.e.g.ts.forEach(function(a,b){var c=PData.tByID(a),d=i.getLocAtts(b);if(d&&d.length>0||!(j&V_FLAG_LOC)){var e=i.getFeatureAtts(b);if(e.length>0){n&&k.append("<hr/>");var f=jQuery('<div class="lgnd-template" data-index="'+b+'"><div class="lgnd-title">'+c.l+"</div></div>");d&&d.forEach(function(a,b){var c=PData.aByID(a);f.append('<div class="lgnd-entry lgnd-locate" data-id="'+a+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><span class="lgnd-value-title">'+c.def.l+"</span></div>")});var g='<select class="lgnd-select">';e.forEach(function(a,b){var c=PData.aByID(a);g+='<option value="'+a+'">'+c.def.l+"</option>"}),g+="</select>";var h=jQuery(g);h.change(r),jQuery(f).append(h),jQuery(f).append('<div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div>'),k.append(f);var l=e[0];x.push(l),s(b,l),n=!0}}})}h.find("div.lgnd-container").show(),u.flushLgnd()}else h.find("button.hslgnd").button("disable"),h.find("div.lgnd-container").hide();b(!1),j&V_FLAG_SEL?(h.find(".hilite").button("enable"),jQuery("#save-prspctv-h"+a).prop("disabled",!1).prop("checked",!1)):(h.find(".hilite").button("disable"),jQuery("#save-prspctv-h"+a).prop("disabled",!0).prop("checked",!1)),j&V_FLAG_OPT?h.find(".vopts").button("enable"):h.find(".vopts").button("disable");var o=i.hint();if(o||"string"==typeof f.n&&""!==f.n?(h.find(".vnote").button("enable"),o?o+="string"==typeof f.n&&""!==f.n?".<br/>"+f.n:".":o=f.n,jQuery("#vnotes-txt").empty().append(o)):h.find(".vnote").button("disable"),i.setup(),g(!1),e){var p=A[d];p&&i.setState(p),z&&i.render(z)}w=i}var u={},v=0,w=null,x=[],y=null,z=null,A=[];u.getFrameID=c;for(var B=0;B<prspdata.e.vf.length;B++)A.push(null);return u.getIndex=function(){return a},u.setViz=function(a,b){if(a!=v){var d=jQuery(c()+" div.view-controls select.view-viz-select");d.val(a),t(a,b)}},u.initDOM=function(b){var g=document.getElementById("dltext-view-controls").innerHTML;jQuery("#viz-frame").append('<div id="view-frame-'+a+'">'+g+"</div>");var l=jQuery(c()),m=prspdata.bClrs.vf;m&&m.length>0&&l.find("div.view-controls").css("background-color",m),l.find("div.lgnd-container").draggable({handle:l.find("div.lgnd-handle"),containment:"parent"});var n=l.find("div.view-controls select.view-viz-select");prspdata.e.vf.forEach(function(a,b){var c='<option value="'+b+'">'+a.l+"</option>";n.append(c)}),n.val(b),n.change(d),l.find("div.view-controls button:first").button({icons:{primary:"ui-icon-bookmark"},text:!1}).click(e).next().button({icons:{primary:"ui-icon-wrench"},text:!1}).click(j).next().button({icons:{primary:"ui-icon-info"},text:!1}).click(k).next().button({icons:{primary:"ui-icon-star"},text:!1}).click(h).next().button({icons:{primary:"ui-icon-cancel"},text:!1}).click(i).next().button({icons:{primary:"ui-icon-search"},text:!1}).click(f).next(),l.find("div.lgnd-container").click(q),t(b,!1)},u.getSelLocAtts=function(a){var b=[],d=jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-locate input:checked');return d.each(function(){var a=jQuery(this).parent().data("id");b.push(a)}),b},u.getSelFeatAtts=function(a){var b,d,e=[],f=jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+a+'"] div.lgnd-group div.lgnd-value input:checked');return f.each(function(){b=jQuery(this).parent().data("index"),"number"==typeof b?e.push(b):-1!=(d=b.indexOf(","))?e.push([parseInt(b.substring(0,d),10),parseInt(b.substring(d+1),10)]):e.push(parseInt(b,10))}),e},u.getSelLegend=function(a){return x[a]},u.getLgndSels=function(){return x.slice(0)},u.setLgndSels=function(a){a.forEach(function(a,b){if(a){var d=jQuery(c()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] select.lgnd-select');d.val(a),s(b,a)}})},u.getState=function(){return w?w.getState():null},u.setState=function(a){w&&w.setState(a)},u.showStream=function(a){z=a,w&&w.render(a),b(!1)},u.setStream=function(a){z=a},u.selBtns=function(a){g(a)},u.clearSel=function(){w&&w.clearSel(),g(!1)},u.setSel=function(a){return w&&w.flags()&V_FLAG_SEL?(w.setSel(a),g(a.length>0),!0):!1},u.vizAddSel=function(a){},u.vizDelSel=function(a){},u.resize=function(){w&&w.resize()},u.title=function(){var a=PData.vByN(v);return a.l},u.flushLgnd=function(){var a=jQuery(c()),b=a.width()-280;a.find("div.lgnd-container").css("left",b)},u.getBMData=function(){return w?{t:w.tUsed,r:w.rMap}:null},u}function onYouTubeIframeAPIReady(){widgetData.ytCall&&widgetData.ytCall()}var xhbtURL,widgetData={ytLoaded:!1,ytCall:null,ytCode:null,timer:null,extract:null,sTime:null,eTime:null,playing:!1,widget:null,xscriptOn:!1,tcArray:null,tcIndex:-1};jQuery(document).ready(function(a){function b(){var a;PState.set(PSTATE_PROCESS),null==A&&(A=PData.sNew(!0)),B=A;var b,c,d=!1;for(b=0;b<E.length;b++)if(c=E[b],a=jQuery('div.filter-instance[data-id="'+c.id+'"]'),d||c.f.isDirty(null)){d=!0;var e=c.f;e.evalPrep();for(var f,g,h=PData.sNew(!1),i=0,j=0,k=B.t[0],l=0,m=0,n=a.find(".apply-tmplt-0").is(":checked");i<B.l;){for(;0===k.n||k.i+k.n===i;)h.t.push({i:h.l-l,n:l}),l=0,k=B.t[++j],n=a.find(".apply-tmplt-"+j).is(":checked");f=B.s[i++],n?(g=PData.rByN(f),e.eval(g)&&(h.s[h.l++]=f,l++),m++):(h.s[h.l++]=f,l++)}for(;j++<PData.eTNum();)h.t.push({i:h.l-l,n:l}),l=0;e.isDirty(!1),e.out=h,e.evalDone(m),B=h}else B=c.f.out;PState.set(PSTATE_BUILD),D.forEach(function(a){a&&a.showStream(B)}),E.length>0?(F=2,jQuery("#btn-f-state").prop("disabled",!0).html(dlText.filtered)):(F=0,jQuery("#btn-f-state").prop("disabled",!0).html(dlText.nofilter))}function c(a){D.forEach(function(a){a&&a.clearSel()}),b(),PState.set(PSTATE_READY),a.preventDefault()}function d(a){z=a;var b=jQuery("#annote");b.text(a),a.length>0?(jQuery("#btn-annote").button("enable"),b.show()):(jQuery("#btn-annote").button("disable"),b.hide())}function e(a){jQuery("#annote").toggle("slide",{direction:"right"}),a.preventDefault()}function f(){null!==D[1]?(D[1]=null,jQuery("#view-frame-1").remove()):(PState.set(PSTATE_BUILD),D[1]=PViewFrame(1),D[1].initDOM(0),D[1].showStream(B),D[0].flushLgnd(),PState.set(PSTATE_READY)),D[0].resize()}function g(a){var b;jQuery("#dialog-about img").removeClass("zoomin"),b=jQuery("#dialog-about").dialog({height:390,width:350,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close")}}]}),jQuery("#dialog-about img").addClass("zoomin"),a.preventDefault()}function h(a){var b=_.find(prspdata.p,function(b){return a==b.id});return b?b:null==I||0==J.length?null:(b=_.find(J,function(b){return a==b.id}),b?b:null)}function i(a,b){var c=jQuery("input[name=save-prspctv-dest]:checked").val();if(""==c)return null;var d=jQuery("#save-prspctv-note").val();d=d.replace(/"/g,"");var e={f:[],h0:null,h1:null,v0:null,v1:null};D.forEach(function(a,b){a&&(e["v"+b]={l:a.title(),s:a.getState()})}),E.forEach(function(a){for(var b=[],c=jQuery('div.filter-instance[data-id="'+a.id+'"]'),d=0;d<PData.eTNum();d++)b.push(c.find(".apply-tmplt-"+d).is(":checked"));e.f.push({id:a.attID,a:b,s:a.f.getState()})});for(var f=0;2>f;f++){var g=G[f];null!==g&&jQuery("#save-prspctv-h"+f).is(":checked")&&(e["h"+f]={id:H[f],s:g.getState()})}var h={id:a,l:b,n:d,s:e};return"local"==c?(J.push(h),I.setItem(prspdata.e.id,JSON.stringify(J))):"server"==c&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_save_prspctv",id:a,l:b,x:prspdata.e.id,n:d,s:JSON.stringify(e)},success:function(a,b,c){"0"!=a&&prspdata.p.push(h)},error:function(a,b,c){alert(c)}}),c}function j(a){var b,c=/[^\w\-]/;jQuery("#save-prspctv-id").val(""),jQuery("#save-prspctv-lbl").val(""),jQuery("#save-prspctv-note").val(""),I||jQuery("#save-prspctv-d-1").prop("disabled",!0),prspdata.x.add_prspctv||jQuery("#save-prspctv-d-2").prop("disabled",!0),jQuery("#save-prspctv-h0").prop("checked",!1),jQuery("#save-prspctv-h1").prop("checked",!1);for(var d=0;2>d;d++){var e=null===G[d]||null===D[d];jQuery("#save-prspctv-h"+d).prop("disabled",e)}b=jQuery("#dialog-save-prsrctv").dialog({width:350,height:370,modal:!0,buttons:[{text:dlText.ok,click:function(){var a=jQuery("#save-prspctv-id").val().trim(),d=a.match(c),e=jQuery("#save-prspctv-lbl").val().trim();if(e=e.replace(/"/g,""),0===a.length||a.length>20||d?d="#dialog-prspctv-id-badchars":h(a)?d="#dialog-prspctv-id-used":(0===e.length||e.length>32)&&(d="#dialog-prspctv-label-bad"),d)var f=jQuery(d).dialog({width:320,height:210,modal:!0,buttons:[{text:dlText.ok,click:function(){f.dialog("close")}}]});else{var g=i(a,e);if(b.dialog("close"),"server"==g){var j=xhbtURL+"/?prspctv="+a;jQuery("#save-prspctv-embed").val(j);var k=jQuery("#dialog-prspctv-url").dialog({width:480,height:230,modal:!0,buttons:[{text:dlText.ok,click:function(){k.dialog("close")}}]})}}}},{text:dlText.cancel,click:function(){b.dialog("close")}}]}),a.preventDefault()}function k(){function a(){var a=jQuery("#prspctv-mlist");a.empty(),J.forEach(function(b){a.append('<li data-type="l" data-id="'+b.id+'"><span class="label">'+b.l+'</span> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")});for(var b=0;b<I.length;b++){var d=I.key(b);if(d!=prspdata.e.id){var e=I.getItem(d);c.push({id:d,ps:JSON.parse(e)})}}c.forEach(function(b,c){b.ps.forEach(function(d){a.append('<li data-type="x" data-xid="'+b.id+'" data-xindex="'+c+'" data-id="'+d.id+'"><i class="label">'+d.l+'</i> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")})})}var b,c=[],d=!1;a(),jQuery("#prspctv-mlist").click(function(a){if("BUTTON"==a.target.nodeName){var b,e=jQuery(a.target).hasClass("del"),f=jQuery(a.target).parent(),g=f.data("type"),h=f.data("id");if(e){switch(g){case"l":b=J.findIndex(function(a){return h==a.id}),-1!=b&&(J.splice(b,1),0==J.length?I.removeItem(prspdata.e.id):I.setItem(prspdata.e.id,JSON.stringify(J)));break;case"x":var i=f.data("xindex"),j=c[i];b=j.ps.findIndex(function(a){return h==a.id}),-1!=b&&(j.ps.splice(b,1),d=!0)}f.remove()}else{var k;switch(g){case"l":k=_.find(J,function(a){return h==a.id});break;case"x":var i=f.data("xindex"),j=c[i];k=_.find(j.ps,function(a){return h==a.id})}jQuery("#edit-prspctv-lbl").val(k.l),jQuery("#edit-prspctv-note").val(k.n);var l=jQuery("#dialog-edit-prsrctv").dialog({width:340,height:270,modal:!0,buttons:[{text:dlText.ok,click:function(){k.l=jQuery("#edit-prspctv-lbl").val(),k.n=jQuery("#edit-prspctv-note").val(),f.find(".label").text(k.l),"x"==g?d=!0:I.setItem(prspdata.e.id,JSON.stringify(J)),l.dialog("close")}},{text:dlText.cancel,click:function(){l.dialog("close")}}]})}}}),b=jQuery("#dialog-manage-prsrctv").dialog({width:450,height:350,modal:!0,buttons:[{text:dlText.ok,click:function(){d&&c.forEach(function(a){a.ps.length>0?I.setItem(a.id,JSON.stringify(a.ps)):I.removeItem(a.id)}),jQuery("#prspctv-mlist").off("click"),b.dialog("close")}}]})}function l(a){var b=jQuery("#prspctv-slist");b.empty(),prspdata.p.forEach(function(a){b.append('<li data-src="server" data-id="'+a.id+'">'+a.l+"</li>")}),J.forEach(function(a){b.append('<li data-src="local" data-id="'+a.id+'">'+a.l+"</li>")});var c=[{text:dlText.ok,click:function(){d.dialog("close");var a=b.find("li.selected");if(a.length){var c=a.data("id");w(c),PState.set(PSTATE_READY)}}},{text:dlText.cancel,click:function(){d.dialog("close")}}];I&&c.push({text:dlText.manage,click:function(){d.dialog("close"),k()}});var d=jQuery("#dialog-show-prsrctv").dialog({width:350,height:350,modal:!0,buttons:c});a.preventDefault()}function m(a){window.location.href=prspdata.e.g.hurl,a.preventDefault()}function n(a){jQuery(this).parent().next().slideToggle(400),a.preventDefault()}function o(a){var b=jQuery(this).closest("div.filter-instance");if(b){var c=b.data("id");if(c&&""!==c){var d;if(d=E.find(function(a){return a.id==c}),null==d)return void alert("Bad Filter ID "+c);d.f.isDirty(!0)}}}function p(a){var c,d,e=jQuery(this).closest("div.filter-instance"),f=e.data("id");if(c=E.findIndex(function(a){return a.id==f}),-1===c)return void alert("Bad Filter ID "+f);if(d=E[c].f,d.teardown(),E.splice(c,1),c>=E.length){var g;g=0===E.length?A:E[c-1].out,D.forEach(function(a){a&&a.setStream(g)})}else E[c].f.isDirty(!0);e.remove(),0===E.length?(jQuery("#btn-toggle-filters").button("disable"),D.forEach(function(a){a&&a.clearSel(g)}),b(),PState.set(PSTATE_READY)):(F=1,jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters)),a.preventDefault()}function q(a,b,c){var d,e,f,g;if(null!==c)d=c;else do d=Math.floor(1e3*Math.random()+2),-1!=E.findIndex(function(a){return a.id==d})&&(d=-1);while(-1==d);if("_remove"==a)e=new PFilterRemove(d),f={t:[!0,!0,!0,!0]};else switch(f=PData.aByID(a),f.def.t){case"V":e=new PFilterVocab(d,f);break;case"T":e=new PFilterText(d,f);break;case"g":e=new PFilterTags(d,f);break;case"N":e=new PFilterNum(d,f);break;case"D":e=new PFilterDates(d,f);break;case"P":e=new PFilterPtr(d,f)}if(null!==c)g=jQuery("#dialog-hilite-"+c+" span.filter-id").html(f.def.l),g=jQuery("#hilite-"+c),g.empty();else{var h={id:d,attID:a,f:e,out:null};E.push(h);var i=_.template(document.getElementById("dltext-filter-head").innerHTML);jQuery("#filter-instances").append(i({newID:d,title:e.title(),apply:y}));for(var j=jQuery('div.filter-instance[data-id="'+d+'"]'),k=0;k<PData.eTNum();k++){var l=j.find(".apply-tmplt-"+k);l.prop("disabled",!f.t[k]),l.prop("checked",b[k]&&f.t[k]),l.click(o)}j.find("button.btn-filter-toggle").button({text:!1,icons:{primary:"ui-icon-carat-2-n-s"}}).click(n),j.find("button.btn-filter-del").button({text:!1,icons:{primary:"ui-icon-trash"}}).click(p),F=1,jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters)}return e.setup(),e}function r(a,b,c,d){jQuery("#filter-list li").removeClass("selected");var e,f,g,h,i=jQuery("#filter-list li");i.each(function(b){e=jQuery(this),f=e.data("id"),"_remove"==f?a?e.show():e.hide():c?(g=PData.aByID(f),h=!1,g.t.forEach(function(a,b){h=h||a&&c[b]}),h?e.show():e.hide()):e.show()});var j,k={height:300,width:350,modal:!0,buttons:[{text:dlText.add,click:function(){var a=jQuery("#filter-list li.selected");1===a.length&&d(a.data("id")),j.dialog("close")}},{text:dlText.cancel,click:function(){j.dialog("close")}}]};b&&(k.appendTo="#dialog-2"),j=jQuery("#dialog-choose-att").dialog(k)}function s(a){r(!0,!1,null,function(a){jQuery("#filter-instances").show(400),q(a,[!0,!0,!0,!0],null),jQuery("#btn-toggle-filters").button("enable")}),a.preventDefault()}function t(a){jQuery("#filter-instances").slideToggle(400),a.preventDefault()}function u(a){PState.set(PSTATE_PROCESS);var b=D[a],c=b.getBMData(),d=[],e=G[a];if(null!==B){e.evalPrep();var f,g,h=0,i=0,j=B.t[0];a:for(;h<B.l;){for(;!c.t[i]||0==j.n||j.i+j.n==h;){if(++i===PData.eTNum())break a;j=B.t[i],h=j.i}f=B.s[h++],c.r[f>>4]&1<<(15&f)&&(g=PData.rByN(f),e.eval(g)&&d.push(f))}e.evalDone(B.l)}PState.set(PSTATE_UPDATE),d.length>0?b.setSel(d):b.clearSel(),PState.set(PSTATE_READY)}function v(a,b){var c;c=jQuery("#dialog-hilite-"+a).dialog({height:275,width:Math.min(jQuery(window).width()-20,675),modal:!0,appendTo:"#dialog-1",buttons:[{text:dlText.chsatt,click:function(){r(!1,!0,b,function(b){H[a]=b,G[a]=q(b,null,a)})}},{text:dlText.ok,click:function(){c.dialog("close"),null!==G[a]&&u(a)}},{text:dlText.cancel,click:function(){c.dialog("close")}}]})}function w(a){function c(a){return prspdata.e.vf.findIndex(function(b){return a==b.l})}var e=h(a);if(null==e)return!1;PState.set(PSTATE_PROCESS),jQuery("#filter-frame").hide(),E.forEach(function(a){a.f.teardown()}),E=[],jQuery("#filter-instances").empty(),e.s.f.forEach(function(a){var b=q(a.id,a.a,null);b.setState(a.s)}),jQuery("#filter-instances").hide(),jQuery("#btn-toggle-filters").button(0==e.s.f.length?"disable":"enable");for(var f=0;2>f;f++)if(null!=e.s["h"+f]){var g=e.s["h"+f];H[f]=g.id;var i=q(g.id,null,f);G[f]=i,i.setState(g.s)}else G[f]=null,H[f]=null;var j,k=D[0],l=D[1],m=!1;if(PState.set(PSTATE_BUILD),j=c(e.s.v0.l),k?(k.setViz(j,!1),k.selBtns(!1)):(D[0]=PViewFrame(0),k=D[0],k.initDOM(j)),null!==e.s.v1?(j=c(e.s.v1.l),l?(l.selBtns(!1),l.setViz(j,!1),l.setState(e.s.v1.s)):(D[1]=PViewFrame(1),l=D[1],l.initDOM(j),l.setState(e.s.v1.s),m=!0,k.flushLgnd())):l&&(D[1]=null,jQuery("#view-frame-1").remove(),m=!0),m&&k.resize(),k.setState(e.s.v0.s),d(e.n),PData.ready()&&A)for(b(),f=0;2>f;f++)null!==H[f]&&u(f);return!0}function x(a,b){var c=prspdata.bClrs[a];c&&c.length>0&&jQuery(b).css("background-color",c)}var y,z,A,B,C,D=[null,null],E=[],F=0,G=[null,null],H=[null,null],I=null,J=[];jQuery("body").addClass("waiting"),x("cb","#command-bar"),x("fs","#filter-frame"),PState.init(),"undefined"!=typeof PMapHub&&PMapHub.init(prspdata.m,prspdata.mg),function(){function a(a,c){b=document.getElementById(a).innerHTML,dlText[c]=b.trim()}var b;if(a("dltext-removehideall","rha"),a("dltext-showhideall","sha"),a("dltext-ok","ok"),a("dltext-cancel","cancel"),a("dltext-next","next"),a("dltext-prev","prev"),a("dltext-choose-att","chsatt"),a("dltext-seerec","seerec"),a("dltext-close","close"),a("dltext-add","add"),a("dltext-manage","manage"),a("dltext-delete","del"),a("dltext-edit","edit"),a("dltext-markers","markers"),a("dltext-hint-marker","markersize"),a("dltext-hint-text","textsize"),a("dltext-xaxis","xaxis"),a("dltext-yaxis","yaxis"),a("dltext-undefined","undef"),a("dltext-orderedby","orderedby"),a("dltext-grpblks","grpblks"),a("dltext-reset","reset"),a("dltext-nofilter","nofilter"),a("dltext-dofilters","dofilters"),a("dltext-filtered","filtered"),b=document.getElementById("dltext-month-names").innerHTML,months=b.trim().split("|"),(b=document.getElementById("dltext-d3-local"))&&(b=b.innerHTML.trim())&&"no-d3-local"!==b){var c=d3.locale(JSON.parse(b));localD3=c.timeFormat.multi([["%H:%M",function(a){return a.getMinutes()}],["%H:%M",function(a){return a.getHours()}],["%a %d",function(a){return a.getDay()&&1!=a.getDate()}],["%b %d",function(a){return 1!=a.getDate()}],["%B",function(a){return a.getMonth();
}],["%Y",function(){return!0}]])}}(),xhbtURL=window.location.pathname,xhbtURL=xhbtURL.replace(/\&*prspctv=[\w\-]+/,""),xhbtURL=xhbtURL.replace(/\/$/,""),xhbtURL=xhbtURL.replace(/^\//,""),xhbtURL="http://"+window.location.host+"/"+xhbtURL,function(){var a=_.template(document.getElementById("dltext-filter-template").innerHTML),b=[];prspdata.t.forEach(function(c,d){b.push(a({ti:d,tl:c.def.l}))}),y=b.join("&nbsp;")}(),function(){var a;prspdata.t.forEach(function(b,c){var d="";b.def.a.forEach(function(b){switch(a=PData.aByID(b),a.def.t){case"T":case"V":case"N":case"D":d+='<option value="'+b+'">'+a.def.l+"</option>"}}),jQuery("#dialog-sortby").append("<b>"+b.def.l+"</b>: <select data-ti="+c+">"+d+"</select><br/>")})}(),"/"!=prspdata.site_url.charAt(prspdata.site_url.length-1)&&(prspdata.site_url+="/"),""!=prspdata.e.g.l&&jQuery("#title").text(prspdata.e.g.l);try{var K=window.localStorage,L="__storage_test__";K.setItem(L,L),K.removeItem(L);var M=K.getItem(prspdata.e.id);I=K,M.length>0&&(J=JSON.parse(M))}catch(a){}if(jQuery("#btn-about").button({icons:{primary:"ui-icon-power"},text:!1}).click(g),jQuery("#btn-set-layout").button({icons:{primary:"ui-icon-newwin"},text:!1}).click(f),jQuery("#btn-hs-bars").button({icons:{primary:"ui-icon-carat-2-n-s"},text:!1}).click(function(a){jQuery("#filter-frame").slideToggle(400),a.preventDefault()}),jQuery("#btn-show-prspctv").button({icons:{primary:"ui-icon-image"},text:!1}).click(l),jQuery("#btn-save-prspctv").button({icons:{primary:"ui-icon-pencil"},text:!1}).click(j),jQuery("#btn-annote").button({icons:{primary:"ui-icon-comment"},text:!1}).click(e),prspdata.e.g.hbtn.length>0&&prspdata.e.g.hurl.length>0?(jQuery("#home-title").text(prspdata.e.g.hbtn),jQuery("#btn-home").button({icons:{primary:"ui-icon-home"},text:!1}).click(m)):jQuery("#btn-home").remove(),jQuery("#filter-list").click(function(a){"I"==a.target.nodeName?(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).parent().addClass("selected")):"LI"==a.target.nodeName&&(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).addClass("selected"))}),jQuery("#prspctv-slist").click(function(a){"LI"==a.target.nodeName&&(jQuery("#prspctv-slist li").removeClass("selected"),jQuery(a.target).addClass("selected"))}),jQuery("#btn-new-filter").button({icons:{primary:"ui-icon-plus"},text:!1}).click(s),jQuery("#btn-toggle-filters").button({icons:{primary:"ui-icon-arrow-2-n-s"},text:!1}).click(t),jQuery("#btn-f-state").click(c),jQuery("#dialog-about .logo").attr("src",prspdata.assets+"prospectlogo.jpg"),jQuery("#btn-inspect-left").button({icons:{primary:"ui-icon-arrowthick-1-w"},text:!1}),jQuery("#btn-inspect-right").button({icons:{primary:"ui-icon-arrowthick-1-e"},text:!1}),function(){jQuery("#filter-list").append('<li class="remove" data-id="_remove"><i>'+dlText.rha+"</i></li>"),prspdata.a.forEach(function(a){if("undefined"==typeof a.def.f||a.def.f===!0)switch(a.def.t){case"V":case"T":case"g":case"N":case"D":case"P":jQuery("#filter-list").append('<li data-id="'+a.id+'">'+a.def.l+"</li>")}})}(),0!=prspdata.show_prspctv.length&&w(prspdata.show_prspctv)||(D[0]=PViewFrame(0),D[0].initDOM(0),d("")),jQuery(window).resize(function(){D.forEach(function(a){a&&a.resize()})}),jQuery("body").on("prospect",function(a,c){switch(c.s){case PSTATE_PROCESS:PState.set(PSTATE_PROCESS),b();for(var d=0;2>d;d++)null!==G[d]&&u(d);PState.set(PSTATE_READY),jQuery("body").removeClass("waiting");break;case PSTATE_FDIRTY:F=1,jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters);break;case PSTATE_HILITE:v(c.v,c.t)}}),PState.set(PSTATE_LOAD),PData.init(),prspdata.x.tour){C={id:"ProspectTour",showPrevButton:!0,i18n:{nextBtn:dlText.next,prevBtn:dlText.prev,doneBtn:dlText.close},steps:[]};for(var N=jQuery("#help-tour").children(":first");0!=N.length;){var O={target:jQuery(N).data("t"),placement:jQuery(N).data("p"),title:jQuery(N).data("l"),xOffset:jQuery(N).data("x"),yOffset:jQuery(N).data("y"),content:jQuery(N).contents().text()};C.steps.push(O),N=N.next()}jQuery("#command-bar .help").click(function(){jQuery("#filter-frame").slideDown(200),hopscotch.startTour(C)})}else jQuery("#command-bar .help").hide()});