var xhbtURL,widgetData={ytLoaded:!1,ytCall:null,ytCode:null,timer:null,extract:null,sTime:null,eTime:null,playing:!1,widget:null,xscriptOn:!1,tcArray:null,tcIndex:-1};
function PViewFrame(y){function t(b){b!==z&&(z=b,jQuery(n()+" div.lgnd-container div.lgnd-handle button.lgnd-update").prop("disabled",!b))}function n(){return"#view-frame-"+y}function L(b){b=jQuery(n()+" div.view-controls select.view-viz-select option:selected").val();PState.set(PSTATE_BUILD);F(b,!0);PState.set(PSTATE_READY)}function M(b){h.flags()&V_FLAG_LGND&&jQuery(n()+" div.lgnd-container").toggle("slide",{direction:"left"});b.preventDefault()}function N(b){function g(a){return a.replace(/^[ \f\t\v\u200b]+|[ \f\t\v\u200b]+$/g,
"")}function c(a){var d=new Number,e=parseTC.exec(a);if(null!==e)d=1E3*(3600*parseInt(e[1])+60*parseInt(e[2])+parseFloat(e[3])),d=1==e[4].length?d+100*parseInt(e[4]):d+10*parseInt(e[4]);else throw Error("Error in transcript file: Cannot parse "+a+" as timecode.");return d}function f(a,d){var e=new String(a),e=g(e).split(/\r\n|\r|\n/g),q=[];if(e){var b,k=0;_.each(e,function(a){a=g(a);0<a.length&&("["===a.charAt(0)?(0<k&&q.push(b),b=""):(0<b.length&&(b+="<br/>"),b+=a),k++)})}_.each(q,function(a,e){d.find('div.timecode[data-tcindex="'+
e+'"]').next().after('<div class="xscript">'+a+"</div>")})}function p(a){widgetData.tcArray=[];widgetData.tcIndex=-1;var e=widgetData.tcArray;a=new String(a);if(a=g(a).split(/\r\n|\r|\n/g)){var d=jQuery("#xscript-tbl"),b=0,q,k=0,v=0,m="";_.each(a,function(a){a=g(a);1<a.length&&("["===a.charAt(0)&&"0"<=a.charAt(1)&&"9">=a.charAt(1)?(q=c(a),0<m.length&&(v&&e.push({s:k,e:q}),d.append('<div class="row"><div class="timecode" data-timecode="'+k+'" data-tcindex="'+b++ +'">'+v+'</div><div class="xscript">'+
m+"</div></div>"),m=""),v=a,k=q):(0<m.length&&(m+="<br/>"),m+=a))});0<m.length&&(e.push({s:k,e:324E5}),d.append('<div class="row"><div class="timecode" data-timecode="'+k+'" data-tcindex="'+b+'">'+v+'</div><div class="xscript">'+m+"</div></div>"));"undefined"!==typeof r&&null!=r&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:r,excerpt:widgetData.extract},success:function(a,e,b){f(JSON.parse(a),d)},error:function(a,e,d){alert(d)}})}}function a(a){var e,
d=widgetData.tcIndex;_.find(widgetData.tcArray,function(b,q){if((e=b.s<=a&&a<b.e)&&q!=d){var k=jQuery("#xscript-tbl");if(document.getElementById("sync-xscript").checked){var c=k.find('[data-tcindex="'+q+'"]').offset().top-k.offset().top,c=k.scrollTop()+c;k.animate({scrollTop:c},300)}-1!=d&&k.find('[data-tcindex="'+d+'"]').removeClass("current");k.find('[data-tcindex="'+q+'"]').addClass("current");widgetData.tcIndex=q}return e})}function q(){widgetData.widget=new YT.Player("yt-widget",{width:A-40,
height:Math.floor(9*(A-40)/16),videoId:widgetData.ytCode,events:{onError:function(a){console.log("YouTube Error: "+a.data)},onStateChange:function(e){var d;switch(e.data){case 1:widgetData.playing=!0;null==widgetData.timer&&(widgetData.timer=setInterval(function(){d=1E3*widgetData.widget.getCurrentTime();widgetData.playing&&widgetData.xscriptOn&&a(d)},300));break;case 0:case 2:widgetData.playing=!1;window.clearInterval(widgetData.timer);widgetData.timer=null;break;case 3:case 5:widgetData.playing=
!1}},onReady:function(){widgetData.extract&&widgetData.widget.cueVideoById({videoId:widgetData.ytCode,startSeconds:widgetData.sTime/1E3,endSeconds:widgetData.eTime/1E3})}}})}function d(){widgetData.playing=!0}function e(){widgetData.playing=!1}function k(){widgetData.playing&&widgetData.xscriptOn&&a(1E3*widgetData.widget.currentTime)}function v(){switch(C){case 3:null!=widgetData.widget&&(widgetData.widget.removeEventListener("ended",e),widgetData.widget.removeEventListener("pause",e),widgetData.widget.removeEventListener("playing",
d),widgetData.widget.removeEventListener("timeupdate",k));case 1:null!=widgetData.widget&&widgetData.playing&&widgetData.widget.pause();widgetData.playing=!1;widgetData.widget=null;break;case 2:widgetData.ytCall=null,null!=widgetData.widget&&widgetData.playing&&widgetData.widget.stopVideo(),widgetData.widget=null,widgetData.playing=!1,null!=widgetData.timer&&(window.clearInterval(widgetData.timer),widgetData.timer=null)}}function m(){function b(){widgetData.sTime=widgetData.eTime=null;var a;(a=prspdata.e.i.t.tcAtts[f])&&
(a=D.a[a])&&""!==a&&(widgetData.extract=a,a=a.split("-"),widgetData.sTime=c(a[0]),widgetData.eTime=c(a[1]))}var v=u[y];D=PData.rByN(v);var m=" "+D.l+" ("+(y+1)+"/"+u.length+") ",g=jQuery("#inspect-name");g.text(m);g.prop("title",D.id);var f=PData.n2T(v);w.empty();n=null;C=0;widgetData.extract=null;widgetData.xscriptOn=!1;widgetData.playing=!1;if(prspdata.e.i.modal.scOn||"boolean"===typeof prspdata.e.i.modal.aOn&&prspdata.e.i.modal.aOn)if(n=prspdata.e.i.sc.atts[f])if(m=D.a[n])if(b(),m.match(/soundcloud\.com/)){var h=
!0;C=1;w.append('<iframe id="sc-widget" class="player" width="100%" height="110" src="http://w.soundcloud.com/player/?url='+m+'"></iframe>');var x=SC.Widget(document.getElementById("sc-widget"));widgetData.widget=x;x.bind(SC.Widget.Events.READY,function(){x.play();x.bind(SC.Widget.Events.PLAY,function(){widgetData.playing=!0});x.bind(SC.Widget.Events.PAUSE,function(){widgetData.playing=!1});x.bind(SC.Widget.Events.PLAY_PROGRESS,function(e){h&&(x.pause(),h=!1,widgetData.playing=!1);widgetData.extract&&
(e.currentPosition<widgetData.sTime?x.seekTo(widgetData.sTime):e.currentPosition>widgetData.eTime&&(x.pause(),widgetData.playing=!1));widgetData.playing&&widgetData.xscriptOn&&a(e.currentPosition)});x.bind(SC.Widget.Events.FINISH,function(){widgetData.playing=!1})})}else C=3,widgetData.extract&&(g=widgetData.extract.split("-"),m+="#t="+g[0]+","+g[1]),w.append('<audio id="na-widget" controls src="'+m+'"></audio>'),widgetData.widget=document.getElementById("na-widget"),widgetData.widget.addEventListener("ended",
e),widgetData.widget.addEventListener("pause",e),widgetData.widget.addEventListener("playing",d),widgetData.widget.addEventListener("timeupdate",k);0===C&&prspdata.e.i.modal.ytOn&&(n=prspdata.e.i.yt.atts[f])&&(m=D.a[n])&&(b(),widgetData.ytCode=m,w.append('<div id="yt-widget"></div>'),widgetData.ytCall=q,widgetData.ytLoaded?q():(widgetData.ytLoaded=!0,m=document.createElement("script"),m.src="https://www.youtube.com/iframe_api",g=document.getElementsByTagName("script")[0],g.parentNode.insertBefore(m,
g)),C=2);prspdata.e.i.modal.tOn&&(m=prspdata.e.i.t.t1Atts[f])&&""!==m&&"disable"!==m&&(m=D.a[m],"string"===typeof m&&""!==m&&(0<C&&w.append("<div>"+document.getElementById("dltext-sync-xscript").innerHTML+"</div>"),w.find("#xscript-tbl").remove(),w.append('<div id="xscript-tbl"></div>'),widgetData.xscriptOn=!0,jQuery("#xscript-tbl").click(function(a){if(C&&jQuery(a.target).hasClass("timecode"))switch(a=jQuery(a.target).data("timecode"),C){case 1:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play());
widgetData.widget.seekTo(a);break;case 2:widgetData.playing||(widgetData.playing=!0,widgetData.widget.playVideo());widgetData.widget.seekTo(a/1E3);break;case 3:widgetData.playing||(widgetData.playing=!0,widgetData.widget.play()),widgetData.widget.currentTime=a/1E3}}),r=null,(g=prspdata.e.i.t.t2Atts[f])&&""!==g&&"disable"!==g&&(r=D.a[g]),jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_get_transcript",transcript:m,excerpt:widgetData.extract},success:function(a,e,d){p(JSON.parse(a))},
error:function(a,e,d){alert(d)}})));prspdata.e.i.modal.atts[f].forEach(function(a){var e=PData.rAV(v,a,!1);if(e){a=PData.aByID(a);var d;"_"==a.def.l.charAt(0)?d="<div>"+e+"</div>":(d='<div><span class="att-label">'+a.def.l+":</span> ","I"==a.def.t&&(d+="<br/>"),d+=e+"</div>");w.append(d)}})}function x(a){a=y+a;-1==a?a=u.length-1:a==u.length&&(a=0);a!=y&&(y=a,v(),m())}function I(a){x(-1)}function S(a){x(1)}var w=jQuery("#inspect-content"),n=null,C=0,r,A=450,t=400,u=null;h&&(u=h.getSel());if(null!=
u&&0!=u.length){var z,D,y=0;prspdata.e.i.modal.scOn&&(A=550);prspdata.e.i.modal.ytOn&&(A=Math.max(A,475),t=500);prspdata.e.i.modal.tOn&&(t+=100,prspdata.e.i.modal.t2On?(A=Math.max(750,Math.floor(.8*jQuery(document).width())),A=Math.min(900,A)):A=Math.max(A,550));"number"===typeof prspdata.e.i.modal.w&&(A=prspdata.e.i.modal.w);"number"===typeof prspdata.e.i.modal.h&&(t=prspdata.e.i.modal.h);B(!1);m();jQuery("#btn-inspect-left").click(I);jQuery("#btn-inspect-right").click(S);z=jQuery("#dialog-inspector").dialog({width:A,
height:t,modal:!0,buttons:[{text:dlText.seerec,click:function(){window.open(prspdata.site_url+"?p="+D.wp,"_blank")}},{text:dlText.close,click:function(){z.dialog("close")}}]});z.on("dialogclose",function(a,d){v();jQuery("#btn-inspect-left").off("click");jQuery("#btn-inspect-right").off("click");B(!0);z.off("dialogclose")});b.preventDefault()}}function B(b){var g=jQuery(n()+" div.view-controls");b?(g.find(".osel").button("enable"),g.find(".osel").addClass("pulse"),g.find(".xsel").button("enable")):
(g.find(".osel").button("disable"),g.find(".osel").removeClass("pulse"),g.find(".xsel").button("disable"))}function O(b){jQuery("body").trigger("prospect",{s:PSTATE_HILITE,v:y,t:h.tUsed});b.preventDefault()}function P(b){PState.set(PSTATE_UPDATE);h&&h.clearSel();B(!1);PState.set(PSTATE_READY);b.preventDefault()}function Q(b){h&&h.doOptions();b.preventDefault()}function G(b){var g=jQuery("#dialog-vnotes").dialog({width:300,height:300,modal:!0,buttons:[{text:dlText.ok,click:function(){g.dialog("close")}}]});
b.preventDefault()}function J(b,g){jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",g);t(!0)}function K(b){var g=jQuery(b.target).closest("div.lgnd-template").data("index"),c=b.target.className;switch(c){case "lgnd-update":h&&u&&(PState.set(PSTATE_BUILD),B(!1),h.render(u),t(!1),PState.set(PSTATE_READY));break;case "lgnd-entry-check":c=jQuery(b.target).closest("div.lgnd-entry");b=jQuery(b.target).is(":checked");
c.hasClass("lgnd-sh")?J(g,b):c.hasClass("lgnd-locate")?(c.data("id"),t(!0)):c.hasClass("lgnd-value")&&(c.data("index"),t(!0));break;case "lgnd-viz":case "lgnd-value-title":c=jQuery(b.target).closest("div.lgnd-entry");c.hasClass("lgnd-locate")?(b=c.data("id"),jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+g+'"] div.lgnd-locate input.lgnd-entry-check').prop("checked",!1),jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+g+'"] div.lgnd-locate[data-id="'+
b+'"] input.lgnd-entry-check').prop("checked",!0),t(!0)):c.hasClass("lgnd-value")&&(b=c.data("index"),jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+g+'"] div.lgnd-group input.lgnd-entry-check').prop("checked",!1),jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+g+'"] div.lgnd-group div.lgnd-value[data-index="'+b+'"] input.lgnd-entry-check').prop("checked",!0),t(!0));break;case "lgnd-template":case "lgnd-select":case "":break;default:c.match(/lgnd-sh/i)&&
(c=jQuery(b.target).find("input.lgnd-entry-check"),b=!c.is(":checked"),c.prop("checked",b),J(g,b))}}function R(b){var g=jQuery(b.target).closest("div.lgnd-template").data("index");b=jQuery(b.target).val();E(g,b);t(!0)}function E(b,g){var c,f=jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] div.lgnd-group');f.empty();r[b]=g;var h=PData.aByID(g);"undefined"!==typeof h.r.u&&(c='<div class="lgnd-value lgnd-entry" data-index="-1"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+
h.r.u.v+'"> </div> <span class="lgnd-value-title">'+dlText.undef+"</span></div>",f.append(c));h.l.forEach(function(a,b){c='<div class="lgnd-value lgnd-entry" data-index="'+b+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><div class="lgnd-viz" style="background-color: '+a.v+'"> </div> <span class="lgnd-value-title">'+a.l+"</span></div>";f.append(c);a.z&&0<a.z.length&&a.z.forEach(function(a,e){c='<div class="lgnd-value lgnd-entry" data-index="'+b+","+e+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/>';
c=a.v&&""!==a.v?c+('<div class="lgnd-viz" style="background-color: '+a.v+'"></div>'):c+'<div class="lgnd-viz lgnd-viz-empty"></div>';c+=' <span class="lgnd-value-title">&raquo; '+a.l+"</span></div>";f.append(c)})});jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] div.lgnd-sh input').prop("checked",!0)}function F(b,g){var c=PData.vByN(b);h&&(h.teardown(),h=null);var l=jQuery(n());l.find("div.viz-content div.viz-result").empty();var p;switch(c.vf){case "M":p=new VizMap(f,
c.c);break;case "C":p=new VizCards(f,c.c);break;case "P":p=new VizPinboard(f,c.c);break;case "T":p=new VizTime(f,c.c);break;case "D":p=new VizDirectory(f,c.c);break;case "t":p=new VizTextStream(f,c.c);break;case "S":p=new VizStackChart(f,c.c);break;case "N":p=new VizNetWheel(f,c.c);break;case "F":p=new VizFlow(f,c.c);break;case "B":p=new VizBrowser(f,c.c);break;case "m":p=new VizMBMap(f,c.c)}H=b;var a=p.flags();a&V_FLAG_HSCRL?(l.find("div.viz-content").addClass("h-scroll"),l.find("div.viz-result").addClass("viz-fit-w"),
l.find("div.viz-result").removeClass("viz-max-w")):(l.find("div.viz-content").removeClass("h-scroll"),l.find("div.viz-result").removeClass("viz-fit-w"),l.find("div.viz-result").addClass("viz-max-w"));a&V_FLAG_VSCRL?(l.find("div.viz-content").addClass("v-scroll"),l.find("div.viz-result").addClass("viz-fit-h"),l.find("div.viz-result").removeClass("viz-max-h")):(l.find("div.viz-content").removeClass("v-scroll"),l.find("div.viz-result").removeClass("viz-fit-h"),l.find("div.viz-result").addClass("viz-max-h"));
r=[];if(a&V_FLAG_LGND){l.find(".hslgnd").button("enable");var q=l.find("div.lgnd-container div.lgnd-scroll");q.empty();if(a&V_FLAG_SLGND){var d=p.getFeatureAtts(),e=PData.aByID(d);q.append('<div class="lgnd-template" data-index="0"><div class="lgnd-title">'+e.def.l+'</div><div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div></div>');r.push(d);E(0,d)}else{var k=!1;prspdata.e.g.ts.forEach(function(e,
d){var b=PData.tByID(e),c=p.getLocAtts(d);if(c&&0<c.length||!(a&V_FLAG_LOC)){var g=p.getFeatureAtts(d);if(0<g.length){k&&q.append("<hr/>");var f=jQuery('<div class="lgnd-template" data-index="'+d+'"><div class="lgnd-title">'+b.l+"</div></div>");c&&c.forEach(function(a,e){var d=PData.aByID(a);f.append('<div class="lgnd-entry lgnd-locate" data-id="'+a+'"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><span class="lgnd-value-title">'+d.def.l+"</span></div>")});var h='<select class="lgnd-select">';
g.forEach(function(a,d){var e=PData.aByID(a);h+='<option value="'+a+'">'+e.def.l+"</option>"});h+="</select>";b=jQuery(h);b.change(R);jQuery(f).append(b);jQuery(f).append('<div class="lgnd-entry lgnd-sh"><input type="checkbox" checked="checked" class="lgnd-entry-check"/><i>'+dlText.sha+'</i></div><div class="lgnd-group"></div>');q.append(f);g=g[0];r.push(g);E(d,g);k=!0}}})}l.find("div.lgnd-container").show()}else l.find("button.hslgnd").button("disable"),l.find("div.lgnd-container").hide();t(!1);
a&V_FLAG_SEL?(l.find(".hilite").button("enable"),jQuery("#save-prspctv-h"+y).prop("disabled",!1).prop("checked",!1)):(l.find(".hilite").button("disable"),jQuery("#save-prspctv-h"+y).prop("disabled",!0).prop("checked",!1));a&V_FLAG_OPT?l.find(".vopts").button("enable"):l.find(".vopts").button("disable");(d=p.hint())||"string"===typeof c.n&&""!==c.n?(l.find(".vnote").button("enable"),d=d?"string"===typeof c.n&&""!==c.n?d+(".<br/>"+c.n):d+".":c.n,jQuery("#vnotes-txt").empty().append(d)):l.find(".vnote").button("disable");
p.setup();B(!1);u&&g&&p.render(u);h=p}var f={},H=0,h=null,r=[],z=null,u=null;f.getFrameID=n;f.getIndex=function(){return y};f.setViz=function(b,g){b!=H&&(jQuery(n()+" div.view-controls select.view-viz-select").val(b),F(b,g))};f.initDOM=function(b){var g=document.getElementById("dltext-view-controls").innerHTML;jQuery("#viz-frame").append('<div id="view-frame-'+y+'">'+g+"</div>");var g=jQuery(n()),c=prspdata.bClrs.vf;c&&0<c.length&&g.find("div.view-controls").css("background-color",c);g.find("div.lgnd-container").draggable({handle:g.find("div.lgnd-handle"),
containment:"parent"});var f=g.find("div.view-controls select.view-viz-select");prspdata.e.vf.forEach(function(b,a){f.append('<option value="'+a+'">'+b.l+"</option>")});f.val(b);f.change(L);g.find("div.view-controls button:first").button({icons:{primary:"ui-icon-bookmark"},text:!1}).click(M).next().button({icons:{primary:"ui-icon-wrench"},text:!1}).click(Q).next().button({icons:{primary:"ui-icon-info"},text:!1}).click(G).next().button({icons:{primary:"ui-icon-star"},text:!1}).click(O).next().button({icons:{primary:"ui-icon-cancel"},
text:!1}).click(P).next().button({icons:{primary:"ui-icon-search"},text:!1}).click(N).next();g.find("div.lgnd-container").click(K);F(b,!1)};f.getSelLocAtts=function(b){var g=[];jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] div.lgnd-locate input:checked').each(function(){var b=jQuery(this).parent().data("id");g.push(b)});return g};f.getSelFeatAtts=function(b){var g=[],c,f;jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+b+'"] div.lgnd-group div.lgnd-value input:checked').each(function(){c=
jQuery(this).parent().data("index");"number"==typeof c?g.push(c):-1!=(f=c.indexOf(","))?g.push([parseInt(c.substring(0,f),10),parseInt(c.substring(f+1),10)]):g.push(parseInt(c,10))});return g};f.getSelLegend=function(b){return r[b]};f.getLgndSels=function(){return r.slice(0)};f.setLgndSels=function(b){b.forEach(function(b,c){b&&(jQuery(n()+' div.lgnd-container div.lgnd-scroll div.lgnd-template[data-index="'+c+'"] select.lgnd-select').val(b),E(c,b))})};f.getState=function(){return h?h.getState():null};
f.setState=function(b){h&&h.setState(b)};f.showStream=function(b){u=b;h&&h.render(b);t(!1)};f.setStream=function(b){u=b};f.selBtns=function(b){B(b)};f.clearSel=function(){h&&h.clearSel();B(!1)};f.setSel=function(b){return h&&h.flags()&V_FLAG_SEL?(h.setSel(b),B(0<b.length),!0):!1};f.resize=function(){h&&h.resize()};f.title=function(){return PData.vByN(H).l};f.flushLgnd=function(){jQuery(n()).find("div.lgnd-container").css("left","10px")};f.getBMData=function(){return h?{t:h.tUsed,r:h.rMap}:null};return f}
jQuery(document).ready(function(y){function t(){var a;PState.set(PSTATE_PROCESS);null==u&&(u=PData.sNew(!0));b=u;var q=!1,d,e;for(d=0;d<h.length;d++)if(e=h[d],a=jQuery('div.filter-instance[data-id="'+e.id+'"]'),q||e.f.isDirty(null)){q=!0;e=e.f;e.evalPrep();for(var k=PData.sNew(!1),c=0,m,g,I=0,l=b.t[0],w=0,n=0,p=a.find(".apply-tmplt-0").is(":checked");c<b.l;){for(;0===l.n||l.i+l.n===c;)k.t.push({i:k.l-w,n:w}),w=0,l=b.t[++I],p=a.find(".apply-tmplt-"+I).is(":checked");m=b.s[c++];p?(g=PData.rByN(m),e.eval(g)&&
(k.s[k.l++]=m,w++),n++):(k.s[k.l++]=m,w++)}for(;I++<PData.eTNum();)k.t.push({i:k.l-w,n:w}),w=0;e.isDirty(!1);e.out=k;e.evalDone(n);b=k}else b=e.f.out;PState.set(PSTATE_BUILD);f.forEach(function(a){a&&a.showStream(b)});0<h.length?jQuery("#btn-f-state").prop("disabled",!0).html(dlText.filtered):jQuery("#btn-f-state").prop("disabled",!0).html(dlText.nofilter)}function n(a){var b=jQuery("#annote");b.text(a);0<a.length?(jQuery("#btn-annote").button("enable"),b.show()):(jQuery("#btn-annote").button("disable"),
b.hide())}function L(a){var b=_.find(prspdata.p,function(d){return a==d.id});return b?b:null==g||0==c.length?null:(b=_.find(c,function(d){return a==d.id}))?b:null}function M(a,b){var d=jQuery("input[name=save-prspctv-dest]:checked").val();if(""==d)return null;var e=jQuery("#save-prspctv-note").val(),e=e.replace(/"/g,""),k={f:[],h0:null,h1:null,v0:null,v1:null};f.forEach(function(a,e){a&&(k["v"+e]={l:a.title(),s:a.getState()})});h.forEach(function(a){for(var e=[],d=jQuery('div.filter-instance[data-id="'+
a.id+'"]'),b=0;b<PData.eTNum();b++)e.push(d.find(".apply-tmplt-"+b).is(":checked"));k.f.push({id:a.attID,a:e,s:a.f.getState()})});for(var v=0;2>v;v++){var m=r[v];null!==m&&jQuery("#save-prspctv-h"+v).is(":checked")&&(k["h"+v]={id:z[v],s:m.getState()})}var x={id:a,l:b,n:e,s:k};"local"==d?(c.push(x),g.setItem(prspdata.e.id,JSON.stringify(c))):"server"==d&&jQuery.ajax({type:"POST",url:prspdata.ajax_url,data:{action:"prsp_save_prspctv",id:a,l:b,x:prspdata.e.id,n:e,s:JSON.stringify(k)},success:function(a,
e,d){"0"!=a&&prspdata.p.push(x)},error:function(a,e,d){alert(d)}});return d}function N(){var a,b=[],d=!1;(function(){var a=jQuery("#prspctv-mlist");a.empty();c.forEach(function(d){a.append('<li data-type="l" data-id="'+d.id+'"><span class="label">'+d.l+'</span> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")});for(var d=0;d<g.length;d++){var f=g.key(d);if(f!=prspdata.e.id){var m=g.getItem(f);b.push({id:f,ps:JSON.parse(m)})}}b.forEach(function(d,b){d.ps.forEach(function(k){a.append('<li data-type="x" data-xid="'+
d.id+'" data-xindex="'+b+'" data-id="'+k.id+'"><i class="label">'+k.l+'</i> <button class="del">'+dlText.del+'</button> <button class="edit">'+dlText.edit+"</button></li>")})})})();jQuery("#prspctv-mlist").click(function(a){if("BUTTON"==a.target.nodeName){var k=jQuery(a.target).hasClass("del"),f=jQuery(a.target).parent(),m=f.data("type"),h=f.data("id");if(k){switch(m){case "l":a=c.findIndex(function(a){return h==a.id});-1!=a&&(c.splice(a,1),0==c.length?g.removeItem(prspdata.e.id):g.setItem(prspdata.e.id,
JSON.stringify(c)));break;case "x":a=f.data("xindex"),k=b[a],a=k.ps.findIndex(function(a){return h==a.id}),-1!=a&&(k.ps.splice(a,1),d=!0)}f.remove()}else{var l;switch(m){case "l":l=_.find(c,function(a){return h==a.id});break;case "x":a=f.data("xindex"),k=b[a],l=_.find(k.ps,function(a){return h==a.id})}jQuery("#edit-prspctv-lbl").val(l.l);jQuery("#edit-prspctv-note").val(l.n);var n=jQuery("#dialog-edit-prsrctv").dialog({width:340,height:270,modal:!0,buttons:[{text:dlText.ok,click:function(){l.l=jQuery("#edit-prspctv-lbl").val();
l.n=jQuery("#edit-prspctv-note").val();f.find(".label").text(l.l);"x"==m?d=!0:g.setItem(prspdata.e.id,JSON.stringify(c));n.dialog("close")}},{text:dlText.cancel,click:function(){n.dialog("close")}}]})}}});a=jQuery("#dialog-manage-prsrctv").dialog({width:450,height:350,modal:!0,buttons:[{text:dlText.ok,click:function(){d&&b.forEach(function(a){0<a.ps.length?g.setItem(a.id,JSON.stringify(a.ps)):g.removeItem(a.id)});jQuery("#prspctv-mlist").off("click");a.dialog("close")}}]})}function B(a){window.location.href=
prspdata.e.g.hurl;a.preventDefault()}function O(a){jQuery(this).parent().next().slideToggle(400);a.preventDefault()}function P(a){if(a=jQuery(this).closest("div.filter-instance")){var b=a.data("id");b&&""!==b&&(a=h.find(function(a){return a.id==b}),null==a?alert("Bad Filter ID "+b):a.f.isDirty(!0))}}function Q(a){var b=jQuery(this).closest("div.filter-instance"),d=b.data("id"),e,k;e=h.findIndex(function(a){return a.id==d});if(-1===e)alert("Bad Filter ID "+d);else{k=h[e].f;k.teardown();h.splice(e,
1);if(e>=h.length){var c;c=0===h.length?u:h[e-1].out;f.forEach(function(a){a&&a.setStream(c)})}else h[e].f.isDirty(!0);b.remove();0===h.length?(jQuery("#btn-toggle-filters").button("disable"),f.forEach(function(a){a&&a.clearSel(c)}),t(),PState.set(PSTATE_READY)):jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters);a.preventDefault()}}function G(a,b,d){var e,k,c;if(null!==d)e=d;else{do e=Math.floor(1E3*Math.random()+2),-1!=h.findIndex(function(a){return a.id==e})&&(e=-1);while(-1==e)}if("_remove"==
a)k=new PFilterRemove(e),c={t:[!0,!0,!0,!0]};else switch(c=PData.aByID(a),c.def.t){case "V":k=new PFilterVocab(e,c);break;case "T":k=new PFilterText(e,c);break;case "g":k=new PFilterTags(e,c);break;case "N":k=new PFilterNum(e,c);break;case "D":k=new PFilterDates(e,c)}if(null!==d)b=jQuery("#dialog-hilite-"+d+" span.filter-id").html(c.def.l),b=jQuery("#hilite-"+d),b.empty();else{h.push({id:e,attID:a,f:k,out:null});d=_.template(document.getElementById("dltext-filter-head").innerHTML);jQuery("#filter-instances").append(d({newID:e,
title:k.title(),apply:H}));d=jQuery('div.filter-instance[data-id="'+e+'"]');for(a=0;a<PData.eTNum();a++){var f=d.find(".apply-tmplt-"+a);f.prop("disabled",!c.t[a]);f.prop("checked",b[a]&&c.t[a]);f.click(P)}d.find("button.btn-filter-toggle").button({text:!1,icons:{primary:"ui-icon-carat-2-n-s"}}).click(O);d.find("button.btn-filter-del").button({text:!1,icons:{primary:"ui-icon-trash"}}).click(Q);jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters)}k.setup();return k}function J(a,b,d,e){jQuery("#filter-list li").removeClass("selected");
var c,f,g,h;jQuery("#filter-list li").each(function(b){c=jQuery(this);f=c.data("id");"_remove"==f?a?c.show():c.hide():d?(g=PData.aByID(f),h=!1,g.t.forEach(function(a,b){h=h||a&&d[b]}),h?c.show():c.hide()):c.show()});var l,n={height:300,width:350,modal:!0,buttons:[{text:dlText.add,click:function(){var a=jQuery("#filter-list li.selected");1===a.length&&e(a.data("id"));l.dialog("close")}},{text:dlText.cancel,click:function(){l.dialog("close")}}]};b&&(n.appendTo="#dialog-2");l=jQuery("#dialog-choose-att").dialog(n)}
function K(a){PState.set(PSTATE_PROCESS);var c=f[a],d=c.getBMData(),e=[];a=r[a];if(null!==b){a.evalPrep();var k=0,g,h,l=0,n=b.t[0];a:for(;k<b.l;){for(;!d.t[l]||0==n.n||n.i+n.n==k;){if(++l===PData.eTNum())break a;n=b.t[l];k=n.i}g=b.s[k++];d.r[g>>4]&1<<(g&15)&&(h=PData.rByN(g),a.eval(h)&&e.push(g))}a.evalDone(b.l)}PState.set(PSTATE_UPDATE);0<e.length?c.setSel(e):c.clearSel();PState.set(PSTATE_READY)}function R(a,b){var d;d=jQuery("#dialog-hilite-"+a).dialog({height:275,width:Math.min(jQuery(window).width()-
20,675),modal:!0,appendTo:"#dialog-1",buttons:[{text:dlText.chsatt,click:function(){J(!1,!0,b,function(b){z[a]=b;r[a]=G(b,null,a)})}},{text:dlText.ok,click:function(){d.dialog("close");null!==r[a]&&K(a)}},{text:dlText.cancel,click:function(){d.dialog("close")}}]})}function E(a){function b(a){return prspdata.e.vf.findIndex(function(b){return a==b.l})}a=L(a);if(null==a)return!1;PState.set(PSTATE_PROCESS);jQuery("#filter-frame").hide();h.forEach(function(a){a.f.teardown()});h=[];jQuery("#filter-instances").empty();
a.s.f.forEach(function(a){G(a.id,a.a,null).setState(a.s)});jQuery("#filter-instances").hide();jQuery("#btn-toggle-filters").button(0==a.s.f.length?"disable":"enable");for(var d=0;2>d;d++)if(null!=a.s["h"+d]){var e=a.s["h"+d];z[d]=e.id;var c=G(e.id,null,d);r[d]=c;c.setState(e.s)}else r[d]=null,z[d]=null;var e=f[0],c=f[1],g=!1;PState.set(PSTATE_BUILD);d=b(a.s.v0.l);e?(e.setViz(d,!1),e.selBtns(!1)):(f[0]=PViewFrame(0),e=f[0],e.initDOM(d));null!==a.s.v1?(d=b(a.s.v1.l),c?(c.selBtns(!1),c.setViz(d,!1),
c.setState(a.s.v1.s)):(e.flushLgnd(),f[1]=PViewFrame(1),c=f[1],c.initDOM(d),c.setState(a.s.v1.s),g=!0)):c&&(f[1]=null,jQuery("#view-frame-1").remove(),g=!0);g&&e.resize();e.setState(a.s.v0.s);n(a.n);if(PData.ready()&&u)for(t(),d=0;2>d;d++)null!==z[d]&&K(d);return!0}function F(a,b){var d=prspdata.bClrs[a];d&&0<d.length&&jQuery(b).css("background-color",d)}var f=[null,null],H,h=[],r=[null,null],z=[null,null],u,b,g=null,c=[];jQuery("body").addClass("waiting");F("cb","#command-bar");F("fs","#filter-frame");
PState.init();"undefined"!==typeof PMapHub&&PMapHub.init(prspdata.m);(function(){function a(a,c){b=document.getElementById(a).innerHTML;dlText[c]=b.trim()}var b;a("dltext-removehideall","rha");a("dltext-showhideall","sha");a("dltext-ok","ok");a("dltext-cancel","cancel");a("dltext-choose-att","chsatt");a("dltext-seerec","seerec");a("dltext-close","close");a("dltext-add","add");a("dltext-manage","manage");a("dltext-delete","del");a("dltext-edit","edit");a("dltext-markers","markers");a("dltext-hint-marker",
"markersize");a("dltext-hint-text","textsize");a("dltext-xaxis","xaxis");a("dltext-yaxis","yaxis");a("dltext-undefined","undef");a("dltext-orderedby","orderedby");a("dltext-grpblks","grpblks");a("dltext-reset","reset");a("dltext-nofilter","nofilter");a("dltext-dofilters","dofilters");a("dltext-filtered","filtered");b=document.getElementById("dltext-month-names").innerHTML;months=b.trim().split("|");(b=document.getElementById("dltext-d3-local"))&&(b=b.innerHTML)&&1<b.length&&(localD3=d3.locale(JSON.parse(b)).timeFormat.multi([["%H:%M",
function(a){return a.getMinutes()}],["%H:%M",function(a){return a.getHours()}],["%a %d",function(a){return a.getDay()&&1!=a.getDate()}],["%b %d",function(a){return 1!=a.getDate()}],["%B",function(a){return a.getMonth()}],["%Y",function(){return!0}]]))})();xhbtURL=window.location.pathname;xhbtURL=xhbtURL.replace(/\&*prspctv=[\w\-]+/,"");xhbtURL=xhbtURL.replace(/\/$/,"");xhbtURL=xhbtURL.replace(/^\//,"");xhbtURL="http://"+window.location.host+"/"+xhbtURL;(function(){var a=_.template(document.getElementById("dltext-filter-template").innerHTML),
b=[];prspdata.t.forEach(function(d,c){b.push(a({ti:c,tl:d.def.l}))});H=b.join("&nbsp;")})();(function(){var a;prspdata.t.forEach(function(b,d){var c="";b.def.a.forEach(function(b){a=PData.aByID(b);switch(a.def.t){case "T":case "V":case "N":case "D":c+='<option value="'+b+'">'+a.def.l+"</option>"}});jQuery("#dialog-sortby").append("<b>"+b.def.l+"</b>: <select data-ti="+d+">"+c+"</select><br/>")})})();"/"!=prspdata.site_url.charAt(prspdata.site_url.length-1)&&(prspdata.site_url+="/");""!=prspdata.e.g.l&&
jQuery("#title").text(prspdata.e.g.l);try{var l=window.localStorage;l.setItem("__storage_test__","__storage_test__");l.removeItem("__storage_test__");var p=l.getItem(prspdata.e.id),g=l;0<p.length&&(c=JSON.parse(p))}catch(a){}jQuery("#btn-about").button({icons:{primary:"ui-icon-power"},text:!1}).click(function(a){var b;jQuery("#dialog-about img").removeClass("zoomin");b=jQuery("#dialog-about").dialog({height:390,width:350,modal:!0,buttons:[{text:dlText.ok,click:function(){b.dialog("close")}}]});jQuery("#dialog-about img").addClass("zoomin");
a.preventDefault()});jQuery("#btn-set-layout").button({icons:{primary:"ui-icon-newwin"},text:!1}).click(function(){null!==f[1]?(f[1]=null,jQuery("#view-frame-1").remove()):(f[0].flushLgnd(),PState.set(PSTATE_BUILD),f[1]=PViewFrame(1),f[1].initDOM(0),f[1].showStream(b),PState.set(PSTATE_READY));f[0].resize()});jQuery("#btn-hs-bars").button({icons:{primary:"ui-icon-carat-2-n-s"},text:!1}).click(function(a){jQuery("#filter-frame").slideToggle(400);a.preventDefault()});jQuery("#btn-show-prspctv").button({icons:{primary:"ui-icon-image"},
text:!1}).click(function(a){var b=jQuery("#prspctv-slist");b.empty();prspdata.p.forEach(function(a){b.append('<li data-src="server" data-id="'+a.id+'">'+a.l+"</li>")});c.forEach(function(a){b.append('<li data-src="local" data-id="'+a.id+'">'+a.l+"</li>")});var d=[{text:dlText.ok,click:function(){e.dialog("close");var a=b.find("li.selected");a.length&&(a=a.data("id"),E(a),PState.set(PSTATE_READY))}},{text:dlText.cancel,click:function(){e.dialog("close")}}];g&&d.push({text:dlText.manage,click:function(){e.dialog("close");
N()}});var e=jQuery("#dialog-show-prsrctv").dialog({width:350,height:350,modal:!0,buttons:d});a.preventDefault()});jQuery("#btn-save-prspctv").button({icons:{primary:"ui-icon-pencil"},text:!1}).click(function(a){var b,d=/[^\w\-]/;jQuery("#save-prspctv-id").val("");jQuery("#save-prspctv-lbl").val("");jQuery("#save-prspctv-note").val("");g||jQuery("#save-prspctv-d-1").prop("disabled",!0);prspdata.x.add_prspctv||jQuery("#save-prspctv-d-2").prop("disabled",!0);jQuery("#save-prspctv-h0").prop("checked",
!1);jQuery("#save-prspctv-h1").prop("checked",!1);for(var c=0;2>c;c++){var h=null===r[c]||null===f[c];jQuery("#save-prspctv-h"+c).prop("disabled",h)}b=jQuery("#dialog-save-prsrctv").dialog({width:350,height:370,modal:!0,buttons:[{text:dlText.ok,click:function(){var a=jQuery("#save-prspctv-id").val().trim(),c=a.match(d),e=jQuery("#save-prspctv-lbl").val().trim(),e=e.replace(/"/g,"");if(0===a.length||20<a.length||c)c="#dialog-prspctv-id-badchars";else if(L(a))c="#dialog-prspctv-id-used";else if(0===
e.length||32<e.length)c="#dialog-prspctv-label-bad";if(c)var f=jQuery(c).dialog({width:320,height:210,modal:!0,buttons:[{text:dlText.ok,click:function(){f.dialog("close")}}]});else if(c=M(a,e),b.dialog("close"),"server"==c){a=xhbtURL+"/?prspctv="+a;jQuery("#save-prspctv-embed").val(a);var g=jQuery("#dialog-prspctv-url").dialog({width:480,height:230,modal:!0,buttons:[{text:dlText.ok,click:function(){g.dialog("close")}}]})}}},{text:dlText.cancel,click:function(){b.dialog("close")}}]});a.preventDefault()});
jQuery("#btn-annote").button({icons:{primary:"ui-icon-comment"},text:!1}).click(function(a){jQuery("#annote").toggle("slide",{direction:"right"});a.preventDefault()});0<prspdata.e.g.hbtn.length&&0<prspdata.e.g.hurl.length?(jQuery("#home-title").text(prspdata.e.g.hbtn),jQuery("#btn-home").button({icons:{primary:"ui-icon-home"},text:!1}).click(B)):jQuery("#btn-home").remove();jQuery("#filter-list").click(function(a){"I"==a.target.nodeName?(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).parent().addClass("selected")):
"LI"==a.target.nodeName&&(jQuery("#filter-list li").removeClass("selected"),jQuery(a.target).addClass("selected"))});jQuery("#prspctv-slist").click(function(a){"LI"==a.target.nodeName&&(jQuery("#prspctv-slist li").removeClass("selected"),jQuery(a.target).addClass("selected"))});jQuery("#btn-new-filter").button({icons:{primary:"ui-icon-plus"},text:!1}).click(function(a){J(!0,!1,null,function(a){jQuery("#filter-instances").show(400);G(a,[!0,!0,!0,!0],null);jQuery("#btn-toggle-filters").button("enable")});
a.preventDefault()});jQuery("#btn-toggle-filters").button({icons:{primary:"ui-icon-arrow-2-n-s"},text:!1}).click(function(a){jQuery("#filter-instances").slideToggle(400);a.preventDefault()});jQuery("#btn-f-state").click(function(a){f.forEach(function(a){a&&a.clearSel()});t();PState.set(PSTATE_READY);a.preventDefault()});jQuery("#dialog-about .logo").attr("src",prspdata.assets+"prospectlogo.jpg");jQuery("#btn-inspect-left").button({icons:{primary:"ui-icon-arrowthick-1-w"},text:!1});jQuery("#btn-inspect-right").button({icons:{primary:"ui-icon-arrowthick-1-e"},
text:!1});(function(){jQuery("#filter-list").append('<li class="remove" data-id="_remove"><i>'+dlText.rha+"</i></li>");prspdata.a.forEach(function(a){switch(a.def.t){case "V":case "T":case "g":case "N":case "D":jQuery("#filter-list").append('<li data-id="'+a.id+'">'+a.def.l+"</li>")}})})();0!=prspdata.show_prspctv.length&&E(prspdata.show_prspctv)||(f[0]=PViewFrame(0),f[0].initDOM(0),n(""));jQuery(window).resize(function(){f.forEach(function(a){a&&a.resize()})});jQuery("body").on("prospect",function(a,
b){switch(b.s){case PSTATE_PROCESS:PState.set(PSTATE_PROCESS);t();for(var c=0;2>c;c++)null!==r[c]&&K(c);PState.set(PSTATE_READY);jQuery("body").removeClass("waiting");break;case PSTATE_FDIRTY:jQuery("#btn-f-state").prop("disabled",!1).html(dlText.dofilters);break;case PSTATE_HILITE:R(b.v,b.t)}});PState.set(PSTATE_LOAD);PData.init()});function onYouTubeIframeAPIReady(){widgetData.ytCall&&widgetData.ytCall()};