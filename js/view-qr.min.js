/*! prospect 2017-01-11 */
var VizQRMap=function(a,b){PVizModel.call(this,a,b)};VizQRMap.prototype=Object.create(PVizModel.prototype),VizQRMap.prototype.constructor=VizQRMap,VizQRMap.prototype.flags=function(){var a=V_FLAG_SEL|V_FLAG_OPT|V_FLAG_LGND;return null==prspdata.e.g.qr.c2&&(a|=V_FLAG_SLGND),a},VizQRMap.prototype.getFeatureAtts=function(a){return null==prspdata.e.g.qr.c2?prspdata.e.g.qr.r:this.settings.lgnds[a]},VizQRMap.prototype.setup=function(){function a(){e.lMap.zoomIn()}function b(){e.lMap.zoomOut()}function c(){e.lMap.setView([g,h],f)}function d(){function a(a){e.lMap.setView([a.coords.latitude,a.coords.longitude])}navigator.geolocation.getCurrentPosition(a)}var e=this;this.qrTI=PData.tIByID(prspdata.e.g.qr.t);var f,g=parseFloat(this.settings.clat),h=parseFloat(this.settings.clon);f="string"==typeof this.settings.zoom?parseInt(this.settings.zoom):this.settings.zoom;var i=this.vFrame.getIndex();jQuery(this.frameID).append('<div id="l-map-'+i+'" class="max-size"></div>'),this.lMap=L.map("l-map-"+i,{zoomControl:!1}).setView([g,h],f),this.baseMap=PMapHub.createMapLayer(this.settings.base,1,this.lMap,null),this.bOp=100,this.lOps=[],this.mapLayers=[];var j;this.settings.lyrs.forEach(function(a,b){j=a.o,e.lOps.push(100*j);var c;c=PMapHub.createMapGroup(a.gid,j,e.lMap),e.mapLayers.push(c)});var k=_.template(document.getElementById("dltext-v-map").innerHTML);jQuery("#view-frame-"+i+" div.view-controls").append(k({vi:i})),jQuery("#map-zoom-"+i).button({text:!1,icons:{primary:"ui-icon-plus"}}).click(a),jQuery("#map-unzoom-"+i).button({text:!1,icons:{primary:"ui-icon-minus"}}).click(b),jQuery("#map-reset-"+i).button({text:!1,icons:{primary:"ui-icon-arrowrefresh-1-w"}}).click(c),jQuery("#map-cloc-"+i).button({text:!1,icons:{primary:"ui-icon-pin-s"}}).click(d);var l=L.featureGroup();this.markerLayer=l,l.options=l.options||{},l.options.layerName=dlText.markers,l.addTo(this.lMap);var m=L.featureGroup();this.lineLayer=m,m.addTo(this.lMap)},VizQRMap.prototype.render=function(a){function b(a){if(a.target&&a.target.options){var b=a.target.options._aid,c=f.toggleSel(b);c?(this.setStyle({color:"yellow",weight:2}),this.bringToFront()):this.setStyle({color:"#000",weight:1})}}function c(a){if(a.target&&a.target.options){var b=a.target.options._aid,c=f.toggleSel(b);c?(this.setStyle({dashArray:""}),this.bringToFront()):this.setStyle({dashArray:"4,6"})}}function d(a,c,d,e){f.rMap[e>>4]|=1<<(15&e);var h=L.circleMarker(a,{_aid:e,weight:1,radius:c,fillColor:d,color:"#000",opacity:1,fillOpacity:1});return h.on("click",b),g.addLayer(h),h}function e(a,b,c){if(null==M)return i;var d=f.settings.sAtts[c];if(d){var e=b.a[d];return"number"==typeof e?Math.floor((e-O[c])*k/N[c])+i:i}return i}var f=this,g=this.markerLayer,h=this.lineLayer;this.recSel.length>0&&(this.recSel=[]),this.preRender(!0,!0),g.clearLayers(),h.clearLayers();var i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z,A,B,C,D=prspdata.e.g.qr,E=D.r,F=PData.aByID(E),G=PData.allFAtts(F),H=a.t[this.qrTI],I=H.i,J=H.i+H.n,K=D.c1,M=D.c2,N=[],O=[];if(i=this.settings.min,"string"==typeof i&&(i=parseInt(i)),j=this.settings.max,"string"==typeof j&&(j=parseInt(j)),k=j-i,this.settings.sAtts.forEach(function(a){if(a){var b=PData.aByID(a);O.push(b.r.min),N.push(b.r.max-b.r.min)}else O.push(i),N.push(0)}),M)for(A=[],B=[],C=[],l=0;l<PData.eTNum();l++)n=this.vFrame.getSelLegend(l),C.push(n),B.push(n?PData.aByID(n):null),A.push(n?this.vFrame.getSelFeatAtts(l):null),this.tUsed[l]=!0;else A=this.vFrame.getSelFeatAtts(0),this.tUsed[this.qrTI]=!0;for(;I<J;)if(l=a.s[I++],m=PData.rByN(l),(n=m.a[D.e1][0])&&null!==(n=PData.nByID(n))&&(o=m.a[D.e2][0])&&null!==(o=PData.nByID(o))){if(s=PData.n2T(n),t=PData.n2T(o),PData.nInS(n,a,s)===-1||PData.nInS(o,a,t)===-1)continue;M?(r=m.a[K])&&(ll2=m.a[M])&&(p=PData.rByN(n),q=PData.rByN(o),u=p.a[C[s]],"undefined"!=typeof u&&(u=PData.lClr(u,B[s],A[s]))&&(v=q.a[C[t]],"undefined"!=typeof v&&(v=PData.lClr(v,B[t],A[t]))&&(w=d(r,e(n,p,s),u,n),x=d(ll2,e(o,q,t),v,o),f.rMap[l>>4]|=1<<(15&l),y=PData.lClr(m.a[E],F,G),z=L.polyline([r,ll2],{_aid:l,weight:5,color:y,dashArray:"4,6"}),z.on("click",c),h.addLayer(z)))):(r=m.a[K])&&(y=PData.lClr(m.a[E],F,A),y&&d(r,i,y,l))}},VizQRMap.prototype.teardown=function(){var a=this.vFrame.getIndex();jQuery("#view-frame-"+a+" div.view-controls div.iconbar").remove()},VizQRMap.prototype.resize=function(){this.lMap.invalidateSize(!1)},VizQRMap.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.markerLayer&&this.markerLayer.eachLayer(function(a){a.setStyle({color:"#000",weight:1})}),this.lineLayer&&this.lineLayer.eachLayer(function(a){a.setStyle({dashArray:"4,6"})}))},VizQRMap.prototype.setSel=function(a){var b=this;this.recSel=a,this.markerLayer&&this.markerLayer.eachLayer(function(a){b.isSel(a.options._aid)?(a.setStyle({color:"yellow",weight:2}),a.bringToFront()):a.setStyle({color:"#000",weight:1})}),this.lineLayer&&this.lineLayer.eachLayer(function(a){b.isSel(a.options._aid)?(a.setStyle({dashArray:""}),a.bringToFront()):a.setStyle({dashArray:"4,6"})})},VizQRMap.prototype.getState=function(){return{c:this.lMap.getCenter(),z:this.lMap.getZoom(),l:this.vFrame.getLgndSels()}},VizQRMap.prototype.setState=function(a){this.lMap.setView(a.c,a.z),this.vFrame.setLgndSels(a.l)},VizQRMap.prototype.hint=function(){var a="",b=PData.eTNum(),c=prspdata.e.g.qr.r,d=PData.aByID(c);d.l.forEach(function(b){a.length>0&&(a+=", "),a+='<b><span style="color: '+b.v+'">'+b.l+"</span></b>"}),a.length>0&&(a+="<br/>");for(var e=!0,f=0;f<b;f++){var g=this.settings.sAtts[f];if(g){e?(a+=dlText.markersize,e=!1):a+=",";var h=PData.aByID(g),i=PData.eTByN(f),j=PData.tByID(i);a+=" "+h.def.l+" ("+j.l+")"}}return a.length>0?a:null},VizQRMap.prototype.doOptions=function(){function a(){e&&(b.baseMap.setOpacity(b.bOp/100),b.lOps.forEach(function(a,c){b.mapLayers[c].eachLayer(function(b){b.setOpacity(a/100)})})),f.empty()}var b=this,c=this.bOp,d=[],e=!0,f=jQuery("#dialog-opacities div.layer-list"),g=jQuery('<div class="op-layer" data-i="-1">Base Map <input type=range class="op-slider" min=0 max=100 value='+this.bOp+" step=5></div>");g.find(".op-slider").on("change",function(){c=jQuery(this).val(),b.baseMap.setOpacity(c/100)}),f.append(g),this.settings.lyrs.forEach(function(a,c){var e=b.lOps[c];g=jQuery('<div class="op-layer" data-i="'+c+'">'+a.gid+' <input type=range class="op-slider" min=0 max=100 value='+e+" step=5></div>"),g.find(".op-slider").on("change",function(){var a=jQuery(this).val();d[c]=a,a/=100,b.mapLayers[c].eachLayer(function(b){b.setOpacity(a)})}),d.push(e),f.append(g)});var h=jQuery("#dialog-opacities").dialog({dialogClass:"no-close",height:300,width:500,modal:!0,buttons:[{text:dlText.ok,click:function(){e=!1,h.dialog("close"),b.bOp=c,d.forEach(function(a,c){b.lOps[c]=d[c]})}},{text:dlText.cancel,click:function(){h.dialog("close")}}]});h.on("dialogclose",function(b,c){a(),h.off("dialogclose")})};var VizQRNet=function(a,b){this.physics=null,this.stream=null,PVizModel.call(this,a,b)};VizQRNet.prototype=Object.create(PVizModel.prototype),VizQRNet.prototype.constructor=VizQRNet,VizQRNet.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_HSCRL},VizQRNet.prototype.setup=function(){this.qrTI=PData.tIByID(prspdata.e.g.qr.t),this.svg=d3.select(this.frameID).append("svg");var a=this.settings.s;"string"==typeof a&&(a=parseInt(a),this.settings.s=a),this.svg.attr("width",a).attr("height",a)},VizQRNet.prototype.render=function(a){function b(a){var b=z.toggleSel(a.ai);d3.select(this).classed("obj-sel",b)}function c(a,b,c,d){var e,f,h=0===J.length;if(h?e=0:(e=_.sortedIndex(J,{ai:a},"ai"),(h=e===J.length)||(f=J[e])),h||f.ai!==a){var j,k=z.settings.sAtts[b];if(k){var l=c.a[k];j="number"==typeof l?Math.floor((l-I[b])*i/H[b])+g:g}else j=g;f={index:0,x:0,y:0,vx:0,vy:0,fx:null,fy:null,ai:a,t:b,s:j,c:d,r:c},h?J.push(f):J.splice(e,0,f),z.rMap[a>>4]|=1<<(15&a)}return f}function d(a){d3.event.active||z.physics.alphaTarget(.3).restart(),a.fx=a.x,a.fy=a.y}function e(a){a.fx=d3.event.x,a.fy=d3.event.y}function f(a){d3.event.active||z.physics.alphaTarget(0),a.fx=null,a.fy=null}var g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y,z=this,A=prspdata.e.g.qr,B=A.r,C=PData.aByID(B),D=PData.allFAtts(C),E=a.t[this.qrTI],F=E.i,G=E.i+E.n,H=[],I=[];if(this.svg.selectAll(".gnode").remove(),this.svg.selectAll(".bond").remove(),this.recSel.length>0&&(this.recSel=[]),this.preRender(!0,!0),0!==a.l){for(g=this.settings.min,"string"==typeof g&&(g=parseInt(g)),h=this.settings.max,"string"==typeof h&&(h=parseInt(h)),i=h-g,this.settings.sAtts.forEach(function(a){if(a){var b=PData.aByID(a);I.push(b.r.min),H.push(b.r.max-b.r.min)}else I.push(g),H.push(0)}),w=[],x=[],y=[],j=0;j<PData.eTNum();j++)j===this.qrTI?(y.push(B),x.push(C),w.push(D)):(l=this.vFrame.getSelLegend(j),y.push(l),x.push(l?PData.aByID(l):null),w.push(l?this.vFrame.getSelFeatAtts(j):null)),this.tUsed[j]=!0;for(var J=[],K=[];F<G;)if(j=a.s[F++],k=PData.rByN(j),(l=k.a[A.e1][0])&&null!==(l=PData.nByID(l))&&(m=k.a[A.e2][0])&&null!==(m=PData.nByID(m))){if(p=PData.n2T(l),q=PData.n2T(m),PData.nInS(l,a,p)===-1||PData.nInS(m,a,q)===-1)continue;n=PData.rByN(l),o=PData.rByN(m),r=n.a[y[p]],"undefined"!=typeof r&&(r=PData.lClr(r,x[p],w[p]))&&(s=o.a[y[q]],"undefined"!=typeof s&&(s=PData.lClr(s,x[q],w[q]))&&(v=PData.lClr(k.a[B],C,D),v&&(t=c(l,p,n,r),u=c(m,q,o,s),z.rMap[j>>4]|=1<<(15&j),K.push({ai:j,c:v,index:K.length,source:t,target:u}))))}J.forEach(function(a,b){a.index=b});var L=this.svg.selectAll("line").data(K).enter().append("line").attr("class","bond").style("stroke",function(a){return a.c}).on("click",b),M=this.svg.selectAll("circle").data(J).enter().append("circle").attr("class","gnode").attr("r",function(a){return a.s}).style("fill",function(a){return a.c}).call(d3.drag().on("start",d).on("drag",e).on("end",f)).on("click",b);M.append("title").text(function(a){return a.r.l}),j=this.settings.s,this.physics=d3.forceSimulation().force("center",d3.forceCenter(j/2,j/2)).force("link",d3.forceLink()).force("charge",d3.forceManyBody().distanceMin((h+g)/2).distanceMax(j/8)),this.physics.force("link").links(K),h=this.settings.s-g,this.physics.force("bounds",function(){for(j=0,G=J.length;j<G;++j)t=J[j],t.x=Math.max(g,Math.min(t.x,h)),t.y=Math.max(g,Math.min(t.y,h))}),this.physics.nodes(J).on("tick",function(){L.attr("x1",function(a){return a.source.x}).attr("y1",function(a){return a.source.y}).attr("x2",function(a){return a.target.x}).attr("y2",function(a){return a.target.y}),M.attr("cx",function(a){return a.x}).attr("cy",function(a){return a.y})})}},VizQRNet.prototype.setSel=function(a){var b=this;b.recSel=a,this.svg.selectAll(".gnode").attr("class",function(a){return b.isSel(a.ai)?"obj-sel gnode":"gnode"}),this.svg.selectAll(".bond").attr("class",function(a){return b.isSel(a.ai)?"obj-sel bond":"bond"})},VizQRNet.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.svg.selectAll(".gnode").attr("class","gnode"),this.svg.selectAll(".bond").attr("class","bond"))},VizQRNet.prototype.getState=function(){return{l:this.vFrame.getLgndSels()}},VizQRNet.prototype.setState=function(a){this.vFrame.setLgndSels(a.l)},VizQRNet.prototype.hint=function(){var a="",b=PData.eTNum(),c=prspdata.e.g.qr.r,d=PData.aByID(c);d.l.forEach(function(b){a.length>0&&(a+=", "),a+='<b><span style="color: '+b.v+'">'+b.l+"</span></b>"}),a.length>0&&(a+="<br/>");for(var e=!0,f=0;f<b;f++){var g=this.settings.sAtts[f];if(g){e?(a+=dlText.markersize,e=!1):a+=",";var h=PData.aByID(g),i=PData.eTByN(f),j=PData.tByID(i);a+=" "+h.def.l+" ("+j.l+")"}}return a.length>0?a:null};var VizEgoGraph=function(a,b){PVizModel.call(this,a,b)};VizEgoGraph.prototype=Object.create(PVizModel.prototype),VizEgoGraph.prototype.constructor=VizEgoGraph,VizEgoGraph.prototype.flags=function(){return V_FLAG_LGND|V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_HSCRL},VizEgoGraph.prototype.setup=function(){var a=this.settings,b=this,c=Math.floor(a.s/2),d=jQuery(this.frameID);this.n=a.n,this.ego=null,this.qrTI=PData.tIByID(prspdata.e.g.qr.t),d.append(document.getElementById("dltext-ego-graph").innerHTML),d.find("div.egograph div.egolist div.sellist-scroll").on("click",function(a){if("DIV"===a.target.nodeName){var c=jQuery(a.target).closest("div.sellist-rec");if(1==c.size()){var d=c.data("id");b.setEgo(d)}}}),d.find("div.egograph input.ego-n").val(a.n),d.find("div.egograph input.ego-n").on("change",function(){var a=jQuery(this).val();a>="1"&&a<="6"?(jQuery(this).removeClass("error"),b.n=parseInt(a,10),b.ego&&b.setEgo(b.ego)):jQuery(this).addClass("error")}),this.svg=d3.select(this.frameID).select("svg"),this.svg.attr("width",a.s).attr("height",a.s),this.center=this.svg.append("g"),this.center.attr("transform","translate("+c+","+c+")")},VizEgoGraph.prototype.teardown=function(){var a=jQuery(this.frameID+" div.egograph");a.find("div.egolist div.sellist-scroll").off("click"),a.find("div.egolist input.ego-n").off("change")},VizEgoGraph.prototype.setEgo=function(a){function b(a,b){var c=(a-90)/180*Math.PI,d=b;return[d*Math.cos(c),d*Math.sin(c)]}function c(a,b,c,d,e){var f;if(c)f=c;else{var h=_.sortedIndex(g.drs,{id:b},"id");f=g.drs[h]}return f.u=!0,g.rMap[f.ai>>4]|=1<<(15&f.ai),{parent:a,children:[],lc:d,li:e,nc:f.f,ni:f.ai,r:f.r}}function d(a,b){var e=a.r.id;b>l&&(l=b),b<g.n&&(g.qrs.forEach(function(b){if(!b.u&&(b.e1===e||b.e2===e)){var d=b.e1===e?b.e2:b.e1;if(drI=_.sortedIndex(g.drs,{id:d},"id"),dr=g.drs[drI],!dr.u){b.u=!0,g.rMap[b.qi>>4]|=1<<(15&b.qi);var f=b.qr.a[i];"undefined"!=typeof f&&(f=PData.lClr(f,j,k),f&&a.children.push(c(a,d,dr,f,b.qi)))}}}),a.children.forEach(function(a){d(a,b+1)}))}function e(a){var b=g.toggleSel(a.data.ni);d3.select(this).classed("obj-sel",b)}function f(a){var b=g.toggleSel(a.data.li);d3.select(this).classed("obj-sel",b)}var g=this,h=this.settings,i=prspdata.e.g.qr.r,j=PData.aByID(i),k=PData.allFAtts(j),l=0,m=Math.floor(h.s/2)-h.r;this.recSel=[],this.vFrame.upSel([],!1),this.preRender(!1,!0),this.center.selectAll(".bond").remove(),this.center.selectAll(".node").remove(),this.center.selectAll(".ring").remove();var n=jQuery(this.frameID+" > div.egograph > div.egolist > div.sellist-scroll"),o=n.find('div.sellist-rec[data-id="'+a+'"]');if(n.find("div.sellist-rec").removeClass("active"),0==o.length)return void(this.ego=null);o.addClass("active"),this.ego=a,this.qrs.forEach(function(a){a.u=!1}),this.drs.forEach(function(a){a.u=!1});var p=c(null,a,null,null,null);d(p,0);for(var q=d3.hierarchy(p),r=d3.tree().size([360,m]).separation(function(a,b){return(a.parent==b.parent?1:2)/a.depth}),s=r(q),t=m/l,u=[],v=0;v<l;)u.push(++v*t);var w=(this.center.selectAll(".ring").data(u).enter().append("circle").attr("class","ring").attr("r",function(a){return a}),this.center.selectAll(".bond").data(s.descendants().slice(1)).enter().append("path").attr("class","bond").attr("stroke",function(a){return a.data.lc}).attr("d",function(a){return"M"+b(a.x,a.y)+"C"+b(a.x,(a.y+a.parent.y)/2)+" "+b(a.parent.x,(a.y+a.parent.y)/2)+" "+b(a.parent.x,a.parent.y)}).on("click",f),this.center.selectAll(".node").data(s.descendants()).enter().append("g").attr("class","node").attr("transform",function(a){return"translate("+b(a.x,a.y)+")"}));w.append("circle").attr("r",h.r).attr("fill",function(a){return a.data.nc}).on("click",e),w.append("title").text(function(a){return a.data.r.l})},VizEgoGraph.prototype.render=function(a){function b(b){var c,d,e,f,g,h,i,k=0===j.length;return k?d=0:(d=_.sortedIndex(j,{id:b},"id"),(k=d===j.length)||(f=j[d])),k||f.id!==b?(c=PData.nByID(b),null===c?-1:(g=PData.n2T(c),PData.nInS(c,a,g)===-1?-1:(e=PData.rByN(c),h=p[g],i=e.a[h],"undefined"==typeof i?-1:(i=PData.lClr(i,o[g],n[g]),i?(k?j.push({ai:c,id:b,r:e,f:i,u:!1}):j.splice(d,0,{ai:c,id:b,r:e,f:i,u:!1}),d):-1)))):d}var c,d,e,f,g,h,i=[],j=[],k=prspdata.e.g.qr,l=a.t[this.qrTI],m=l.i,n=[],o=[],p=[];for(this.recSel.length>0&&(this.recSel=[]),this.preRender(!0,!0),c=0;c<PData.eTNum();c++)f=this.vFrame.getSelLegend(c),p.push(f),o.push(f?PData.aByID(f):null),n.push(f?this.vFrame.getSelFeatAtts(c):null),this.tUsed[c]=!0;for(;m<l.i+l.n;)c=a.s[m++],d=PData.rByN(c),g=d.a[k.e1][0],e=b(g),e!==-1&&(h=d.a[k.e2][0],b(h)!==-1&&i.push({qr:d,qi:c,e1:g,e2:h,u:!1}));this.qrs=i,this.drs=j;var q=new Uint16Array(j.length);for(f=0;f<j.length;f++)q[f]=f;q.sort(function(a,b){return PData.strcmp(j[b].r.l,j[a].r.l)});var r=jQuery(this.frameID).find("div.egograph div.egolist div.sellist-scroll");r.empty(),q.forEach(function(a){f=j[a].r,r.append('<div class="sellist-rec" data-id="'+f.id+'">'+f.l+"</div>")}),this.ego&&this.setEgo(this.ego)},VizEgoGraph.prototype.setSel=function(a){var b=this;b.recSel=a,this.center.selectAll(".node circle").attr("class",function(a){return b.isSel(a.data.ni)?"obj-sel":""}),this.center.selectAll(".bond").attr("class",function(a){return b.isSel(a.data.li)?"bond obj-sel":"bond"})},VizEgoGraph.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.center.selectAll(".node circle").attr("class",""),this.center.selectAll(".bond").attr("class","bond"))},VizEgoGraph.prototype.getState=function(){return{ego:this.ego,l:this.vFrame.getLgndSels(),n:this.n}},VizEgoGraph.prototype.setState=function(a){this.vFrame.setLgndSels(a.l),this.ego=a.ego,this.n=a.n,jQuery(this.frameID+" div.egograph div.egolist input.ego-n").val(a.n)},VizEgoGraph.prototype.hint=function(){var a="",b=prspdata.e.g.qr.r,c=PData.aByID(b);return c.l.forEach(function(b){a.length>0&&(a+=", "),a+='<b><span style="color: '+b.v+'">'+b.l+"</span></b>"}),a};var VizTimeRing=function(a,b){PVizModel.call(this,a,b)};VizTimeRing.prototype=Object.create(PVizModel.prototype),VizTimeRing.prototype.constructor=VizTimeRing,VizTimeRing.prototype.flags=function(){return V_FLAG_SEL|V_FLAG_VSCRL|V_FLAG_HSCRL|V_FLAG_LGND|V_FLAG_SLGND},VizTimeRing.prototype.getFeatureAtts=function(a){return prspdata.e.g.qr.r},VizTimeRing.prototype.setup=function(){var a=this.settings,b=this,c=jQuery(this.frameID);this.r=a.r,this.egoID=null,this.egoAbsI=null,this.ls=null,this.qrTI=PData.tIByID(prspdata.e.g.qr.t),this.dAtt=PData.aByID(prspdata.e.g.qr.d),this.ts=d3.scaleTime(),this.spokes=[],this.spots=[],c.append(document.getElementById("dltext-timerings").innerHTML),c.find("div.egograph div.egolist div.sellist-scroll").on("click",function(a){if("DIV"===a.target.nodeName){var c=jQuery(a.target).closest("div.sellist-rec");if(1==c.size()){var d=c.data("id");b.setEgo(d)}}}),c.find("div.egograph div.egolist input.rr").val(a.r),c.find("div.egograph div.egolist input.rr").on("change",function(){var a=jQuery(this).val();a.match(/^[0-9]+$/)?(jQuery(this).removeClass("error"),b.r=parseInt(a,10),b.egoID&&b.drawAll()):jQuery(this).addClass("error")}),this.svg=d3.select(this.frameID).select("svg"),this.center=this.svg.append("g")},VizTimeRing.prototype.teardown=function(){var a=jQuery(this.frameID+" div.egograph");a.find("div.egolist div.sellist-scroll").off("click"),a.find("div.egolist input.rr").off("change")},VizTimeRing.prototype.showDomain=function(){function a(a){return a.getUTCFullYear()+"-"+(a.getMonth()+1)+"-"+a.getDate()}var b,c;this.ls?(b=a(this.ls[0]),c=a(this.ls[1])):b=c="--";var d=jQuery(this.frameID+" div.egograph div.egolist");d.find(".from").text(b),d.find(".to").text(c)},VizTimeRing.prototype.setEgo=function(a){var b=this,c=this.settings.dAtts;this.recSel=[],this.vFrame.upSel([],!1),this.preRender(!1,!0);var d=jQuery(this.frameID+" div.egograph div.egolist div.sellist-scroll"),e=d.find('div.sellist-rec[data-id="'+a+'"]');if(d.find("div.sellist-rec").removeClass("active"),0==e.length)return this.egoID=null,this.ls=null,this.showDomain(),this.center.selectAll(".bond").remove(),this.center.selectAll(".node").remove(),this.center.selectAll(".gnode").remove(),void this.center.selectAll(".ring").remove();e.addClass("active"),this.egoID=a;var f=_.sortedIndex(this.drs,{id:a},"id"),g=this.drs[f],h=PData.n2T(g.ai);this.egoAbsI=g.ai,this.rMap[g.ai>>4]|=1<<(15&g.ai),this.tUsed[h]=!0;var i,j=c[h],k=g.r.a[j],l=PData.dObj(k.min,1,!1);i="open"===k.max?TODAY:PData.dObj(k.max,12,!0),this.ls=[l,i],this.showDomain();var m=[],n=[],o=0;this.qrs.forEach(function(c){if(c.e1===a||c.e2===a){var d=c.e1===a?c.e2:c.e1;f=_.sortedIndex(b.drs,{id:d},"id"),g=b.drs[f],"undefined"!=typeof c.d.max?m.push({d:c.d,i:o++,qr:c,r:g}):n.push({d:c.d,i:o++,qr:c,r:g}),b.rMap[c.qi>>4]|=1<<(15&c.qi)}}),this.spokes=m,this.spots=n,this.drawAll()},VizTimeRing.prototype.drawAll=function(){function a(a,b,c){var d,f=(a*e-90)/180*Math.PI;d=c&&"open"===b?TODAY:PData.dObj(b,c?12:1,!1);var g=h.ts(d);return[g*Math.cos(f),g*Math.sin(f)]}function b(a){var b=h.toggleSel(h.egoAbsI);d3.select(this).classed("obj-sel",b)}function c(a){var b=h.toggleSel(a.qr.qi);d3.select(this).classed("obj-sel",b)}var d,e,f,g,h=this,i=prspdata.e.g.qr.d,j=PData.aByID(i);this.recSel=[],this.vFrame.upSel([],!1),this.center.selectAll(".bond").remove(),this.center.selectAll(".node").remove(),this.center.selectAll(".gnode").remove(),this.center.selectAll(".ring").remove();var k=this.ls[0],l=this.ls[1];switch(e=360/(this.spokes.length+this.spots.length),j.r.g){case"d":d=864e5;break;case"m":d=26352e5;break;case"y":d=31536e6;break;case"t":d=31536e7;break;case"c":d=31536e8}k==l?f=1:(f=(l-k)/d,f="d"===j.r.g&&Math.ceil(f)-f<8496e4?Math.ceil(f):Math.ceil(f)+1),g=(f-1)*this.r,l=new Date(k.getTime()+(f-1)*d),this.ts.domain([k,l]),this.ts.range([10,g+10]),this.svg.attr("width",26+2*g).attr("height",26+2*g),this.center.attr("transform","translate("+(g+13)+","+(g+13)+")");for(var m=[],n=0;n<f;n++)m.push(n*this.r+10);var o=(this.center.selectAll(".ring").data(m).enter().append("circle").attr("class","ring").attr("r",function(a){return a}),[0]),p=this.center.selectAll(".gnode").data(o).enter().append("circle").attr("class","gnode").attr("r","4").attr("fill","#000").on("click",b);p=this.center.selectAll(".node").data(this.spots).enter().append("g").attr("class","node").attr("transform",function(b){return"translate("+a(b.i,b.d.min,!1)+")"}),p.append("circle").attr("r","4").attr("fill",function(a){return a.qr.c}).on("click",c),p.append("title").text(function(a){return a.qr.qr.l});var q=this.center.selectAll(".bond").data(this.spokes).enter().append("path").attr("class","bond").attr("stroke",function(a){return a.qr.c}).attr("d",function(b){return"M"+a(b.i,b.d.min,!1)+"L"+a(b.i,b.d.max,!0)}).on("click",c);q.append("title").text(function(a){return a.qr.qr.l})},VizTimeRing.prototype.render=function(a){function b(b){var c,d,e,f,g=0===k.length;if(g?d=0:(d=_.sortedIndex(k,{id:b},"id"),(g=d===k.length)||(rd=k[d])),g||rd.id!==b){if(c=PData.nByID(b),null===c)return-1;if(f=PData.n2T(c),PData.nInS(c,a,f)===-1)return-1;e=PData.rByN(c);var h,i=null,j=o[f];return null===j||"undefined"==typeof(h=e.a[j])||"?"===h||"number"!=typeof h.min.y||"open"!==h.max&&"number"!=typeof h.max.y||(i=h),g?k.push({ai:c,id:b,r:e,d:i}):k.splice(d,0,{ai:c,id:b,r:e,d:i}),d}}var c,d,e,f,g,h,i,j=[],k=[],l=prspdata.e.g.qr,m=a.t[this.qrTI],n=m.i,o=this.settings.dAtts,p=prspdata.e.g.qr.r,q=PData.aByID(p),r=this.vFrame.getSelFeatAtts(0);for(this.recSel.length>0&&(this.recSel=[]),this.preRender(!0,!0),this.tUsed[this.qrTI]=!0;n<m.i+m.n;){c=a.s[n++],d=PData.rByN(c);var s=d.a[p];if("undefined"!=typeof s&&(s=PData.lClr(s,q,r),s&&"undefined"!=typeof(i=d.a[l.d]))){if(g=d.a[l.e1][0],e=b(g),e===-1)continue;if(h=d.a[l.e2][0],b(h)===-1)continue;j.push({c:s,d:i,e1:g,e2:h,qi:c,qr:d})}}this.qrs=j,this.drs=k;var t=[];k.forEach(function(a,b){null!==a.d&&t.push(b)}),t.sort(function(a,b){return PData.strcmp(k[b].r.l,k[a].r.l)});var u=jQuery(this.frameID).find("div.egograph div.egolist div.sellist-scroll");u.empty(),t.forEach(function(a){f=k[a].r,u.append('<div class="sellist-rec" data-id="'+f.id+'">'+f.l+"</div>")}),this.egoID&&this.setEgo(this.egoID)},VizTimeRing.prototype.setSel=function(a){var b=this;b.recSel=a,this.center.selectAll(".gnode").attr("class",function(a){return b.isSel(b.egoAbsI)?"gnode obj-sel":"gnode"}),this.center.selectAll(".node circle").attr("class",function(a){return b.isSel(a.qr.qi)?"obj-sel":""}),this.center.selectAll(".bond").attr("class",function(a){return b.isSel(a.qr.qi)?"bond obj-sel":"bond"})},VizTimeRing.prototype.clearSel=function(){this.recSel.length>0&&(this.recSel=[],this.center.selectAll(".gnode").attr("class","gnode"),this.center.selectAll(".node circle").attr("class",""),this.center.selectAll(".bond").attr("class","bond"))},VizTimeRing.prototype.getState=function(){return{ego:this.egoID,r:this.r}},VizTimeRing.prototype.setState=function(a){this.egoID=a.ego,this.r=a.r,jQuery(this.frameID+" div.egograph div.egolist input.rr").val(a.r)};var PFilterQR=function(a){PFilterModel.call(this,a,{id:"_qr"}),this.qr=prspdata.e.g.qr,this.r=prspdata.e.g.qr.x[0].id};PFilterQR.prototype=Object.create(PFilterModel.prototype),PFilterQR.prototype.constructor=PFilterQR,PFilterQR.prototype.title=function(){return dlText.qrrr},PFilterQR.prototype.setRoles=function(){var a=this.insertPt(),b=a.find("select.filter-qr-r1"),c=a.find("select.filter-qr-r2");b.empty(),c.empty();var d,e=PData.aByID(this.r);e&&e.l.forEach(function(a){d='<option value="'+a.l+'">'+a.l+"</option>",b.append(d),c.append(d)})},PFilterQR.prototype.setup=function(){var a=this,b=this.insertPt(),c=document.getElementById("dltext-filter-qr").innerHTML;b.append(c);var d=b.find("select.filter-qr-r");prspdata.e.g.qr.x.forEach(function(a){d.append('<option value="'+a.id+'">'+a.t+"</option>")}),this.setRoles(),d.change(function(){b.find("input.filter-qr-use-r1").prop("checked",!1),b.find("input.filter-qr-use-r2").prop("checked",!1),a.r=d.val(),a.setRoles(),a.isDirty(2)}),b.find("select.filter-qr-r1").change(function(){a.isDirty(2)}),b.find("select.filter-qr-r2").change(function(){a.isDirty(2)}),b.find("input.filter-qr-use-r").click(function(b){a.isDirty(2)}),b.find("input.filter-qr-use-r1").click(function(b){a.isDirty(2)}),b.find("input.filter-qr-use-r2").click(function(b){a.isDirty(2)})},PFilterText.prototype.teardown=function(){var a=this.insertPt();a.find("select.filter-qr-r").off("change"),a.find("select.filter-qr-r1").off("change"),a.find("select.filter-qr-r2").off("change"),a.find("input.filter-qr-use-r").off("click"),a.find("input.filter-qr-use-r1").off("click"),a.find("input.filter-qr-use-r2").off("click")},PFilterQR.prototype.evalPrep=function(){var a=this.insertPt();this.rOn=a.find("input.filter-qr-use-r").prop("checked"),this.r1On=a.find("input.filter-qr-use-r1").prop("checked"),this.r2On=a.find("input.filter-qr-use-r2").prop("checked"),this.rT=a.find("select.filter-qr-r :selected").text(),this.r1=a.find("select.filter-qr-r1").val(),this.r2=a.find("select.filter-qr-r2").val()},PFilterQR.prototype.eval=function(a){var b=!0,c=!0;if(this.rOn&&this.rT!==a.a[this.qr.r][0])return!1;if(this.r1On)if(this.r1===a.a[this.qr.r1])b=!1;else{if(this.r1!==a.a[this.qr.r2])return!1;c=!1}return!this.r2On||!(b&&this.r2!==a.a[this.qr.r1]||c&&this.r2!==a.a[this.qr.r2])},PFilterQR.prototype.getState=function(){var a=this.insertPt();return{rOn:a.find("input.filter-qr-use-r").prop("checked"),r:this.r,r1On:a.find("input.filter-qr-use-r1").prop("checked"),r1:a.find("select.filter-qr-r1").val(),r2On:a.find("input.filter-qr-use-r2").prop("checked"),r2:a.find("select.filter-qr-r2").val()}},PFilterQR.prototype.setState=function(a){var b=this.insertPt();b.find("input.filter-qr-use-r").prop("checked",a.rOn),this.r=a.r,b.find("input.filter-qr-r").val(this.r),b.find("input.filter-qr-use-r1").prop("checked",a.r1On),b.find("select.filter-qr-r1").val(a.r1),b.find("input.filter-qr-use-r1").prop("checked",a.r2On),b.find("select.filter-qr-r1").val(a.r2)};